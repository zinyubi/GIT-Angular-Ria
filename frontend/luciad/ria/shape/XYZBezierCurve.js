import{BezierCurve}from"./BezierCurve.js";import{Constants}from"../util/Constants.js";import{XYZPolyline}from"./XYZPolyline.js";import{VecMath}from"../util/VecMath.js";import{CoordinateType}from"../reference/CoordinateType.js";export class XYZBezierCurve extends BezierCurve{constructor(t,e){super(t,e);this.invalidate()}calculatePointParams(){for(let t=0;t<this.points.length;t++)this.pointParams[t]=0===t?0:this.pointParams[t-1]+VecMath.distance(this.points[t-1],this.points[t]);for(let t=0;t<this.points.length;t++)this.pointParams[t]/=this.pointParams[this.points.length-1]}get coordinateType(){return CoordinateType.GEODETIC}getStartTangent2D(){return-1}getEndTangent2D(){return-1}getTangent2D(t){if(t>1-1e-4)return this.getEndTangent2D();if(t<1e-4)return this.getStartTangent2D();const e=this.evaluateBezierDerivative(0,t,0);const i=this.evaluateBezierDerivative(0,t,1);return 90-Constants.RAD2DEG*Math.atan2(e,i)}getDiscretizedPolyline(){return new XYZPolyline(this._reference,this.getDiscretizedPoints())}calculateTotalLength(){const t=this.curvePolyline.getSimplePoints();let e=0;for(let i=0;i<t.length-1;i++)e+=VecMath.distance(t[i],t[i+1]);return e}copy(){return new XYZBezierCurve(this.reference,this.points)}getNormalizedCoordinates(){return this.points.map((({x:t,y:e,z:i})=>[t,e,i]))}evaluateBezierDerivative(t,e,i){const n=this.getControlPointCount()-1;const r=this.getNormalizedCoordinates();if(1===n)return r[t][i]-r[t+1][i];else if(2===n)return 2*(1-e)*(r[t+1][i]-r[t][i])+2*e*(r[t+2][i]-r[t+1][i]);else{let o=0;for(let s=0;s<n;s++)o+=(r[t+s+1][i]-r[t+s][i])*evaluateBernsteinPolynomial(s,n-1,e);return o}}}function evaluateBernsteinPolynomial(t,e,i){return binomial(e,t)*Math.pow(i,t)*Math.pow(1-i,e-t)}function binomial(t,e){let i=1;let n=1;for(let r=1;r<=e;r++){i*=t-(e-r);n*=r}return i/n}