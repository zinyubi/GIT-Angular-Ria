import{ProgrammingError}from"../../error/ProgrammingError.js";import{Photon}from"../../gen/photon/photon_painter.js";import{color}from"../../util/expression/ExpressionFactory.js";import{ExpressionResolver}from"../../util/expression/ExpressionResolver.js";import{ExpressionValidator}from"../../util/expression/ExpressionValidator.js";import{isUndefined}from"../../util/Lang.js";import{ObjectReleaseTracker}from"../../util/ObjectReleaseTracker.js";import{FacetCullingType}from"./FacetCullingType.js";import{MipmapFilteringType}from"./MipmapFilteringType.js";import{PBRSettingsImpl}from"./PBRSettings.js";import{toPhotonPBRSettings}from"./util/PBRUtil.js";export class MeshStyleImpl{_facetCulling=FacetCullingType.NO_CULLING;_mipMapFiltering=MipmapFilteringType.BASED_ON_DATA;constructor(e,i){e=e||{};this._layer=i;this._expressionResolver=ExpressionResolver;this._expressionValidator=new ExpressionValidator(this._expressionResolver);this._colorExpression=e.colorExpression??null;this._selectedColorExpression=e.selectedColorExpression??color("rgb(255,148,76)");this._shouldValidateSelectedColor=false;this._visibilityExpression=e.visibilityExpression??null;this._displacementExpression=e.displacementExpression??null;this._lighting=e.lighting??true;this._pbrSettings=e.pbrSettings?new PBRSettingsImpl(e.pbrSettings):null;this.facetCulling=e.facetCulling??FacetCullingType.NO_CULLING;this.mipMapFiltering=e.mipMapFiltering??MipmapFilteringType.BASED_ON_DATA;this._selectionIds=[]}get layer(){return this._layer}release(){this._layer=null}invalidate(){if(this._layer)this._layer._invalidate()}get colorExpression(){return this._colorExpression}set colorExpression(e){if(this._colorExpression===e)return;this._colorExpression=e;this._styleChanged()}get selectedColorExpression(){return this._selectedColorExpression}set selectedColorExpression(e){if(this._selectedColorExpression===e)return;this._selectedColorExpression=e;this._shouldValidateSelectedColor=true;this._styleChanged()}get visibilityExpression(){return this._visibilityExpression}set visibilityExpression(e){if(this._visibilityExpression===e)return;this._visibilityExpression=e;this._styleChanged()}get displacementExpression(){return this._displacementExpression}set displacementExpression(e){if(this._displacementExpression===e)return;this._displacementExpression=e;this._styleChanged()}get lighting(){return this._lighting}set lighting(e){if(this._lighting===e)return;this._lighting=e;this._styleChanged()}get pbrSettings(){return this._pbrSettings}set pbrSettings(e){if(this._pbrSettings===e)return;this._pbrSettings=e?new PBRSettingsImpl(e):null;this._styleChanged()}get facetCulling(){return this._facetCulling}set facetCulling(e){if(this._facetCulling===e)return;this._facetCulling=e;this._styleChanged()}get mipMapFiltering(){return this._mipMapFiltering}set mipMapFiltering(e){if(this._mipMapFiltering===e)return;this._mipMapFiltering=e;this._styleChanged()}updatePhotonScenePainter(e,i){if(!e)return;const t=new ObjectReleaseTracker;try{const s=this._colorExpression;if(s)this._validateColorExpression(s);let r=null;if(!isUndefined(i)){r=this._selectedColorExpression;if(r&&this._shouldValidateSelectedColor){this._validateColorExpression(r);this._shouldValidateSelectedColor=false}}const n=this._visibilityExpression;if(n)this._validateVisibilityExpression(n);const l=this._displacementExpression;if(l)this._validateDisplacementExpression(l);const o=s?t.track(this._resolveExpression(s)):null;const p=n?t.track(this._resolveExpression(n)):null;const a=l?t.track(this._resolveExpression(l)):null;const h=r?t.track(this._resolveExpression(r)):null;e.setFaceCullingType(this._toPhotonFacetCullingType(this._facetCulling));e.setMipmapFilteringType(this._toPhotonMipmapFilteringType(this._mipMapFiltering));const g=Photon.BufferFactory.createUint32BufferFromData(new Uint32Array(this._selectionIds));Photon.ScenePainterWrapper.setSelected(g,e);g.release();Photon.ScenePainterWrapper.setMeshStyle(o,p,a,h,this._lighting,toPhotonPBRSettings(this._pbrSettings),e)}finally{t.release()}}_toPhotonFacetCullingType(e){switch(e){case FacetCullingType.NO_CULLING:return Photon.FaceCullingType.NoCulling;case FacetCullingType.BACKFACE_CULLING:return Photon.FaceCullingType.BackfaceCulling;case FacetCullingType.FRONTFACE_CULLING:return Photon.FaceCullingType.FrontfaceCulling;case FacetCullingType.BASED_ON_DATA:return Photon.FaceCullingType.BasedOnData;default:return Photon.FaceCullingType.NoCulling}}_toPhotonMipmapFilteringType(e){switch(e){case MipmapFilteringType.NO_MIPMAP_FILTERING:return Photon.MipmapFilteringType.NoMipmapFiltering;case MipmapFilteringType.NEAREST_MIPMAPPING:return Photon.MipmapFilteringType.NearestMipmapping;case MipmapFilteringType.LINEAR_MIPMAPPING:return Photon.MipmapFilteringType.LinearMipmapping;case MipmapFilteringType.BASED_ON_DATA:return Photon.MipmapFilteringType.BasedOnData;default:return Photon.MipmapFilteringType.BasedOnData}}setSelectedIds(e){this._selectionIds=e;this._styleChanged()}_styleChanged(){if(this._layer){this._layer.updatePhotonMeshStyle(true);this._layer._invalidate()}}_resolveExpression(e,i){const t=i||function(){};return this._expressionResolver.resolve(e,this,null,void 0,t)}_validateColorExpression(e){handleErrorMessage(this._expressionValidator.getErrorMessageForColorExpression(e),"color")}_validateVisibilityExpression(e){handleErrorMessage(this._expressionValidator.getErrorMessageForVisibilityExpression(e),"visibility")}_validateDisplacementExpression(e){handleErrorMessage(this._expressionValidator.getErrorMessageForDisplacementExpression(e),"displacement")}static create(e,i){return new MeshStyleImpl(e,i)}}function handleErrorMessage(e,i){if(e)throw new ProgrammingError(`There is a problem with the ${i}  expression:\n ${e}`)}