import{isNumber}from"../../../../util/Lang.js";import{Filled}from"./util/Filled.js";import{Length}from"./util/Length.js";import{Stroked}from"./util/Stroked.js";import{PatternType}from"./util/PatternType.js";import{Pattern}from"../Pattern.js";import{Constants}from"../../../../util/Constants.js";import{clamp}from"../../../../util/Cartesian.js";const DEFAULT_FIXED_LINE_LENGTH=10;const DEFAULT_RELATIVE_LINE_LENGTH=1;const DEBUGGING=false;export class LinePattern extends Pattern{_lineJoin=null;constructor(t={},e){super(e??PatternType.LINE);const i=isNumber(t.length)?t.length:t.relative?DEFAULT_RELATIVE_LINE_LENGTH:DEFAULT_FIXED_LINE_LENGTH;const s=t.relative?0:i;const o=t.relative?i:0;this._length=new Length({fixedLength:s,relativeLength:o});this._stroked=new Stroked(t.line);this._filled=new Filled(t.fill);this._o1=isNumber(t.offset0)?t.offset0:0;this._o2=isNumber(t.offset1)?t.offset1:0;if(!isNumber(this._o1)||isNaN(this._o1))throw new Error("Invalid value for LinePattern offset0: "+this._o1);if(!isNumber(this._o2)||isNaN(this._o2))throw new Error("Invalid value for LinePattern offset1: "+this._o2);this.flexible=this._o1===this._o2;this.canBend=this.flexible}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t}get worldSizeContext(){return this._length.worldSizeContext}set worldSizeContext(t){this._length.worldSizeContext=t;this._stroked.worldSizeContext=t}getUomSizeToPixels(t){return this._length.getUomSizeToPixels(t)}getWidth(t){return this._length.getWidth(t)}isRelativeLength(){return this._length.isRelativeLength()}get fixedLength(){return this._length.fixedLength}set fixedLength(t){this._length.fixedLength=t}get relativeLength(){return this._length.relativeLength}set relativeLength(t){this._length.relativeLength=t}strokePath(t){this._stroked.strokePath(t)}get lineColor(){return this._stroked.lineColor}set lineColor(t){this._stroked.lineColor=t}get lineWidth(){return this._stroked.lineWidth}set lineWidth(t){this._stroked.lineWidth=t}get o1(){return this._o1}get o2(){return this._o2}get dashed(){return this._stroked.dashed}set dashed(t){this._stroked.dashed=t}get parallelOffset(){return this._o1}fillPath(t){this._filled.fillPath(t)}get fillColor(){return this._filled.fillColor}set fillColor(t){this._filled.fillColor=t}getMinHeight(){const t=Math.min(this._o1,this._o2)-this.lineWidth/2;return this.getUomSizeToPixels(t)}getMaxHeight(){const t=Math.max(this._o1,this._o2)+this.lineWidth/2;return this.getUomSizeToPixels(t)}paint(t,e,i,s){const o=s||this.getUomSizeToPixels(this.getWidth(e));if(!this.lineColor&&!this.fillColor)return;t.scale(1,-1);const n=this.getUomSizeToPixels(this._o1);const l=this.getUomSizeToPixels(this._o2);if(this.fillColor){t.beginPath();t.moveTo(0,n);t.lineTo(o,l);t.lineTo(o,0);t.lineTo(0,0);this.fillPath(t)}if(this.lineColor){t.beginPath();t.moveTo(0,n);t.lineTo(o,l);this.strokePath(t)}t.scale(1,-1)}paintFlexible(t,e,i){if(0===this.parallelOffset&&this.lineWidth<3)this.paint(t,i,0,i);else{let s=this.getUomSizeToPixels(this.parallelOffset);if(e.needToInvertOffset())s*=-1;const o=e.bisector();const n=e.bisector(i);this.paintOuterBisector(t,0,0,o,true);this.paintOuterBisector(t,i,0,n,false);t.save();const l=this.createClip(t,0,i,s,o,n);this.paintFromTo(t,l.minX,l.maxX,s,i);t.restore()}}createClip(t,e,i,s,o,n){const l=.5;e-=l;i+=l;const h=this.getUomSizeToPixels(this.lineWidth);let r=s+h/2;let a=s-h/2;let c=true;let f=true;if(this.fillColor){if(s>0){a=0;c=false}if(s<0){r=0;f=false}}r+=l;a-=l;const d=Math.tan(o);const u=Math.tan(n);const g=undefined;const T=undefined;const _=undefined;const m=undefined;const M=undefined;const p=undefined;const P=e+(0===Math.abs(d)?a:a/d);const b=e+(0===Math.abs(d)?a:s/d);const L=e+(0===Math.abs(d)?a:r/d);const k=i+(0===Math.abs(u)?r:a/u);const x=i+(0===Math.abs(u)?r:s/u);const C=i+(0===Math.abs(u)?r:r/u);const I=Math.min(P,L);const v=Math.max(k,C);t.scale(1,-1);t.beginPath();t.moveTo(b,s);if(L===I&&f)switch(this.lineJoin){case"miter":t.lineTo(L,r);break;case"bevel":{const e=o-Math.PI/2;const i=h/2;t.lineTo(b+i*Math.cos(e)*Math.cos(o),s+i*Math.cos(e)*Math.sin(o));t.lineTo(b,r);break}case"round":default:t.lineTo(b+h/2*Math.cos(o),s+h/2*Math.sin(o));t.ellipse(b,s,h/2,h/2,0,o,Math.PI/2,true)}else t.lineTo(L,r);if(C===v&&f)switch(this.lineJoin){case"miter":t.lineTo(C,r);break;case"bevel":{const e=n-Math.PI/2;const i=h/2;t.lineTo(x,r);t.lineTo(x+i*Math.cos(e)*Math.cos(n),s+i*Math.cos(e)*Math.sin(n));break}case"round":default:t.lineTo(x,r);t.ellipse(x,s,h/2,h/2,0,Math.PI/2,n,true)}else t.lineTo(C,r);t.lineTo(x,s);if(k===v&&c)switch(this.lineJoin){case"miter":t.lineTo(k,a);break;case"bevel":{const e=n-Math.PI/2;const i=-h/2;t.lineTo(x+i*Math.cos(e)*Math.cos(n),s+i*Math.cos(e)*Math.sin(n));t.lineTo(x,a);break}case"round":default:t.lineTo(x+h/2*Math.cos(n+Math.PI),s+h/2*Math.sin(n+Math.PI));t.ellipse(x,s,h/2,h/2,0,n+Math.PI,3*Math.PI/2,true)}else t.lineTo(k,a);if(P===I&&c)switch(this.lineJoin){case"miter":t.lineTo(P,a);break;case"bevel":{const e=o-Math.PI/2;const i=-h/2;t.lineTo(b,a);t.lineTo(b+i*Math.cos(e)*Math.cos(o),s+i*Math.cos(e)*Math.sin(o));break}case"round":default:t.lineTo(b,a);t.ellipse(b,s,h/2,h/2,0,3*Math.PI/2,o+Math.PI,true)}else t.lineTo(P,a);t.lineTo(b,s);if(DEBUGGING){t.lineWidth=.1;t.strokeStyle=this.fillColor??this.lineColor;t.stroke()}t.clip();t.scale(1,-1);return{minX:clamp(I,e-2*(Math.abs(s)+h),e),maxX:clamp(v,i,i+2*(Math.abs(s)+h))}}paintFromTo(t,e,i,s,o){if(!this.lineColor&&!this.fillColor)return;t.scale(1,-1);if(this.fillColor){t.beginPath();t.moveTo(e,s);t.lineTo(i,s);t.lineTo(o,0);t.lineTo(0,0);this.fillPath(t)}if(this.lineColor){t.beginPath();t.moveTo(e,s);t.lineTo(i,s);this.strokePath(t)}t.scale(1,-1)}paintOuterBisector(t,e,i,s,o){if(!DEBUGGING)return;t.scale(1,-1);const n=o?40:60;const l=e;const h=i;const r=l+n*Math.cos(s);const a=h+n*Math.sin(s);t.beginPath();t.moveTo(l,h);t.lineTo(r,a);t.lineWidth=3;t.strokeStyle=o?"rgb(255,0,0)":"rgb(0,0,255)";t.stroke();t.scale(1,-1);t.lineWidth=1;t.strokeText(""+Math.round(s*Constants.RAD2DEG),r,-a)}appendHash(t){this._length.appendHash(t);this._stroked.appendHash(t);this._filled.appendHash(t);t.appendDouble(this._o1);t.appendDouble(this._o2)}}