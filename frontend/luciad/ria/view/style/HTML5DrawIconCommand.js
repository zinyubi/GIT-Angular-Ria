import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{LineType}from"../../geodesy/LineType.js";import{createBounds,createPoint}from"../../shape/ShapeFactory.js";import{XYZBounds}from"../../shape/XYZBounds.js";import{Constants}from"../../util/Constants.js";import{isDefined}from"../../util/Lang.js";import{RotatedBox}from"../../util/RotatedBox.js";import{GeoDiscretizerStatic}from"../shape/discretization/GeoDiscretizerStatic.js";import{getAzimuthAtOrientedPoint}from"../AzimuthUtil.js";import{HTML5DrawCommandProto}from"./HTML5DrawCommandProto.js";import{getIconStyleValuesInPx,resolveIconImage,resolveStyleImagePixels}from"./StyleUtil.js";import{createPhotonColorFromString}from"../../util/Color.js";import{Ajax}from"../../util/Ajax.js";import{squaredDistance2D}from"../../util/Cartesian.js";import{isPromise,whenInternal}from"../../util/PromiseUtil.js";import{isBorderTransformation}from"../../transformation/MapToBorderTransformationUtil.js";import{PIXEL_UOM}from"../../uom/UnitOfMeasureUtil.js";import{getImageHash,imageColorMultiply}from"../../util/ImageUtil.js";const coord=createPoint(null,[0,0]);const toCoord=createPoint(null,[0,0]);const dropPath=new Array(6);const tempCoord=createPoint(null,[0,0]);const tempPoint=createPoint(null,[0,0]);const tempBounds1=createBounds(null,[0,0,0,0]);const tempBounds2=createBounds(null,[0,0,0,0]);const rotatedBox1=new RotatedBox;const rotatedBox2=new RotatedBox;export class HTML5DrawIconCommand extends HTML5DrawCommandProto{_modulationColor=null;constructor(t,o,i,e,s){super(t,o,e?.zOrder??0);this._maxPadding=0;this._stemStrokeStyle=null;this._image=null;this._coordinate=null;this._width="0px";this._height="0px";this._ox=0;this._oy=0;this._rotationRad=0;this._heading=Number.NaN;this._anchorX="0px";this._anchorY="0px";this._opacity=1;this._widthPX=0;this._heightPX=0;this._anchorXPX=0;this._anchorYPX=0;this._isWorldSized=false;this._uom=PIXEL_UOM;this._worldWidth=0;this._worldHeight=0;this._isWorldOffsetX=false;this._worldOffsetX=0;this._offsetXUom=PIXEL_UOM;this._isWorldOffsetY=false;this._worldOffsetY=0;this._offsetYUom=PIXEL_UOM;this.initialize(t,i);if(e)this.initializeStyle(e,s)}initialize(t,o){const i=GeoDiscretizerStatic.discretize(o,{modelReference:o.reference,worldReference:t,lineType:LineType.SHORTEST_DISTANCE});if(!i?.points)return;this._coordinate=createPoint(t,[i.points[0].x,i.points[0].y,i.points[0].z]);this.bounds=new XYZBounds(t);this.bounds.setTo3D(i.points[0].x,0,i.points[0].y,0,i.points[0].z,0)}initializeStyle(t,o){this._width=t.width;this._height=t.height;this._ox=t.offsetX;this._oy=t.offsetY;this._rotationRad=t.rotation*Constants.DEG2RAD;this._heading=t.heading;this._anchorX=isDefined(t.anchorX)?t.anchorX:"50%";this._anchorY=isDefined(t.anchorY)?t.anchorY:"50%";this._opacity=t.opacity;this._uom=t.uom;this._isWorldSized=t.isWorldSized;this._worldWidth=t.worldWidth;this._worldHeight=t.worldHeight;this._isWorldOffsetX=t.isWorldOffsetX;this._worldOffsetX=t.worldOffsetX;this._offsetXUom=t.offsetXUom;this._isWorldOffsetY=t.isWorldOffsetY;this._worldOffsetY=t.worldOffsetY;this._offsetYUom=t.offsetYUom;if(t.modulationColor){const o=createPhotonColorFromString(t.modulationColor);if(1!==o.r||1!==o.g||1!==o.b||1!==o.a)this._modulationColor=o}whenInternal(resolveIconImage(t.url,t.image,t.credentials),(i=>{this.configureWidthAndAnchor(i);const e=t=>{this._image=this._modulationColor?getRecoloredImage(t,this._modulationColor)||t:t;if(o)o()};if(Ajax.isSVGImage(t.url)){const{width:o,height:s}=resolveStyleImagePixels(this._width,this._height,i.width,i.height);if(i&&(o!==i.width||s!==i.height)){const o=resolveIconImage(t.url,t.image,t.credentials,this._widthPX,this._heightPX);if(isPromise(o))return o.then(e);e(o)}else e(i)}else e(i)}));this._stemStrokeStyle=t.stem}isReady(){return!!this._image}configureWidthAndAnchor(t){const o=getIconStyleValuesInPx(this._width,this._height,this._anchorX,this._anchorY,t.width,t.height);this._widthPX=o.width;this._heightPX=o.height;this._anchorXPX=o.anchorX;this._anchorYPX=o.anchorY;const i=Math.max(this._widthPX-this._anchorXPX,this._anchorXPX);const e=Math.max(this._heightPX-this._anchorYPX,this._anchorYPX);const s=Math.abs(Math.sin(this._rotationRad));const r=Math.abs(Math.cos(this._rotationRad));const h=e*s+i*r;const n=e*r+i*s;this._maxPadding=Math.ceil(Math.max(h,n))}getMaximumPadding(t){const o=this.getOffsetXInPixels(t);const i=this.getOffsetYInPixels(t);if(this._isWorldSized){const e=t.toPixels(this._worldWidth,this._uom);const s=t.toPixels(this._worldHeight,this._uom);const r=e/this._widthPX;const h=s/this._heightPX;return Math.ceil(Math.max(this._maxPadding*r+Math.abs(o),this._maxPadding*h+Math.abs(i)))}return this._maxPadding+Math.max(Math.abs(o),Math.abs(i))}interacts(t,o,i){if(!this._image||!this._coordinate)return false;o._forwardBoundsCoords(t,tempBounds1);rotatedBox1.configure(tempBounds1.x,tempBounds1.y,tempBounds1.width,tempBounds1.height,0);const{sx:e,sy:s,ox:r,oy:h}=this.computePixelOffsetProps(i);o._forward(this._coordinate,tempCoord);tempBounds2.setTo2D(tempCoord.x+e*-this._anchorXPX+r,e*this._widthPX,tempCoord.y+s*-this._anchorYPX+h,s*this._heightPX);rotatedBox2.configure(tempBounds2.x,tempBounds2.y,tempBounds2.width,tempBounds2.height,this._rotationRad+this.getMapHeadingAngle(o),e*this._anchorXPX,s*this._anchorYPX);return rotatedBox1.intersects(rotatedBox2)}strokeInteracts(t,o,i){return false}mapAnchorPointSFCT(t,o){if(!this._coordinate)return false;o.move3DToPoint(this._coordinate);return true}mapAnchorPointsSFCT(t,o){if(!this._coordinate)return;this.mapAnchorPointSFCT(t,tempPoint);o.add3D(tempPoint.x,tempPoint.y,tempPoint.z,tempPoint.x,tempPoint.y,tempPoint.z)}getMapHeadingAngle(t){if(isNaN(this._heading)||null===this._coordinate)return 0;try{const o=undefined;return getAzimuthAtOrientedPoint(this._coordinate,this._heading,t,t.inputReference)*Constants.DEG2RAD}catch(t){OutOfBoundsError.isOrThrow(t);return 0}}draw(t,o,i){if(!this._image||!this._coordinate)return;if(isBorderTransformation(o))if(!o.canDraw(this._coordinate))return;o._forward(this._coordinate,coord);if(this._stemStrokeStyle){o._inverse(coord,toCoord);if(isBorderTransformation(o)&&o.canDrawStem(this._coordinate,toCoord)){dropPath[0]=toCoord.x;dropPath[1]=toCoord.y;dropPath[2]=0;dropPath[3]=this._coordinate.x;dropPath[4]=this._coordinate.y;dropPath[5]=0;this._stemStrokeStyle.paintPathMapCoords(t,dropPath,o,false)}}let e,s;t.save();if(this._opacity<1)t.globalAlpha=this._opacity;const{sx:r,sy:h,ox:n,oy:a}=this.computePixelOffsetProps(i);if(0!==this._rotationRad||!isNaN(this._heading)){const i=this._rotationRad+this.getMapHeadingAngle(o);t.translate(coord.x+n,coord.y+a);t.rotate(i);t.translate(r*-this._anchorXPX,h*-this._anchorYPX);e=0;s=0}else{e=Math.round(coord.x+r*-this._anchorXPX+n);s=Math.round(coord.y+h*-this._anchorYPX+a)}t.drawImage(this._image,e,s,r*this._widthPX,h*this._heightPX);t.restore()}getMapDistanceSquared(t,o,i,e){t.mapToViewTransformationInternal._forward(this._coordinate,tempCoord);let s=1;let r=1;if(this._isWorldSized){const o=t.worldSizeSupport.toPixels(this._worldWidth,this._uom);const i=t.worldSizeSupport.toPixels(this._worldHeight,this._uom);s=o/this._widthPX;r=i/this._heightPX}const h=this.getOffsetXInPixels(t.worldSizeSupport);const n=this.getOffsetYInPixels(t.worldSizeSupport);tempBounds2.setTo2D(tempCoord.x+s*-this._anchorXPX+h,s*this._widthPX,tempCoord.y+r*-this._anchorYPX+n,r*this._heightPX);rotatedBox2.configure(tempBounds2.x,tempBounds2.y,tempBounds2.width,tempBounds2.height,this._rotationRad,s*this._anchorXPX,r*this._anchorYPX);tempBounds2.setTo2D(rotatedBox2.getLeft(),rotatedBox2.getOBBWidth(),rotatedBox2.getTop(),rotatedBox2.getOBBHeight());t.mapToViewTransformationInternal._inverseBoundsCoords(tempBounds2,tempBounds1);e.setDistanceToBounds(tempBounds1,o,i);e.setDistanceToEdge(squaredDistance2D(this._coordinate.x,this._coordinate.y,o,i))}get width(){return this._width}get height(){return this._height}get image(){return this._image}computePixelOffsetProps(t){let o=1;let i=1;if(this._isWorldSized){const e=t.toPixels(this._worldWidth,this._uom);const s=t.toPixels(this._worldHeight,this._uom);o=e/this._widthPX;i=s/this._heightPX}const e=undefined;const s=undefined;return{sx:o,sy:i,ox:this.getOffsetXInPixels(t),oy:this.getOffsetYInPixels(t)}}getOffsetXInPixels(t){return this._isWorldOffsetX?t.toPixels(this._worldOffsetX,this._offsetXUom):this._ox}getOffsetYInPixels(t){return this._isWorldOffsetY?t.toPixels(this._worldOffsetY,this._offsetYUom):this._oy}}const recoloredImageCache=new Map;function getRecoloredImage(t,o){const i=getImageHash(t,t.width,t.height,o);const e=recoloredImageCache.get(i);if(e)return e;const s=imageColorMultiply(t,o);if(s)recoloredImageCache.set(i,s);return s||null}