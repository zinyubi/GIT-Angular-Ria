import{Axis}from"../../reference/Axis.js";import{CM_UOM,isLengthKind,isWorldSize,METER_UOM}from"../../uom/UnitOfMeasureUtil.js";export class WorldSizeSupport{_incompatibleErrorLogged=false;constructor(t){this._uomIsUniform=t.reference.hasUniformAxes2D();this._uom=t.reference.getAxis(Axis.Name.X).unitOfMeasure;this._map=t}get map(){return this._map}toPixels(t,e){if(!e||!isWorldSize(e))return t;const i=undefined;return this.validateWorldSizeUom(e)?this.toPixelsImpl(t,e):2}toPixelsImpl(t,e){const i=this.toMapUnitsImpl(t,e);const s=this._map.xScale*i;const o=undefined;let r=this._uom.convertToUnit(s,CM_UOM)*this._map.dotsPerCentimeter;if(r>0&&r<1)r=1;else if(r<0&&r>-1)r=-1;return r}getLineStyleRescaledSizes(t){const e=t.uom;const i=this.validateWorldSizeUom(e);let s=0;const o=0===t.dash.length?t.dash:t.dash.map((t=>{const i=this.toPixelsImpl(t,e);s+=i;return i}),this);return{forMapScale:this.getCurrentScale(),width:i?this.toPixelsImpl(t.width,e):2,dash:o,dashOffset:i?this.toPixelsImpl(t.dashOffset,e):0,patternLength:s}}getLineMarkerStyleRescaledSizes(t,e,i){const s=this.validateWorldSizeUom(t);return{forMapScale:this.getCurrentScale(),arrowLineWidth:s?this.toPixelsImpl(e,t):2,arrowSize:s?this.toPixelsImpl(i,t):5}}getPhotonLineStyleWorldSizes(t){const e=t.uom;const i=this.validateWorldSizeUom(e);const s=0===t.dash.length?t.dash:t.dash.map((t=>i?this.toMapUnitsImpl(t,e):1),this);return{width:i?this.toMapUnitsImpl(t.width,e):1,dash:s,dashOffset:i?this.toMapUnitsImpl(t.dashOffset,e):0}}toMapUnits(t,e,i=false){let s=t;let o=e;if(!isWorldSize(e))if(!i)return t;else{const e=t/this._map.dotsPerCentimeter;s=CM_UOM.convertToUnit(e,this._uom)/this._map.xScale;o=this._uom}const r=undefined;return this.validateWorldSizeUom(o)?this.toMapUnitsImpl(s,o):1}getCurrentScale(){return this._map.xScale}validateWorldSizeUom(t){let e=null;if(!this._uomIsUniform)e="World-size unit (style.uom) are not supported for a map with non-uniform X/Y axes";if(!t._isCompatible(this._uom))e="World-size unit (style.uom) is not compatible with Map units";if(!isLengthKind(t))e="World-size unit (style.uom) must be of Length QuantityKind only";if(e&&!this._incompatibleErrorLogged){console.error(e);this._incompatibleErrorLogged=true}return!e}toMapUnitsImpl(t,e){return e===this._uom?t:e.convertToUnit(t,this._uom)}}export function createUOMSupport(t){return new WorldSizeSupport(t)}export function getWorldUOMToMeterScale(t){return t.convertToUnit(1,METER_UOM)}export function getWorldUOMInMeters(t,e){return t.convertToUnit(e,METER_UOM)}