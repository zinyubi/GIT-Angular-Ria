import{ProgrammingError}from"../../error/ProgrammingError.js";import{TransformationType}from"../../transformation/TransformationType.js";import{WorldViewTransformation2D}from"../../transformation/WorldViewTransformation2D.js";import{XYZPoint}from"../../shape/XYZPoint.js";import{Constants}from"../../util/Constants.js";import{whenInternal}from"../../util/PromiseUtil.js";const ROUND_TO_PIXEL=t=>t+.5|0;const IDENTITY=t=>t;function makeErrorMessageCanvas(t,e,i){const n=document.createElement("canvas").getContext("2d",{willReadFrequently:true});n.canvas.width=t;n.canvas.height=e;n.fillStyle="rgb(255,0,0)";n.font="bold 16px Arial";n.fillText(i,10,e/2);return n.canvas}export class RasterImageRenderer{constructor(t,e){this._cachedWorldBounds=null;this._cachedImage=null;this._waitingForResponse=false;this._pixelSize=Constants.INCH_TO_MM/96;this._rotationLessWvt=new WorldViewTransformation2D(e.reference,e.camera);this._tempViewPoint=new XYZPoint;this._unrotatedViewPoint=new XYZPoint;const i=t.modelToWorldTransformation;const n=i._getType();if(n!==TransformationType.TYPE_SCALE&&n!==TransformationType.TYPE_IDENTITY)throw new ProgrammingError("RasterImageLayer: cannot add a RasterImageLayer when the model reference is not identical to the Map reference. ");this._modelBoundsInWorldReference=i.transformBounds(t.model.bounds);this._intersectionInWorld=null;this._intersectionInModel=null;this._intersectionInUnrotatedView=null;this._ready=false;this._refreshFunction=this.refreshImage.bind(this);this._idleHandle=e.on("idle",this._refreshFunction);this._visibleHandle=t.on("VisibilityChanged",this._refreshFunction);this._layer=t;this._refreshFunction()}refreshImage(){if(!this._layer.visible||this._waitingForResponse||!this.updateIntersectionBounds())return;const t=this._intersectionInUnrotatedView.width;const e=this._intersectionInUnrotatedView.height;const i=this._intersectionInWorld.copy();const n=(t,e)=>{this._waitingForResponse=false;const n=this._modelBoundsInWorldReference.intersection(this._layer.map.mapBounds);if(n&&n.equals(i)){this._cachedImage=t(e);this._cachedImage="undefined"===typeof this._cachedImage?null:this._cachedImage;this._cachedWorldBounds=i;this._layer.map.invalidate()}else setTimeout(this._refreshFunction,66)};const r=i=>{let n="Cannot retrieve image";if(i.path&&i.path[0])n+=` for ${i.path[0].src}`;else if(i.srcElement)n+=` for ${i.srcElement.src}`;return makeErrorMessageCanvas(t,e,n)};this._waitingForResponse=true;this._ready=false;const s=this._layer.model.getImage(this._intersectionInModel,t,e,this._pixelSize);whenInternal(s,n.bind(null,IDENTITY),n.bind(null,r))}calculateImageLocation(t,e){if(!this.updateIntersectionBounds())return null;this._tempViewPoint.move2D(t,e);const i=this._layer.map.viewToMapTransformation.transform(this._tempViewPoint);this._unrotatedViewPoint=this._rotationLessWvt.transform(i);if(this._unrotatedViewPoint.x<this._intersectionInUnrotatedView.x||this._unrotatedViewPoint.y<this._intersectionInUnrotatedView.y||this._unrotatedViewPoint.x>this._intersectionInUnrotatedView.x+this._intersectionInUnrotatedView.width||this._unrotatedViewPoint.y>this._intersectionInUnrotatedView.y+this._intersectionInUnrotatedView.height)return null;return{bounds:this._intersectionInModel,size:[this._intersectionInUnrotatedView.width,this._intersectionInUnrotatedView.height],i:this._unrotatedViewPoint.x-this._intersectionInUnrotatedView.x,j:this._unrotatedViewPoint.y-this._intersectionInUnrotatedView.y,pixelSize:this._pixelSize}}updateIntersectionBounds(){const t=this._layer.map.mapBounds;this._intersectionInWorld=this._modelBoundsInWorldReference.intersection(t);if(null===this._intersectionInWorld){this._intersectionInModel=null;this._intersectionInUnrotatedView=null;return false}const e=this._layer.map.mapToViewTransformation;this._rotationLessWvt.setTo(e.getWorldOrigin(),e.getViewOrigin(),e.getScaleX(),e.getScaleY(),0);this._intersectionInUnrotatedView=this._rotationLessWvt.transformBounds(this._intersectionInWorld);const i=this._layer.modelToWorldTransformation.inverseTransformation;this._intersectionInModel=i.transformBounds(this._intersectionInWorld);return true}renderImpl(t,e,i){if(null===this._cachedImage)return;const n=e.transformBounds(this._cachedWorldBounds);t.drawImage(this._cachedImage,i(n.x),i(n.y),i(n.width),i(n.height))}isReady(){return!this._waitingForResponse}render(t,e,i){let n=this._layer.map.mapToViewTransformation;const r=n.getRotation();let s=ROUND_TO_PIXEL;if(0!==r){this._rotationLessWvt.setTo(n.getWorldOrigin(),n.getViewOrigin(),n.getScaleX(),n.getScaleY(),0);n=this._rotationLessWvt;const e=n.getViewOrigin();t.save();t.translate(e.x,e.y);t.rotate(-r*Math.PI/180);t.translate(-e.x,-e.y);s=IDENTITY}if(this._layer._getAlpha()<1){t.save();t.globalAlpha=this._layer._getAlpha();this.renderImpl(t,n,s);t.restore()}else this.renderImpl(t,n,s);if(0!==r)t.restore()}release(){this._idleHandle.remove();this._visibleHandle.remove()}}