import{resolveHrefToResource}from"../../util/kml/KMLInternalUtil.js";import{isString,isUndefined}from"../../util/Lang.js";import{FeatureLayer}from"../feature/FeatureLayer.js";import{KMLPainter}from"./KMLPainter.js";import{Feature}from"../../model/feature/Feature.js";import{KMLIsHoverableEvent}from"../../model/kml/KMLEvented.js";import{KMLModel}from"../../model/kml/KMLModel.js";import{DrapeTarget}from"../style/DrapeTarget.js";const IMG_REGEX=/<img[^>]*>/gi;const SRC_REGEX=/src=["'](.*?)["']/gi;export class KMLLayer extends FeatureLayer{_handleHoverable=null;constructor(e,r={}){super(e,{...r,painter:r.painter??new KMLPainter});if(isUndefined(r.hoverable)&&e instanceof KMLModel)this._handleHoverable=e.on(KMLIsHoverableEvent,(e=>{super.hoverable=e}));this._drapeTarget=r.drapeTarget??DrapeTarget.TERRAIN;const{target:t}=this.model.store;this.balloonContentProvider=r=>{if(!(r instanceof Feature))return"";const o=e instanceof KMLModel?e.kmzResources:void 0;const a=e=>e.replace(SRC_REGEX,((e,r)=>{const a=resolveHrefToResource(t,r,o);const s=undefined;return`src="${a?.url||r}"`}));const s=r.properties.description;return isString(s)?s.replace(IMG_REGEX,a):""}}get model(){return super.model}get drapeTarget(){return this._drapeTarget}set drapeTarget(e){if(e!==this._drapeTarget){this._drapeTarget=e;this.painter.invalidateAll()}}get hoverable(){return super.hoverable}set hoverable(e){this._handleHoverable?.remove();super.hoverable=e}}