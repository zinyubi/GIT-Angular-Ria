import{MemoryStore}from"../../model/store/MemoryStore.js";import{createOptimizedEventedSupport}from"../../util/EventedSupport.js";import{NULL_FEATURE}from"./loadingstrategy/ScaleLevelCursor.js";import{ReferenceType}from"../../reference/ReferenceType.js";export class FeatureModelQueryCache{_modelBounds=null;_modelChanged=false;_delayedModelChanges=[];_isQueryProcessing=false;constructor(e){this._layer=e;const s=e.model;this._eventedSupport=createOptimizedEventedSupport(["ModelChanged"]);this._sourceModel=s;this._queryCache=new MemoryStore({reference:s.reference});this._modelChangedHandle=s.on("ModelChanged",((e,s,r)=>{if(this._isQueryProcessing)this._delayedModelChanges.push([e,s,r]);else this.processModelChanges(e,s,r)}))}get sourceModel(){return this._sourceModel}get reference(){return this._sourceModel.reference}get modelBounds(){return this._modelBounds}isModelChanged(){return this._modelChanged}release(){this._modelChangedHandle?.remove();this._modelChangedHandle=null;this.clearCachedModelData()}prepareForQuery(){this._delayedModelChanges.length=0;this._modelBounds=null;this.clearCachedModelData();this._isQueryProcessing=true}cache(e,s){return{hasNext:()=>{if(s.aborted){this.clearCachedModelData();return false}return e.hasNext()},next:()=>{const s=e.next();if(s===NULL_FEATURE)return s;try{this._queryCache.put(s);this.updateBounds(s);return s}catch(e){this.clearCachedModelData();throw e}}}}updateBounds(e){const s=e.shape?.bounds;if(s&&this._sourceModel.reference.referenceType!==ReferenceType.GEOCENTRIC)if(null===this._modelBounds)this._modelBounds=s.copy();else this._modelBounds.setTo2DUnion(s)}query(){return this._queryCache.query()}getNumberOfFeaturesInCache(){return this._queryCache.size}processDelayedModelChangesOnQueryFinish(){this._delayedModelChanges.forEach((([e,s,r])=>{this.processModelChanges(e,s,r)}));this._isQueryProcessing=false;this._delayedModelChanges=[]}clearCachedModelData(){this.processDelayedModelChangesOnQueryFinish();this._queryCache.clear();this._modelChanged=false;this._isQueryProcessing=false;this._modelBounds=null}processModelChanges(e,s,r){if("remove"===e)this._queryCache.remove(r);else if("update"===e||"add"===e)this._queryCache.put(s);this._modelChanged=true;this._eventedSupport.emitModelChangedEvent(e,s,r)}on(e,s,r){return this._eventedSupport.on(e,s,r)}}