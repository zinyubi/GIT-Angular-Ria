import{ProgrammingError}from"../../../error/ProgrammingError.js";import{Hash}from"../../../util/Hash.js";import{Log}from"../../../util/Log.js";import{createCanvasFromConvertedTextStyle,isConvertedFromTextStyle}from"./TextToIconSupport.js";import{PhotonWeakMap}from"./PhotonWeakMap.js";import{createDefaultPointStyle,createDensityPointStyle}from"../DefaultStyles.js";import{isPromise,whenInternal}from"../../../util/PromiseUtil.js";import{appendImageHashCode}from"../../style/complexstroke/pattern/util/HashUtil.js";export class PhotonImageProvider{_imageCache=new PhotonWeakMap;_promiseCache=new Map;_hash=new Hash;constructor(e,t){this._imageDecoder=e;this._getFallbackIconUrl=t}release(){this._imageCache.release();this._imageCache=null}_isReleased(){return null===this._imageCache}getPhotonImage(e,t,a,r,o,i,s,n,l,m,h=1){if(!t)throw new ProgrammingError("Can only get images with alpha pre-multiplied");const c=this;this._hash.reset();const g=this.imageHashCode(e,s??0,n??0,a??false,this._hash).getHashCode();if(!e)e=a?createDensityPointStyle().image:createDefaultPointStyle().image;const d=this._imageCache.get(g);if(d)return d;const p=this._promiseCache.get(g);if(p)return p.then((l=>{if(c._isReleased())return new Promise(((e,t)=>{}));return c.getPhotonImage(e,t,a,r,o,i,s,n,h)}));let f;if(isConvertedFromTextStyle(e))f=this._imageDecoder.decodeCanvas(createCanvasFromConvertedTextStyle(e,h),true,0,0,l,m);else if(e instanceof HTMLCanvasElement)f=this._imageDecoder.decodeCanvas(e,true,s,n,l,m);else if(e instanceof HTMLImageElement)f=this._imageDecoder.decodeImage(e,true,s,n,l,m);else f=this._imageDecoder.decodeUrl(e,true,r,o,void 0,s,n,l,m);function u(e){c._promiseCache.delete(g);if(c._isReleased()){e.release();return new Promise(((e,t)=>{}))}else{c._imageCache.set(g,e);return e}}const C=a=>{this._promiseCache.delete(g);if(i){Log.warn("Could not load image"+(a&&a.message?": "+a.message:"."));throw new ProgrammingError("Image request failed: "+a)}if(e!==this._getFallbackIconUrl()){if(this._isReleased())throw a;return whenInternal(this.getPhotonImage(this._getFallbackIconUrl(),t,false,false,false,i),u)}else{Log.warn("Could not load fallback icon "+this._getFallbackIconUrl()+": "+a);return this._imageDecoder.decodeCanvas(createDefaultPointStyle().image,true)}};if(isPromise(f)){f=f.then(u).catch(C);this._promiseCache.set(g,f)}else this._imageCache.set(g,f);return f}imageHashCode(e,t,a,r,o){appendImageHashCode(e,o);o.append(t);o.append(a);o.appendBoolean(r);return o}clean(){this._imageCache.purge()}}