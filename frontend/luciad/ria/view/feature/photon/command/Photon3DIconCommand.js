import{ProgrammingError}from"../../../../error/ProgrammingError.js";import{createPhotonColorFromString}from"../../../../util/Color.js";import{XYZPoint}from"../../../../shape/XYZPoint.js";import{Hash}from"../../../../util/Hash.js";import{ObjectReleaseTracker}from"../../../../util/ObjectReleaseTracker.js";import{GeoDiscretizerStatic}from"../../../shape/discretization/GeoDiscretizerStatic.js";import{isPromise,whenInternal}from"../../../../util/PromiseUtil.js";import{toPhotonPBRSettings}from"../../../style/util/PBRUtil.js";import{PBRSettingsImpl}from"../../../style/PBRSettings.js";import{BloomStyleImpl,DEFAULT_BLOOM}from"../../../style/BloomStyle.js";import{isDefined,isNumber,isObject}from"../../../../util/Lang.js";import{DrapeTarget}from"../../../style/DrapeTarget.js";import{getZStyleForPoint}from"./ZStyleUtil.js";import{ReferenceType}from"../../../../reference/ReferenceType.js";import{FacetCullingType}from"../../../style/FacetCullingType.js";function Photon3DIconCommand(e,t,o,r){this._is3d=e;this._worldReference=t;this._shapePainter=o;this._hash=new Hash;this._meshProvider=r;this._coordinatesPool=[new XYZPoint(null)]}Photon3DIconCommand.prototype=Object.create(ObjectReleaseTracker.prototype);Photon3DIconCommand.prototype.constructor=Photon3DIconCommand;Photon3DIconCommand.prototype.canHandle=function(e){return"icon3d"===e.type};Photon3DIconCommand.prototype.add=function(e){var t=e.shape.focusPoint;var o=e.style;var r=e.zStyle;var n=GeoDiscretizerStatic.discretizePoint(t,{modelReference:t.reference,worldReference:this._worldReference,coordinatesPool:this._coordinatesPool,zToZero:false});if(null===n)return;this._shapePainter.addMeshLocation(e.objectId,e.geometryId,e.styleId,o.meshIcon,n,o.pitch,o.heading,o.roll,createPhotonColorFromString(o.color),o.scale,o.rotation,o.translation,o.pbrSettings,o.zOrder,e.renderPassId,e.selected,r.drapeTarget,r.aboveGround,o.transparency,o.bloom,o.legacyAxis,o.facetCulling)};Photon3DIconCommand.prototype.updateStyle=function(e,t){var o=e.style;var r=e.zStyle;this._shapePainter.updateMeshStyle(e.objectId,e.geometryId,t,e.styleId,o.meshIcon,createPhotonColorFromString(o.color),o.scale,o.rotation,o.translation,o.pbrSettings,o.zOrder,e.renderPassId,e.selected,r.drapeTarget,r.aboveGround,o.transparency,o.bloom,o.legacyAxis,o.facetCulling)};Photon3DIconCommand.prototype.updateGeometry=function(e,t){var o=e.shape.focusPoint;var r=e.style;var n=GeoDiscretizerStatic.discretizePoint(o,{modelReference:o.reference,worldReference:this._worldReference,coordinatesPool:this._coordinatesPool,zToZero:false});if(null===n){this._shapePainter.removeGeometry(e.objectId,t,e.styleId);return}this._shapePainter.updateMeshGeometry(e.objectId,t,e.geometryId,n,r.orientation?.pitch||0,r.orientation?.heading||0,r.orientation?.roll||0);return true};Photon3DIconCommand.prototype.resolveStyle=function(e){e.style=this._resolveAndNormalizeStyle(e.style)};function Normalized3DIconStyle(e,t,o,r,n,a,i,s,l,h,c,p,d,m,y,u,g,f,P,_,D){this.meshIcon=e;this.meshHashCode=t;this.meshTexture=null;this.pitch=o;this.heading=r;this.roll=n;this.color=a;this.scale=new XYZPoint(null,[i,s,l]);this.rotation=new XYZPoint(null,[h,c,p]);this.translation=new XYZPoint(null,[d,m,y]);this.pbrSettings=u;this.zOrder=g;this.drapeTarget=DrapeTarget.NOT_DRAPED;this.transparency=f;this.bloom=P;this.legacyAxis=_;this.facetCulling=D}Normalized3DIconStyle.prototype=Object.create(Object.prototype);Normalized3DIconStyle.prototype.constructor=Normalized3DIconStyle;Normalized3DIconStyle.prototype.release=function(){if(this.meshIcon)this.meshIcon.release();if(this.meshTexture)this.meshTexture.release()};Photon3DIconCommand.prototype._resolveAndNormalizeStyle=function(e){var t=this._normalizeStyle(e);var o=t.meshUrl?t.meshUrl:t.mesh;if(!o)throw new ProgrammingError("An Icon3DStyle was given to the geocanvas without a mesh or meshUrl parameter. At least "+"one of the two should be non-null");var r=this._meshProvider.getPhotonMesh(o,t);this._hash.reset();this._meshProvider.meshHashCode(o,this._hash);var n=this._hash.getHashCode();if(isPromise(r))return whenInternal(r).then((function(e){var o;return new Normalized3DIconStyle(e,n,t.pitch,t.heading,t.roll,t.color,t.scaleX,t.scaleY,t.scaleZ,t.rotationX,t.rotationY,t.rotationZ,t.translationX,t.translationY,t.translationZ,t.pbrSettings,t.zOrder,t.transparency,t.bloom,t.legacyAxis,t.facetCulling)}),(function(e){throw e}));else{var a;return new Normalized3DIconStyle(r,n,t.pitch,t.heading,t.roll,t.color,t.scaleX,t.scaleY,t.scaleZ,t.rotationX,t.rotationY,t.rotationZ,t.translationX,t.translationY,t.translationZ,t.pbrSettings,t.zOrder,t.transparency,t.bloom,t.legacyAxis,t.facetCulling)}};Photon3DIconCommand.prototype._normalizeStyle=function(e){var t=e.scale&&e.scale.x?e.scale.x:1||1;var o=e.scale&&e.scale.y?e.scale.y:1||1;var r=e.scale&&e.scale.z?e.scale.z:1||1;if(t<=0)t=1;if(o<=0)o=1;if(r<=0)r=1;return{mesh:e.mesh,meshUrl:e.meshUrl,pitch:e.orientation&&e.orientation.pitch?e.orientation.pitch:0,heading:e.orientation&&e.orientation.heading?e.orientation.heading:0,roll:e.orientation&&e.orientation.roll?e.orientation.roll:0,color:e.color||"rgba(255, 255, 255, 1)",scaleX:t,scaleY:o,scaleZ:r,rotationX:e.rotation&&e.rotation.x?e.rotation.x:0||0,rotationY:e.rotation&&e.rotation.y?e.rotation.y:0||0,rotationZ:e.rotation&&e.rotation.z?e.rotation.z:0||0,translationX:e.translation&&e.translation.x?e.translation.x:0||0,translationY:e.translation&&e.translation.y?e.translation.y:0||0,translationZ:e.translation&&e.translation.z?e.translation.z:0||0,pbrSettings:toPhotonPBRSettings(e.pbrSettings?new PBRSettingsImpl(e.pbrSettings):null),zOrder:e.zOrder||0,transparency:e.transparency,bloom:e.bloom&&isObject(e.bloom)?new BloomStyleImpl(e.bloom):DEFAULT_BLOOM,legacyAxis:e.legacyAxis??false,facetCulling:e.facetCulling??FacetCullingType.NO_CULLING,requestHeaders:e.requestHeaders??null,credentials:e.credentials??false,requestParameters:e.requestParameters??null}};Photon3DIconCommand.prototype.getDrawItems=function(e){var t=[];for(var o=0;o<e.length;o++){var r=e[o].shape;var n=e[o].style;var a=e[o].renderPassId;var i=e[o].selected;let h=DrapeTarget.NOT_DRAPED;if(isDefined(n.drapeTarget))h=n.drapeTarget;else if(isDefined(n.draped))h=n.draped?DrapeTarget.TERRAIN:DrapeTarget.NOT_DRAPED;var s=getZStyleForPoint(r,void 0,h,this._is3d);var l={shape:r,style:n,geometryId:this._getGeometryId(r.focusPoint,n),styleId:this._getStyleId(n,s,i,a,r),zStyle:s};t.push(l)}return t};Photon3DIconCommand.prototype._getGeometryId=function(e,t){this._hash.reset();e.hashCode(this._hash);if(e.reference)e.reference.hashCode(this._hash);this._hash.appendDouble(t.orientation?.pitch);this._hash.appendDouble(t.orientation?.heading);this._hash.appendDouble(t.orientation?.roll);return this._hash.getHashCode()};Photon3DIconCommand.prototype._getStyleId=function(e,t,o,r,n){this._hash.reset();this._hash.appendUInt32(t.drapeTarget);this._hash.appendBoolean(t.aboveGround);this._hash.appendBoolean(e.transparency);this._hash.appendUInt32(r);this._hash.appendBoolean(o);this._hash.appendUInt32(e.zOrder);this._hash.appendString(e.color);if(e.bloom)this._hash.appendDouble(isNumber(e.bloom.intensity,false)?e.bloom.intensity:new BloomStyleImpl({}).intensity);this._hash.appendDouble(e.rotation?.x);this._hash.appendDouble(e.rotation?.y);this._hash.appendDouble(e.rotation?.z);this._hash.appendDouble(e.scale?.x);this._hash.appendDouble(e.scale?.y);this._hash.appendDouble(e.scale?.z);this._hash.appendDouble(e.translation?.x);this._hash.appendDouble(e.translation?.y);this._hash.appendDouble(e.translation?.z);const a=toPhotonPBRSettings(e.pbrSettings?new PBRSettingsImpl(e.pbrSettings):null);this._hash.appendDouble(a.directionalLighting);this._hash.appendDouble(a.lightIntensity);this._hash.appendDouble(a.ibl);this._hash.appendDouble(a.metallicFactor);this._hash.appendDouble(a.roughnessFactor);this._hash.appendUInt32(e.facetCulling);this._hash.appendString(e.meshUrl||e.mesh?.id||"");return this._hash.getHashCode()};Photon3DIconCommand.prototype.usesPhotonShapePainter=function(){return true};export{Photon3DIconCommand};