import{createBounds}from"../../../shape/ShapeFactory.js";import{createTransformation}from"../../../transformation/TransformationFactory.js";function canProceed(e,t){return e&&e.length>0&&t}export class PhotonSpatialQueryProcess{constructor(e,t,s,i,r){this._layer=e;this._layerVisible=t;this._map=s;this._workingSet=i;this._painterProcess=r;this._spatialUpdateScheduled=false;this._mapBounds=createBounds(e.model.reference);this._map2Model=createTransformation(this._map.reference,this._mapBounds.reference);this._workingSet.forEachVisibleFeature((e=>{this._processWorkingSetChangedEvent("add",e,e.id)}));this._workingSetListener=this._workingSet.on("WorkingSetChanged",this._processWorkingSetChangedEvent)}isReady(){return!this._spatialUpdateScheduled}release(){if(this._workingSetListener){this._workingSetListener.remove();this._workingSetListener=null}this._painterProcess.clear()}onMapIdle(){this._scheduleSpatialUpdate()}onLayerVisibilityChanged(e){this._layerVisible=e;this._scheduleSpatialUpdate()}_processWorkingSetChangedEvent=(e,t,s)=>{const i=this._map.getMapBounds({reference:this._mapBounds.reference});if(!canProceed(i,this._layerVisible))return;if("update"===e||"add"===e){const s=this._layer.fetchProvidedShape(t);const r=i.some((e=>s&&s.bounds?e.interacts2D(s.bounds):false));if(s&&r)this._painterProcess[e](t);else this._painterProcess.remove(t)}else if("remove"===e)this._painterProcess.remove(t);else if("clear"===e)this._painterProcess.clear()};_scheduleSpatialUpdate(){if(!this._spatialUpdateScheduled){this._spatialUpdateScheduled=true;setTimeout(this._spatialUpdate.bind(this),1)}}_spatialUpdate(){const e=this._map.getMapBounds({reference:this._mapBounds.reference});if(!canProceed(e,this._layerVisible)){this._spatialUpdateScheduled=false;return}const t=[];for(const s of e)this._workingSet.search(s,(e=>{t.push(e.feature)}));this._painterProcess.reset(t);this._spatialUpdateScheduled=false}}