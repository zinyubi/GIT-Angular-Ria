import{createOptimizedEventedSupport}from"../../../util/EventedSupport.js";import{ProgrammingError}from"../../../error/ProgrammingError.js";function createTransformationParams(e,r){const t=e.map;if(!t)throw new ProgrammingError("ModelTransformer: layer is not attached to map");let o=null;try{o=t.getMapBounds({reference:r.reference})[0];o?.enlarge2D(4)}catch(e){}return{mapReference:t.reference,modelReference:r.reference,mapToViewTransformation:t.mapToViewTransformationInternal,mapScale:t.mapScale,mapViewSize:t.viewSize,modelBounds:r.modelBounds,sceneBounds:o,layer:e}}export class ModelTransformer{constructor(e=true){this._withTransformParameters=e;this._modelListener=null;this._dirty=true;this._eventedSupport=createOptimizedEventedSupport(["ModelChanged"])}release(){this._modelListener?.remove();this._modelListener=null}runQuery(e,r,t){this.release();this._modelListener=e.on("ModelChanged",((r,t,o)=>{this.handleSourceModelChange(e,r,t,o)}),this);this._dirty=false;const o=this._withTransformParameters?createTransformationParams(t,e):void 0;return this.doTransformation(r,o)}shouldTransform(e){return this._dirty||this.needsTransformation(e)}invalidate(){this._dirty=true;this.resetCaches()}on(e,r,t){return this._eventedSupport.on(e,r,t)}}