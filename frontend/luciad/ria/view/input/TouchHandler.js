import{On}from"../../util/On.js";import{Handler}from"./Handler.js";import{GestureEventType}from"./GestureEventType.js";import{MultitouchGestureDetector}from"./MultitouchGestureDetector.js";import{PinchEventImpl}from"./PinchEvent.js";import{DragEventImpl}from"./DragEvent.js";import{GestureEventImpl}from"./GestureEvent.js";import{RotateEventImpl}from"./RotateEvent.js";import{TwoFingerDragEventImpl}from"./TwoFingerDragEvent.js";const LONGPRESS_TIMEOUT=500;const TAP_TIMEOUT=180;const DOUBLE_TAP_TIMEOUT=300;const SHOW_PRESS="SHOW_PRESS";const LONG_PRESS="LONG_PRESS";const TAP="TAP";const TWO_FINGER_TWIST_MIN_ANGLE=12;const PINCH_GESTURE_SPAN_RATIO_DIFFERENCE=.12;const TWO_FINGER_DRAG_MIN_PIXEL_DISTANCE=75;const EVENT_LISTENER_OPTS={capture:false,passive:false};export class TouchHandler{_currentContextMenuEvent=null;_currentDownX=0;_currentDownY=0;_dragging=false;_currentMultiTouchGesture=null;_multiTouchDownEventInfo=null;constructor(t,e,n){this._map=t;this._node=e;this._downEvent=new GestureEventImpl(t,GestureEventType.DOWN,"touch");this._upEvent=new GestureEventImpl(t,GestureEventType.UP,"touch");this._dragEvent=new DragEventImpl(t,GestureEventType.DRAG,"touch");this._currentDragEvent=new DragEventImpl(t,GestureEventType.DRAG,"touch");this._dragEndEvent=new DragEventImpl(t,GestureEventType.DRAG_END,"touch");this._singleClickUpEvent=new GestureEventImpl(t,GestureEventType.SINGLE_CLICK_UP,"touch");this._singleClickConfirmedEvent=new GestureEventImpl(t,GestureEventType.SINGLE_CLICK_CONFIRMED,"touch");this._doubleClickEvent=new GestureEventImpl(t,GestureEventType.DOUBLE_CLICK,"touch");this._doubleClickEventEvent=new GestureEventImpl(t,GestureEventType.DOUBLE_CLICK_EVENT,"touch");this._longPressEvent=new GestureEventImpl(t,GestureEventType.LONG_PRESS,"touch");this._showPressEvent=new GestureEventImpl(t,GestureEventType.SHOW_PRESS,"touch");this._contextMenuEvent=new GestureEventImpl(t,GestureEventType.CONTEXT_MENU,"touch");this._pinchEvent=new PinchEventImpl(t,GestureEventType.PINCH);this._pinchEndEvent=new PinchEventImpl(t,GestureEventType.PINCH_END);this._twoFingerDragEvent=new TwoFingerDragEventImpl(t,GestureEventType.TWO_FINGER_DRAG);this._twoFingerDragEndEvent=new TwoFingerDragEventImpl(t,GestureEventType.TWO_FINGER_DRAG_END);this._twoFingerTwistEvent=new RotateEventImpl(t,GestureEventType.ROTATE);this._twoFingerTwistEndEvent=new RotateEventImpl(t,GestureEventType.ROTATE_END);this._biggerTouchSlopSquare=20*20;this._touchSlopSquare=0;this._doubleTapSlopSquare=0;const s=this;this._handler=new class extends Handler{constructor(){super()}handleMessage=t=>{s._handleMessage(t)};destroy(){}};this._listener=n;this._stillDown=false;this._inLongPress=false;this._alwaysInTapRegion=false;this._alwaysInBiggerTapRegion=false;this._currentDownDOMEvent=null;this._previousUpEvent=null;this._isDoubleTapping=false;this._lastMotionY=0;this._lastMotionX=0;this._isLongpressEnabled=true;const i=8;const o=100;this._touchSlopSquare=i*i;this._doubleTapSlopSquare=o*o;this._recognizerAttempts=0;this._gestureDetector=new MultitouchGestureDetector(this);this._currentDownEvent=new GestureEventImpl(this._map,GestureEventType.DOWN,"touch");this._hasPointerEventsSupport="onpointerdown"in window&&"onpointerup"in window&&"onpointermove"in window;this._domListeners={};this._domListeners["touchstart"]=On(this._node,"touchstart",this._wrapEventHandler(this.ontouchstart,this._gestureDetector.ontouchstart),EVENT_LISTENER_OPTS);this._domListeners["touchmove"]=On(this._node,"touchmove",this._wrapEventHandler(this.ontouchmove,this._gestureDetector.ontouchmove),EVENT_LISTENER_OPTS);this._domListeners["touchend"]=On(this._node,"touchend",this._wrapEventHandler(this.ontouchend,this._gestureDetector.ontouchend),EVENT_LISTENER_OPTS);this._domListeners["touchcancel"]=On(this._node,"touchcancel",this._wrapEventHandler(this.ontouchcancel,this._gestureDetector.ontouchcancel),EVENT_LISTENER_OPTS);this._domListeners["blur"]=On(this._node,"blur",this._wrapEventHandler(this.onblur,this._gestureDetector.onblur),EVENT_LISTENER_OPTS);this._domListeners["contextmenu"]=On(this._node,"contextmenu",this._wrapEventHandler(this.oncontextmenu,this._gestureDetector.oncontextmenu),EVENT_LISTENER_OPTS);this._windowListeners=null}_wrapEventHandler(t,e){const n=this;return s=>{if(n._hasPointerEventsSupport&&s instanceof window.PointerEvent&&"touch"!==s.pointerType)return;n._map._updateViewBounds();const i=t(s);const o=e(s);if(i||o){s.preventDefault();s.stopPropagation()}}}destroy(){this.cancel();for(const t in this._domListeners)if(this._domListeners.hasOwnProperty(t))this._domListeners[t].remove();this._domListeners={}}registerWindowListeners(){if(!this._windowListeners)this._windowListeners=[On(window,"touchmove",this.ontouchmove,EVENT_LISTENER_OPTS),On(window,"touchend",this.ontouchend,EVENT_LISTENER_OPTS),On(window,"blur",this.onblur,EVENT_LISTENER_OPTS),On(window,"contextmenu",this.oncontextmenu,EVENT_LISTENER_OPTS)]}unregisterWindowListeners(){const t=this._windowListeners;if(t){for(const e of t)e.remove();this._windowListeners=null}}ontouchstart=t=>{if(0===t.targetTouches.length)return false;else if(1===t.targetTouches.length){const e=t.targetTouches[0];return this.down(t,e,e.pageX,e.pageY)}else{this.cancel();return false}};ontouchmove=t=>{if(1===t.targetTouches.length){const e=t.targetTouches[0];return this.move(t,e,e.pageX,e.pageY)}else return false};ontouchend=t=>{let e;if(0===t.targetTouches.length){e=t.changedTouches[0];return this.up(t,e,e.pageX,e.pageY)}else if(1===t.targetTouches.length){e=t.targetTouches[0];this._lastMotionX=e.pageX;this._lastMotionY=e.pageY}return false};ontouchcancel=t=>{this.cancel();return false};down(t,e,n,s){this.registerWindowListeners();const i=this._handler.hasMessages(TAP);if(i)this._handler.removeMessages(TAP);this._currentContextMenuEvent=null;if(null!=this._currentDownDOMEvent&&null!=this._previousUpEvent&&i&&this.isConsideredDoubleTap(this._currentDownDOMEvent,this._previousUpEvent,t)){this._isDoubleTapping=true;const n=this._doubleClickEvent;n.location=this._currentDownEvent.location;n.domEvent=this._currentDownEvent.domEvent;this.dispatchGestureEvent(n);const s=this._doubleClickEventEvent;s.location=e;s.domEvent=t;this.dispatchGestureEvent(s)}else this._handler.sendEmptyMessageDelayed(TAP,DOUBLE_TAP_TIMEOUT);this._lastMotionX=n;this._lastMotionY=s;this._currentDownDOMEvent=t;this._currentDownEvent.location=e;this._currentDownEvent.domEvent=t;this._currentDownX=n;this._currentDownY=s;this._alwaysInTapRegion=true;this._alwaysInBiggerTapRegion=true;this._alwaysInBiggerTapRegion=true;this._stillDown=true;this._inLongPress=false;if(this._isLongpressEnabled&&!this._isDoubleTapping){this._handler.removeMessages(LONG_PRESS);this._handler.sendEmptyMessageDelayed(LONG_PRESS,TAP_TIMEOUT+LONGPRESS_TIMEOUT)}this._handler.sendEmptyMessageDelayed(SHOW_PRESS,TAP_TIMEOUT);const o=this._downEvent;o.location=e;o.domEvent=t;this._currentDownEvent=o.copy();this.dispatchGestureEvent(o);return t.currentTarget===this._node}move(t,e,n,s){if(this._inLongPress)return true;const i=n-this._lastMotionX;const o=s-this._lastMotionY;if(this._isDoubleTapping){const n=this._doubleClickEventEvent;n.location=e;n.domEvent=t;this.dispatchGestureEvent(n)}else if(this._alwaysInTapRegion){const r=n-this._currentDownX;const h=s-this._currentDownY;const u=r*r+h*h;if(u>this._touchSlopSquare){this._dragging=true;const r=this._dragEvent;r.location=e;r.domEvent=t;r.downEvent=this._currentDownEvent;r.dragX=i;r.dragY=o;this.dispatchGestureEvent(r);this._currentDragEvent=r;this._lastMotionX=n;this._lastMotionY=s;this._alwaysInTapRegion=false;this._handler.removeMessages(TAP);this._handler.removeMessages(SHOW_PRESS);this._handler.removeMessages(LONG_PRESS)}if(u>this._biggerTouchSlopSquare)this._alwaysInBiggerTapRegion=false}else if(Math.abs(i)>=1||Math.abs(o)>=1){this._dragging=true;const r=this._dragEvent;r.location=e;r.domEvent=t;r.downEvent=this._currentDownEvent;r.dragX=i;r.dragY=o;this.dispatchGestureEvent(r);this._lastMotionX=n;this._lastMotionY=s}return t.currentTarget===this._node}up(t,e,n,s){this.unregisterWindowListeners();const i=this._upEvent;i.location=e;i.domEvent=t;this.dispatchGestureEvent(i);if(this._dragging){this._dragging=false;const n=this._dragEndEvent;n.location=e;n.domEvent=t;this.dispatchGestureEvent(n)}this._stillDown=false;if(this._isDoubleTapping){const n=this._doubleClickEventEvent;n.location=e;n.domEvent=t;this.dispatchGestureEvent(n)}else if(this._inLongPress){this._handler.removeMessages(TAP);this._inLongPress=false}else if(this._alwaysInTapRegion){const n=this._singleClickUpEvent;n.location=e;n.domEvent=t;this.dispatchGestureEvent(n)}this._previousUpEvent=t;this._isDoubleTapping=false;this._handler.removeMessages(SHOW_PRESS);this._handler.removeMessages(LONG_PRESS);return t.currentTarget===this._node}onblur=t=>{this.cancel();return false};oncontextmenu=t=>{this._currentContextMenuEvent=t;return true};_triggerContextMenu(t){this.cancel();const e=this._contextMenuEvent;e.location=t;e.domEvent=t;this.dispatchGestureEvent(e)}cancel(){this.unregisterWindowListeners();if(this._dragging){this._dragging=false;const t=this._dragEndEvent;t.domEvent=this._currentDragEvent.domEvent;t.location=this._currentDragEvent.location;t.downEvent=this._currentDragEvent.downEvent;t.dragX=this._currentDragEvent.dragX;t.dragY=this._currentDragEvent.dragY;this.dispatchGestureEvent(t)}this._handler.removeMessages(SHOW_PRESS);this._handler.removeMessages(LONG_PRESS);this._handler.removeMessages(TAP);this._isDoubleTapping=false;this._stillDown=false;this._alwaysInTapRegion=false;this._alwaysInBiggerTapRegion=false;if(this._inLongPress)this._inLongPress=false}isConsideredDoubleTap(t,e,n){if(!this._alwaysInBiggerTapRegion||n.timeStamp-e.timeStamp>DOUBLE_TAP_TIMEOUT)return false;const s=t.touches[0].pageX-n.touches[0].pageX;const i=t.touches[0].pageY-n.touches[0].pageY;return s*s+i*i<this._doubleTapSlopSquare}dispatchLongPress(){this._handler.removeMessages(TAP);this._inLongPress=true;const t=this._longPressEvent;t.location=this._currentDownEvent.location;t.domEvent=this._currentDownEvent.domEvent;this.dispatchGestureEvent(t)}_handleMessage(t){switch(t){case SHOW_PRESS:{const t=this._showPressEvent;t.location=this._currentDownEvent.location;t.domEvent=this._currentDownEvent.domEvent;this.dispatchGestureEvent(t);break}case LONG_PRESS:if(this._currentContextMenuEvent){this._triggerContextMenu(this._currentContextMenuEvent);this._currentContextMenuEvent=null}else this.dispatchLongPress();break;case TAP:if(!this._stillDown){const t=this._singleClickConfirmedEvent;t.location=this._currentDownEvent.location;t.domEvent=this._currentDownEvent.domEvent;this.dispatchGestureEvent(t)}break}}determineMultiTouchGestureEventType(t){const e=t.getCurrentSpan();const n=t.getInitialSpan();const s=Math.abs(1-e/n);const i=t.getCurrentAngle();const o=t.getInitialAngle();const r=Math.min(Math.abs(i-o),360-Math.abs(i-o));const h=Math.abs(t.getInitialFocusX()-t.getFocusX());const u=Math.abs(t.getInitialFocusY()-t.getFocusY());const a=r>TWO_FINGER_TWIST_MIN_ANGLE;const c=s>PINCH_GESTURE_SPAN_RATIO_DIFFERENCE;const E=undefined;if(u>TWO_FINGER_DRAG_MIN_PIXEL_DISTANCE||h>TWO_FINGER_DRAG_MIN_PIXEL_DISTANCE){this._recognizerAttempts=0;return GestureEventType.TWO_FINGER_DRAG}if(a&&!c){this._recognizerAttempts=0;return GestureEventType.ROTATE}if(c&&!a){this._recognizerAttempts=0;return GestureEventType.PINCH}if(c&&a){this._recognizerAttempts++;if(this._recognizerAttempts>=3){this._recognizerAttempts=0;if(35*s>r)return GestureEventType.PINCH;return GestureEventType.ROTATE}}return null}onMultiTouchGesture(t,e){const n=this._currentMultiTouchGesture?this._currentMultiTouchGesture.type:this.determineMultiTouchGestureEventType(t);if(null!==n&&!this._multiTouchDownEventInfo)this._multiTouchDownEventInfo={domEvent:e,location:{pageX:t.getFocusX(),pageY:t.getFocusY()},span:t.getCurrentSpan(),previousSpan:t.getPreviousSpan(),scaleFactor:1,scaleFactorFromStart:1,angle:t.getCurrentAngle()};if(n===GestureEventType.PINCH&&this._multiTouchDownEventInfo){this._pinchEvent.domEvent=e;this._pinchEvent.location={pageX:t.getFocusX(),pageY:t.getFocusY()};this._pinchEvent.span=t.getCurrentSpan();this._pinchEvent.previousSpan=t.getPreviousSpan();this._pinchEvent.timeStamp=t.getEventTime();this._pinchEvent.timeDelta=t.getTimeDelta();this._pinchEvent.scaleFactor=t.getScaleFactor();this._pinchEvent.scaleFactorFromStart=t.getScaleFactorFromStart();const n=this._pinchEvent.copy();n.domEvent=this._multiTouchDownEventInfo.domEvent;n.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};n.span=this._multiTouchDownEventInfo.span;n.previousSpan=this._multiTouchDownEventInfo.previousSpan;n.scaleFactor=this._multiTouchDownEventInfo.scaleFactor;n.scaleFactorFromStart=this._multiTouchDownEventInfo.scaleFactorFromStart;this._pinchEvent.downEvent=n;this._currentMultiTouchGesture=this._pinchEvent.copy();this._listener.onGestureEvent(this._currentMultiTouchGesture)}if(n===GestureEventType.ROTATE&&this._multiTouchDownEventInfo){this._twoFingerTwistEvent.domEvent=e;this._twoFingerTwistEvent.location={pageX:t.getInitialFocusX(),pageY:t.getInitialFocusY()};this._twoFingerTwistEvent.angle=t.getCurrentAngle();this._twoFingerTwistEvent.span=t.getCurrentSpan();const n=this._twoFingerTwistEvent.copy();n.domEvent=this._multiTouchDownEventInfo.domEvent;n.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};n.span=this._multiTouchDownEventInfo.span;n.angle=this._multiTouchDownEventInfo.angle;this._twoFingerTwistEvent.downEvent=n;this._currentMultiTouchGesture=this._twoFingerTwistEvent.copy();this._listener.onGestureEvent(this._currentMultiTouchGesture)}if(n===GestureEventType.TWO_FINGER_DRAG&&this._multiTouchDownEventInfo){this._twoFingerDragEvent.domEvent=e;this._twoFingerDragEvent.location={pageX:t.getFocusX(),pageY:t.getFocusY()};const n=this._twoFingerDragEvent.copy();n.domEvent=this._multiTouchDownEventInfo.domEvent;n.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};this._twoFingerDragEvent.downEvent=n;this._currentMultiTouchGesture=this._twoFingerDragEvent.copy();this._listener.onGestureEvent(this._currentMultiTouchGesture)}return true}onMultiTouchGestureBegin(t){}onMultiTouchGestureEnd(t,e){if(this._currentMultiTouchGesture&&this._currentMultiTouchGesture.type===GestureEventType.ROTATE)this.twoFingerTwistEnd(t,e);else if(this._currentMultiTouchGesture&&this._currentMultiTouchGesture.type===GestureEventType.TWO_FINGER_DRAG)this.twoFingerDragEnd(t,e);else if(this._currentMultiTouchGesture&&this._currentMultiTouchGesture.type===GestureEventType.PINCH)this.pinchEnd(t,e);this._currentMultiTouchGesture=null;this._multiTouchDownEventInfo=null}pinchEnd(t,e){this._pinchEndEvent.domEvent=e;this._pinchEndEvent.location={pageX:t.getFocusX(),pageY:t.getFocusY()};const n=this._pinchEndEvent.copy();if(this._multiTouchDownEventInfo){n.domEvent=this._multiTouchDownEventInfo.domEvent;n.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};n.span=this._multiTouchDownEventInfo.span;n.previousSpan=this._multiTouchDownEventInfo.previousSpan;n.scaleFactor=this._multiTouchDownEventInfo.scaleFactor;n.scaleFactorFromStart=this._multiTouchDownEventInfo.scaleFactorFromStart;this._pinchEndEvent.downEvent=n}this._listener.onGestureEvent(this._pinchEndEvent.copy())}twoFingerDragEnd(t,e){this._twoFingerDragEndEvent.domEvent=e;this._twoFingerDragEndEvent.location={pageX:t.getFocusX(),pageY:t.getFocusY()};const n=this._twoFingerDragEndEvent.copy();if(this._multiTouchDownEventInfo){n.domEvent=this._multiTouchDownEventInfo.domEvent;n.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};this._twoFingerDragEndEvent.downEvent=n}this._listener.onGestureEvent(this._twoFingerDragEndEvent.copy())}twoFingerTwistEnd(t,e){this._twoFingerTwistEndEvent.domEvent=e;this._twoFingerTwistEndEvent.location={pageX:t.getInitialFocusX(),pageY:t.getInitialFocusY()};this._twoFingerTwistEndEvent.angle=t.getCurrentAngle();this._twoFingerTwistEndEvent.span=t.getCurrentSpan();if(this._multiTouchDownEventInfo){const t=this._twoFingerTwistEndEvent.copy();t.domEvent=this._multiTouchDownEventInfo.domEvent;t.location={pageX:this._multiTouchDownEventInfo.location.pageX,pageY:this._multiTouchDownEventInfo.location.pageY};t.span=this._multiTouchDownEventInfo.span;t.angle=this._multiTouchDownEventInfo.angle;this._twoFingerTwistEndEvent.downEvent=t}this._listener.onGestureEvent(this._twoFingerTwistEndEvent.copy())}dispatchGestureEvent(t){if(this._currentMultiTouchGesture)return;t.modifier=this._handler.modifier(t.domEvent);this._listener.onGestureEvent(t)}}