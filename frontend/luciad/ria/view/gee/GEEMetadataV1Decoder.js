import{DataViewCursor}from"./DataViewCursor.js";const FLAG_TREE=16;const FLAG_VECTOR=32;const FLAG_IMAGERY=64;const FLAG_TERRAIN=128;export class GEETileMetadataV1{constructor(t){this._node=t;this._channels=[]}get quadkey(){return this._node.quadTreeIndex}get channels(){if(this._channels.length)return this._channels;return this._node.channels.reduce(((t,e,n)=>{t.push({type:e,version:this._node.channel_versions[n]});return t}),this._channels)}get layers(){return[]}get hasChildren(){return this.flags(15)}get hasTree(){return this.flags(FLAG_TREE)}get hasTerrainData(){return this.flags(FLAG_TERRAIN)}get hasImageryData(){return this.flags(FLAG_IMAGERY)}get hasVectorData(){return this.flags(FLAG_VECTOR)}get terrainVersion(){return this._node.terrain_version}get imageryVersion(){return this._node.image_version}get cnodeVersion(){return this._node.cnode_version}hasChild(t){return this.flags(1<<t)}getVectorVersion(t){const e=this._node.channels.findIndex((e=>e===t));return this._node.channel_versions[e]??null}flags(t){return Boolean(this._node.bitField&t)}}function getEndianness(t){const e=32301;if(t.getUint32(0,true)===e)return true;if(t.getUint32(0,false)===e)return false;throw new Error("Not a metadata packet")}export function parseQuadTreePacketV1(t,e){const n=new DataView(t);const r=new DataViewCursor(n,getEndianness(n));r.padding(4);const i={isLittleEndian:r.isLittleEndian,data_type_id:r.nextUint32(),version:r.nextUint32(),num_instances:r.nextUint32(),data_instance_size:r.nextUint32(),data_buffer_offset:r.nextUint32(),data_buffer_size:r.nextUint32(),meta_buffer_size:r.nextUint32()};const a=new Array(i.num_instances);if(1!==i.data_type_id)throw new Error(`Data type ID in metadata packet should be 1, but was ${i.data_type_id}`);for(let t=0;t<i.num_instances;t++)a[t]=parseInstance(i,r,"");return mapQuadStrings(a,e).map((t=>new GEETileMetadataV1(t)))}function parseInstance(t,e,n){const r=e.nextUint8();e.padding(1);const i=e.nextUint16();const a=e.nextUint16();const s=e.nextUint16();const o=e.nextUint16();e.padding(2);const d=e.nextUint32();const c=e.nextUint32();e.padding(8);const u=e.nextUint8();const _=e.nextUint8();const l=new Array(o);const f=new Array(o);const{dataView:h}=e;for(let e=0;e<o;e++){l[e]=h.getUint16(t.data_buffer_offset+c+2*e,t.isLittleEndian);f[e]=h.getUint16(t.data_buffer_offset+d+2*e,t.isLittleEndian)}e.padding(2);return{quadTreeIndex:n,bitField:r,cnode_version:i,image_version:a,terrain_version:s,image_data_provider:u,terrain_data_provider:_,channel_versions:l,channels:f}}function mapQuadStrings(t,e){const n=t.length;let r=0;function i(e,a,s){const o=4===s;if(o&&a.bitField&FLAG_TREE)return;for(let d=0;d<4;++d){const c=`${e}${d}`;if(s<4&&!o)if(getBit(a.bitField,d)){if(r===n){console.log("Incorrect number of instances");return}const e=t[r++];e.quadTreeIndex=c;i(c,e,s+1)}}}i(e,t[r++],Number(""===e));return t.filter((t=>""!==t.quadTreeIndex))}function getBit(t,e){return 0!==(t&1<<e)}export function getMetadataUrl(t,e,n){return`${t}/flatfile?q2-0${e}-q.${n}`}