import{isQuadtreeCacheEntryPending,isQuadtreeCacheEntryValid}from"../../model/google/GEEQuadTreeCache.js";import{tileToGEEString}from"../../model/tileset/GEETileSetUtil.js";import{RasterDataType}from"../../model/tileset/RasterDataType.js";import{UrlTileSetModel}from"../../model/tileset/UrlTileSetModel.js";import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds}from"../../shape/ShapeFactory.js";import{isString}from"../../util/Lang.js";import{request}from"../../util/request.js";import{decodePacket}from"./GEEVectorTileDecoder.js";export class GEEVectorTileSetModel extends UrlTileSetModel{constructor(e){const t=getReference("EPSG:4326");const r=undefined;super({structure:{reference:t,bounds:createBounds(t,[-180,360,-90,180]),levelCount:25,level0Columns:2,level0Rows:1,tileWidth:256,tileHeight:256},baseURL:e.baseURL,dataType:RasterDataType.IMAGE,credentials:false,modelDescriptor:Object.freeze({name:e.name??"Vector",description:e.description??"GEE Vector TileSet",source:e.baseURL,type:RasterDataType.IMAGE})});this._quadTreeCache=e.quadTreeCache;this._channelId=e.channel;this._prefix=this._channelId?"f1c":"f1";this._minLevel=e.minLevel;this._maxLevel=e.maxLevel;this._featureType=e.featureType;this._styleAttribute=e.styleAttribute;this._styleMap=e.styleMap}get featureType(){return this._featureType}get minLevel(){return this._minLevel}get maxLevel(){return this._maxLevel}get styleAttribute(){return this._styleAttribute}get styleMap(){return this._styleMap}getTileURL(e,t,r){const s=isString(t)?t:this.getQuadTreeString(t);if(1&s.length)return null;const i=s.substr(0,~1&s.length);const{version:n,status:a}=this.getVersion(i);if(a===QTVersion.IsInvalid)return null;return`${e}/flatfile?f1c-0${i}-d.${this._channelId}.${r??(n||1)}`}getVectorTile(e,t,r){const s=this.getTileRowCount(e.level)??0;const i=0!==e.level?s-e.y-1+(s>>1):e.y;const n=tileToGEEString(e.x,i,e.level);const a=this._quadTreeCache.getQuadTreeNode(n);if(!isQuadtreeCacheEntryValid(a)){if(!this._quadTreeCache.isValid(n)){r("Quad Tree String invalid.");return Promise.resolve()}const s=()=>this.getVectorTile(e,t,r);return this._quadTreeCache.requestMissingMetadata(n,r).then((()=>this._quadTreeCache.metadataReady(e,n,s,r)),r)}return Promise.resolve(a).then((e=>{const s=isQuadtreeCacheEntryValid(e)&&e.hasVectorData&&e.getVectorVersion(this._channelId);if(!s){r("No vector data at this level.");return}this.requestVectorTileInternal(n,s,t,r)}),r)}requestVectorTileInternal(e,t,r,s){const i=this.getTileURL(this.baseURL,e,t);if(!i){s("No vector tile");return Promise.resolve()}return request(i).then((e=>e.arrayBuffer())).then((e=>r(decodePacket(this.baseURL,e)))).catch(s)}getQuadTreeString(e){const t=this.getTileRowCount(e.level)??0;const r=0!==e.level?t-e.y-1+(t>>1):e.y;return tileToGEEString(e.x,r,e.level)}getVersion(e){const t=this._quadTreeCache.getQuadTreeNode(e);if(isQuadtreeCacheEntryPending(t))return{status:QTVersion.IsPromise,version:1};if(!isQuadtreeCacheEntryValid(t))return{status:QTVersion.IsMissing,version:1};const r=t.getVectorVersion(this._channelId);if(null===r)return{status:QTVersion.IsInvalid,version:1};return{status:QTVersion.IsNumber,version:r}}}var QTVersion=function(e){e[e["IsPromise"]=0]="IsPromise";e[e["IsMissing"]=1]="IsMissing";e[e["IsInvalid"]=2]="IsInvalid";e[e["IsNumber"]=3]="IsNumber";return e}(QTVersion||{});