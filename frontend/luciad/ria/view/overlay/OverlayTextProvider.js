import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{getReference}from"../../reference/ReferenceProvider.js";import{createPoint}from"../../shape/ShapeFactory.js";import{LocationMode}from"../../transformation/LocationMode.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{EventedSupport}from"../../util/EventedSupport.js";import{PaintRepresentation}from"../PaintRepresentation.js";import{OverlayTextCoordinateType}from"./OverlayTextCoordinateType.js";export class OverlayTextProvider{constructor(e,t,i,o){this._content=o?.coordinate??OverlayTextCoordinateType.CENTER;this._settings=t;this._defaultFormat=i;this._eventedSupport=new EventedSupport(["TextChanged","VisibilityChanged"]);this._layer=e;this._visible=isOverlayVisible(e);this._mouseLocation=null;this._text="";this._map=null;this._map2Model=null;this._mapChangeListener=null;this._layerVisibilityListener=e.on("VisibilityChanged",(()=>{this.setVisible(isOverlayVisible(e))}));this._labelingChangedListener=e.on("PaintRepresentationVisibilityChanged",(()=>{this.setVisible(isOverlayVisible(e))}));this.handleMapChanged(e.map);this._addedToMapListener=e.on("AddedToMap",(()=>{this.handleMapChanged(e.map)}));this._removedFromMapListener=e.on("RemovedFromMap",(()=>{this.handleMapChanged(e.map)}))}get text(){return this._text}get visible(){return this._visible}setVisible(e){if(this._visible!==e){this._visible=e;this._eventedSupport.emit("VisibilityChanged",e)}}destroy(){this._layerVisibilityListener.remove();this._labelingChangedListener.remove();this.handleMapChanged(null)}on(e,t,i){return this._eventedSupport.on(e,t,i)}viewPointToModel(e){const t=this._map.getViewToMapTransformation(LocationMode.TERRAIN).transform(e);return this._map2Model.transform(t)}handleMapChanged(e){const t=this._map;if(t&&t!==e){this._mapChangeListener?.remove();this._mapChangeListener=null;if(this._content===OverlayTextCoordinateType.MOUSE_CURSOR){t.domNode.removeEventListener("mousemove",this.handleMouseMove);t.domNode.removeEventListener("mouseleave",this.handleMouseLeave)}if(!e)this.setVisible(false)}this._map=e;if(e){this._mapChangeListener=e.on("MapChange",this.handleMapMoved);if(this._content===OverlayTextCoordinateType.MOUSE_CURSOR){e.domNode.addEventListener("mousemove",this.handleMouseMove);e.domNode.addEventListener("mouseleave",this.handleMouseLeave)}const t=this._layer.model?.reference??getReference("CRS:84");this._map2Model=createTransformation(e.reference,t);if(!this.visible)this.setVisible(isOverlayVisible(this._layer))}}update(){if(!this.visible||!this._map)return;const e=this.getFormat(this._map.mapScale[0]);let t="";if(this._content===OverlayTextCoordinateType.COMMON_MAP_COORDINATE)t=this.formatCommonMapCoordinate(this._map,e);else try{const i=this.getViewPoint(this._map);const o=this.viewPointToModel(i);t=this.formatModelPoint(o,e)}catch(e){if(!(e instanceof OutOfBoundsError))throw e}this.setLabelContents(t)}getFormat(e){const t=this._settings.find((t=>t.scaleRange.min<=e&&e<t.scaleRange.max));return t?.format??this._defaultFormat}getViewPoint(e){const t=e.viewSize[0];const i=e.viewSize[1];if(this._content===OverlayTextCoordinateType.MOUSE_CURSOR){if(this._mouseLocation)return this._mouseLocation;return getOverlayViewPoint(OverlayTextCoordinateType.CENTER,t,i)}return getOverlayViewPoint(this._content,t,i)}handleMapMoved=()=>{this.update()};handleMouseMove=e=>{const t=this._map.domNode.getBoundingClientRect();this._mouseLocation=createPoint(null,[e.clientX-t.left,e.clientY-t.top]);this.update()};handleMouseLeave=e=>{this._mouseLocation=null};setLabelContents(e){if(this._text!==e){this._text=e;this._eventedSupport.emit("TextChanged",e)}}}const isOverlayVisible=e=>!!e.map&&e.visible&&e.isPaintRepresentationVisible(PaintRepresentation.LABEL);export const getOverlayViewPoint=(e,t,i)=>{let o,a;switch(e){case OverlayTextCoordinateType.LEFT:case OverlayTextCoordinateType.BOTTOM_LEFT:case OverlayTextCoordinateType.TOP_LEFT:o=0;break;case OverlayTextCoordinateType.RIGHT:case OverlayTextCoordinateType.BOTTOM_RIGHT:case OverlayTextCoordinateType.TOP_RIGHT:o=t;break;case OverlayTextCoordinateType.TOP:case OverlayTextCoordinateType.BOTTOM:case OverlayTextCoordinateType.CENTER:default:o=t/2}switch(e){case OverlayTextCoordinateType.BOTTOM_LEFT:case OverlayTextCoordinateType.BOTTOM:case OverlayTextCoordinateType.BOTTOM_RIGHT:a=i;break;case OverlayTextCoordinateType.TOP_LEFT:case OverlayTextCoordinateType.TOP:case OverlayTextCoordinateType.TOP_RIGHT:a=0;break;case OverlayTextCoordinateType.LEFT:case OverlayTextCoordinateType.CENTER:case OverlayTextCoordinateType.RIGHT:default:a=i/2}return createPoint(null,[o,a])};