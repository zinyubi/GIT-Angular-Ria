import{SimpleXYZPoint}from"../../shape/SimpleXYZPoint.js";import{rectangleSegmentIntersectionsSFCT,squaredDistance2D,squaredDistance2D_flat}from"../../util/Cartesian.js";import{LabelLocation,LabelLocationPosition}from"./LabelLocation.js";const LINE_LENGTH_LIMIT_MAX=1e3;const LINE_LENGTH_LIMIT_MIN=100;const VIEW_DIST_EPSILON=.01;const INVERT_THRESHOLD=.9999;const EPSILON=.001;const LABEL_EDGE_OFFSET=3;const LABEL_GRID_OFFSET=1;const LABEL_POSITION={ABOVE:0,CENTER:1,BELOW:2,LEFT:3,RIGHT:4};const getSingleIntersectionSFCT=(()=>{const e=[];e.intersections=0;return(t,n,o,i,l,s,r,a)=>{rectangleSegmentIntersectionsSFCT(t,o,n+t,0,i,l,s,r,e);if(e.intersections>=0){a.x=e[0];a.y=e[1]}else{a.x=null;a.y=null}}})();const intersectionInWorldSFCT=(()=>{const e=new SimpleXYZPoint(null,0,0,0);const t=new SimpleXYZPoint(null,0,0,0);const n=new SimpleXYZPoint(null,0,0,0);const o=new SimpleXYZPoint(null,0,0,0);const i=new SimpleXYZPoint(null,0,0,0);const l=new SimpleXYZPoint(null,0,0,0);return function s(r,a,L,c,E,T,u,I,S){t.x=E;t.y=T;n.x=u;n.y=I;r._forward(t,o);r._forward(n,i);getSingleIntersectionSFCT(a,L,c,o.x,o.y,i.x,i.y,e);r._inverse(e,l);S.x=l.x;S.y=l.y;return l}})();const getIntersectionWorldPointsOutsideSFCT=(()=>{const e=[];e.intersections=0;const t=new SimpleXYZPoint(null,0,0,0);const n=new SimpleXYZPoint(null,0,0,0);const o=new SimpleXYZPoint(null,0,0,0);const i=new SimpleXYZPoint(null,0,0,0);return(l,s,r,a,L,c,E,T,u,I)=>{let S,_;o.x=L;o.y=c;i.x=E;i.y=T;l._forward(o,t);l._forward(i,n);rectangleSegmentIntersectionsSFCT(s,a,r+s,0,t.x,t.y,n.x,n.y,e);if(e.intersections<2)return false;else{t.x=e[0];t.y=e[1];n.x=e[2];n.y=e[3];l._inverse(t,o);l._inverse(n,i);S=squaredDistance2D(o.x,o.y,L,c);_=squaredDistance2D(i.x,i.y,E,T);if(S<_){u.move2DToCoordinates(o.x,o.y);I.move2DToCoordinates(i.x,i.y)}else{u.move2DToCoordinates(i.x,i.y);I.move2DToCoordinates(o.x,o.y)}return true}}})();const modifyLabelAnchorPointSFCT=(e,t,n,o,i,l)=>{const s=true;const r=LABEL_POSITION.ABOVE;let a,L,c;l.configure(l.getX(),l.getY(),e,t,l.getRotation(),l.getAnchorX(),l.getAnchorY(),0);if(l.edge===LabelLocationPosition.IN_VIEW){a=s?-(e+LABEL_EDGE_OFFSET):LABEL_EDGE_OFFSET;L=l.getCos()*a;c=-l.getSin()*a;l.translate(L,c)}let E=r;let T;if(r===LABEL_POSITION.BELOW||r===LABEL_POSITION.RIGHT)T=1;else T=-1;if(Math.abs(l.getRotation()*INVERT_THRESHOLD)>Math.PI/2){l.invert();if(E===LABEL_POSITION.ABOVE)E=LABEL_POSITION.BELOW;else if(E===LABEL_POSITION.BELOW)E=LABEL_POSITION.ABOVE;else if(E===LABEL_POSITION.CENTER)T=1;else if(E===LABEL_POSITION.LEFT)T*=-1;else if(E===LABEL_POSITION.RIGHT)T*=-1}let u=0;if(E===LABEL_POSITION.ABOVE)u=l.getHeight()+LABEL_GRID_OFFSET;else if(E===LABEL_POSITION.CENTER)u=l.getHeight()/2-1;else if(E===LABEL_POSITION.BELOW)u=LABEL_GRID_OFFSET;else if(E===LABEL_POSITION.LEFT)u=l.getHeight()+LABEL_GRID_OFFSET;else if(E===LABEL_POSITION.RIGHT)u=LABEL_GRID_OFFSET;L=l.getSin()*T*u;c=l.getCos()*T*u;l.translate(L,c);if(l.getMinX()<LABEL_EDGE_OFFSET+n)l.moveX(LABEL_EDGE_OFFSET+n-l.getMinX());if(l.getMaxX()>o-LABEL_EDGE_OFFSET+n)l.moveX(o+n-LABEL_EDGE_OFFSET-l.getMaxX());if(l.getMinY()<LABEL_EDGE_OFFSET)l.moveY(LABEL_EDGE_OFFSET-l.getMinY());if(l.getMaxY()>i-LABEL_EDGE_OFFSET)l.moveY(i-LABEL_EDGE_OFFSET-l.getMaxY())};function calculateLabelAnchorPointSFCT(e,t,n,o,i,l,s,r,a,L){let c;const E=l.x;const T=l.y;const u=r.x;const I=r.y;if(o&&(s||a)){c=Math.atan2(I-T,u-E);configureLabelLocation(L,E,T,c,calculatePosition(e,t,n,E,T));return true}if(!i&&!s&&!a){c=Math.atan2(I-T,u-E);configureLabelLocation(L,E,T,c,calculatePosition(e,t,n,E,T));return true}if(s&&a){c=Math.atan2(I-T,u-E);configureLabelLocation(L,E,T,c,calculatePosition(e,t,n,E,T));return true}else if(s){c=Math.atan2(I-T,u-E);configureLabelLocation(L,E,T,c,calculatePosition(e,t,n,E,T));return true}else if(a){c=Math.atan2(I-T,u-E);configureLabelLocation(L,u,I,c,calculatePosition(e,t,n,u,I));return true}else return false}function calculatePosition(e,t,n,o,i){if(Math.abs(o-e)<EPSILON)return LabelLocationPosition.LEFT;else if(Math.abs(i)<EPSILON)return LabelLocationPosition.TOP;else if(Math.abs(o-(t+e))<EPSILON)return LabelLocationPosition.RIGHT;else if(Math.abs(i-n)<EPSILON)return LabelLocationPosition.BOTTOM;else return LabelLocationPosition.IN_VIEW}function forEachXYPointFrontToBack(e,t,n){const o=3*t;const i=e.length;let l=true;for(let t=0;t<i&&l;t+=o)l=n(e[t],e[t+1])}function forEachXYPointBackToFront(e,t,n){let o,i;const l=3*t;let s=true;for(o=e.length-2,i=0;o>=i&&s;o-=l)s=n(e[o-1],e[o])}function configureLabelLocation(e,t,n,o,i){e.configure(t,n,0,0,o,0,0,0);e.edge=i}export const GridLineLabelLocationUtil={__LABEL_POSITION:LABEL_POSITION,__LabelLocation:LabelLocation,__getIntersectionWorldPointsOutsideSFCT:getIntersectionWorldPointsOutsideSFCT,__getSingleIntersectionSFCT:getSingleIntersectionSFCT,__firstLabelLocation:(()=>{const e=new SimpleXYZPoint(null,0,0,0);const t=new SimpleXYZPoint(null,0,0,0);const n=new SimpleXYZPoint(null,0,0,0);const o=new SimpleXYZPoint(null,0,0,0);return(i,l,s,r,a,L,c,E,T)=>{E=true===E;if(l.length<2)return false;const u=E?forEachXYPointBackToFront:forEachXYPointFrontToBack;let I=Math.round(l.length/LINE_LENGTH_LIMIT_MAX);I=Math.min(LINE_LENGTH_LIMIT_MIN,Math.max(1,I));let S=true;let _=true;let f,O,P,F,g,m;let B,A,d,N;u(l,I,((l,E)=>{f=O;P=F;d=N;O=l;F=E;N=i.isInsideRectangleForward(O,F,s,0,r+s,a);if(S){S=false;_=true;return true}if(d&&N){e.move2DToCoordinates(f,P);t.move2DToCoordinates(O,F)}else if(d){e.move2DToCoordinates(f,P);A=new SimpleXYZPoint(null,0,0,0);intersectionInWorldSFCT(i,s,r,a,f,P,O,F,A);g=A.x;m=A.y;t.move2DToCoordinates(g,m)}else if(N){A=new SimpleXYZPoint(null,0,0,0);intersectionInWorldSFCT(i,s,r,a,O,F,f,P,A);g=A.x;m=A.y;e.move2DToCoordinates(g,m);t.move2DToCoordinates(O,F)}else{B=getIntersectionWorldPointsOutsideSFCT(i,s,r,a,O,F,f,P,t,e);if(!B)return true}i.transform(e,n);i.transform(t,o);if(squaredDistance2D_flat(n,o)>=VIEW_DIST_EPSILON){const e=undefined;if(calculateLabelAnchorPointSFCT(s,r,a,_,false,n,!d,o,!N,T)){modifyLabelAnchorPointSFCT(L,c,s,r,a,T);return false}}_=false;return true}));return true}})(),findLabelLocationSFCT:function(e,t){const n=e.mapToViewTransformation;const o=e.lines;const i=e.viewWidth;const l=e.viewHeight;const s=e.labelWidth;const r=e.labelHeight;const a=e.lastToFirst;const L=e.leftOffset;let c,E,T;for(c=0,E=o.length;c<E;c+=1){T=o[c];const e=undefined;if(this.__firstLabelLocation(n,T,L,i,l,s,r,a,t))return true}return false}};