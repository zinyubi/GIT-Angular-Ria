import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds,createMeridian,createParallel}from"../../shape/ShapeFactory.js";import{normalizeLat,normalizeLon}from"../../util/LonLatCoord.js";import{NoBoundsError}from"../../error/NoBoundsError.js";import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{isDefined}from"../../util/Lang.js";const INCREASE_FACTOR=2;const MAX_GRIDLINES=120;const NORTH_POLE=90;const SOUTH_POLE=-90;const crs84=getReference("CRS:84");const MODEL_BOUNDS=createBounds(crs84,[-180,360,-90,180]);export class GridRendererState{constructor(e,o){this._grid=e;this._originLatModel=this._grid.originLat;this._originLonModel=this._grid.originLon;this._originLonPrecisionFactor=getPrecisionFactor(this._originLonModel);this._originLatPrecisionFactor=getPrecisionFactor(this._originLatModel);this._mapBounds=createBounds(o);this._modelBounds=MODEL_BOUNDS;this._previousCalculatedModelBounds=null;this._previousRenderedModelBounds=null;this._previousDeltaLat=null;this._previousRenderedScaleIndex=null;this._previousDeltaLon=null;this._previousCalculatedScale=0;this._previousScaleIndex=0;this._tooMany=false;this._gridLines=[];this._originLines=[]}get tooMany(){return this._tooMany}get modelBounds(){return this._modelBounds}get originLines(){return this._originLines}get gridLines(){return this._gridLines}getModelBounds(e){try{this._mapBounds.setToBounds3D(e.getMapBounds({reference:this._mapBounds.reference})[0]);this._mapBounds.normalize()}catch(e){if(!NoBoundsError.is(e)&&!OutOfBoundsError.is(e))throw e;this._mapBounds.setTo3D(0,0,0,0,0,0)}return this._mapBounds}canSkipUpdate(e,o,t){if(!this._previousCalculatedModelBounds||!this._previousRenderedModelBounds||!this._previousDeltaLat||!this._previousDeltaLon||!isDefined(this._previousRenderedScaleIndex))return false;if(e.x===this._previousRenderedModelBounds.x&&e.y===this._previousRenderedModelBounds.y&&e.width===this._previousRenderedModelBounds.width&&e.height===this._previousRenderedModelBounds.height&&t===this._previousRenderedScaleIndex)return true;if(!this._previousCalculatedModelBounds.contains2DBoundsWithEps(e,1e-6))return false;else if(o/this._previousCalculatedScale>1024)return false;const i=t===this._previousScaleIndex;if(i)this._previousRenderedModelBounds.setToBounds3D(e);return i}update(e,o){if(!this._previousRenderedModelBounds)this._previousRenderedModelBounds=createBounds(e.reference);this._previousRenderedModelBounds.setToBounds3D(e);this._previousScaleIndex=o}reset(e,o,t){const i=getEnlargeBounds(e,INCREASE_FACTOR);this._previousCalculatedModelBounds=i;this._previousCalculatedScale=o;this._previousRenderedScaleIndex=t;while(t<this._grid.scales.length){const e=this._grid.getDeltaLat(t);const o=this._grid.getDeltaLon(t);this._previousDeltaLat=e;this._previousDeltaLon=o;this.updateLonLatLines(i,e,o);if(this._tooMany)t++;else break}if(!this._previousRenderedModelBounds)this._previousRenderedModelBounds=createBounds(e.reference);this._previousRenderedModelBounds.setToBounds3D(e);this._previousScaleIndex=t}calculateScaleIndex(e,o){const t=e.length;let i=0;while(i<t)if(o>=e[i])break;else i++;if(i<t)return i;else return-1}updateLonLatLines(e,o,t){const i=Math.max(getPrecisionFactor(o),this._originLatPrecisionFactor);const s=Math.max(getPrecisionFactor(t),this._originLonPrecisionFactor);const n=e.y;const r=e.y+e.height;let d=e.x;let a=e.x+e.width;if(e.width>=360){d=-180;a=180}const l=toPrecision(ceilTo(n,o,this._originLatModel),i);const u=toPrecision(floorTo(r,o,this._originLatModel),i);const c=toPrecision(ceilTo(d,t,this._originLonModel),s);const h=toPrecision(floorTo(a,t,this._originLonModel),s);const _=normalizeLat(toPrecision(floorTo(n,o,this._originLatModel),i));const L=normalizeLat(toPrecision(ceilTo(r,o,this._originLatModel),i));let p=toPrecision(floorTo(d,t,this._originLonModel),s);let f=toPrecision(ceilTo(a,t,this._originLonModel),s);if(p===f||f-p>=360){p=-180;f=180}const M=[];const g=[];let B=Math.round((this._originLonModel-c)/t);let v,m,P,R,O;const S=undefined;if(Math.round((h-c)/t)>MAX_GRIDLINES){this._tooMany=true;return}const E=undefined;if(Math.round((u-l)/t)>MAX_GRIDLINES){this._tooMany=true;return}this._tooMany=false;for(O=0,m=c;m<=h;m=toPrecision(m+t,s),O+=1){v=normalizeLon(m);R=createMeridian(crs84,v,_,L);if(O===B)g.push(R);else M.push(R);if(180===v){R=createMeridian(crs84,-180,_,L);if(O===B)g.push(R);else M.push(R)}}B=Math.round((this._originLatModel-l)/o);let T=false,D=false;for(O=0,P=l;P<=u;P=toPrecision(P+o,i),O+=1){v=normalizeLat(P);R=createParallel(crs84,v,p,f);if(O===B)g.push(R);else M.push(R);if(P===NORTH_POLE)T=true;else if(P===SOUTH_POLE)D=true}const x=l-o;const I=u+o;if(!T&&x<=SOUTH_POLE&&SOUTH_POLE<=I){v=normalizeLat(SOUTH_POLE);R=createParallel(crs84,v,p,f);M.push(R)}if(!D&&x<=NORTH_POLE&&NORTH_POLE<=I){v=normalizeLat(NORTH_POLE);R=createParallel(crs84,v,p,f);M.push(R)}this._gridLines=M;this._originLines=g}invalidate(){this._previousCalculatedModelBounds=null}}function toPrecision(e,o){return Math.round(e*o)/o}function floorTo(e,o,t){return t+Math.floor((e-t)/o)*o}function ceilTo(e,o,t){return t+Math.ceil((e-t)/o)*o}function getEnlargeBounds(e,o){const t=e.width;const i=e.height;const s=Math.min(t*o,360);const n=Math.min(i*o,180);const r=(s-t)/2;const d=(n-i)/2;const a=Math.max(e.x-r,-180);const l=Math.max(e.y-d,-90);const u=e.copy();u.setTo2D(a,s,l,n);return u}function getPrecisionFactor(e){const o=e.toString();const t=o.indexOf(".");const i=o.length;let s;if(t<i)s=Math.pow(10,i-t-1);else s=1;return s}