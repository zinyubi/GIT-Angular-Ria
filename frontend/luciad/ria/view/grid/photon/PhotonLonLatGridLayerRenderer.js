import{Photon}from"../../../gen/photon/photon_painter.js";import{createPhotonColorFromString}from"../../../util/Color.js";import{ObjectReleaseTracker}from"../../../util/ObjectReleaseTracker.js";import{LabelPosition}from"../LabelPosition.js";import{AbstractPhotonGridLayerRenderer}from"./AbstractPhotonGridLayerRenderer.js";import{GridLabelConflictChecker}from"../GridLabelConflictChecker.js";import{StyleUtil}from"../../style/StyleUtil.js";import{HTML5TextUtil}from"../../style/HTML5TextUtil.js";export class PhotonLonLatGridLayerRenderer extends AbstractPhotonGridLayerRenderer{constructor(e,t,i,o,l){const r=e.photon.LonLatGrid.create({x:e.grid.originLon,y:e.grid.originLat,z:0});const a=new e.photon.RiaLonLatGridPainterCallback;const n=undefined;const s=undefined;super({photonGrid:r,painter:e.photon.RiaLonLatGridPainter.create(o,l,r,a),callback:a,labelConflictChecker:new GridLabelConflictChecker,...e},t,i,o,l);a.gridInvalidated=e=>{this._isLabeled=this.grid.getLabeled(e);this._labelPosition=this.grid.getLabelPosition(e);this._labelStyle=this.grid.getLabelStyle(e);this._labelFormat=this.grid.getLabelFormat(e);this._originLabelStyle=this.grid.getOriginLabelStyle(e);this._originLabelFormat=this.grid.getOriginLabelFormat(e);this.objectReleaseTracker.untrack(this.labelResourcesToRelease);this.labelResourcesToRelease=this.objectReleaseTracker.track(new ObjectReleaseTracker);this.labels=[];this.drawGridLabelCommandFactory.reset()};a.gridLineAdded=(e,t,i,o,l)=>{if(this._isLabeled&&this.paintLabels){const r=this.labelResourcesToRelease.track(e);const a=this.labelResourcesToRelease.track(t);if(l)this._appendLabelCommand(r,a,i,o,this._originLabelStyle,this._originLabelFormat,this.labels);else this._appendLabelCommand(r,a,i,o,this._labelStyle,this._labelFormat,this.labels)}else{e.release();t.release()}};this._isLabeled=false;this._labelPosition=null;this._labelStyle=null;this._labelFormat=null;this._originLabelStyle=null;this._originLabelFormat=null}configurePhotonGrid(e,t){t.invalidate();let i=0;while(i<e.scales.length){const o=e.scales[i];const l=e.getDeltaLat(i);const r=e.getDeltaLon(i);const a=e.getLineStyle(i);const n=e.getOriginLineStyle(i);t.addLonLatSetting(o,r,l,createPhotonColorFromString(a.color),a.width,createPhotonColorFromString(n.color),n.width);i++}}_appendLabelCommand(e,t,i,o,l,r,a){let n="";if(i)n=r.formatLon(o);else n=r.formatLat(o);const s=this._labelPosition===LabelPosition.ALL_SIDES;const d=StyleUtil.convertTextToLabel(n,l);const h=HTML5TextUtil.calculateBounds(n,l,true,false);let b=this.drawGridLabelCommandFactory.buildGridLabelCommand(d,h,false,this.labelGroup,e,t,2,Photon.GridLabelPosition.AboveOrLeft,1,Photon.GridLabelOrientation.AlongLine,true);a.push(b);if(s){b=this.drawGridLabelCommandFactory.buildGridLabelCommand(d,h,true,this.labelGroup,e,t,2,Photon.GridLabelPosition.AboveOrLeft,1,Photon.GridLabelOrientation.AlongLine,true);a.push(b)}}}