import{HandleEventResult}from"./HandleEventResult.js";import{GestureEventType}from"../input/GestureEventType.js";import{Controller}from"./Controller.js";import{createBounds,createPoint}from"../../shape/ShapeFactory.js";import{clamp}from"../../util/Cartesian.js";import{EventedSupport}from"../../util/EventedSupport.js";export let SwipeLineOrientation=function(e){e[e["HORIZONTAL"]=1]="HORIZONTAL";e[e["VERTICAL"]=2]="VERTICAL";return e}({});export class SwipeController extends Controller{constructor(){super();this._focusThreshold=10;this._borderThreshold=5;this._pixelOrientationSwitchThreshold=20;this._hovering=false;this._swiping=false;this._swipeLineLocation=createPoint(null,[0,0]);this._swipeLineOrientation=SwipeLineOrientation.VERTICAL;this._automaticOrientation=true;this._currentMapWidth=0;this._currentMapHeight=0;this._thresholdMouseLocation=createPoint(null,[0,0]);this._layers=[[],[]];this._mapChangeHandle=null;this._eventedSupport=new EventedSupport(["LayersChange","SwipeLineLocationChange","SwipeLineOrientationChange","AutomaticOrientationChange","HoveringChanged","SwipingChanged"],true)}onActivate(e){const i=undefined;if(!!e._isSoftwareMap())throw new Error("SwipeController can only be used on a WebGLMap");const t=undefined;const n=[];if(!e.viewPaintingStrategy.isLayerClippingSupported(n))throw new Error("Can not activate SwipeController."+n.join("\n"));this._mapChangeHandle=e.on("MapChange",(()=>{const i=e.viewSize[0];const t=e.viewSize[1];if(this._currentMapWidth!==i||this._currentMapHeight!==t){const e=i/this._currentMapWidth;const n=t/this._currentMapHeight;this._currentMapWidth=i;this._currentMapHeight=t;this.swipeLineLocation=createPoint(null,[this.swipeLineLocation.x*e,this.swipeLineLocation.y*n]);this.invalidate()}}));const s=e.viewSize[0];const o=e.viewSize[1];this._currentMapWidth=s;this._currentMapHeight=o;this.swipeLineLocation=createPoint(null,[s/2,o/2]);this.swipeLineOrientation=SwipeLineOrientation.VERTICAL;this._thresholdMouseLocation.move2D(0,0);super.onActivate(e);this.invalidate()}onDeactivate(e){this._hovering=false;this._swiping=false;if(!e._isSoftwareMap())e.disableLayerClipping();this._mapChangeHandle?.remove();return super.onDeactivate(e)}set layers(e){const i=[];for(const t of e[0]){const n=e[1].indexOf(t);if(n>-1){e[1].splice(n,1);i.push(t)}}for(const t of i){const i=e[0].indexOf(t);if(i>-1)e[0].splice(i,1)}this._layers=e;this.invalidate();this._eventedSupport.emit("LayersChange",this._layers)}get layers(){return this._layers}invalidate(){const e=this.map;const i=e&&e.webGLContext?e.webGLContext?.isContextLost():false;if(e&&!e._isSoftwareMap()&&!i)if(0==this._layers[0].length&&0==this._layers[1].length)e.disableLayerClipping();else{const i=e.camera.width;const t=e.camera.height;const n=createBounds(null,[]);const s=createBounds(null,[]);if(this._swipeLineOrientation===SwipeLineOrientation.HORIZONTAL){n.setTo2D(0,i,t-this._swipeLineLocation.y,this._swipeLineLocation.y);s.setTo2D(0,i,0,t-this._swipeLineLocation.y)}else{n.setTo2D(0,this._swipeLineLocation.x,0,t);s.setTo2D(this._swipeLineLocation.x,i-this._swipeLineLocation.x,0,t)}e.enableLayerClipping(n,this._layers[0],s,this._layers[1])}super.invalidate()}onGestureEvent(e){let i=HandleEventResult.EVENT_IGNORED;if(this._swiping){if(e.type===GestureEventType.DRAG){const t=e.viewPoint.copy();this.clampToBorderSFCT(t);this.moveSwipeLine(t);i=HandleEventResult.EVENT_HANDLED}else if(e.type===GestureEventType.DRAG_END||e.type===GestureEventType.UP){this._setSwiping(false);this._setHovering(this.isOnSwipeLine(e.viewPoint));this._thresholdMouseLocation.move2D(0,0);i=HandleEventResult.EVENT_HANDLED}}else{const t=this.isOnSwipeLine(e.viewPoint);if(e.type===GestureEventType.DOWN&&t){this._setHovering(false);this._setSwiping(true);this._thresholdMouseLocation.move2D(e.viewPoint);i=HandleEventResult.EVENT_HANDLED}else if(e.type===GestureEventType.MOVE){this._setHovering(t);i=HandleEventResult.EVENT_HANDLED}}return i}isOnSwipeLine(e){if(this._swipeLineOrientation===SwipeLineOrientation.HORIZONTAL)return Math.abs(this._swipeLineLocation.y-e.y)<this._focusThreshold;else return Math.abs(this._swipeLineLocation.x-e.x)<this._focusThreshold}clampToViewSFCT(e){const i=this.map;if(i){const t=i.viewSize[0];const n=i.viewSize[1];e.move2D(clamp(e.x,0,t),clamp(e.y,0,n))}}clampToBorderSFCT(e){const i=this.map;if(i){const t=i.viewSize[0];const n=i.viewSize[1];e.move2D(clamp(e.x,this._borderThreshold,t-this._borderThreshold),clamp(e.y,this._borderThreshold,n-this._borderThreshold))}}set swipeLineLocation(e){if(this._swipeLineLocation.x!==e.x||this._swipeLineLocation.y!==e.y){this._swipeLineLocation.move2D(e);this.clampToViewSFCT(this._swipeLineLocation);this.invalidate();this._eventedSupport.emit("SwipeLineLocationChange",this._swipeLineLocation)}}moveSwipeLine(e){this.swipeLineLocation=e.copy();if(0!=this._thresholdMouseLocation.x&&0!=this._thresholdMouseLocation.y&&this._automaticOrientation){const i=Math.abs(this._thresholdMouseLocation.x-e.x);const t=Math.abs(this._thresholdMouseLocation.y-e.y);if(i>t+this._pixelOrientationSwitchThreshold)this.swipeLineOrientation=SwipeLineOrientation.VERTICAL;else if(t>i+this._pixelOrientationSwitchThreshold)this.swipeLineOrientation=SwipeLineOrientation.HORIZONTAL;else return}this._thresholdMouseLocation.move2D(e.x,e.y)}get swipeLineLocation(){return this._swipeLineLocation}set swipeLineOrientation(e){if(e!==this._swipeLineOrientation){this._swipeLineOrientation=e;this.invalidate();this._eventedSupport.emit("SwipeLineOrientationChange",e)}}get swipeLineOrientation(){return this._swipeLineOrientation}set automaticOrientation(e){if(e!==this._automaticOrientation){this._automaticOrientation=e;this.invalidate();this._eventedSupport.emit("AutomaticOrientationChange",this._automaticOrientation)}}get automaticOrientation(){return this._automaticOrientation}_setHovering(e){if(this._hovering!==e){this._hovering=e;this._eventedSupport.emit("HoveringChanged",this._hovering)}}get hovering(){return this._hovering}_setSwiping(e){if(this._swiping!==e){this._swiping=e;this._eventedSupport.emit("SwipingChanged",this._swiping)}}get swiping(){return this._swiping}on(e,i){if("Invalidated"===e)return super.on(e,i);if("Activated"===e)return super.on(e,i);if("Deactivated"===e)return super.on(e,i);return this._eventedSupport.on(e,i)}}