import{FeatureLayerRenderer}from"../feature/FeatureLayerRenderer.js";import{GestureEventType}from"../input/GestureEventType.js";import{PaintRepresentation}from"../PaintRepresentation.js";import{EditingSupport}from"./EditingSupport.js";import{Feature}from"../../model/feature/Feature.js";import{isPolygon}from"../../shape/Polygon.js";import{isPolyline}from"../../shape/Polyline.js";import{ShapeType}from"../../shape/ShapeType.js";export function findGeoBuffer(e){if(ShapeType.contains(e.shape.type,ShapeType.GEO_BUFFER))return e.shape;if(ShapeType.contains(e.shape.type,ShapeType.SHAPE_LIST)){const t=e.shape;for(let e=0;e<t.shapeCount;e++){const r=t.getShape(e);if(ShapeType.contains(r.type,ShapeType.GEO_BUFFER))return r}}return null}export class GeoBufferEditingSupport extends EditingSupport{constructor(e,t){super(e,t);const r=findGeoBuffer(t);if(!r)throw new Error("GeoBufferEditingSupport used without GeoBuffer on EditContext");this._currentBuffer=r.copy();this._updatedBuffer=r.copy()}onDraw(e,t){if(!t.layer.visible||!t.layer._addedToMap)return;if((isPolygon(this._currentBuffer.baseShape)||isPolyline(this._currentBuffer.baseShape))&&this._currentBuffer.baseShape.pointCount>0){const r=new Feature(this._currentBuffer,t.feature.properties,t.feature.id);FeatureLayerRenderer.paintFeature(e,r,t.layer,t.map,PaintRepresentation.BODY,{selected:true})}this._handle.onDraw(e,t)}onDrawLabel(e,t){if(!t.layer.visible||!t.layer._addedToMap)return;const r=this._currentBuffer;if((isPolygon(r.baseShape)||isPolyline(r.baseShape))&&r.baseShape.pointCount>0){const r=new Feature(this._currentBuffer,t.feature.properties,t.feature.id);FeatureLayerRenderer.paintFeature(e,r,t.layer,t.map,PaintRepresentation.LABEL,{selected:true})}this._handle.onDrawLabel(e,t)}onGestureEvent(e,t){if(e.type===GestureEventType.SINGLE_CLICK_CONFIRMED){this._currentBuffer=this._updatedBuffer;if(t.map.controller)t.map.controller.invalidate()}const r=super.onGestureEvent(e,t);if(e.type===GestureEventType.DOUBLE_CLICK)this._currentBuffer=this._updatedBuffer;else if(e.type===GestureEventType.SINGLE_CLICK_UP){const e=findGeoBuffer(t);if(!e)throw new Error("GeoBufferEditingSupport: No GeoBuffer found on EditContext");this._updatedBuffer=e.copy()}return r}}