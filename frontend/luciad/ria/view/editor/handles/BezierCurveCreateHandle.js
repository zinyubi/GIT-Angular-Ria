import{createPoint}from"../../../shape/ShapeFactory.js";import{EVENT_HANDLED,EVENT_IGNORED,HandleEventResult,REQUEST_DEACTIVATION,REQUEST_FINISH}from"../../controller/HandleEventResult.js";import{GestureEventType}from"../../input/GestureEventType.js";import{EditHandle}from"../EditHandle.js";import*as SnapUtil from"../snapping/SnapUtil.js";import{EditShapeStatus}from"../../controller/EditShapeEvent.js";import{viewToModel}from"./HandleUtil.js";import{createTransformation}from"../../../transformation/TransformationFactory.js";export class BezierCurveCreateHandle extends EditHandle{_waitForSingleClickConfirmed=null;constructor(e){super();this._bezierCurve=e;this._lastWorldPoint=null;this._pointIndex=0;this._snapPoint=null}get bezierCurve(){return this._bezierCurve}getCursor(e,t){return"crosshair"}onDraw(e,t){SnapUtil.paintSnapIcon(e,this._snapPoint)}onGestureEvent(e,t){const{type:i,viewPosition:n}=e;const r=this._pointIndex===this._bezierCurve.points.length;if(i===GestureEventType.DOUBLE_CLICK&&r){this.emitEditShapeEvent(this.bezierCurve,EditShapeStatus.FINISHED);return EVENT_HANDLED|REQUEST_FINISH|REQUEST_DEACTIVATION}if(this._waitForSingleClickConfirmed&&r){if(i===GestureEventType.SINGLE_CLICK_CONFIRMED){clearTimeout(this._waitForSingleClickConfirmed);this._waitForSingleClickConfirmed=null}if(this._waitForSingleClickConfirmed)return HandleEventResult.EVENT_HANDLED;else return HandleEventResult.EVENT_HANDLED|HandleEventResult.REQUEST_FINISH}const o=i===GestureEventType.SINGLE_CLICK_UP;const s=i===GestureEventType.MOVE;const l=undefined;if(!(o&&!r||s&&this._pointIndex>0))return EVENT_IGNORED;const a=t.map;const E=createPoint(null,[0,0]);const p=createPoint(a.reference,[0,0,0]);const u=t.layer.model.reference;let h=createPoint(u,[0,0,0]);this.moveToClosestSnapPointIfAny(e,t,h);try{E.move2D(n[0],n[1]);this.viewToMap(E,p,t);h=this.viewToModel(E,t)}catch(e){return EVENT_HANDLED}const _=this._bezierCurve.points;if(o&&!r){this._lastWorldPoint=p;for(let e=this._pointIndex;e<this.bezierCurve.points.length;e++)_[e]=h.copy();this._bezierCurve.invalidate();this._pointIndex++;if(this._pointIndex===this._bezierCurve.points.length)this._waitForSingleClickConfirmed=setTimeout((()=>{this._waitForSingleClickConfirmed=null}),310);return EVENT_HANDLED}if(s&&this._pointIndex>0){for(let e=this._pointIndex;e<this.bezierCurve.points.length;e++)_[e]=h.copy();this._bezierCurve.invalidate();return EVENT_HANDLED}return EVENT_IGNORED}viewToModel(e,t){let i=viewToModel(e,t,true);if(!i)i=null===this._lastWorldPoint?null:createTransformation(t.map.reference,t.layer.model.reference).transform(this._lastWorldPoint);else this._lastWorldPoint=createTransformation(i.reference,t.map.reference).transform(i);return i}viewToMap(e,t,i){i.map.viewToMapTransformation.transform(e,t)}moveToClosestSnapPointIfAny(e,t,i){const n=SnapUtil.findClosestPoint(e,this.bezierCurve.getControlPoint(this._pointIndex),this.bezierCurve,t.map);if(null!==n){i.move2D(n);this._snapPoint=n.copy()}else this._snapPoint=null}}