import{OutOfBoundsError}from"../../../error/OutOfBoundsError.js";import{EVENT_HANDLED,REQUEST_DEACTIVATION,REQUEST_FINISH}from"../../controller/HandleEventResult.js";import{GestureEventType}from"../../input/GestureEventType.js";import*as SnapUtil from"../snapping/SnapUtil.js";import{ThreeStepEditHandle}from"./ThreeStepEditHandle.js";import{EditShapeStatus}from"../../controller/EditShapeEvent.js";export class BoundsCreateHandle extends ThreeStepEditHandle{constructor(t){super();this._bounds=t;this._startPoint=null;this._snapPoint=null;this._clickCount=0;this._boundsCreated=false}get bounds(){return this._bounds}shouldActivate(t,s){return t.type===GestureEventType.DRAG||t.type===GestureEventType.SINGLE_CLICK_UP}activate(t,s){this._clickCount=0;let e=s.onTerrainViewModelTransformation.transform(t.viewPoint);this._snapPoint=SnapUtil.findClosestPoint(t,e,this.bounds,s.map);if(this._snapPoint)e=this._snapPoint;this._startPoint=e;this.bounds.x=this._startPoint.x;this.bounds.y=this._startPoint.y;this.bounds.width=0;this.bounds.height=0;this.emitEditShapeEvent(this.bounds,EditShapeStatus.IN_PROGRESS);return EVENT_HANDLED}shouldPaintFeature(t){return this._boundsCreated}shouldProcess(t){return t.type===GestureEventType.DRAG||t.type===GestureEventType.MOVE||t.type===GestureEventType.SINGLE_CLICK_UP}process(t,s){if(t.type===GestureEventType.SINGLE_CLICK_UP)this._clickCount++;if(2===this._clickCount)return EVENT_HANDLED;if(this._clickCount>2)return EVENT_HANDLED|REQUEST_DEACTIVATION;let e;try{e=s.onTerrainViewModelTransformation.transform(t.viewPoint)}catch(t){OutOfBoundsError.isOrThrow(t);return EVENT_HANDLED}this._snapPoint=SnapUtil.findClosestPoint(t,e,this.bounds,s.map);if(this._snapPoint)e=this._snapPoint;const n=Math.min(this._startPoint.x,e.x);const i=Math.max(this._startPoint.x,e.x);const o=Math.min(this._startPoint.y,e.y);const r=Math.max(this._startPoint.y,e.y);this.bounds.setTo2D(n,0,o,0);const a=this.bounds.focusPoint.copy();a.move2D(i,r);this.bounds.setToIncludePoint2D(a);this._boundsCreated=true;this.emitEditShapeEvent(this.bounds,EditShapeStatus.IN_PROGRESS);return EVENT_HANDLED}shouldDeactivate(t){const s=t.type===GestureEventType.DOUBLE_CLICK||t.type===GestureEventType.SINGLE_CLICK_CONFIRMED&&this._clickCount>=2;return t.type===GestureEventType.DRAG_END||s}deactivate(t,s){this._clickCount=0;this._startPoint=null;this._snapPoint=null;this._boundsCreated=false;this.emitEditShapeEvent(this.bounds,EditShapeStatus.FINISHED);return EVENT_HANDLED|REQUEST_FINISH}getCursor(){return"crosshair"}onDraw(t,s){SnapUtil.paintSnapIcon(t,this._snapPoint)}}