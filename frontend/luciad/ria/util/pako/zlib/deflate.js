import{common as utils}from"../utils/common.js";import{trees}from"./trees.js";import{adler32}from"./adler32.js";import{crc32}from"./crc32.js";import{messages as msg}from"./messages.js";var Z_NO_FLUSH=0;var Z_PARTIAL_FLUSH=1;var Z_FULL_FLUSH=3;var Z_FINISH=4;var Z_BLOCK=5;var Z_OK=0;var Z_STREAM_END=1;var Z_STREAM_ERROR=-2;var Z_DATA_ERROR=-3;var Z_BUF_ERROR=-5;var Z_DEFAULT_COMPRESSION=-1;var Z_FILTERED=1;var Z_HUFFMAN_ONLY=2;var Z_RLE=3;var Z_FIXED=4;var Z_DEFAULT_STRATEGY=0;var Z_UNKNOWN=2;var Z_DEFLATED=8;var MAX_MEM_LEVEL=9;var MAX_WBITS=15;var DEF_MEM_LEVEL=8;var LENGTH_CODES=29;var LITERALS=256;var L_CODES=LITERALS+1+LENGTH_CODES;var D_CODES=30;var BL_CODES=19;var HEAP_SIZE=2*L_CODES+1;var MAX_BITS=15;var MIN_MATCH=3;var MAX_MATCH=258;var MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1;var PRESET_DICT=32;var INIT_STATE=42;var EXTRA_STATE=69;var NAME_STATE=73;var COMMENT_STATE=91;var HCRC_STATE=103;var BUSY_STATE=113;var FINISH_STATE=666;var BS_NEED_MORE=1;var BS_BLOCK_DONE=2;var BS_FINISH_STARTED=3;var BS_FINISH_DONE=4;var OS_CODE=3;function err(t,e){t.msg=msg[e];return e}function rank(t){return(t<<1)-(t>4?9:0)}function zero(t){var e=t.length;while(--e>=0)t[e]=0}function flush_pending(t){var e=t.state;var a=e.pending;if(a>t.avail_out)a=t.avail_out;if(0===a)return;utils.arraySet(t.output,e.pending_buf,e.pending_out,a,t.next_out);t.next_out+=a;e.pending_out+=a;t.total_out+=a;t.avail_out-=a;e.pending-=a;if(0===e.pending)e.pending_out=0}function flush_block_only(t,e){trees._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e);t.block_start=t.strstart;flush_pending(t.strm)}function put_byte(t,e){t.pending_buf[t.pending++]=e}function putShortMSB(t,e){t.pending_buf[t.pending++]=e>>>8&255;t.pending_buf[t.pending++]=255&e}function read_buf(t,e,a,_){var r=t.avail_in;if(r>_)r=_;if(0===r)return 0;t.avail_in-=r;utils.arraySet(e,t.input,t.next_in,r,a);if(1===t.state.wrap)t.adler=adler32(t.adler,e,r,a);else if(2===t.state.wrap)t.adler=crc32(t.adler,e,r,a);t.next_in+=r;t.total_in+=r;return r}function longest_match(t,e){var a=t.max_chain_length;var _=t.strstart;var r;var i;var s=t.prev_length;var n=t.nice_match;var l=t.strstart>t.w_size-MIN_LOOKAHEAD?t.strstart-(t.w_size-MIN_LOOKAHEAD):0;var h=t.window;var f=t.w_mask;var o=t.prev;var d=t.strstart+MAX_MATCH;var u=h[_+s-1];var E=h[_+s];if(t.prev_length>=t.good_match)a>>=2;if(n>t.lookahead)n=t.lookahead;do{if(h[(r=e)+s]!==E||h[r+s-1]!==u||h[r]!==h[_]||h[++r]!==h[_+1])continue;_+=2;r++;do{}while(h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&h[++_]===h[++r]&&_<d);i=MAX_MATCH-(d-_);_=d-MAX_MATCH;if(i>s){t.match_start=e;s=i;if(i>=n)break;u=h[_+s-1];E=h[_+s]}}while((e=o[e&f])>l&&0!==--a);if(s<=t.lookahead)return s;return t.lookahead}function fill_window(t){var e=t.w_size;var a,_,r,i,s;do{i=t.window_size-t.lookahead-t.strstart;if(t.strstart>=e+(e-MIN_LOOKAHEAD)){utils.arraySet(t.window,t.window,e,e,0);t.match_start-=e;t.strstart-=e;t.block_start-=e;a=_=t.hash_size;do{r=t.head[--a];t.head[a]=r>=e?r-e:0}while(--_);a=_=e;do{r=t.prev[--a];t.prev[a]=r>=e?r-e:0}while(--_);i+=e}if(0===t.strm.avail_in)break;_=read_buf(t.strm,t.window,t.strstart+t.lookahead,i);t.lookahead+=_;if(t.lookahead+t.insert>=MIN_MATCH){s=t.strstart-t.insert;t.ins_h=t.window[s];t.ins_h=(t.ins_h<<t.hash_shift^t.window[s+1])&t.hash_mask;while(t.insert){t.ins_h=(t.ins_h<<t.hash_shift^t.window[s+MIN_MATCH-1])&t.hash_mask;t.prev[s&t.w_mask]=t.head[t.ins_h];t.head[t.ins_h]=s;s++;t.insert--;if(t.lookahead+t.insert<MIN_MATCH)break}}}while(t.lookahead<MIN_LOOKAHEAD&&0!==t.strm.avail_in)}function deflate_stored(t,e){var a=65535;if(a>t.pending_buf_size-5)a=t.pending_buf_size-5;for(;;){if(t.lookahead<=1){fill_window(t);if(0===t.lookahead&&e===Z_NO_FLUSH)return BS_NEED_MORE;if(0===t.lookahead)break}t.strstart+=t.lookahead;t.lookahead=0;var _=t.block_start+a;if(0===t.strstart||t.strstart>=_){t.lookahead=t.strstart-_;t.strstart=_;flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}if(t.strstart-t.block_start>=t.w_size-MIN_LOOKAHEAD){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}}t.insert=0;if(e===Z_FINISH){flush_block_only(t,true);if(0===t.strm.avail_out)return BS_FINISH_STARTED;return BS_FINISH_DONE}if(t.strstart>t.block_start){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}return BS_NEED_MORE}function deflate_fast(t,e){var a;var _;for(;;){if(t.lookahead<MIN_LOOKAHEAD){fill_window(t);if(t.lookahead<MIN_LOOKAHEAD&&e===Z_NO_FLUSH)return BS_NEED_MORE;if(0===t.lookahead)break}a=0;if(t.lookahead>=MIN_MATCH){t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+MIN_MATCH-1])&t.hash_mask;a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h];t.head[t.ins_h]=t.strstart}if(0!==a&&t.strstart-a<=t.w_size-MIN_LOOKAHEAD)t.match_length=longest_match(t,a);if(t.match_length>=MIN_MATCH){_=trees._tr_tally(t,t.strstart-t.match_start,t.match_length-MIN_MATCH);t.lookahead-=t.match_length;if(t.match_length<=t.max_lazy_match&&t.lookahead>=MIN_MATCH){t.match_length--;do{t.strstart++;t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+MIN_MATCH-1])&t.hash_mask;a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h];t.head[t.ins_h]=t.strstart}while(0!==--t.match_length);t.strstart++}else{t.strstart+=t.match_length;t.match_length=0;t.ins_h=t.window[t.strstart];t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask}}else{_=trees._tr_tally(t,0,t.window[t.strstart]);t.lookahead--;t.strstart++}if(_){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}}t.insert=t.strstart<MIN_MATCH-1?t.strstart:MIN_MATCH-1;if(e===Z_FINISH){flush_block_only(t,true);if(0===t.strm.avail_out)return BS_FINISH_STARTED;return BS_FINISH_DONE}if(t.last_lit){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}return BS_BLOCK_DONE}function deflate_slow(t,e){var a;var _;var r;for(;;){if(t.lookahead<MIN_LOOKAHEAD){fill_window(t);if(t.lookahead<MIN_LOOKAHEAD&&e===Z_NO_FLUSH)return BS_NEED_MORE;if(0===t.lookahead)break}a=0;if(t.lookahead>=MIN_MATCH){t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+MIN_MATCH-1])&t.hash_mask;a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h];t.head[t.ins_h]=t.strstart}t.prev_length=t.match_length;t.prev_match=t.match_start;t.match_length=MIN_MATCH-1;if(0!==a&&t.prev_length<t.max_lazy_match&&t.strstart-a<=t.w_size-MIN_LOOKAHEAD){t.match_length=longest_match(t,a);if(t.match_length<=5&&(t.strategy===Z_FILTERED||t.match_length===MIN_MATCH&&t.strstart-t.match_start>4096))t.match_length=MIN_MATCH-1}if(t.prev_length>=MIN_MATCH&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-MIN_MATCH;_=trees._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-MIN_MATCH);t.lookahead-=t.prev_length-1;t.prev_length-=2;do{if(++t.strstart<=r){t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+MIN_MATCH-1])&t.hash_mask;a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h];t.head[t.ins_h]=t.strstart}}while(0!==--t.prev_length);t.match_available=0;t.match_length=MIN_MATCH-1;t.strstart++;if(_){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}}else if(t.match_available){if(_=trees._tr_tally(t,0,t.window[t.strstart-1]))flush_block_only(t,false);t.strstart++;t.lookahead--;if(0===t.strm.avail_out)return BS_NEED_MORE}else{t.match_available=1;t.strstart++;t.lookahead--}}if(t.match_available){_=trees._tr_tally(t,0,t.window[t.strstart-1]);t.match_available=0}t.insert=t.strstart<MIN_MATCH-1?t.strstart:MIN_MATCH-1;if(e===Z_FINISH){flush_block_only(t,true);if(0===t.strm.avail_out)return BS_FINISH_STARTED;return BS_FINISH_DONE}if(t.last_lit){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}return BS_BLOCK_DONE}function deflate_rle(t,e){var a;var _;var r,i;var s=t.window;for(;;){if(t.lookahead<=MAX_MATCH){fill_window(t);if(t.lookahead<=MAX_MATCH&&e===Z_NO_FLUSH)return BS_NEED_MORE;if(0===t.lookahead)break}t.match_length=0;if(t.lookahead>=MIN_MATCH&&t.strstart>0)if((_=s[r=t.strstart-1])===s[++r]&&_===s[++r]&&_===s[++r]){i=t.strstart+MAX_MATCH;do{}while(_===s[++r]&&_===s[++r]&&_===s[++r]&&_===s[++r]&&_===s[++r]&&_===s[++r]&&_===s[++r]&&_===s[++r]&&r<i);t.match_length=MAX_MATCH-(i-r);if(t.match_length>t.lookahead)t.match_length=t.lookahead}if(t.match_length>=MIN_MATCH){a=trees._tr_tally(t,1,t.match_length-MIN_MATCH);t.lookahead-=t.match_length;t.strstart+=t.match_length;t.match_length=0}else{a=trees._tr_tally(t,0,t.window[t.strstart]);t.lookahead--;t.strstart++}if(a){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}}t.insert=0;if(e===Z_FINISH){flush_block_only(t,true);if(0===t.strm.avail_out)return BS_FINISH_STARTED;return BS_FINISH_DONE}if(t.last_lit){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}return BS_BLOCK_DONE}function deflate_huff(t,e){var a;for(;;){if(0===t.lookahead){fill_window(t);if(0===t.lookahead){if(e===Z_NO_FLUSH)return BS_NEED_MORE;break}}t.match_length=0;a=trees._tr_tally(t,0,t.window[t.strstart]);t.lookahead--;t.strstart++;if(a){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}}t.insert=0;if(e===Z_FINISH){flush_block_only(t,true);if(0===t.strm.avail_out)return BS_FINISH_STARTED;return BS_FINISH_DONE}if(t.last_lit){flush_block_only(t,false);if(0===t.strm.avail_out)return BS_NEED_MORE}return BS_BLOCK_DONE}function Config(t,e,a,_,r){this.good_length=t;this.max_lazy=e;this.nice_length=a;this.max_chain=_;this.func=r}var configuration_table;configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];function lm_init(t){t.window_size=2*t.w_size;zero(t.head);t.max_lazy_match=configuration_table[t.level].max_lazy;t.good_match=configuration_table[t.level].good_length;t.nice_match=configuration_table[t.level].nice_length;t.max_chain_length=configuration_table[t.level].max_chain;t.strstart=0;t.block_start=0;t.lookahead=0;t.insert=0;t.match_length=t.prev_length=MIN_MATCH-1;t.match_available=0;t.ins_h=0}function DeflateState(){this.strm=null;this.status=0;this.pending_buf=null;this.pending_buf_size=0;this.pending_out=0;this.pending=0;this.wrap=0;this.gzhead=null;this.gzindex=0;this.method=Z_DEFLATED;this.last_flush=-1;this.w_size=0;this.w_bits=0;this.w_mask=0;this.window=null;this.window_size=0;this.prev=null;this.head=null;this.ins_h=0;this.hash_size=0;this.hash_bits=0;this.hash_mask=0;this.hash_shift=0;this.block_start=0;this.match_length=0;this.prev_match=0;this.match_available=0;this.strstart=0;this.match_start=0;this.lookahead=0;this.prev_length=0;this.max_chain_length=0;this.max_lazy_match=0;this.level=0;this.strategy=0;this.good_match=0;this.nice_match=0;this.dyn_ltree=new utils.Buf16(2*HEAP_SIZE);this.dyn_dtree=new utils.Buf16(2*(2*D_CODES+1));this.bl_tree=new utils.Buf16(2*(2*BL_CODES+1));zero(this.dyn_ltree);zero(this.dyn_dtree);zero(this.bl_tree);this.l_desc=null;this.d_desc=null;this.bl_desc=null;this.bl_count=new utils.Buf16(MAX_BITS+1);this.heap=new utils.Buf16(2*L_CODES+1);zero(this.heap);this.heap_len=0;this.heap_max=0;this.depth=new utils.Buf16(2*L_CODES+1);zero(this.depth);this.l_buf=0;this.lit_bufsize=0;this.last_lit=0;this.d_buf=0;this.opt_len=0;this.static_len=0;this.matches=0;this.insert=0;this.bi_buf=0;this.bi_valid=0}function deflateResetKeep(t){var e;if(!t||!t.state)return err(t,Z_STREAM_ERROR);t.total_in=t.total_out=0;t.data_type=Z_UNKNOWN;(e=t.state).pending=0;e.pending_out=0;if(e.wrap<0)e.wrap=-e.wrap;e.status=e.wrap?INIT_STATE:BUSY_STATE;t.adler=2===e.wrap?0:1;e.last_flush=Z_NO_FLUSH;trees._tr_init(e);return Z_OK}function deflateReset(t){var e=deflateResetKeep(t);if(e===Z_OK)lm_init(t.state);return e}function deflateSetHeader(t,e){if(!t||!t.state)return Z_STREAM_ERROR;if(2!==t.state.wrap)return Z_STREAM_ERROR;t.state.gzhead=e;return Z_OK}function deflateInit2(t,e,a,_,r,i){if(!t)return Z_STREAM_ERROR;var s=1;if(e===Z_DEFAULT_COMPRESSION)e=6;if(_<0){s=0;_=-_}else if(_>15){s=2;_-=16}if(r<1||r>MAX_MEM_LEVEL||a!==Z_DEFLATED||_<8||_>15||e<0||e>9||i<0||i>Z_FIXED)return err(t,Z_STREAM_ERROR);if(8===_)_=9;var n=new DeflateState;t.state=n;n.strm=t;n.wrap=s;n.gzhead=null;n.w_bits=_;n.w_size=1<<n.w_bits;n.w_mask=n.w_size-1;n.hash_bits=r+7;n.hash_size=1<<n.hash_bits;n.hash_mask=n.hash_size-1;n.hash_shift=~~((n.hash_bits+MIN_MATCH-1)/MIN_MATCH);n.window=new utils.Buf8(2*n.w_size);n.head=new utils.Buf16(n.hash_size);n.prev=new utils.Buf16(n.w_size);n.lit_bufsize=1<<r+6;n.pending_buf_size=4*n.lit_bufsize;n.pending_buf=new utils.Buf8(n.pending_buf_size);n.d_buf=1*n.lit_bufsize;n.l_buf=(1+2)*n.lit_bufsize;n.level=e;n.strategy=i;n.method=a;return deflateReset(t)}function deflateInit(t,e){return deflateInit2(t,e,Z_DEFLATED,MAX_WBITS,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY)}function deflateFunc(t,e){var a,_;var r,i;if(!t||!t.state||e>Z_BLOCK||e<0)return t?err(t,Z_STREAM_ERROR):Z_STREAM_ERROR;_=t.state;if(!t.output||!t.input&&0!==t.avail_in||_.status===FINISH_STATE&&e!==Z_FINISH)return err(t,0===t.avail_out?Z_BUF_ERROR:Z_STREAM_ERROR);_.strm=t;a=_.last_flush;_.last_flush=e;if(_.status===INIT_STATE)if(2===_.wrap){t.adler=0;put_byte(_,31);put_byte(_,139);put_byte(_,8);if(!_.gzhead){put_byte(_,0);put_byte(_,0);put_byte(_,0);put_byte(_,0);put_byte(_,0);put_byte(_,9===_.level?2:_.strategy>=Z_HUFFMAN_ONLY||_.level<2?4:0);put_byte(_,OS_CODE);_.status=BUSY_STATE}else{put_byte(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(!_.gzhead.extra?0:4)+(!_.gzhead.name?0:8)+(!_.gzhead.comment?0:16));put_byte(_,255&_.gzhead.time);put_byte(_,_.gzhead.time>>8&255);put_byte(_,_.gzhead.time>>16&255);put_byte(_,_.gzhead.time>>24&255);put_byte(_,9===_.level?2:_.strategy>=Z_HUFFMAN_ONLY||_.level<2?4:0);put_byte(_,255&_.gzhead.os);if(_.gzhead.extra&&_.gzhead.extra.length){put_byte(_,255&_.gzhead.extra.length);put_byte(_,_.gzhead.extra.length>>8&255)}if(_.gzhead.hcrc)t.adler=crc32(t.adler,_.pending_buf,_.pending,0);_.gzindex=0;_.status=EXTRA_STATE}}else{var s=Z_DEFLATED+(_.w_bits-8<<4)<<8;var n=-1;if(_.strategy>=Z_HUFFMAN_ONLY||_.level<2)n=0;else if(_.level<6)n=1;else if(6===_.level)n=2;else n=3;s|=n<<6;if(0!==_.strstart)s|=PRESET_DICT;s+=31-s%31;_.status=BUSY_STATE;putShortMSB(_,s);if(0!==_.strstart){putShortMSB(_,t.adler>>>16);putShortMSB(_,65535&t.adler)}t.adler=1}if(_.status===EXTRA_STATE)if(_.gzhead.extra){r=_.pending;while(_.gzindex<(65535&_.gzhead.extra.length)){if(_.pending===_.pending_buf_size){if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);flush_pending(t);r=_.pending;if(_.pending===_.pending_buf_size)break}put_byte(_,255&_.gzhead.extra[_.gzindex]);_.gzindex++}if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);if(_.gzindex===_.gzhead.extra.length){_.gzindex=0;_.status=NAME_STATE}}else _.status=NAME_STATE;if(_.status===NAME_STATE)if(_.gzhead.name){r=_.pending;do{if(_.pending===_.pending_buf_size){if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);flush_pending(t);r=_.pending;if(_.pending===_.pending_buf_size){i=1;break}}if(_.gzindex<_.gzhead.name.length)i=255&_.gzhead.name.charCodeAt(_.gzindex++);else i=0;put_byte(_,i)}while(0!==i);if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);if(0===i){_.gzindex=0;_.status=COMMENT_STATE}}else _.status=COMMENT_STATE;if(_.status===COMMENT_STATE)if(_.gzhead.comment){r=_.pending;do{if(_.pending===_.pending_buf_size){if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);flush_pending(t);r=_.pending;if(_.pending===_.pending_buf_size){i=1;break}}if(_.gzindex<_.gzhead.comment.length)i=255&_.gzhead.comment.charCodeAt(_.gzindex++);else i=0;put_byte(_,i)}while(0!==i);if(_.gzhead.hcrc&&_.pending>r)t.adler=crc32(t.adler,_.pending_buf,_.pending-r,r);if(0===i)_.status=HCRC_STATE}else _.status=HCRC_STATE;if(_.status===HCRC_STATE)if(_.gzhead.hcrc){if(_.pending+2>_.pending_buf_size)flush_pending(t);if(_.pending+2<=_.pending_buf_size){put_byte(_,255&t.adler);put_byte(_,t.adler>>8&255);t.adler=0;_.status=BUSY_STATE}}else _.status=BUSY_STATE;if(0!==_.pending){flush_pending(t);if(0===t.avail_out){_.last_flush=-1;return Z_OK}}else if(0===t.avail_in&&rank(e)<=rank(a)&&e!==Z_FINISH)return err(t,Z_BUF_ERROR);if(_.status===FINISH_STATE&&0!==t.avail_in)return err(t,Z_BUF_ERROR);if(0!==t.avail_in||0!==_.lookahead||e!==Z_NO_FLUSH&&_.status!==FINISH_STATE){var l=_.strategy===Z_HUFFMAN_ONLY?deflate_huff(_,e):_.strategy===Z_RLE?deflate_rle(_,e):configuration_table[_.level].func(_,e);if(l===BS_FINISH_STARTED||l===BS_FINISH_DONE)_.status=FINISH_STATE;if(l===BS_NEED_MORE||l===BS_FINISH_STARTED){if(0===t.avail_out)_.last_flush=-1;return Z_OK}if(l===BS_BLOCK_DONE){if(e===Z_PARTIAL_FLUSH)trees._tr_align(_);else if(e!==Z_BLOCK){trees._tr_stored_block(_,0,0,false);if(e===Z_FULL_FLUSH){zero(_.head);if(0===_.lookahead){_.strstart=0;_.block_start=0;_.insert=0}}}flush_pending(t);if(0===t.avail_out){_.last_flush=-1;return Z_OK}}}if(e!==Z_FINISH)return Z_OK;if(_.wrap<=0)return Z_STREAM_END;if(2===_.wrap){put_byte(_,255&t.adler);put_byte(_,t.adler>>8&255);put_byte(_,t.adler>>16&255);put_byte(_,t.adler>>24&255);put_byte(_,255&t.total_in);put_byte(_,t.total_in>>8&255);put_byte(_,t.total_in>>16&255);put_byte(_,t.total_in>>24&255)}else{putShortMSB(_,t.adler>>>16);putShortMSB(_,65535&t.adler)}flush_pending(t);if(_.wrap>0)_.wrap=-_.wrap;return 0!==_.pending?Z_OK:Z_STREAM_END}function deflateEnd(t){var e;if(!t||!t.state)return Z_STREAM_ERROR;if((e=t.state.status)!==INIT_STATE&&e!==EXTRA_STATE&&e!==NAME_STATE&&e!==COMMENT_STATE&&e!==HCRC_STATE&&e!==BUSY_STATE&&e!==FINISH_STATE)return err(t,Z_STREAM_ERROR);t.state=null;return e===BUSY_STATE?err(t,Z_DATA_ERROR):Z_OK}function deflateSetDictionary(t,e){var a=e.length;var _;var r,i;var s;var n;var l;var h;var f;if(!t||!t.state)return Z_STREAM_ERROR;if(2===(s=(_=t.state).wrap)||1===s&&_.status!==INIT_STATE||_.lookahead)return Z_STREAM_ERROR;if(1===s)t.adler=adler32(t.adler,e,a,0);_.wrap=0;if(a>=_.w_size){if(0===s){zero(_.head);_.strstart=0;_.block_start=0;_.insert=0}f=new utils.Buf8(_.w_size);utils.arraySet(f,e,a-_.w_size,_.w_size,0);e=f;a=_.w_size}n=t.avail_in;l=t.next_in;h=t.input;t.avail_in=a;t.next_in=0;t.input=e;fill_window(_);while(_.lookahead>=MIN_MATCH){r=_.strstart;i=_.lookahead-(MIN_MATCH-1);do{_.ins_h=(_.ins_h<<_.hash_shift^_.window[r+MIN_MATCH-1])&_.hash_mask;_.prev[r&_.w_mask]=_.head[_.ins_h];_.head[_.ins_h]=r;r++}while(--i);_.strstart=r;_.lookahead=MIN_MATCH-1;fill_window(_)}_.strstart+=_.lookahead;_.block_start=_.strstart;_.insert=_.lookahead;_.lookahead=0;_.match_length=_.prev_length=MIN_MATCH-1;_.match_available=0;t.next_in=l;t.input=h;t.avail_in=n;_.wrap=s;return Z_OK}export var deflate={deflateInit:deflateInit,deflateInit2:deflateInit2,deflateReset:deflateReset,deflateResetKeep:deflateResetKeep,deflateSetHeader:deflateSetHeader,deflate:deflateFunc,deflateEnd:deflateEnd,deflateSetDictionary:deflateSetDictionary,deflateInfo:"pako deflate (from Nodeca project)"};