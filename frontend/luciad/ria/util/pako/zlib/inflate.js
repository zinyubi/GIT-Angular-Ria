import{common as utils}from"../utils/common.js";import{adler32}from"./adler32.js";import{crc32}from"./crc32.js";import{inffast as inflate_fast}from"./inffast.js";import{inftrees as inflate_table}from"./inftrees.js";var CODES=0;var LENS=1;var DISTS=2;var Z_FINISH=4;var Z_BLOCK=5;var Z_TREES=6;var Z_OK=0;var Z_STREAM_END=1;var Z_NEED_DICT=2;var Z_STREAM_ERROR=-2;var Z_DATA_ERROR=-3;var Z_MEM_ERROR=-4;var Z_BUF_ERROR=-5;var Z_DEFLATED=8;var HEAD=1;var FLAGS=2;var TIME=3;var OS=4;var EXLEN=5;var EXTRA=6;var NAME=7;var COMMENT=8;var HCRC=9;var DICTID=10;var DICT=11;var TYPE=12;var TYPEDO=13;var STORED=14;var COPY_=15;var COPY=16;var TABLE=17;var LENLENS=18;var CODELENS=19;var LEN_=20;var LEN=21;var LENEXT=22;var DIST=23;var DISTEXT=24;var MATCH=25;var LIT=26;var CHECK=27;var LENGTH=28;var DONE=29;var BAD=30;var MEM=31;var SYNC=32;var ENOUGH_LENS=852;var ENOUGH_DISTS=592;var MAX_WBITS=15;var DEF_WBITS=MAX_WBITS;function zswap32(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function InflateState(){this.mode=0;this.last=false;this.wrap=0;this.havedict=false;this.flags=0;this.dmax=0;this.check=0;this.total=0;this.head=null;this.wbits=0;this.wsize=0;this.whave=0;this.wnext=0;this.window=null;this.hold=0;this.bits=0;this.length=0;this.offset=0;this.extra=0;this.lencode=null;this.distcode=null;this.lenbits=0;this.distbits=0;this.ncode=0;this.nlen=0;this.ndist=0;this.have=0;this.next=null;this.lens=new utils.Buf16(320);this.work=new utils.Buf16(288);this.lendyn=null;this.distdyn=null;this.sane=0;this.back=0;this.was=0}function inflateResetKeep(e){var a;if(!e||!e.state)return Z_STREAM_ERROR;a=e.state;e.total_in=e.total_out=a.total=0;e.msg="";if(a.wrap)e.adler=1&a.wrap;a.mode=HEAD;a.last=0;a.havedict=0;a.dmax=32768;a.head=null;a.hold=0;a.bits=0;a.lencode=a.lendyn=new utils.Buf32(ENOUGH_LENS);a.distcode=a.distdyn=new utils.Buf32(ENOUGH_DISTS);a.sane=1;a.back=-1;return Z_OK}function inflateReset(e){var a;if(!e||!e.state)return Z_STREAM_ERROR;(a=e.state).wsize=0;a.whave=0;a.wnext=0;return inflateResetKeep(e)}function inflateReset2(e,a){var i;var t;if(!e||!e.state)return Z_STREAM_ERROR;t=e.state;if(a<0){i=0;a=-a}else{i=(a>>4)+1;if(a<48)a&=15}if(a&&(a<8||a>15))return Z_STREAM_ERROR;if(null!==t.window&&t.wbits!==a)t.window=null;t.wrap=i;t.wbits=a;return inflateReset(e)}function inflateInit2(e,a){var i;var t;if(!e)return Z_STREAM_ERROR;t=new InflateState;e.state=t;t.window=null;if((i=inflateReset2(e,a))!==Z_OK)e.state=null;return i}function inflateInit(e){return inflateInit2(e,DEF_WBITS)}var virgin=true;var lenfix,distfix;function fixedtables(e){if(virgin){var a;lenfix=new utils.Buf32(512);distfix=new utils.Buf32(32);a=0;while(a<144)e.lens[a++]=8;while(a<256)e.lens[a++]=9;while(a<280)e.lens[a++]=7;while(a<288)e.lens[a++]=8;inflate_table(LENS,e.lens,0,288,lenfix,0,e.work,{bits:9});a=0;while(a<32)e.lens[a++]=5;inflate_table(DISTS,e.lens,0,32,distfix,0,e.work,{bits:5});virgin=false}e.lencode=lenfix;e.lenbits=9;e.distcode=distfix;e.distbits=5}function updatewindow(e,a,i,t){var n;var r=e.state;if(null===r.window){r.wsize=1<<r.wbits;r.wnext=0;r.whave=0;r.window=new utils.Buf8(r.wsize)}if(t>=r.wsize){utils.arraySet(r.window,a,i-r.wsize,r.wsize,0);r.wnext=0;r.whave=r.wsize}else{if((n=r.wsize-r.wnext)>t)n=t;utils.arraySet(r.window,a,i-t,n,r.wnext);if(t-=n){utils.arraySet(r.window,a,i-t,t,0);r.wnext=t;r.whave=r.wsize}else{r.wnext+=n;if(r.wnext===r.wsize)r.wnext=0;if(r.whave<r.wsize)r.whave+=n}}return 0}function inflateFunc(e,a){var i;var t,n;var r;var s;var l,f;var d;var o;var c,h;var E;var b;var v;var w=0;var k,_,m;var u,R,T;var D;var g;var S=new utils.Buf8(4);var A;var x;var O=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Z_STREAM_ERROR;if((i=e.state).mode===TYPE)i.mode=TYPEDO;s=e.next_out;n=e.output;f=e.avail_out;r=e.next_in;t=e.input;l=e.avail_in;d=i.hold;o=i.bits;c=l;h=f;g=Z_OK;e:for(;;)switch(i.mode){case HEAD:if(0===i.wrap){i.mode=TYPEDO;break}while(o<16){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(2&i.wrap&&35615===d){i.check=0;S[0]=255&d;S[1]=d>>>8&255;i.check=crc32(i.check,S,2,0);d=0;o=0;i.mode=FLAGS;break}i.flags=0;if(i.head)i.head.done=false;if(!(1&i.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check";i.mode=BAD;break}if((15&d)!==Z_DEFLATED){e.msg="unknown compression method";i.mode=BAD;break}o-=4;D=(15&(d>>>=4))+8;if(0===i.wbits)i.wbits=D;else if(D>i.wbits){e.msg="invalid window size";i.mode=BAD;break}i.dmax=1<<D;e.adler=i.check=1;i.mode=512&d?DICTID:TYPE;d=0;o=0;break;case FLAGS:while(o<16){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.flags=d;if((255&i.flags)!==Z_DEFLATED){e.msg="unknown compression method";i.mode=BAD;break}if(57344&i.flags){e.msg="unknown header flags set";i.mode=BAD;break}if(i.head)i.head.text=d>>8&1;if(512&i.flags){S[0]=255&d;S[1]=d>>>8&255;i.check=crc32(i.check,S,2,0)}d=0;o=0;i.mode=TIME;case TIME:while(o<32){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(i.head)i.head.time=d;if(512&i.flags){S[0]=255&d;S[1]=d>>>8&255;S[2]=d>>>16&255;S[3]=d>>>24&255;i.check=crc32(i.check,S,4,0)}d=0;o=0;i.mode=OS;case OS:while(o<16){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(i.head){i.head.xflags=255&d;i.head.os=d>>8}if(512&i.flags){S[0]=255&d;S[1]=d>>>8&255;i.check=crc32(i.check,S,2,0)}d=0;o=0;i.mode=EXLEN;case EXLEN:if(1024&i.flags){while(o<16){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.length=d;if(i.head)i.head.extra_len=d;if(512&i.flags){S[0]=255&d;S[1]=d>>>8&255;i.check=crc32(i.check,S,2,0)}d=0;o=0}else if(i.head)i.head.extra=null;i.mode=EXTRA;case EXTRA:if(1024&i.flags){if((E=i.length)>l)E=l;if(E){if(i.head){D=i.head.extra_len-i.length;if(!i.head.extra)i.head.extra=new Array(i.head.extra_len);utils.arraySet(i.head.extra,t,r,E,D)}if(512&i.flags)i.check=crc32(i.check,t,E,r);l-=E;r+=E;i.length-=E}if(i.length)break e}i.length=0;i.mode=NAME;case NAME:if(2048&i.flags){if(0===l)break e;E=0;do{D=t[r+E++];if(i.head&&D&&i.length<65536)i.head.name+=String.fromCharCode(D)}while(D&&E<l);if(512&i.flags)i.check=crc32(i.check,t,E,r);l-=E;r+=E;if(D)break e}else if(i.head)i.head.name=null;i.length=0;i.mode=COMMENT;case COMMENT:if(4096&i.flags){if(0===l)break e;E=0;do{D=t[r+E++];if(i.head&&D&&i.length<65536)i.head.comment+=String.fromCharCode(D)}while(D&&E<l);if(512&i.flags)i.check=crc32(i.check,t,E,r);l-=E;r+=E;if(D)break e}else if(i.head)i.head.comment=null;i.mode=HCRC;case HCRC:if(512&i.flags){while(o<16){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(d!==(65535&i.check)){e.msg="header crc mismatch";i.mode=BAD;break}d=0;o=0}if(i.head){i.head.hcrc=i.flags>>9&1;i.head.done=true}e.adler=i.check=0;i.mode=TYPE;break;case DICTID:while(o<32){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}e.adler=i.check=zswap32(d);d=0;o=0;i.mode=DICT;case DICT:if(0===i.havedict){e.next_out=s;e.avail_out=f;e.next_in=r;e.avail_in=l;i.hold=d;i.bits=o;return Z_NEED_DICT}e.adler=i.check=1;i.mode=TYPE;case TYPE:if(a===Z_BLOCK||a===Z_TREES)break e;case TYPEDO:if(i.last){d>>>=7&o;o-=7&o;i.mode=CHECK;break}while(o<3){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.last=1&d;o-=1;switch(3&(d>>>=1)){case 0:i.mode=STORED;break;case 1:fixedtables(i);i.mode=LEN_;if(a===Z_TREES){d>>>=2;o-=2;break e}break;case 2:i.mode=TABLE;break;case 3:e.msg="invalid block type";i.mode=BAD}d>>>=2;o-=2;break;case STORED:d>>>=7&o;o-=7&o;while(o<32){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if((65535&d)!==(d>>>16^65535)){e.msg="invalid stored block lengths";i.mode=BAD;break}i.length=65535&d;d=0;o=0;i.mode=COPY_;if(a===Z_TREES)break e;case COPY_:i.mode=COPY;case COPY:if(E=i.length){if(E>l)E=l;if(E>f)E=f;if(0===E)break e;utils.arraySet(n,t,r,E,s);l-=E;r+=E;f-=E;s+=E;i.length-=E;break}i.mode=TYPE;break;case TABLE:while(o<14){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.nlen=(31&d)+257;d>>>=5;o-=5;i.ndist=(31&d)+1;d>>>=5;o-=5;i.ncode=(15&d)+4;d>>>=4;o-=4;if(i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols";i.mode=BAD;break}i.have=0;i.mode=LENLENS;case LENLENS:while(i.have<i.ncode){while(o<3){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.lens[O[i.have++]]=7&d;d>>>=3;o-=3}while(i.have<19)i.lens[O[i.have++]]=0;i.lencode=i.lendyn;i.lenbits=7;A={bits:i.lenbits};g=inflate_table(CODES,i.lens,0,19,i.lencode,0,i.work,A);i.lenbits=A.bits;if(g){e.msg="invalid code lengths set";i.mode=BAD;break}i.have=0;i.mode=CODELENS;case CODELENS:while(i.have<i.nlen+i.ndist){for(;;){_=(w=i.lencode[d&(1<<i.lenbits)-1])>>>16&255;m=65535&w;if((k=w>>>24)<=o)break;if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(m<16){d>>>=k;o-=k;i.lens[i.have++]=m}else{if(16===m){x=k+2;while(o<x){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}d>>>=k;o-=k;if(0===i.have){e.msg="invalid bit length repeat";i.mode=BAD;break}D=i.lens[i.have-1];E=3+(3&d);d>>>=2;o-=2}else if(17===m){x=k+3;while(o<x){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}o-=k;D=0;E=3+(7&(d>>>=k));d>>>=3;o-=3}else{x=k+7;while(o<x){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}o-=k;D=0;E=11+(127&(d>>>=k));d>>>=7;o-=7}if(i.have+E>i.nlen+i.ndist){e.msg="invalid bit length repeat";i.mode=BAD;break}while(E--)i.lens[i.have++]=D}}if(i.mode===BAD)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block";i.mode=BAD;break}i.lenbits=9;A={bits:i.lenbits};g=inflate_table(LENS,i.lens,0,i.nlen,i.lencode,0,i.work,A);i.lenbits=A.bits;if(g){e.msg="invalid literal/lengths set";i.mode=BAD;break}i.distbits=6;i.distcode=i.distdyn;A={bits:i.distbits};g=inflate_table(DISTS,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,A);i.distbits=A.bits;if(g){e.msg="invalid distances set";i.mode=BAD;break}i.mode=LEN_;if(a===Z_TREES)break e;case LEN_:i.mode=LEN;case LEN:if(l>=6&&f>=258){e.next_out=s;e.avail_out=f;e.next_in=r;e.avail_in=l;i.hold=d;i.bits=o;inflate_fast(e,h);s=e.next_out;n=e.output;f=e.avail_out;r=e.next_in;t=e.input;l=e.avail_in;d=i.hold;o=i.bits;if(i.mode===TYPE)i.back=-1;break}i.back=0;for(;;){_=(w=i.lencode[d&(1<<i.lenbits)-1])>>>16&255;m=65535&w;if((k=w>>>24)<=o)break;if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(_&&0===(240&_)){u=k;R=_;T=m;for(;;){_=(w=i.lencode[T+((d&(1<<u+R)-1)>>u)])>>>16&255;m=65535&w;if(u+(k=w>>>24)<=o)break;if(0===l)break e;l--;d+=t[r++]<<o;o+=8}d>>>=u;o-=u;i.back+=u}d>>>=k;o-=k;i.back+=k;i.length=m;if(0===_){i.mode=LIT;break}if(32&_){i.back=-1;i.mode=TYPE;break}if(64&_){e.msg="invalid literal/length code";i.mode=BAD;break}i.extra=15&_;i.mode=LENEXT;case LENEXT:if(i.extra){x=i.extra;while(o<x){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.length+=d&(1<<i.extra)-1;d>>>=i.extra;o-=i.extra;i.back+=i.extra}i.was=i.length;i.mode=DIST;case DIST:for(;;){_=(w=i.distcode[d&(1<<i.distbits)-1])>>>16&255;m=65535&w;if((k=w>>>24)<=o)break;if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(0===(240&_)){u=k;R=_;T=m;for(;;){_=(w=i.distcode[T+((d&(1<<u+R)-1)>>u)])>>>16&255;m=65535&w;if(u+(k=w>>>24)<=o)break;if(0===l)break e;l--;d+=t[r++]<<o;o+=8}d>>>=u;o-=u;i.back+=u}d>>>=k;o-=k;i.back+=k;if(64&_){e.msg="invalid distance code";i.mode=BAD;break}i.offset=m;i.extra=15&_;i.mode=DISTEXT;case DISTEXT:if(i.extra){x=i.extra;while(o<x){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}i.offset+=d&(1<<i.extra)-1;d>>>=i.extra;o-=i.extra;i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back";i.mode=BAD;break}i.mode=MATCH;case MATCH:if(0===f)break e;E=h-f;if(i.offset>E){if((E=i.offset-E)>i.whave)if(i.sane){e.msg="invalid distance too far back";i.mode=BAD;break}if(E>i.wnext){E-=i.wnext;b=i.wsize-E}else b=i.wnext-E;if(E>i.length)E=i.length;v=i.window}else{v=n;b=s-i.offset;E=i.length}if(E>f)E=f;f-=E;i.length-=E;do{n[s++]=v[b++]}while(--E);if(0===i.length)i.mode=LEN;break;case LIT:if(0===f)break e;n[s++]=i.length;f--;i.mode=LEN;break;case CHECK:if(i.wrap){while(o<32){if(0===l)break e;l--;d|=t[r++]<<o;o+=8}h-=f;e.total_out+=h;i.total+=h;if(h)e.adler=i.check=i.flags?crc32(i.check,n,h,s-h):adler32(i.check,n,h,s-h);h=f;if((i.flags?d:zswap32(d))!==i.check){e.msg="incorrect data check";i.mode=BAD;break}d=0;o=0}i.mode=LENGTH;case LENGTH:if(i.wrap&&i.flags){while(o<32){if(0===l)break e;l--;d+=t[r++]<<o;o+=8}if(d!==(4294967295&i.total)){e.msg="incorrect length check";i.mode=BAD;break}d=0;o=0}i.mode=DONE;case DONE:g=Z_STREAM_END;break e;case BAD:g=Z_DATA_ERROR;break e;case MEM:return Z_MEM_ERROR;case SYNC:default:return Z_STREAM_ERROR}e.next_out=s;e.avail_out=f;e.next_in=r;e.avail_in=l;i.hold=d;i.bits=o;if(i.wsize||h!==e.avail_out&&i.mode<BAD&&(i.mode<CHECK||a!==Z_FINISH))if(updatewindow(e,e.output,e.next_out,h-e.avail_out)){i.mode=MEM;return Z_MEM_ERROR}c-=e.avail_in;h-=e.avail_out;e.total_in+=c;e.total_out+=h;i.total+=h;if(i.wrap&&h)e.adler=i.check=i.flags?crc32(i.check,n,h,e.next_out-h):adler32(i.check,n,h,e.next_out-h);e.data_type=i.bits+(i.last?64:0)+(i.mode===TYPE?128:0)+(i.mode===LEN_||i.mode===COPY_?256:0);if((0===c&&0===h||a===Z_FINISH)&&g===Z_OK)g=Z_BUF_ERROR;return g}function inflateEnd(e){if(!e||!e.state)return Z_STREAM_ERROR;var a=e.state;if(a.window)a.window=null;e.state=null;return Z_OK}function inflateGetHeader(e,a){var i;if(!e||!e.state)return Z_STREAM_ERROR;if(0===(2&(i=e.state).wrap))return Z_STREAM_ERROR;i.head=a;a.done=false;return Z_OK}function inflateSetDictionary(e,a){var i=a.length;var t;var n;var r;if(!e||!e.state)return Z_STREAM_ERROR;if(0!==(t=e.state).wrap&&t.mode!==DICT)return Z_STREAM_ERROR;if(t.mode===DICT)if((n=adler32(n=1,a,i,0))!==t.check)return Z_DATA_ERROR;if(r=updatewindow(e,a,i,i)){t.mode=MEM;return Z_MEM_ERROR}t.havedict=1;return Z_OK}export var inflate={inflateReset:inflateReset,inflateReset2:inflateReset2,inflateResetKeep:inflateResetKeep,inflateInit:inflateInit,inflateInit2:inflateInit2,inflate:inflateFunc,inflateEnd:inflateEnd,inflateGetHeader:inflateGetHeader,inflateSetDictionary:inflateSetDictionary,inflateInfo:"pako inflate (from Nodeca project)"};