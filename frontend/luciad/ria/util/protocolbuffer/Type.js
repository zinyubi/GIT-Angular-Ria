import{constructors}from"./constructors.js";import*as converter from"./converter.js";import{decoder}from"./decoder.js";import{encoder}from"./encoder.js";import{isField,isMessage,isOneOf}from"./interfaces.js";import{Message}from"./Message.js";import{Namespace}from"./Namespace.js";import{Reader}from"./Reader.js";import*as util from"./util.js";import{verifier}from"./verifier.js";import{wrappers}from"./wrappers.js";import{Writer}from"./Writer.js";export class Type extends Namespace{static className="Type";constructor(e,t){super(e,t);this._PB_TYPE=true;this.fields={};this.oneofs=void 0;this.extensions=void 0;this.reserved=void 0;this.group=void 0;this._fieldsById=null;this._fieldsArray=null;this._oneofsArray=null;this._ctor=null}get fieldsById(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(let e=Object.keys(this.fields),t=0;t<e.length;++t){const s=this.fields[e[t]],r=s.id;if(this._fieldsById[r])throw Error("duplicate id "+r+" in "+this);this._fieldsById[r]=s}return this._fieldsById}get fieldsArray(){return this._fieldsArray||(this._fieldsArray=util.toArray(this.fields))}get oneofsArray(){return this._oneofsArray||(this._oneofsArray=util.toArray(this.oneofs))}get ctor(){return this._ctor||(this.ctor=Type.generateConstructor(this)())}set ctor(e){const t=e.prototype;if(!isMessage(t)){(e.prototype=new Message).constructor=e;util.merge(e.prototype,t)}e.$type=e.prototype.$type=this;util.merge(e,Message,true);this._ctor=e;let s=0;const{fieldsArray:r}=this;for(;s<r.length;++s)r[s].resolve();const i={};const{oneofsArray:o}=this;for(s=0;s<o.length;++s)i[o[s].resolve().name]={get:util.oneOfGetter(o[s].oneof),set:util.oneOfSetter(o[s].oneof)};if(s)Object.defineProperties(e.prototype,i)}static generateConstructor(e){const t=util.codegen(["p"],e.name);const{fieldsArray:s}=e;for(let e=0,r;e<s.length;++e)if((r=s[e]).map)t("this%s={}",util.safeProp(r.name));else if(r.repeated)t("this%s=[]",util.safeProp(r.name));return t("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")}static fromJSON(e,t){const s=new Type(e,t.options);s.extensions=t.extensions;s.reserved=t.reserved;let r=Object.keys(t.fields),i=0;for(;i<r.length;++i){const e=t.fields[r[i]];s.add(("undefined"!==typeof e.keyType?constructors.MapField:constructors.Field).fromJSON(r[i],e))}if(t.oneofs)for(r=Object.keys(t.oneofs),i=0;i<r.length;++i)s.add(constructors.OneOf.fromJSON(r[i],t.oneofs[r[i]]));if(t.nested)for(r=Object.keys(t.nested),i=0;i<r.length;++i){const e=t.nested[r[i]];s.add((void 0!==e.id?constructors.Field:void 0!==e.fields?constructors.Type:void 0!==e.values?constructors.Enum:void 0!==e.methods?constructors.Service:constructors.Namespace).fromJSON(r[i],e))}if(t.extensions&&t.extensions.length)s.extensions=t.extensions;if(t.reserved&&t.reserved.length)s.reserved=t.reserved;if(t.group)s.group=true;if(t.comment)s.comment=t.comment;return s}toJSON(e){const t=Boolean(e?.keepComments);const s=Namespace.arrayToJSON(this.fieldsArray.filter((e=>!e.declaringField)),e)||{};const r={...super.toJSON(e),fields:s};const i=Namespace.arrayToJSON(this.oneofsArray,e);if(i)r.oneofs=i;if(this.extensions?.length)r.extensions=this.extensions;if(this.reserved?.length)r.reserved=this.reserved;if(this.group)r.group=this.group;if(t&&this.comment)r.comment=this.comment;return r}resolveAll(){const e=this.fieldsArray;let t=0;while(t<e.length)e[t++].resolve();const s=this.oneofsArray;t=0;while(t<s.length)s[t++].resolve();return super.resolveAll()}get(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested?.[e]||null}add(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(isField(e)&&void 0===e.extend){if(this._fieldsById?this._fieldsById[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);if(e.parent)e.parent.remove(e);this.fields[e.name]=e;e.message=this;e.onAdd(this);return clearCache(this)}if(isOneOf(e)){if(!this.oneofs)this.oneofs={};this.oneofs[e.name]=e;e.onAdd(this);return clearCache(this)}return super.add(e)}remove(e){if(isField(e)&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);delete this.fields[e.name];e.parent=null;e.onRemove(this);return clearCache(this)}if(isOneOf(e)){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);delete this.oneofs[e.name];e.parent=null;e.onRemove(this);return clearCache(this)}return super.remove(e)}isReservedId(e){return util.isReservedId(this.reserved,e)}isReservedName(e){return util.isReservedName(this.reserved,e)}create(e){return new this.ctor(e)}setup(){const e=this.fullName;const t=[];const{fieldsArray:s}=this;for(let e=0;e<s.length;++e)t.push(s[e].resolve().resolvedType);this.encode=encoder(this)({Writer:Writer,types:t,util:util});this.decode=decoder(this)({Reader:Reader,types:t,util:util});this.verify=verifier(this)({types:t,util:util});this.fromObject=converter.fromObject(this)({types:t,util:util});this.toObject=converter.toObject(this)({types:t,util:util});const r=wrappers[e];if(r){const e=Object.create(this);e.fromObject=this.fromObject;this.fromObject=r.fromObject.bind(e);e.toObject=this.toObject;this.toObject=r.toObject.bind(e)}return this}encode(e,t){return this.setup().encode(e,t)}encodeDelimited(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()}decode(e,t){return this.setup().decode(e,t)}decodeDelimited(e){if(!(e instanceof Reader))e=Reader.create(e);return this.decode(e,e.uint32())}verify(e){return this.setup().verify(e)}fromObject(e){return this.setup().fromObject(e)}toObject(e,t){return this.setup().toObject(e,t)}}export function d(e){return t=>void util.decorateType(t,e)}function clearCache(e){e._fieldsById=e._fieldsArray=e._oneofsArray=null;delete e.encode;delete e.decode;delete e.verify;return e}