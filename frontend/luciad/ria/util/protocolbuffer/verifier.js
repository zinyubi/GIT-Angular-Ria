import{isEnum}from"./interfaces.js";import{safeProp}from"./util.js";import{codegen}from"./util/codegen.js";function invalid(e,i){return`${e.name}: ${i}${e.repeated&&"array"!==i?"[]":e.map&&"object"!==i?`{k:${e.keyType}}`:""} expected`}function genVerifyValue(e,i,r,t){if(i.resolvedType)if(isEnum(i.resolvedType)){e("switch(%s){",t)("default:")("return%j",invalid(i,"enum value"));for(let r=Object.keys(i.resolvedType.values),t=0;t<r.length;++t)e("case %i:",i.resolvedType.values[r[t]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",r,t)("if(e)")("return%j+e",i.name+".")("}");else switch(i.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",t)("return%j",invalid(i,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",t,t,t,t)("return%j",invalid(i,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',t)("return%j",invalid(i,"number"));break;case"bool":e('if(typeof %s!=="boolean")',t)("return%j",invalid(i,"boolean"));break;case"string":e("if(!util.isString(%s))",t)("return%j",invalid(i,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',t,t,t)("return%j",invalid(i,"buffer"));break}return e}function genVerifyKey(e,i,r){switch(i.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",r)("return%j",invalid(i,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",r)("return%j",invalid(i,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",r)("return%j",invalid(i,"boolean key"));break}return e}export function verifier(e){const i=codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected");const r=undefined;const t={};if(e.oneofsArray.length)i("var p={}");const{fieldsArray:n}=e;for(let e=0;e<n.length;++e){const r=n[e].resolve();const s="m"+safeProp(r.name);if(r.optional)i("if(%s!=null&&m.hasOwnProperty(%j)){",s,r.name);if(r.map){i("if(!util.isObject(%s))",s)("return%j",invalid(r,"object"))("var k=Object.keys(%s)",s)("for(var i=0;i<k.length;++i){");genVerifyKey(i,r,"k[i]");genVerifyValue(i,r,e,s+"[k[i]]")("}")}else if(r.repeated){i("if(!Array.isArray(%s))",s)("return%j",invalid(r,"array"))("for(var i=0;i<%s.length;++i){",s);genVerifyValue(i,r,e,s+"[i]")("}")}else{if(r.partOf){const e=safeProp(r.partOf.name);if(1===t[r.partOf.name])i("if(p%s===1)",e)("return%j",r.partOf.name+": multiple values");t[r.partOf.name]=1;i("p%s=1",e)}genVerifyValue(i,r,e,s)}if(r.optional)i("}")}return i("return null")}