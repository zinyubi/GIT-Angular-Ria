const delimRe=/[\s{}=;:[\],'"()<>]/g;const stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g;const stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g;const setCommentRe=/^ *[*/]+ */;const setCommentAltRe=/^\s*\*?\/*/;const setCommentSplitRe=/\n/g;const whitespaceRe=/\s/;const unescapeRe=/\\(.?)/g;const unescapeMap={0:"\0",r:"\r",n:"\n",t:"\t"};function unescape(e){return e.replace(unescapeRe,((e,t)=>{switch(t){case"\\":case"":return t;default:return unescapeMap[t]||""}}))}export const tokenize=Object.assign((function e(t,n=false){t=t.toString();let i=0;const l=t.length;let s=1;let r=null;let u=null;let o=0;let c=false;const f=[];let a=null;function h(e){return Error("illegal "+e+" (line "+s+")")}function m(){const e="'"===a?stringSingleRe:stringDoubleRe;e.lastIndex=i-1;const n=e.exec(t);if(!n)throw h("string");i=e.lastIndex;b(a);a=null;return unescape(n[1])}function p(e){return t.charAt(e)}function g(e,i){r=t.charAt(e++);o=s;c=false;const l=undefined;let f=e-(n?2:3);let a;do{if(--f<0||"\n"===(a=t.charAt(f))){c=true;break}}while(" "===a||"\t"===a);const h=t.substring(e,i).split(setCommentSplitRe);for(let e=0;e<h.length;++e)h[e]=h[e].replace(n?setCommentAltRe:setCommentRe,"").trim();u=h.join("\n").trim()}function d(e){const n=R(e);const i=t.substring(e,n);return/^\s*\/{1,2}/.test(i)}function R(e){let t=e;while(t<l&&"\n"!==p(t))t++;return t}function w(){if(f.length>0)return f.shift()??null;if(a)return m();let e;let r;let u;let o;let c;do{if(i===l)return null;e=false;while(whitespaceRe.test(u=p(i))){if("\n"===u)++s;if(++i===l)return null}if("/"===p(i)){if(++i===l)throw h("comment");if("/"===p(i))if(!n){c="/"===p(o=i+1);while("\n"!==p(++i))if(i===l)return null;++i;if(c)g(o,i-1);++s;e=true}else{o=i;c=false;if(d(i)){c=true;do{i=R(i);if(i===l)break;i++}while(d(i))}else i=Math.min(l,R(i)+1);if(c)g(o,i);s++;e=true}else if("*"===(u=p(i))){o=i+1;c=n||"*"===p(o);do{if("\n"===u)++s;if(++i===l)throw h("comment");r=u;u=p(i)}while("*"!==r||"/"!==u);++i;if(c)g(o,i-2);e=true}else return"/"}}while(e);let w=i;delimRe.lastIndex=0;const b=undefined;if(!delimRe.test(p(w++)))while(w<l&&!delimRe.test(p(w)))++w;const x=t.substring(i,i=w);if('"'===x||"'"===x)a=x;return x}function b(e){f.push(e)}function x(){if(!f.length){const e=w();if(null===e)return null;b(e)}return f[0]}function k(e,t=false){const n=x();const i=undefined;if(n===e){w();return true}if(!t)throw h(`token '${n}', '${e}' expected`);return false}function C(e){let t=null;if(void 0===e){if(o===s-1&&(n||"*"===r||c))t=u;return t}if(o<e)x();if(o===e&&!c&&(n||"/"===r))t=u;return t}return Object.defineProperty({next:w,peek:x,push:b,skip:k,cmnt:C},"line",{get:()=>s})}),{unescape:unescape});