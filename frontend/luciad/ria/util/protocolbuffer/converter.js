import{isEnum}from"./interfaces.js";import*as util from"./util.js";import{codegen}from"./util/codegen.js";function genValuePartial_fromObject(e,s,t,r){if(s.resolvedType)if(isEnum(s.resolvedType)){e("switch(d%s){",r);for(let t=s.resolvedType.values,o=Object.keys(t),i=0;i<o.length;++i){if(s.repeated&&t[o[i]]===s.typeDefault)e("default:");e("case%j:",o[i])("case %i:",t[o[i]])("m%s=%j",r,t[o[i]])("break")}e("}")}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",s.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,t,r);else{let t=false;switch(s.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":t=true;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,t)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,t?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r);break}}return e}export function fromObject(e){const s=e.fieldsArray;const t=codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!s.length)return t("return new this.ctor");t("var m=new this.ctor");for(let e=0;e<s.length;++e){const r=s[e].resolve();const o=util.safeProp(r.name);if(r.map){t("if(d%s){",o)('if(typeof d%s!=="object")',o)("throw TypeError(%j)",`${r.fullName}: object expected`)("m%s={}",o)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",o);genValuePartial_fromObject(t,r,e,o+"[ks[i]]")("}")("}")}else if(r.repeated){t("if(d%s){",o)("if(!Array.isArray(d%s))",o)("throw TypeError(%j)",r.fullName+": array expected")("m%s=[]",o)("for(var i=0;i<d%s.length;++i){",o);genValuePartial_fromObject(t,r,e,o+"[i]")("}")("}")}else{if(!isEnum(r.resolvedType))t("if(d%s!=null){",o);genValuePartial_fromObject(t,r,e,o);if(!isEnum(r.resolvedType))t("}")}}return t("return m")}function genValuePartial_toObject(e,s,t,r){if(s.resolvedType)if(isEnum(s.resolvedType))e("d%s=o.enums===String?types[%i].values[m%s]:m%s",r,t,r,r);else e("d%s=types[%i].toObject(m%s,o)",r,t,r);else{let t=false;switch(s.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":t=true;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,t?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r);break}}return e}export function toObject(e){const s=e.fieldsArray.slice().sort(util.compareFieldsById);if(!s.length)return codegen()("return {}");const t=codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}");const r=[];const o=[];const i=[];for(let e=0;e<s.length;++e)if(!s[e].partOf)(s[e].resolve().repeated?r:s[e].map?o:i).push(s[e]);if(r.length){t("if(o.arrays||o.defaults){");for(let e=0;e<r.length;++e)t("d%s=[]",util.safeProp(r[e].name));t("}")}if(o.length){t("if(o.objects||o.defaults){");for(let e=0;e<o.length;++e)t("d%s={}",util.safeProp(o[e].name));t("}")}if(i.length){t("if(o.defaults){");for(let e=0;e<i.length;++e){const s=i[e];const r=util.safeProp(s.name);if(isEnum(s.resolvedType))t("d%s=o.enums===String?%j:%j",r,s.resolvedType.valuesById[s.typeDefault],s.typeDefault);else if(s.long)t("if(util.Long){")("var n=new util.Long(%i,%i,%j)",s.typeDefault.low,s.typeDefault.high,s.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",r)("}else")("d%s=o.longs===String?%j:%i",r,s.typeDefault.toString(),s.typeDefault.toNumber());else if(s.bytes){const e="["+Array.prototype.slice.call(s.typeDefault).join(",")+"]";t("if(o.bytes===String)d%s=%j",r,String.fromCharCode.apply(String,s.typeDefault))("else{")("d%s=%s",r,e)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",r,r)("}")}else t("d%s=%j",r,s.typeDefault)}t("}")}let l=false;for(let r=0;r<s.length;++r){const o=s[r];const i=e.fieldsArray.indexOf(o);const n=util.safeProp(o.name);if(o.map){if(!l){l=true;t("var ks2")}t("if(m%s&&(ks2=Object.keys(m%s)).length){",n,n)("d%s={}",n)("for(var j=0;j<ks2.length;++j){");genValuePartial_toObject(t,o,i,n+"[ks2[j]]")("}")}else if(o.repeated){t("if(m%s&&m%s.length){",n,n)("d%s=[]",n)("for(var j=0;j<m%s.length;++j){",n);genValuePartial_toObject(t,o,i,n+"[j]")("}")}else{t("if(m%s!=null&&m.hasOwnProperty(%j)){",n,o.name);genValuePartial_toObject(t,o,i,n);if(o.partOf)t("if(o.oneofs)")("d%s=%j",util.safeProp(o.partOf.name),o.name)}t("}")}return t("return d")}