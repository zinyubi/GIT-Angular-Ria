import{asPromise}from"./util/asPromise.js";import{EventEmitter}from"./util/EventEmitter.js";export class RPCService extends EventEmitter{constructor(e,r=false,t=false){if("function"!==typeof e)throw TypeError("rpcImpl must be a function");super();this.rpcImpl=e;this.requestDelimited=Boolean(r);this.responseDelimited=Boolean(t)}rpcCall(e,r,t,i,s){if(!i)throw TypeError("request must be specified");if(!s)return asPromise(this.rpcCall,this,e,r,t,i);if(!this.rpcImpl){setTimeout((function(){s(Error("already ended"))}),0);return}try{return this.rpcImpl(e,r[this.requestDelimited?"encodeDelimited":"encode"](i).finish(),((r,i)=>{if(r){this.emit("error",r,e);return s(r)}if(null===i){this.end(true);return}if(!(i instanceof t))try{i=t[this.responseDelimited?"decodeDelimited":"decode"](i)}catch(r){const t=r instanceof Error?r:new Error(""+r);this.emit("error",r,e);return s(t)}this.emit("data",i,e);return s(null,i)}))}catch(r){this.emit("error",r,e);setTimeout((function(){const e=r instanceof Error?r:new Error(""+r);s(e)}),0);return}}end(e){if(this.rpcImpl){if(!e)this.rpcImpl(null,null,null);this.rpcImpl=null;this.emit("end").off()}return this}}