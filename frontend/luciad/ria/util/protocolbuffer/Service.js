import{constructors}from"./constructors.js";import{isMethod}from"./interfaces.js";import{Namespace}from"./Namespace.js";import{RPCService}from"./rpc.js";import*as util from"./util.js";export class Service extends Namespace{static className="Service";constructor(e,t){super(e,t);this.methods={};this._methodsArray=null}get methodsArray(){return this._methodsArray||(this._methodsArray=util.toArray(this.methods))}get _PB_SERVICE(){return true}static fromJSON(e,t){const r=new Service(e,t.options);if(t.methods)for(let e=Object.keys(t.methods),s=0;s<e.length;++s)r.add(constructors.Method.fromJSON(e[s],t.methods[e[s]]));if(t.nested)r.addJSON(t.nested);r.comment=t.comment??null;return r}toJSON(e){const t=super.toJSON(e);const r=Boolean(e?.keepComments);const s=undefined;const o={...t,methods:Namespace.arrayToJSON(this.methodsArray,e)||{}};if(this.comment&&r)o.comment=this.comment;return o}get(e){return this.methods[e]||super.get(e)}resolveAll(){const e=this.methodsArray;for(let t=0;t<e.length;++t)e[t].resolve();return super.resolve()}add(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(isMethod(e)){this.methods[e.name]=e;e.parent=this;return clearCache(this)}return super.add(e)}remove(e){if(isMethod(e)){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);delete this.methods[e.name];e.parent=null;return clearCache(this)}return super.remove(e)}create(e,t=false,r=false){const s=new RPCService(e,t,r);const{methodsArray:o}=this;for(let e=0;e<o.length;++e){const t=o[e];const r=util.lcFirst(t.resolve().name).replace(/[^$\w_]/g,"");s[r]=util.codegen(["r","c"],util.isReserved(r)?r+"_":r)("return this.rpcCall(m,q,s,r,c)")({m:t,q:t.resolvedRequestType?.ctor,s:t.resolvedResponseType?.ctor})}return s}}function clearCache(e){e._methodsArray=null;return e}