import{AbortError}from"../error/AbortError.js";import{NotFoundError}from"../error/NotFoundError.js";import{createHTML5Canvas}from"../view/HTML5Canvas.js";import{base64}from"./base64.js";import{isIE}from"./Browser.js";import{addHttpRequestOptions}from"./HttpRequestOptions.js";import{isBoolean,isObject,isString}from"./Lang.js";import{On}from"./On.js";import{isPromise}from"./PromiseUtil.js";import{request}from"./request.js";import{URL}from"./URL.js";import{getImageHash,resizeImageOrCanvas}from"./ImageUtil.js";const imageCache=new Map;const patternCache=new Map;const html5Canvas=createHTML5Canvas(0,0);const endsWith=(e,t)=>{const r=e.length-t.length;return r>=0&&e.lastIndexOf(t)===r};const onloadImage=(()=>{if(isIE())return(e,t,r)=>{const n=On(e,"error",(t=>{e.onload=null;n.remove();a.remove();r&&r(t)}));const a=On(e,"abort",(t=>{e.onload=null;n.remove();a.remove();r&&r(t)}));e.onload=()=>{e.onload=null;n.remove();a.remove();if(!isImageComplete(e)){r&&r(new Error("Image load event fired before image is complete"));return}t&&t(e)}};return(e,t,r)=>{const n=On(e,"error",(e=>{o.remove();n.remove();a.remove();r&&r(e)}));const a=On(e,"abort",(e=>{o.remove();n.remove();a.remove();r&&r(e)}));const o=On(e,"load",(()=>{if(!isImageComplete(e)){o.remove();n.remove();a.remove();r&&r(new Error("Image load event fired before image is complete"));return}t&&t(e)}))}})();const getImage=(e,t=false,r=false,n=false,a=null,o=null,s=0,i=0)=>{if(!isString(e))return getLoadedImage(e,s,i);const m=t?getUrlImage(e,r,n,a,o,s,i):getImageFromUrl(e,t,r,n,a,o);let g=m;if(!t&&(s||i))if(isPromise(m))g=m.then((e=>resizeImage(e,s,i)));else g=resizeImage(m,s,i);return g};function getUrlImage(e,t,r,n,a,o,s){const i=getImageHash(e,o,s);const m=imageCache.get(i);if(m)return m;const g=getImageHash(e);function c(e,t,r){if(t&&isSVGImage(r)){const t=resizeImageOrCanvas(r,r.width,r.height).then((t=>{imageCache.set(e,t);return t}));imageCache.set(e,t);return t}else{imageCache.set(e,r);return r}}function l(e,t){imageCache.delete(e);throw t}function u(t){const r=getImageHash(e,t.width,t.height);c(g,false,t);return c(r,true,t)}if(o&&s){const m=c.bind(null,i,true);const f=l.bind(null,i);const h=e=>{const t=resizeImage(e,o,s);if(isPromise(t))imageCache.set(i,t.then(m,f));else imageCache.set(i,t);return imageCache.get(i)};const d=imageCache.get(g);if(d)if(isPromise(d))d.then(h);else h(d);else imageCache.set(i,getImageFromUrl(e,true,t,r,n,a).then((e=>{u(e);const t=resizeImage(e,o,s);if(isPromise(t))imageCache.set(i,t.then(m,f));else imageCache.set(i,t);return imageCache.get(i)}),f));return imageCache.get(i)}else{const o=getImageFromUrl(e,true,t,r,n,a).then((e=>u(e)),(e=>l(g,e)));imageCache.set(g,o);return o}}async function getImageWithXHR(e,t,r,n,a){const o=addHttpRequestOptions({signal:a},{requestHeaders:n,credentials:r});const s=await request(e,o);const i=s.headers.get("Content-Type");const m=await s.arrayBuffer();const g=undefined;return getImageFromUrl(arrayBufferToDataURI(m,i),t,false,r,null,a)}async function getImageFromUrl(e,t,r,n,a,o){if(a&&isObject(a)&&0!==Object.keys(a).length)return getImageWithXHR(e,t,n,a,o);return getImageWithDOM(e,r,n,o)}async function getImageWithDOM(e,t,r,n){let a;return new Promise(((o,s)=>{a=new Image;if(t&&0!==e.indexOf("data:"))a.crossOrigin=r?"use-credentials":"anonymous";a.onerror=()=>{s(new NotFoundError(e))};a.onload=()=>{o(a)};if(n){const e=()=>{a.onerror=null;a.onload=null;a.src="";a=null;s(new AbortError("DOM image request aborted"))};if(n.aborted){e();return}n.addEventListener("abort",e)}a.src=e}))}const isImageComplete=e=>{if(e&&isBoolean(e.complete)&&false===e.complete)return false;return!(e&&(e.width<=0||e.height<=0))||e&&endsWith(e.src,".svg")};const getLoadedImage=(e,t,r)=>{if(isImageComplete(e))if(!t&&!r||t&&t===e.width||r&&r===e.height)return e;const n=resizeImage(e,t,r);const a=e=>new Promise(((t,r)=>{if(isImageComplete(e))t(e);onloadImage(e,(e=>{t(e)}),(e=>{r(e)}))}));if(isPromise(n))return n.then(a);else return a(n)};function shouldResizeImage(e,t,r){if(t&&t!==e.width||r&&r!==e.height)return true;return isSVGImage(e)}function resizeImage(e,t,r){if(shouldResizeImage(e,t,r))return resizeImageOrCanvas(e,t,r);return e}function isSVGImage(e){let t=null;if(isString(e))t=e;else if(e instanceof HTMLImageElement)t=e.src;else if(e instanceof HTMLCanvasElement)return false;if(t)return endsWith(t,".svg")||0===t.indexOf("data:image/svg+xml");return false}function createImagePattern(e){const t=undefined;return html5Canvas.getContext("2d",{willReadFrequently:true}).createPattern(e,"repeat")}const prunePatternCache=e=>patternCache.delete(e);function getPattern(e,t,r){const n=getImageHash(e,t,r);const a=patternCache.get(n);if(a)return a;const o=createImagePattern(e);if(!o)return null;patternCache.set(n,o);setTimeout((()=>{prunePatternCache(n)}),1e3);return o}const arrayBufferToDataURI=(e,t)=>{let r="";const n=new Uint8Array(e);const a=n.byteLength;for(let e=0;e<a;e++)r+=String.fromCharCode(n[e]);return URL.fromData(base64.encode(r),{mimeType:t})};function clearCache(){imageCache.clear();patternCache.clear()}const inspectCaches=()=>({imageCacheSize:imageCache.size,patternCacheSize:patternCache.size});function getCachedImage(e){return imageCache.get(e)}export const Ajax={getImage:getImage,getPattern:getPattern,prunePatternCache:prunePatternCache,loadImage:function(e,t){return new Promise(((r,n)=>{if(null===t||void 0===t)n("Url is invalid");onloadImage(e,r,n);e.src=t}))},isSVGImage:isSVGImage,clearCache:clearCache,getCachedImage:getCachedImage,inspectCaches:inspectCaches};