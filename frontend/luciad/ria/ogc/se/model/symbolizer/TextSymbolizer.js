import{getUnitOfMeasure}from"../../../../uom/UnitOfMeasureRegistry.js";import{Fill}from"../Fill.js";import{DEFAULT_FONT_SIZE_PX}from"../Font.js";import{PointPlacement}from"../PointPlacement.js";import{SEElementType}from"../SEElementType.js";import{SVGParameter}from"../SVGParameter.js";import{BodySymbolizer}from"./BodySymbolizer.js";import{getVendorOptionValue,SupportedVendorOptions}from"../VendorOption.js";import{getForName}from"../WellKnownName.js";const DEFAULT_TEXT_FILL=new Fill;const DEFAULT_TEXT_FILL_COLOR=new SVGParameter("fill");DEFAULT_TEXT_FILL_COLOR.addContent("#000000");DEFAULT_TEXT_FILL.addSVGParameter(DEFAULT_TEXT_FILL_COLOR);export class TextSymbolizer extends BodySymbolizer{static VALID_CHILDREN=(new Array).concat(BodySymbolizer.VALID_CHILDREN,["Label","Font","LabelPlacement","Halo","Fill","Graphic"]);static VALID_VENDOR_OPTIONS=[SupportedVendorOptions.VENDOR_OPTION_CONFLICT_RESOLUTION,SupportedVendorOptions.VENDOR_OPTION_GRAPHIC_MARGIN,SupportedVendorOptions.VENDOR_OPTION_GRAPHIC_RESIZE,SupportedVendorOptions.VENDOR_OPTION_INCLUSION];_label=null;_font=null;_halo=null;_fill=null;_labelPlacement=null;_graphic=null;constructor(){super(SEElementType.TEXT_SYMBOLIZER)}isReady(){if(null===this._halo&&null===this._fill)return Promise.resolve();else{const e=null===this._halo?Promise.resolve():this._halo.isReady();const t=null===this._fill?Promise.resolve():this._fill.isReady();return Promise.all([e,t]).then((()=>{}))}}get validVendorOptions(){return TextSymbolizer.VALID_VENDOR_OPTIONS}get label(){return this._label}set label(e){this._label=e;this._label?.createStringEvaluationFunction(true)}get font(){return this._font}set font(e){this._font=e}get halo(){return this._halo}set halo(e){this._halo=e}get fill(){return this._fill}set fill(e){this._fill=e;if(null===e?.fillColor)this._fill?.addSVGParameter(DEFAULT_TEXT_FILL_COLOR)}get labelPlacement(){return this._labelPlacement}set labelPlacement(e){this._labelPlacement=e}get graphic(){return this._graphic}set graphic(e){this._graphic=e}getHTMLLabelText(e,t){if(!this.uom.equals(getUnitOfMeasure("Pixels")))return"";let l="";const i=this.createValidLabelText(e,t);if(i.length>0){let n="";for(const e of i)n+=`<div>${e}</div>`;const o=[];if(this._font)this._font.appendCssStyleTokens(e,t,o);if(this._fill)this._fill.appendCssStyleTokens(e,t,o);if(this._halo)this._halo.appendCssStyleTokens(e,t,o);if(null!==this._graphic&&this._graphic.marks.length>0){const l=this._graphic.marks[0];const i=getVendorOptionValue(this,SupportedVendorOptions.VENDOR_OPTION_GRAPHIC_RESIZE);const n=undefined;if("square"===getForName(l.wellKnownName?.evaluateContentAsString(e,t,true))&&"stretch"===i){const i=l.createMarkStyle(e,t,this.uom);if(i.fill)o.push(`background:${i.fill.color}`);if(i.stroke){const e=i.stroke;if(e.color)o.push(`border:${e.width??1}px solid ${e.color}`)}const n=getVendorOptionValue(this,SupportedVendorOptions.VENDOR_OPTION_GRAPHIC_MARGIN);o.push(`padding:${n}px`)}}if(o.length>0){const e=undefined;l=`<div style="${o.join(";")}">${n}</div>`}else l=`<div>${n}</div>`}return l}createLabelPlacementSpecifics(e,t){return this._labelPlacement?.createLabelPlacementSpecifics(e,t)}createStyledTexts(e,t){const l=null===this._labelPlacement||this._labelPlacement?.placement instanceof PointPlacement;if(this.uom.equals(getUnitOfMeasure("Pixels"))||!l)return[];const i=undefined;return[{text:this.createValidLabelText(e,t)[0],style:this.getTextStyle(e,t)}]}createStrokeStyles(e,t,l){if(this.uom.equals(getUnitOfMeasure("Pixels")))return[];const i=this.createValidLabelText(e,t)[0];const n=this.getTextStyle(e,t);const o=this._labelPlacement?.createCSPatterns(e,t,i,n,l);if(!o)return[];return[{uom:this.uom,isWorldSize:true,regular:o.regular,decorations:o.decorations??void 0}]}createValidLabelText(e,t){let l=this._label?.evaluateContentAsString(e,t,true)||"";if("null"===l||"undefined"===l)l="";const i=l.split(/\r?\n|\r|\n/g);const n=[];for(const e of i)n.push(e.trim());return n}getTextStyle(e,t){const l=this._font?.fontSize.evaluateContentAsNumber(e,t)??DEFAULT_FONT_SIZE_PX;const i={uom:this.uom,height:l,strokeWidth:0};this._font?.appendTextStyle(e,t,i);this._fill?.appendTextStyle(e,t,i);this._halo?.appendTextStyle(e,t,i);if(this._labelPlacement)this._labelPlacement.appendTextSyle(e,t,i);else{i.angle=0;i.offsetX=0;i.offsetY=0;i.alignmentBaseline="50%";i.textAnchor="50%"}return i}}