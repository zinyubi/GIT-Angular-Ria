import{SEElementType}from"./SEElementType.js";import{SEElement}from"./SEElement.js";import{Base64InlineContentEncoder}from"../encoding/Base64InlineContentEncoder.js";import{convertToBase64,SvgXmlInlineContentEncoder}from"../encoding/SvgXmlInlineContentEncoder.js";import{mimeType}from"../../../util/mimeType.js";import{loadImageFromImage,loadImageFromString,sanitizeString}from"../util/SEUtil.js";import{isString}from"../../../util/Lang.js";import{ProgrammingError}from"../../../error/ProgrammingError.js";export class ExternalGraphic extends SEElement{static VALID_CHILDREN=["OnlineResource","InlineContent","Format","ColorReplacement"];_onlineResource=null;_inlineContent=null;_format=null;_colorReplacement=[];_supportedFormat=null;_icon=null;constructor(e){super(SEElementType.EXTERNAL_GRAPHIC);this._iconProvider=e??null}async isReady(){if(this.onlineResource||this.inlineContent){const e=this.buildImageUrl();const n=null!==this._iconProvider?this._iconProvider.getIcon(e):e;if(isString(n))if(n.indexOf(".svg")>0){const e=await fetch(n);const t=await e.text();const o=convertToBase64(t,true);const i=o?"data:image/svg+xml;base64,"+sanitizeString(o):n;return loadImageFromString(i).then((e=>{this._icon=e}),(()=>{this._icon=null}))}else return loadImageFromString(n).then((e=>{this._icon=e}),(()=>{this._icon=null}));else if(n instanceof HTMLImageElement)return loadImageFromImage(n).then((e=>{this._icon=e}),(()=>{this._icon=null}));else{this._icon=n;return Promise.resolve()}}else throw new ProgrammingError("An external graphic should have either an onlineResource or an inlineContent")}get icon(){return this._icon}get format(){return this._format}set format(e){this._format=e;this._supportedFormat=findSupportedFormat(this._format)}get onlineResource(){return this._onlineResource}set onlineResource(e){this._onlineResource=e;this._inlineContent=null}get inlineContent(){return this._inlineContent}set inlineContent(e){this._inlineContent=e;this._onlineResource=null}get supportedFormat(){return this._supportedFormat}isSupportedEncoding(e){if(this._supportedFormat&&this._supportedFormat.encoders)for(let n=0;n<this._supportedFormat.encoders.length;n++){const t=undefined;if(this._supportedFormat.encoders[n].canEncode(e))return true}return false}buildImageUrl(){let e;if(this.onlineResource)e=encodeURI(this.onlineResource);else{const n=this.inlineContent;e="data:"+this.format+";"+sanitizeString(n.encoding)+","+sanitizeString(n.content[0])}return e}}const base64InlineContentEncoder=new Base64InlineContentEncoder;const svgXmlInlineContentEncodingDecoder=new SvgXmlInlineContentEncoder;export const VALID_SE_GRAPHIC_FORMATS=[{mimeType:mimeType.png,encoders:[base64InlineContentEncoder]},{mimeType:mimeType.jpeg,encoders:[base64InlineContentEncoder]},{mimeType:mimeType.jpg,encoders:[base64InlineContentEncoder]},{mimeType:mimeType.gif,encoders:[base64InlineContentEncoder]},{mimeType:mimeType.svg,encoders:[base64InlineContentEncoder,svgXmlInlineContentEncodingDecoder]}];function findSupportedFormat(e){for(let n=0;n<VALID_SE_GRAPHIC_FORMATS.length;n++)if(e===VALID_SE_GRAPHIC_FORMATS[n].mimeType)return VALID_SE_GRAPHIC_FORMATS[n];return null}