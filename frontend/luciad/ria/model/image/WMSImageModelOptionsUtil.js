import{getReference,isValidReferenceIdentifier}from"../../reference/ReferenceProvider.js";import{isDefined,isString}from"../../util/Lang.js";import{processServiceUrl}from"../capabilities/common/CapabilitiesParserUtil.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{getTransformation}from"../../util/CacheUtil.js";function findServiceUrl(e,r){if(!isDefined(e))return null;const n=e.supportedRequests.filter((function(e){return e.method===r}))[0];if(isDefined(n))return processServiceUrl(n.url);else return null}function findLayer(e,r){let n=null;for(let t=0;null==n&&t<e.length;t++)if(e[t].name===r)n=e[t];else n=findLayer(e[t].children,r);return n}function calculateBounds(e,r,n){if(isDefined(n.bounds)){const e=n.bounds;const t=e.reference;if(null===t)return null;else if(t.equals(r))return e;else{const n=getTransformation(t,r);let i;try{i=n.transformBounds(e)}catch(e){i=null}return i}}else{let n=null;e.forEach((function(e){const t=e.getBounds(r);if(null===t)return null;else if(null===n)n=t;else n.setTo2DUnion(t)}));return n}}const PREFERRED_REFERENCES=[getReference("CRS:84"),getReference("EPSG:4326"),getReference("EPSG:3857"),getReference("EPSG:900913")];function determineModelReference(e,r){let n=null;if(r.bounds)n=r.bounds.reference;else if(r.reference)n=r.reference;let t;if(n)t=[n];else t=PREFERRED_REFERENCES.slice();let i=null;for(let r=0;r<t.length&&null===i;r++){const n=t[r];const o=n.identifier;const s=undefined;if(e.findIndex((e=>!e.supportedReferences.includes(o)))<0)i=n}if(null===i&&null===n){const r=e.map((e=>e.supportedReferences));const n=undefined;const t=r.reduce(((e,r,n)=>{if(0===n)return e;return e.filter((e=>r.includes(e)))}),r[0]).find((e=>isValidReferenceIdentifier(e)));if(t)i=getReference(t)}if(null===i)if(null!==n)throw new ProgrammingError(`The requested reference (${n.identifier}) is not supported `+`for the requested WMS layer configuration.`);else throw new ProgrammingError("Did not find a suitable model reference for WMS layer configuration.");return i}export function createImageModelConstructorOptions(e,r,n){const t=[];const i=[];const o=[];const s=[];r.forEach((function(r){const n=findLayer(e.layers,r.layer);if(null===n)throw new ProgrammingError('Layer "'+r.layer+'" is not defined in the WMS capabilities');t.push(n);i.push(n.name);if(n.queryable)o.push(n.name);s.push(isString(r.style)?r.style:"")}));const l=determineModelReference(t,n);const f=calculateBounds(t,l,n);const u=findServiceUrl(e.operations.filter((function(e){return"GetMap"===e.name}))[0],"GET");const c=findServiceUrl(e.operations.filter((function(e){return"GetFeatureInfo"===e.name}))[0],"GET");const a={getMapRoot:n.getMapRoot||u||"",version:e.version,transparent:isDefined(n.transparent)?n.transparent:true,backgroundColor:n.backgroundColor,reference:l,layers:i,queryLayers:o,credentials:n.credentials,styles:s,sld:n.sld,sldBody:n.sldBody,requestParameters:n.requestParameters,dimensions:n.dimensions,imageFormat:n.imageFormat,infoFormat:n.infoFormat,requestHeaders:n.requestHeaders,swapAxes:n.swapAxes};if(null!==f)a.bounds=f;const d=n.getFeatureInfoRoot||c;if(null!==d)a.getFeatureInfoRoot=d;return a}