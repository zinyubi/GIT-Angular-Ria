import{request}from"../../util/request.js";import{decodeQuadTreeMetadata}from"../../view/gee/GEEMetadataDecoder.js";import{getMetadataUrl}from"../../view/gee/GEEMetadataV1Decoder.js";export const UnrequestedTileCacheEntry=Symbol("UnrequestedTileCacheEntry");export const UnavailableTileCacheEntry=Symbol("UnavailableTileCacheEntry");export function isQuadtreeCacheEntryValid(e){return!isQuadtreeCacheEntryUnavailable(e)&&!isQuadtreeCacheEntryUnrequested(e)}export function isQuadtreeCacheEntryPending(e){return e instanceof Promise}export function isQuadtreeCacheEntryUnavailable(e){return e===UnavailableTileCacheEntry}export function isQuadtreeCacheEntryUnrequested(e){return e===UnrequestedTileCacheEntry}export class GEEQuadTreeCache{constructor(e){this._tileCache=new Map;this._baseURL=e.baseUrl;this._pendingRequests=new Map;this._requestedParents=["0","1","2","3"]}addQuadTreeNodes(e){e.forEach((e=>this._tileCache.set(e.quadkey,e)))}setQuadTreePromise(e,t){this._tileCache.set(e,t);return t}getQuadTreeNode(e){return this._tileCache.get(e)??UnrequestedTileCacheEntry}isValid(e){while(e.length>1){const t=Number(e.substring(e.length-1));e=e.substring(0,e.length-1);const a=this.getQuadTreeNode(e);if(isQuadtreeCacheEntryUnrequested(a))continue;if(0!==t&&1!==t&&2!==t&&3!==t)return false;if(isQuadtreeCacheEntryPending(a)||isQuadtreeCacheEntryUnavailable(a))return true;return a.hasTree||a.hasChild(t)}return true}metadataReady(e,t,a,r){return Promise.resolve(this.getQuadTreeNode(t)).then((e=>isQuadtreeCacheEntryValid(e)?a(e):r("Metadata not found")))}getParentIndex(e){const t=e.length>3?(e.length-3)%4||4:e.length-1;return e.substr(0,e.length-t)}requestMissingMetadata(e,t){const a=this.getParentIndex(e);const r=this.getQuadTreeNode(a);if(isQuadtreeCacheEntryUnavailable(r)){t("Unavailable metadata");return Promise.resolve()}if(isQuadtreeCacheEntryValid(r)&&-1===this._requestedParents.indexOf(a))return Promise.resolve(r).then((r=>{if(isQuadtreeCacheEntryValid(r))return this.requestMetadata(r,a,e,(e=>t(e)))})).then((e=>{}));if(isQuadtreeCacheEntryUnrequested(r)&&-1===this._requestedParents.indexOf(a))return this.requestMissingMetadata(a,t).then((()=>this.requestMissingMetadata(e,t)));return new Promise((r=>{this.markNodeUnavailable(e);this.markNodeUnavailable(a);t("No data");r()}))}requestMetadata(e,t,a,r){const n=quadtreeMetadataUrl(this._baseURL,t,e.cnodeVersion);const s=this._pendingRequests.get(n);if(s)return s.then((e=>{}));const i=request(n).then((e=>e.arrayBuffer())).then((e=>new Promise(((a,r)=>{try{return a(decodeQuadTreeMetadata(e,t))}catch(e){return r(e)}})))).then((e=>{this._requestedParents.push(t);this.markNodeUnavailable(a);this.addQuadTreeNodes(e);this._pendingRequests.delete(n);return e}),(()=>{this.markNodeUnavailable(a);this.markNodeUnavailable(t);r(`Query for URL [${n}] failed.`);return null}));const d=i.then((()=>this.getQuadTreeNode(a))).then((e=>{if(isQuadtreeCacheEntryValid(e))return e;r("Quad tree node could not be loaded");return UnrequestedTileCacheEntry}));this._pendingRequests.set(n,i);return this.setQuadTreePromise(a,d??UnrequestedTileCacheEntry).then((e=>{}))}markNodeUnavailable(e){this._tileCache.set(e,UnavailableTileCacheEntry)}}function quadtreeMetadataUrl(e,t,a){return getMetadataUrl(e,t,a)}