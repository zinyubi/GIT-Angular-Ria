import{hasProperty,isNumber}from"../../util/Lang.js";import{request}from"../../util/request.js";import{isDbRootProto,lookupString}from"../../view/gee/GEEDbRootDecoder.js";import{decodeImageryMetadata,decodeQuadTreeMetadata,decodeRootDatabase,isGeeServerDef}from"../../view/gee/GEEMetadataDecoder.js";import{getMetadataUrl as getMetadataUrlV1}from"../../view/gee/GEEMetadataV1Decoder.js";import{getMetadataUrl as getMetadataUrlV2}from"../../view/gee/GEEMetadataV2Decoder.js";import{GEEVectorTileSetModel}from"../../view/gee/GEEVectorTileSetModel.js";import{GEEFlatfileImageryTileSetModel}from"../tileset/GEEFlatfileImageryTileSetModel.js";import{GEEImageryTileSetModel}from"../tileset/GEEImageryTileSetModel.js";import{GEEMapsTileSetModel}from"../tileset/GEEMapsTileSetModel.js";import{GEETerrainTileSetModel}from"../tileset/GEETerrainTileSetModel.js";import{GEEQuadTreeCache}from"./GEEQuadTreeCache.js";export const IMAGERY_LAYER_IDENTIFIER="GEE-RIA-Imagery-Layer-identifier";export const TERRAIN_LAYER_IDENTIFIER="GEE-RIA-Terrain-Layer-identifier";export class GEEConnector{constructor(e,r){this._projection=getProjection(r);this._styleAttribute=getStyleAttribute(r);this._styleMap=getStyleMap(r);this._baseUrl=e;this._api=r.api;this._layers=r.layers;this._metadataVersion=r.metadataVersion;this._dbMetadata=getMetadata(r);this._quadTree=new GEEQuadTreeCache({...r,baseUrl:e});this._quadTree.addQuadTreeNodes(getQuadTreeNodes(r))}get api(){return this._api}get metadata(){return this._dbMetadata}get quadTree(){return this._quadTree}get layers(){return this._layers}get imageryLayers(){return this._layers.filter(isImageryLayer)}get terrainLayers(){return this._layers.filter(isTerrainLayer)}get vectorLayers(){return this._layers.filter(isVectorLayer)}get mapsLayers(){return this._layers.filter(isMapsLayer)}get baseUrl(){return this._baseUrl}createModel(e){if(!e)throw new Error(`Could not create model for ${e}. This needs to be an item from the GEEConnector.layers array.`);if(isTerrainLayer(e))return new GEETerrainTileSetModel({baseURL:this._baseUrl,quadTreeCache:this._quadTree});if(isImageryLayer(e))return new GEEFlatfileImageryTileSetModel({baseURL:this._baseUrl,quadTreeCache:this._quadTree});if(isVectorLayer(e)){const r={baseURL:this.baseUrl,quadTreeCache:this._quadTree,channel:e.channelId,minLevel:e.minLevel,maxLevel:e.maxLevel,styleMap:this._styleMap,styleAttribute:this._styleAttribute,featureType:e.featureType,name:e.name,description:e.description};return new GEEVectorTileSetModel(r)}if(isMapsLayer(e)){const r=this._baseUrl;const{id:t,type:a,version:o,label:n}=e;const i={baseURL:r,channel:t,request:a,version:o,label:n};return this._projection===GEEProjection.FLAT?new GEEImageryTileSetModel(i):new GEEMapsTileSetModel(i)}throw new Error(`Unknown layer type: ${e}`)}}export function createGEEConnector(e){return request(`${e}/dbRoot.v5?output=proto`,{}).then((e=>e.arrayBuffer())).then((r=>createConnector(e,r)),(()=>onCreateError(e)))}function getProjection(e){if(e.api===GEEConnectorAPI.MAPS&&"flat"===e.imageryMetadata.projection)return GEEProjection.FLAT;return GEEProjection.MERCATOR}function getStyleAttribute(e){if(e.api===GEEConnectorAPI.EARTH)return e.rootDb.styleAttribute;return[]}function getStyleMap(e){if(e.api===GEEConnectorAPI.EARTH)return e.rootDb.styleMap;return[]}function getQuadTreeNodes(e){if(e.api===GEEConnectorAPI.EARTH)return e.rootQuadTree;return[]}function getMetadata(e){if(e.api===GEEConnectorAPI.EARTH)return e.rootDb;return e.imageryMetadata}function buildConnector(e,r){return new GEEConnector(e,{rootDb:r.rootDb,rootQuadTree:r.quadTree,metadataVersion:r.metadataVersion,api:GEEConnectorAPI.EARTH,layers:createAbstractedLayers(r.rootDb)})}function buildQuadTreeResponse(e,r){return{rootDb:e,quadTree:decodeQuadTreeMetadata(r),metadataVersion:2}}function createConnector(e,r,t=false){const a=decodeRootDatabase(r);const o=getRootDbVersion(a);return createConnectorV2(e,a,o,t).catch((()=>createConnectorV1(e,a,o)))}function createConnectorV1(e,r,t){return request(getMetadataUrlV1(e,"",t)).then((e=>e.arrayBuffer())).then((t=>buildConnector(e,buildQuadTreeResponse(r,t))))}function createConnectorV2(e,r,t,a){return request(getMetadataUrlV2(e,"",t,a)).then((e=>e.arrayBuffer())).then((t=>buildConnector(e,buildQuadTreeResponse(r,t))))}function onCreateError(e){return request(`${e}/query?request=Json&is2d=t`,{}).then((e=>e.json())).then((e=>decodeImageryMetadata(e))).then((r=>createGoogleMapsConnector(e,r)))}function createGoogleMapsConnector(e,r){return new GEEConnector(e,{imageryMetadata:r,api:GEEConnectorAPI.MAPS,layers:r?createAbstractedLayers(r):[],metadataVersion:1})}function getRootDbVersion(e){const r=e?.databaseVersion?.quadtreeVersion;return isNumber(r)?r:1}function isImageryLayer(e){return e.id===IMAGERY_LAYER_IDENTIFIER}function isTerrainLayer(e){return e.id===TERRAIN_LAYER_IDENTIFIER}function isVectorLayer(e){return e.type===GEELayerType.VECTOR&&hasProperty(e,"channelId")}function isMapsLayer(e){return isMapsLayerType(e.type)}function isMapsLayerType(e){return e===GEELayerType.IMAGERY_MAPS||e===GEELayerType.VECTOR_MAPS_RASTER||e===GEELayerType.IMAGERY_MAPS_MERCATOR}export function createAbstractedLayers(e){if(isGeeServerDef(e))if("gemap"===e.dbType)return e.layers.reduce(((e,r)=>{const t=toGEELayerType(r.requestType);if(isMapsLayerType(t))e.push({...r,name:r.label,type:t});return e}),[]);if(isDbRootProto(e)){const r=[];if(e.imageryPresent)r.push({id:IMAGERY_LAYER_IDENTIFIER,name:"Imagery",type:GEELayerType.IMAGERY});if(e.terrainPresent)r.push({id:TERRAIN_LAYER_IDENTIFIER,name:"Terrain",type:GEELayerType.TERRAIN});const t={layers:r,dbRoot:e};return e.nestedFeature.reduce(reduceVectorLayer,t).layers}throw new Error("Unsupported metadata. Not connecting.")}function reduceVectorLayer(e,r){const t=r.assetUuid;const{minZoom:a,maxZoom:o}=r.layer?.zoomRange[0]||{};const n=lookupString(e.dbRoot,r.displayName)??t;const i=lookupString(e.dbRoot,r.description)??void 0;e.layers.push({...r,id:t,name:n,description:i,type:GEELayerType.VECTOR,minLevel:a??0,maxLevel:o??24,children:r.children.reduce(reduceVectorLayer,{...e,layers:[]}).layers});return e}var GEEProjection=function(e){e[e["FLAT"]=0]="FLAT";e[e["MERCATOR"]=1]="MERCATOR";return e}(GEEProjection||{});export let GEEConnectorAPI=function(e){e["EARTH"]="googleEarth";e["MAPS"]="googleMaps";return e}({});export let GEELayerType=function(e){e["UNKNOWN"]="";e["IMAGERY"]="Imagery";e["TERRAIN"]="Terrain";e["VECTOR"]="Vector";e["IMAGERY_MAPS"]="ImageryMaps";e["VECTOR_MAPS_RASTER"]="VectorMapsRaster";e["IMAGERY_MAPS_MERCATOR"]="ImageryMapsMercator";return e}({});function toGEELayerType(e){switch(e){case"Imagery":return GEELayerType.IMAGERY;case"Terrain":return GEELayerType.TERRAIN;case"Vector":return GEELayerType.VECTOR;case"ImageryMaps":return GEELayerType.IMAGERY_MAPS;case"VectorMapsRaster":return GEELayerType.VECTOR_MAPS_RASTER;case"ImageryMapsMercator":return GEELayerType.IMAGERY_MAPS_MERCATOR}return GEELayerType.UNKNOWN}