import{ProgrammingError}from"../../error/ProgrammingError.js";import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds}from"../../shape/ShapeFactory.js";import{isString}from"../../util/Lang.js";import{RasterDataType}from"./RasterDataType.js";import{UrlTileSetModel}from"./UrlTileSetModel.js";const wgs84=getReference("EPSG:4326");export class GEEImageryTileSetModel extends UrlTileSetModel{constructor(e){if(!e||!isString(e.baseURL))throw new ProgrammingError("GEEImageryTileSetModel::BaseURL missing");const t=e.channel||e.mapId;if(!t)throw new ProgrammingError("GEEImageryTileSetModel:: Missing required parameter channel (or legacy equivalent parameter mapId)");const r=undefined;super({structure:{reference:e.reference||wgs84,level0Columns:e.level0Columns||2,level0Rows:e.level0Rows||1,levelCount:e.levelCount||24,tileWidth:e.tileWidth||256,tileHeight:e.tileHeight||256,bounds:e.bounds||createBounds(wgs84,[-180,360,-90,180])},baseURL:e.baseURL+"/query?request="+(e.request||"ImageryMaps")+"&channel={c}&version={v}&x={x}&y={y}&z={z}",dataType:RasterDataType.IMAGE});this.modelDescriptor={source:e.baseURL,name:e.layer||e.name||e.label||"",description:"Google Earth Enterprise Imagery Model",type:"tileset/image"};this._version=e.version??1;this._channel=t}get channel(){return this._channel}set channel(e){this._channel=e;this.invalidate()}get mapId(){return this._channel}set mapId(e){this._channel=e;this.invalidate()}get version(){return this._version}getTileURL(e,t){const r=t.level+1;const n=t.x;const s=this.getTileRowCount(t.level)??0;const i=0!==t.level?s-t.y-1+(s>>1):t.y;return e.replace("{c}",`${this._channel}`).replace("{v}",`${this._version}`).replace("{x}",`${n}`).replace("{y}",`${i}`).replace("{z}",`${r}`)}getImage(e,t,r,n){if(0!==e.level)return super.getImage(e,t,r,n);const s=(e,s)=>{const i=(e,n)=>{const i=this.getTileWidth(0);const l=this.getTileHeight(0);if(null===i||null===l)return;const a=document.createElement("canvas");a.width=i;a.height=l;const o=a.getContext("2d",{willReadFrequently:true});if(!o)return r(e,"could not initialize 2D Context");o.drawImage(s,0,l/2,i,l/2,0,0,i,l/2);o.drawImage(n,0,0,i,l/2,0,l/2,i,l/2);s.src=a.toDataURL();t(e,s)};const l={x:e.x,y:e.y+1,level:0};super.getImage(l,i,r,n)};return super.getImage(e,s,r,n)}}