import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds}from"../../shape/ShapeFactory.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{isArray,isNumber,isString}from"../../util/Lang.js";import{WebMercatorBounds}from"../WebMercatorBounds.js";import{RasterDataType}from"./RasterDataType.js";import{UrlTileSetModel}from"./UrlTileSetModel.js";import{URL}from"../../util/URL.js";const EPSILON=1e-6;function boundsInteracts(e,t,r,o,s){const i=e.x;const n=e.y;return!(r>i+e.height+EPSILON||r+s<i-EPSILON||(t>n+e.width+EPSILON||t+o<n-EPSILON)&&t>n-360+e.width+EPSILON&&t+o<n+360-EPSILON)}function imageryProviderOverlaps(e,t,r){const o=e.coverageAreas;for(let e=0,s=o.length;e<s;e++){const s=o[e];const i=s.zoomMin;const n=s.zoomMax;const a=s.bbox;const c=a[0];const l=a[1];const u=a[2];const m=a[3];if(i<=t&&t<=n&&boundsInteracts(r,c,l,u-c,m-l))return true}return false}function tileXYToQuadKey(e,t,r){let o="";for(let s=r;s>0;s--){let r=0;const i=1<<s-1;if(0!=(e&i))r++;if(0!=(t&i)){r++;r++}o+=r}return o}export class BingMapsTileSetModel extends UrlTileSetModel{constructor(e){let t=null;let r=["t0","t1","t2","t3"];let o=[];const s=undefined;const i="{quadkey}.jpeg?g=950";let n="http://ecn.{subdomain}.tiles.virtualearth.net/tiles/a"+i;const a=22;let c=256;let l=256;let u="en";let m,d;if(isString((e=e||{}).brandLogoUri))t=e.brandLogoUri;if(isString(e.culture))u=e.culture;let g=e;if(isArray(e.resourceSets)&&e.resourceSets.length>0){const t=e.resourceSets[0];if(isArray(t.resources)&&t.resources.length>0)g=t.resources[0]}if(isNumber(g.zoomMin)&&isNumber(g.zoomMax)){m=g.zoomMin;d=g.zoomMax}if(isNumber(g.imageWidth))c=g.imageWidth;if(isNumber(g.imageHeight))l=g.imageHeight;if(isArray(g.imageUrlSubdomains))r=g.imageUrlSubdomains.slice();if(isString(g.imageUrl))n=g.imageUrl;if(-1===n.indexOf("n=z"))n+=`${-1===n.indexOf("?")?"?":"&"}n=z`;if(isArray(g.imageryProviders))o=g.imageryProviders;const f=getReference("EPSG:900913");const h=getReference("EPSG:4326");const p=d-m+1;const y=Math.pow(2,m);const b={source:r[0]?n.replace("{subdomain}",r[0]).replace(i,""):n,name:"Bing Maps",description:`Microsoft Bing Maps Tile Model. culture=${u}`,type:RasterDataType.IMAGE.toString()};const M=undefined;super({structure:{reference:f,bounds:WebMercatorBounds.create(),levelCount:p,level0Columns:y,level0Rows:y,tileWidth:c,tileHeight:l},baseURL:n,credentials:false,modelDescriptor:Object.freeze(b)});this._domains=r;this._culture=u;this._imageryProviders=o;this._logoUri=t;this._zoomMin=m||0;this._zoomMax=d||a;this._referenceToWGS84=createTransformation(f,h);this._areaBounds=createBounds(f,[]);this._wgs84Bounds=createBounds(h,[]);this.useCors=true}_getBingLevel(e){return this._zoomMin+e}getTileURL(e,t){const r=this._getBingLevel(t.level);if(r<this._zoomMin||r>this._zoomMax)return null;const o=t.x;const s=this.getTileRowCount(r)-1-t.y;e=(e=(e=e.replace("{subdomain}",this._domains[Math.round(Math.random()*(this._domains.length-1))])).replace("{quadkey}",tileXYToQuadKey(o,s,r))).replace("{culture}",this._culture);const i=this.requestParameters;if(i&&0!==Object.keys(i).length)e+=(e.includes("?")?"&":"?")+URL.buildQueryString(i);return e}getAttribution(e){let t=[];for(const r of e){const e=r.level+1;const o=r.x;const s=r.y;const i=o+r.width;const n=s+r.height;const a=1<<e;const c=1<<e;const l=this.bounds;if(null===l)return[];const u=l.width/c;const m=l.height/a;const d=l.x+o*u;const g=l.y+s*m;const f=l.x+i*u;const h=l.y+n*m;const p=this._areaBounds;p.setTo2D(d,f-d,g,h-g);try{const r=this._referenceToWGS84.transformBounds(p,this._wgs84Bounds);const o=[];const s=this._imageryProviders;for(let t=0,i=s.length;t<i;t++){const i=s[t];if(imageryProviderOverlaps(i,e,r))o.push(i.attribution)}t=t.concat(o)}catch(e){}}return t}getLogo(){return this._logoUri}on(e,t,r){if("Invalidated"===e)return super.on(e,t,r);return{remove:()=>{}}}}