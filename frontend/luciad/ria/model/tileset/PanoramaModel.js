import{WithHttpRequestOptions}from"../../util/WithHttpRequestOptions.js";import{Ajax}from"../../util/Ajax.js";import{URL}from"../../util/URL.js";import{URLPatternUtil}from"./URLPatternUtil.js";import{CubeMapFace}from"./CubeMapFace.js";import{isPromise}from"../../util/PromiseUtil.js";import{PanoramaImageryType}from"./PanoramaImageryType.js";import{ProgrammingError}from"../../error/ProgrammingError.js";const DEFAULT_FACE_PATTERN_MAP=new Map([[CubeMapFace.FRONT,"front"],[CubeMapFace.BACK,"back"],[CubeMapFace.LEFT,"left"],[CubeMapFace.RIGHT,"right"],[CubeMapFace.TOP,"top"],[CubeMapFace.BOTTOM,"bottom"]]);export class PanoramaModel{constructor(e){this._panoramaDescriptor=e.panoramaDescriptor;this._httpRequestOptions=new WithHttpRequestOptions(e);this._urlPatternUtil=new URLPatternUtil(e);this._facePatternMap=e.facePatternMap||DEFAULT_FACE_PATTERN_MAP;this._requestParameters=e.requestParameters||{}}getPanoramicImage(e,t,r){let a;try{a=this.getPanoramicImageURL(e)}catch(t){if(r)r(e,t instanceof Error?t:new Error(""+t));return}if(!a){if(r)r(e,new Error("tile URL is null"));return}const s=r=>{if(t)t(e,r)};const i=t=>{if(r)r(e,t)};const n=!URL.isLocalURL(a);let o;try{o=Ajax.getImage(a,false,n,this.credentials,this.requestHeaders);if(isPromise(o))o.then(s).catch(i);else s(o)}catch(e){i(e)}}getPanoramicImageURL(e){if(this.isVideoPanoramaModel(e))throw new ProgrammingError("Cannot use getPanoramicImageURL for a PanoramaModel with video imagery.");let t=this.replaceURLPatterns(this.baseURL,e);if(this._requestParameters&&0!==Object.keys(this._requestParameters).length)t+=(this.baseURL.includes("?")?"&":"?")+URL.buildQueryString(this._requestParameters);return t}isVideoPanoramaModel(e){return this.getPanoramaDescriptor(e.feature,e.context)?.imageryType===PanoramaImageryType.VIDEO}replaceURLPatterns(e,t){const r=this.getPanoramaDescriptor(t.feature,t.context);if(!r)return null;let a=this._urlPatternUtil.replaceURLPatterns(t,r.structure,e);if(!a)return null;a=a.replace(/{id}/g,String(t.feature.id));if(t.face)a=a.replace(/{face}/g,this._facePatternMap.get(t.face));for(const e in t.context)if(t.context.hasOwnProperty(e)){const r=new RegExp(`{context.${e}}`,"g");a=a.replace(r,String(t.context[e]))}return a}getPanoramaDescriptor(e,t){return this._panoramaDescriptor}get credentials(){return this._httpRequestOptions.credentials}set credentials(e){this._httpRequestOptions.credentials=e}get requestHeaders(){return this._httpRequestOptions.requestHeaders}set requestHeaders(e){this._httpRequestOptions.requestHeaders=e}get subdomains(){return this._urlPatternUtil.subdomains}set subdomains(e){this._urlPatternUtil.subdomains=e}get baseURL(){return this._urlPatternUtil.baseURL}set baseURL(e){this._urlPatternUtil.baseURL=e}get requestParameters(){return this._requestParameters}set requestParameters(e){this._requestParameters=e}}