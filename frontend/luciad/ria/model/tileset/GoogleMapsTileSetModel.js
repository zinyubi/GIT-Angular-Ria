import{UrlTileSetModel}from"./UrlTileSetModel.js";import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds}from"../../shape/ShapeFactory.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{URL}from"../../util/URL.js";import{request}from"../../util/request.js";import{EventedSupport}from"../../util/EventedSupport.js";import{WebMercatorBounds}from"../WebMercatorBounds.js";import{isDefined}from"../../util/Lang.js";const WEB_MERCATOR=getReference("EPSG:3857");const WGS84=getReference("EPSG:4326");function equalRegions(e,t){return e.level===t.level&&e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}export class GoogleMapsTileSetModel extends UrlTileSetModel{_lastRequestedRegions=null;_lastRequestResult=[];_eventedSupport=new EventedSupport(["AttributionChanged"]);constructor(e,t){super({baseURL:"https://tile.googleapis.com/v1/2dtiles/{z}/{x}/{-y}",credentials:false,structure:{levelCount:22,level0Columns:1,level0Rows:1,tileWidth:t.tileWidth,tileHeight:t.tileHeight,reference:WEB_MERCATOR,bounds:WebMercatorBounds.create()}});this.requestParameters={session:t.session,key:e};this._session=t.session;this._apiKey=e;this._referenceToWGS84=createTransformation(WEB_MERCATOR,WGS84);this._areaBounds=createBounds(WEB_MERCATOR,[]);this._wgs84Bounds=createBounds(WGS84,[])}addTileRegionToBoundsPerLevel(e,t){const s=this.bounds;if(null===s)return;const o=t.level;const n=t.x;const i=t.y;const r=n+t.width;const a=i+t.height;const l=1<<o;const u=1<<o;const c=s.width/u;const h=s.height/l;const d=s.x+n*c;const p=s.y+i*h;const g=s.x+r*c;const f=s.y+a*h;const R=this._areaBounds;R.setTo2D(d,g-d,p,f-p);const m=this._referenceToWGS84.transformBounds(R,this._wgs84Bounds);if(e.has(o))e.get(o).setTo3DUnion(m);else e.set(o,m)}isRegionCacheValid(e){if(!this._lastRequestedRegions)return false;if(this._lastRequestedRegions.length!==e.length)return false;for(let t=0;t<this._lastRequestedRegions.length;t++)if(!equalRegions(this._lastRequestedRegions[t],e[t]))return false;return true}getAttribution(e){if(this.isRegionCacheValid(e))return this._lastRequestResult;this._lastRequestedRegions=e;const t=[];const s=new Map;for(const o of e){if(!t.includes(o.level))t.push(o.level);this.addTileRegionToBoundsPerLevel(s,o)}const o=[];for(let e=0;e<t.length;e++){const n=t[e];const i=s.get(n);const r="https://tile.googleapis.com/tile/v1/viewport";const a={session:this._session,key:this._apiKey,zoom:n,north:i.y+i.height,south:i.y,east:i.x+i.width,west:i.x};const l=`${r}?${URL.buildQueryString(a)}`;const u=request(l).then((e=>e.json())).then((e=>e.copyright??"")).catch((e=>""));o.push(u)}Promise.allSettled(o).then((e=>{this._lastRequestResult=[];for(const t of e)if("fulfilled"===t.status){const e=t.value;if(!this._lastRequestResult.includes(e))this._lastRequestResult.push(e)}this._eventedSupport.emit("AttributionChanged")})).catch((e=>{}));return this._lastRequestResult}getLogo(){return null}on(e,t,s){if("Invalidated"===e)return super.on(e,t,s);return this._eventedSupport.on(e,t,s)}}export async function createGoogleMapsTileSetModel(e,t){try{const s=await request(`https://www.googleapis.com/tile/v1/createSession?key=${e}`,{method:"POST",body:createDataForSessionCreation(t)});const o=await s.json();return new GoogleMapsTileSetModel(e,o)}catch(e){const t=e.response;const s=(await t.json())["error"]["message"];throw new Error("Cannot create a GoogleMapsTileSetModel, cannot create a valid session for Google Map Tiles: "+s)}}export function createDataForSessionCreation(e){let t=e?.layerTypes;if("terrain"===e?.mapType){if(!isDefined(t))t=[];if(-1===t.indexOf("layerRoadmap"))t.push("layerRoadmap")}const s={mapType:e?.mapType??"roadmap",language:e?.language??"en-US",region:e?.region??"US",imageFormat:e?.imageFormat,scale:e?.scale,highDpi:false,layerTypes:t,styles:e?.styles,overlay:e?.overlay};return JSON.stringify(s)}