import{PhotonWorkerPoolFactory}from"../../gen/inlined-webworker/PhotonWorkerPoolFactory.js";import{Log}from"../../util/Log.js";import{isString}from"../../util/Lang.js";import{TileSet3DModelSupport}from"./TileSet3DModelSupport.js";import{addHttpRequestOptions}from"../../util/HttpRequestOptions.js";import{request,urlWithParams}from"../../util/request.js";import{URL as RIAUrl}from"../../util/URL.js";import{EventedSupport}from"../../util/EventedSupport.js";import{GLTFDecoder}from"../../geometry/mesh/GLTFDecoder.js";const STRING_DECODE_CHUNK_SIZE=1024;export class OGC3DTilesModel{_attributions=[];constructor(e,t){this._delegate=new TileSet3DModelSupport(e,t);this._eventedSupport=new EventedSupport(["AttributionChanged"])}get credentials(){return this._delegate.credentials}set credentials(e){this._delegate.credentials=e}getAttribution(e){return this._attributions}getLogo(){return null}get requestHeaders(){return this._delegate.requestHeaders}set requestHeaders(e){this._delegate.requestHeaders=e}addHttpRequestOptions(e){return this._delegate.addHttpRequestOptions(e)}get url(){return this._delegate.url}get urlParams(){return this._delegate.urlParams}get requestParameters(){return this._delegate.requestParameters}set requestParameters(e){this._delegate.requestParameters=e}get bounds(){return this._delegate.bounds}get orientedBox(){return this._delegate.orientedBox}get coordinateType(){return this._delegate.coordinateType}get reference(){return this._delegate.reference}get modelDescriptor(){return this._delegate.modelDescriptor}set attributions(e){this._attributions=e;this._eventedSupport.emit("AttributionChanged")}static async create(e,t){const r=await TileSet3DModelSupport.open(e,"OGC3DTilesModel",t);const s={source:urlWithParams(e,t?.requestParameters??null),name:"OGC 3D Tiles Tile Set Model",type:"OGC3D",description:"Model for Mesh and PointCloud OGC 3D tiles",properties:r.metadata.properties||{},asset:r.metadata.asset||{},hasMesh:r.hasMesh,hasPointCloud:r.hasPointCloud,hasNormalData:r.hasNormalData};logUnsupportedWarnings(r.metadata,e);if(0==Object.keys(s.properties).length)s.properties=await loadPropertiesFromDataFile(e,r.metadata.rootContentUrl,r.credentials,r.requestHeaders,r.requestParameters);return new OGC3DTilesModel(r,s)}on(e,t,r){return{remove:()=>{}}}}function logUnsupportedWarnings(e,t){if(e)if(e.asset&&e.asset.gltfUpAxis)if(!isString(e.asset.gltfUpAxis)||"y"!==e.asset.gltfUpAxis.toLowerCase()&&"z"!==e.asset.gltfUpAxis.toLowerCase())Log.warn(`${t}: Unsupported gltfUpAxis value: ${e.asset.gltfUpAxis}. Only 'Y' and 'Z' are supported. This could result in the 3D mesh to be incorrectly oriented.`)}function parsePropertiesInWebWorker(e,t,r){let s=PhotonWorkerPoolFactory.getGLTFWorkerPoolHandle();const o=undefined;return new GLTFDecoder(s.webWorkerPool).parse3DTilesProperties(e,t,r).then((e=>e)).finally((()=>{s.release()}))}function loadPropertiesFromDataFile(e,t,r,s,o){const a=new URL(e,window.location.href).href;t=new URL(t??"",a).href;const i={...RIAUrl.parseQueryString(e),...o??{}};const n={credentials:r,requestHeaders:s};const l=addHttpRequestOptions({},{credentials:r,requestHeaders:s});const u=urlWithParams(t,i);return request(u,l).then((e=>e.arrayBuffer())).then((e=>parsePropertiesInWebWorker(e,t,n))).then((e=>{const t=JSON.parse(e);const r={minimum:void 0,maximum:void 0};let s={};for(let e=0;e<t.length;e++)s[t[e]]=r;return s})).catch((e=>{console.error(e)}))}function parseTilesMetaData(e){if(!e)return{asset:{},properties:{}};return{asset:e.asset||{},properties:e.properties||{}}}export function createOGC3DTilesModel(e,t){return OGC3DTilesModel.create(e,t)}