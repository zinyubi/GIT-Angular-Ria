import{getReference}from"../../reference/ReferenceProvider.js";import{createBounds}from"../../shape/ShapeFactory.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{isArray,isDefined,isNumber,isObject,isString}from"../../util/Lang.js";import{WebMercatorBounds}from"../WebMercatorBounds.js";import{RasterDataType}from"./RasterDataType.js";import{UrlTileSetModel}from"./UrlTileSetModel.js";import{ProgrammingError}from"../../error/ProgrammingError.js";const CONNECTION_ERROR_MESSAGE="Could not connect to HERE Maps server";const PSEUDO_MERCATOR=getReference("EPSG:3857");const WGS84=getReference("EPSG:4326");const DEFAULT_SERVER="maps.hereapi.com";const DEFAULT_RESOURCE="base";const DEFAULT_PROJECTION="mc";const DEFAULT_STYLE="explore.day";const DEFAULT_FORMAT="png8";const DEFAULT_SIZE=256;const copyrightBounds=createBounds(WGS84,[]);function copyrightProviderOverlaps(e,r,t){const o=e.boundingBoxes;const s=e.minLevel;const n=e.maxLevel;if(s<=r&&r<=n){if("undefined"===typeof o)return true;for(let e=0,r=o.length;e<r;e++){const r=o[e];const s=r.south;const n=r.west;const i=r.north;const c=r.east;copyrightBounds.setTo2D(n,c-n,s,i-s);if(t.interacts2D(copyrightBounds))return true}}return false}export class HereMapsTileSetModel extends UrlTileSetModel{constructor(e){e=e||{};let r=[];let t="https://{server}/v3/{resource}";t=t.replace("{server}",e.server);t=t.replace("{resource}",e.resource);let o="/{projection}/{z}/{x}/{y}/{format}?apiKey={apiKey}";o=o.replace("{projection}",e.projection);o=o.replace("{format}",e.format);o=o.replace("{apiKey}",e.apiKey);if(isString(e.style))o+=`&style=${e.style}`;let s=DEFAULT_SIZE;if(isNumber(e.size)&&e.size!==DEFAULT_SIZE){s=e.size;o+=`&size=${s}`}if(isObject(e.features)){const r=[];const t=Object.keys(e.features).sort();for(const o of t){const t=e.features[o];r.push(`${o}:${t}`)}o+="&features="+r.join(",")}if(isString(e.lang))o+=`&lang=${e.lang}`;if(isString(e.lang2))o+=`&lang2=${e.lang2}`;if(isString(e.pview))o+=`&pview=${e.pview}`;if(isNumber(e.ppi))o+=`&ppi=${e.ppi}`;if(isNumber(e.scale))o+=`&scale=${e.scale}`;const n=t+o;const i=e;if(isArray(e.copyrightProviders))r=i.copyrightProviders;const c={source:t,name:"HERE Maps",description:`HERE Maps Tile Model.`,type:RasterDataType.IMAGE.toString()};const a=undefined;super({structure:{reference:PSEUDO_MERCATOR,bounds:WebMercatorBounds.create(),levelCount:21,level0Columns:1,level0Rows:1,tileWidth:s,tileHeight:s},baseURL:n,credentials:false,modelDescriptor:Object.freeze(c)});this._copyrightProviders=r;this._zoomMin=0;this._zoomMax=20;this._referenceToWGS84=createTransformation(PSEUDO_MERCATOR,WGS84);this._areaBounds=createBounds(PSEUDO_MERCATOR,[]);this._wgs84Bounds=createBounds(WGS84,[]);this.useCors=true}_getHereLevel(e){return this._zoomMin+e}getTileURL(e,r){const t=this._getHereLevel(r.level);if(t<this._zoomMin||t>this._zoomMax)return null;const o=r.x;const s=this.getTileRowCount(t)-1-r.y;return super.getTileURL(e,{level:t,x:o,y:s})}getAttribution(e){let r=[];for(const t of e){const e=t.level;const o=t.x;const s=t.y;const n=o+t.width;const i=s+t.height;const c=1<<e;const a=1<<e;const l=this.bounds;if(null===l)return[];const u=l.width/a;const f=l.height/c;const p=l.x+o*u;const m=l.y+s*f;const E=l.x+n*u;const g=l.y+i*f;const d=this._areaBounds;d.setTo2D(p,E-p,m,g-m);try{const t=this._referenceToWGS84.transformBounds(d,this._wgs84Bounds);const o=[];o.push("Â© "+(new Date).getFullYear()+" HERE");const s=this._copyrightProviders;for(let r=0,n=s.length;r<n;r++){const n=s[r];if(copyrightProviderOverlaps(n,e,t))o.push(n.copyrightText)}r=r.concat(o)}catch(e){}}return r}getLogo(){return null}on(e,r,t){if("Invalidated"===e)return super.on(e,r,t);return{remove:()=>{}}}}export function createHereMapsTileSetModel(e){if(!e.apiKey)return Promise.reject(new ProgrammingError("Could not access HERE; an API key must be specified."));const r=isDefined(e.server)?e.server:DEFAULT_SERVER;const t=isDefined(e.resource)?e.resource:DEFAULT_RESOURCE;const o=isDefined(e.projection)?e.projection:DEFAULT_PROJECTION;const s="undefined"!==typeof e.format?e.format:DEFAULT_FORMAT;let n="https://{server}/v3/info?apiKey={apiKey}";n=n.replace("{server}",r);n=n.replace("{apiKey}",e.apiKey);return fetch(n).then((function(e){if(!e.ok)return Promise.reject(new ProgrammingError("Could not access HERE; please verify whether the supplied API key is valid."));return e.json()}),(function(){return Promise.reject(new Error(`${CONNECTION_ERROR_MESSAGE}: ${r}`))})).then((function(n){if(n.resources.indexOf(t)<0)return Promise.reject(new ProgrammingError(`Invalid resource [${t}] for server ${r}`));if(n.projections.indexOf(o)<0)return Promise.reject(new ProgrammingError(`Invalid projection [${o}] for resource ${t} on server ${r}`));if(n.imageFormats.indexOf(s)<0)return Promise.reject(new ProgrammingError(`Invalid format [${s}] for resource ${t} on server ${r}`));if(e.style&&n.styles.indexOf(e.style)<0)return Promise.reject(new ProgrammingError(`Invalid style [${e.style}] for resource ${t} on server ${r}`));if(isNumber(e.size)&&n.imageSizes.indexOf(e.size)<0)return Promise.reject(new ProgrammingError(`Invalid tile size [${e.size}] for server ${r}`));let i="https://{server}/v3/copyright?apiKey={apiKey}";i=i.replace("{server}",r);i=i.replace("{apiKey}",e.apiKey);return fetch(i)})).then((function(e){if(!e.ok)return Promise.resolve({copyrights:[],resources:[]});return e.json()}),(function(e){if(e instanceof ProgrammingError||e.message&&e.message.indexOf(CONNECTION_ERROR_MESSAGE)>=0)return Promise.reject(e);return{copyrights:[],resources:[]}})).then((function(n){let i=[];const c=n.resources[t];if(c){const r=e.style||DEFAULT_STYLE;const t=undefined;c.styles[r].forEach((e=>{if(n.copyrights[e])i=i.concat(n.copyrights[e])}))}const a={...e,apiKey:e.apiKey,server:r,resource:t,projection:o,format:s,copyrightProviders:i};return new HereMapsTileSetModel(a)}))}