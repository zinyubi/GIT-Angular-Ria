import{WMTSCapabilitiesParser}from"./WMTSCapabilitiesParser.js";import{WMTSCapabilitiesUtil}from"./WMTSCapabilitiesUtil.js";import{URL as RIAUrl}from"../../util/URL.js";import{WMSVersion}from"../../ogc/WMSVersion.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{RequestError}from"../../error/RequestError.js";import{LuciadAggregateError}from"../../error/LuciadAggregateError.js";import{createWMTSGetOperationsEncodingInfo,resolveRequestEncodingFromRequestUrl,WMTSRequestEncoding}from"../tileset/WMTSRequestEncoding.js";const SUPPORTED_VERSIONS=[WMSVersion.V100];function createParser(e,r){switch(r){case WMSVersion.V100:return new WMTSCapabilitiesParser(e);default:throw new Error(`Can not parse unsupported WMTS version: ${r}`)}}export class WMTSCapabilities{constructor(e,r){this._capabilitiesXML=r;this._parser=createParser(r,e);this._version=this._parser.version;this._service=this._parser.getService();this._updateSequence=this._parser.getUpdateSequence();const t=this._layers=this._parser.getLayers();const i=this._requests=this._parser.getRequests();this._httpGetRequestEncodings=createWMTSGetOperationsEncodingInfo(i,t)}static fromURL(e,r){(r=r||{}).requestParameters=Object.assign(r.requestParameters||{},RIAUrl.parseQueryString(e));const t=r.preferredRequestEncoding??resolveRequestEncodingFromRequestUrl(e);const i=e.indexOf("?");if(i>-1)e=e.substr(0,i);const s={credentials:r.credentials,requestHeaders:r.requestHeaders,requestParameters:r.requestParameters};let n=WMTSCapabilitiesUtil.createVersionNegotiator(e,SUPPORTED_VERSIONS,r.allowedVersions,s,t);return WMTSCapabilities.createWMTSCapabilitiesFromVersionNegotiator(n).catch((i=>{if(!(i instanceof RequestError))throw i;n=WMTSCapabilitiesUtil.createVersionNegotiator(e,SUPPORTED_VERSIONS,r.allowedVersions,s,t===WMTSRequestEncoding.KVP?WMTSRequestEncoding.REST:WMTSRequestEncoding.KVP);return WMTSCapabilities.createWMTSCapabilitiesFromVersionNegotiator(n).catch((e=>{if(e instanceof RequestError){const r=new LuciadAggregateError("Could not negotiate WMTS version, Tried both KVP and REST request encodings");r.addErrors([i,e]);throw r}else if(e instanceof Error)throw e;else throw new ProgrammingError(e)}))}))}static async createWMTSCapabilitiesFromVersionNegotiator(e){return e.negotiateVersion().then((e=>new WMTSCapabilities(e.version,e.response))).catch((e=>{if(e instanceof Error)throw e;throw new ProgrammingError(e)}))}static fromXML(e){const r=WMTSCapabilitiesUtil.parseVersion(e);const t=new WMTSCapabilities(r,e);return Promise.resolve(t)}getRawCapabilities(){return this._capabilitiesXML}get version(){return this._version}get service(){return this._service}get updateSequence(){return this._updateSequence}get layers(){return this._layers}get requests(){return this._requests}getHttpGetRequestEncodings(e,r,t){if("GetCapabilities"===e){if(this._service.url)this._httpGetRequestEncodings.OperationsMetadataDeducedEncodings[e].add(WMTSRequestEncoding.REST);return[...this._httpGetRequestEncodings.OperationsMetadataDeducedEncodings[e].values()]}else if("GetTile"===e||"GetFeatureInfo"===e){if(!r)throw new ProgrammingError(`layerId must be specified when request operation is ${e}`);if("GetTile"===e)return this.getEncodings(r,t,"GetTile");else if("GetFeatureInfo"===e)return this.getEncodings(r,t,"GetFeatureInfo")}throw new ProgrammingError(`Unknown request operation: ${e}`)}getEncodings(e,r,t){const i=new Set(this._httpGetRequestEncodings.OperationsMetadataDeducedEncodings[t]);const s=this.layers.filter((r=>r.identifier===e))?.[0];if(!s)throw new ProgrammingError(`Cannot find layer with identifier: ${e}`);const n="GetTile"===t;const o=n?s.formats:s.infoFormats;const a=o&&o.length>0;if(i.has(WMTSRequestEncoding.KVP))if(!a||r&&!o.includes(r))i.delete(WMTSRequestEncoding.KVP);const c=n?"tile":"FeatureInfo";const u=undefined;if(!!this._httpGetRequestEncodings.restEncodingSupportedLayers.find((r=>r.LayerId===e))?.resources.some((e=>e.resourceType.toUpperCase()===c.toUpperCase()&&(!r||e.format===r))))i.add(WMTSRequestEncoding.REST);else if(i.has(WMTSRequestEncoding.REST))i.delete(WMTSRequestEncoding.REST);return[...i]}}