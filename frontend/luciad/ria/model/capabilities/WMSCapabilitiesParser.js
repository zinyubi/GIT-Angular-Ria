import{isDefined}from"../../util/Lang.js";import{freeze}from"./common/CapabilitiesParserUtil.js";import{WMSCapabilitiesLayer}from"./WMSCapabilitiesLayer.js";export class WMSCapabilitiesParser{constructor(e,t){this._raw=e;for(let r=0;r<t.length;r++)if(isDefined(e[t[r]]))this._rawRoot=e[t[r]];this._layers=[]}getRawCapabilities(){return this._raw}parseServiceMetadata(){const e=this._rawRoot.Service;if(!isDefined(e))return null;return freeze({name:e.Name,title:e.Title,abstract:e.Abstract,keywords:e.KeywordList&&e.KeywordList.Keyword,url:e.OnlineResource&&e.OnlineResource.href,contactInformation:this.parseContactInformation(e.ContactInformation),fees:"none"!==e.Fees?e.Fees:null,accessConstraints:"none"!==e.AccessConstraints?e.AccessConstraints:null,layerLimit:e.LayerLimit,maxWidth:e.MaxWidth,maxHeight:e.MaxHeight})}parseContactInformation(e){if(!isDefined(e))return null;return freeze({primaryPerson:this._parsePerson(e.ContactPersonPrimary),position:e.ContactPosition,address:parseContactAddress(e.ContactAddress),telephone:e.ContactVoiceTelephone,fax:e.ContactFacsimileTelephone,email:e.ContactElectronicMailAddress})}_parsePerson(e){if(!isDefined(e))return null;return freeze({person:e.ContactPerson,organization:e.ContactOrganization})}parseUpdateSequence(){return this._rawRoot.updateSequence}parseLayers(){const e=this._rawRoot.Capability.Layer;if(e)for(let t=0;t<e.length;t++){const r=this.parseLayer(e[t],{});if(r){r.setParent(null);this._layers.push(r)}}return this._layers}parseLayer(e,t){if(!isDefined(e))return null;t=this.createLayerInheritanceOptions(e,t);const r=new WMSCapabilitiesLayer({swapAxes:this._swapAxes,children:(e.Layer||[]).map((e=>this.parseLayer(e,t))),title:e.Title,name:e.Name,styles:t.styles||[],supportedReferences:t.references||[],queryable:t.queryable||false,cascaded:t.cascaded||0,opaque:t.opaque||false,noSubsets:t.noSubsets||false,fixedWidth:t.fixedWidth||0,fixedHeight:t.fixedHeight||0,abstract:e.Abstract,keywords:e.KeywordList&&e.KeywordList.Keyword,attribution:t.attribution,metadata:(e.MetadataURL||[]).map(parseResourceWithFormat),identifiers:(e.Identifier||[]).map((e=>parseIdentifier(e,t))),featureListURL:parseResourceWithFormat(e.FeatureListURL&&e.FeatureListURL[0]),dataURL:parseResourceWithFormat(e.DataURL&&e.DataURL[0]),dimensions:t.dimensions||[],wgs84Bounds:t.wgs84Bounds,bounds:t.bounds||[],minScaleDenominator:t.scaleDenominator&&t.scaleDenominator.min,maxScaleDenominator:t.scaleDenominator&&t.scaleDenominator.max});r.children.forEach((e=>{e.setParent(r)}));return r}createLayerInheritanceOptions(e,t){t={...t};if(isDefined(e.AuthorityURL)){const r=e.AuthorityURL.map(parseAuthority);const i=t.authorities||[];t.authorities=inheritArrayByAdd(r,i,((e,t)=>e.name===t.name))}t.attribution=parseAttribution(e.Attribution);if(isDefined(e.Style)){const r=e.Style.map(parseStyle);const i=t.styles||[];t.styles=inheritArrayByReplace(r,i,((e,t)=>e.name===t.name))}const r=e[this._referenceFieldName];if(isDefined(r)){const e=t.references||[];t.references=inheritArrayByAdd(r,e,((e,t)=>e===t))}if(this._hasWGS84Bounds(e))t.wgs84Bounds=this._parseWGS84Bounds(e);if(this._hasBoundsList(e)){const r=this._parseBoundsList(e);const i=t.bounds||[];t.bounds=inheritArrayByReplace(r,i,((e,t)=>e.reference===t.reference))}if(isDefined(e.Dimension)){const r=e.Dimension.map(parseDimension);const i=t.dimensions||[];t.dimensions=inheritArrayByReplace(r,i,((e,t)=>e.name===t.name))}const i=this._parseLayerScaleDenominator(e);if(isDefined(i))t.scaleDenominator=i;if(isDefined(e.queryable))t.queryable=e.queryable;if(isDefined(e.cascaded))t.cascaded=e.cascaded;if(isDefined(e.opaque))t.opaque=e.opaque;if(isDefined(e.noSubsets))t.noSubsets=e.noSubsets;if(isDefined(e.fixedWidth))t.fixedWidth=e.fixedWidth;if(isDefined(e.fixedHeight))t.fixedHeight=e.fixedHeight;return t}parseBounds(e){if(!e)return null;const t=undefined;return{reference:e[this._referenceFieldName],x:e.minx,y:e.miny,width:e.maxx-e.minx,height:e.maxy-e.miny,resolutionX:e.resx,resolutionY:e.resy}}parseOperations(){const e=[];const t=this._rawRoot.Capability.Request;function r(t){if(t)e.push(t)}r(parseOperationTypeSchema(t.GetCapabilities,"GetCapabilities"));r(parseOperationTypeSchema(t.GetMap,"GetMap"));r(parseOperationTypeSchema(t.GetFeatureInfo,"GetFeatureInfo"));return Object.freeze(e)}parseExceptionFormats(){const e=this._rawRoot.Capability.Exception;if("undefined"!==typeof e)return freeze(e.Format);else return freeze([])}parseUserDefinedSymbolization(){const e=this._rawRoot.Capability.UserDefinedSymbolization||{};return freeze({supportSLD:!!e.supportSLD,userLayer:!!e.userLayer,userStyle:!!e.userStyle,remoteWFS:!!e.remoteWFS})}}function parseStyle(e){if(!isDefined(e))return null;return freeze({name:e.Name,title:e.Title,abstract:e.Abstract,legend:(e.LegendURL||[]).map(parseImageUrl)})}function parseAttribution(e){if(!isDefined(e))return null;return freeze({url:e.OnlineResource&&e.OnlineResource.href,title:e.Title,logo:parseImageUrl(e.LogoURL)})}function parseIdentifier(e,t){if(!isDefined(e))return null;const r=findAuthority(t.authorities,e.authority);return freeze({authority:r,identifier:e["#text"]})}function parseAuthority(e){return freeze({name:e.name,url:e.OnlineResource&&e.OnlineResource})}function parseContactAddress(e){if(!isDefined(e))return null;return freeze({type:e.AddressType,address:e.Address,city:e.City,stateOrProvince:e.StateOrProvince,postCode:e.PostCode,country:e.Country})}function findAuthority(e,t){if(!isDefined(e))return null;for(let r=0;r<e.length;r++)if(e[r].name===t)return e[r];return null}function parseResourceWithFormat(e){if(!isDefined(e))return null;return freeze({type:e.Format,url:e.OnlineResource&&e.OnlineResource.href})}function parseImageUrl(e){if(!isDefined(e))return null;return freeze({width:e.width,height:e.height,format:e.Format,url:e.OnlineResource&&e.OnlineResource.href})}function parseDimension(e){if(!isDefined(e))return null;return freeze({name:e.name,units:e.units,extent:e["#text"],unitSymbol:e.unitSymbol,default:e["default"],multipleValues:e.multipleValues,nearestValue:e.nearestValue,current:e.current})}function parseOperationTypeSchema(e,t){if(!isDefined(e))return null;const r=[];const i=e.DCPType&&e.DCPType[0];if(i.HTTP&&i.HTTP.Get)r.push({method:"GET",url:i.HTTP.Get.OnlineResource&&i.HTTP.Get.OnlineResource.href});if(i.HTTP&&i.HTTP.Post)r.push({method:"POST",url:i.HTTP.Post.OnlineResource&&i.HTTP.Post.OnlineResource.href});return freeze({name:t,supportedFormats:e.Format,supportedRequests:r})}function inheritArrayByAdd(e,t,r){return inheritArray(e,t,r,false)}function inheritArrayByReplace(e,t,r){return inheritArray(e,t,r,true)}function inheritArray(e,t,r,i){const n=t.slice(0);for(let s=0;s<e.length;s++){let a=false;for(let o=0;o<t.length;o++){if(!r(t[o],e[s]))continue;if(i)n[o]=e[s];a=true;break}if(!a)n.push(e[s])}return n}