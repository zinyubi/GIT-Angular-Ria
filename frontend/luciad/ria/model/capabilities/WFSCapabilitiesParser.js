import{isDefined}from"../../util/Lang.js";import{parseCornerValues,freeze}from"./common/CapabilitiesParserUtil.js";export class WFSCapabilitiesParser{constructor(e){this._raw=e;this._rawRoot=e.WFS_Capabilities}getRawCapabilities(){return this._raw}getUpdateSequence(){return this._rawRoot.updateSequence?this._rawRoot.updateSequence:null}getFeatureTypes(){const e=this._rawRoot.FeatureTypeList;const t=this._rawRoot.OperationsMetadata;if(!isDefined(e))return null;const r=this.getFeature(t);const s=[];e.FeatureType.forEach((e=>{const t=this.getFeatureType(e,r.outputFormats);if(t)s.push(t)}));return s}getWGS84Bounds(e){if(!isDefined(e))return[];return e.map((e=>{const[t,r]=parseCornerValues(e.LowerCorner);const[s,n]=parseCornerValues(e.UpperCorner);return freeze({reference:e.crs||"CRS:84",minX:t,minY:r,maxX:s,maxY:n,width:s-t,height:n-r})}))}getService(){const e=this._rawRoot.ServiceProvider;if(!isDefined(e))return null;const t=this._rawRoot.ServiceIdentification;const r=e.ProviderSite;return freeze({title:t&&t.Title,abstract:t&&t.Abstract,keywords:t&&this.getKeywords(t),url:r&&r.href,contactInformation:getContactInformation(e)})}getKeywords(e){const t=e.Keywords;if(!isDefined(t))return[];return t.map((e=>{const t=e.Type&&e.Type["#text"];return freeze({keywords:e.Keyword||[],type:t})}))}getOperations(){const e=[];const t=this._rawRoot.OperationsMetadata;const r=this.getCapabilities(t);const s=this.getFeature(t);const n=this.getDescribeFeatureType(t);if(r)e.push(r);if(s)e.push(s);if(n)e.push(n);return Object.freeze(e)}getCapabilities(e){if(!isDefined(e))return null;const t=e.Operation.filter((e=>"GetCapabilities"===e.name))[0];const r=this.getParametersValues(t,"AcceptVersions");const s=this.getParametersValues(t,"AcceptFormats");const n=getSupportedRequests(t);return freeze({name:"GetCapabilities",supportedVersions:r,supportedFormats:s,supportedRequests:n})}getFeature(e){if(!e)return null;const t=e.Operation.filter((e=>"GetFeature"===e.name))[0];const r=this.getParametersValues(t,"outputFormat");const s=getSupportedRequests(t);return freeze({name:"GetFeature",supportedFormats:r,supportedRequests:s})}getDescribeFeatureType(e){if(!isDefined(e))return null;const t=e.Operation.filter((e=>"DescribeFeatureType"===e.name))[0];const r=this.getParametersValues(t,"outputFormat");const s=getSupportedRequests(t);return freeze({name:"DescribeFeatureType",supportedFormats:r,supportedRequests:s})}getQualifiedFeatureTypeName(e){const t=e.Name.split(":");if(isDefined(e.Namespace)&&t.length>1)return{namespace:e.Namespace,prefix:t[0],localPart:e.Name.substring(t[0].length+1)};return null}getParameterObject(e,t){if(!isDefined(e?.Parameter))return null;return e.Parameter.filter((e=>e.name===t))[0]??null}}function getContactInformation(e){const t=e.ServiceContact;const r=t&&t.ContactInfo;const s=r&&r.Phone;const n=r&&r.Address;return freeze({primaryPerson:getPrimaryPerson(e),position:t&&t.PositionName,address:getAddress(e),telephone:s&&s.Voice&&s.Voice[0],fax:s&&s.Facsimile,email:n&&n.ElectronicMailAddress&&n.ElectronicMailAddress[0]})}function getPrimaryPerson(e){return freeze({person:e.ServiceContact&&e.ServiceContact.IndividualName,organization:e.ProviderName})}function getAddress(e){const t=e.ServiceContact&&e.ServiceContact.ContactInfo;const r=t&&t.Address;if(!isDefined(r))return null;return freeze({address:r.DeliveryPoint&&r.DeliveryPoint[0],city:r.City,stateOrProvince:r.AdministrativeArea,postCode:r.PostalCode,country:r.Country})}function getSupportedRequests(e){if(!isDefined(e))return null;const t=[];const r=e.DCP&&e.DCP[0];if(r.HTTP&&r.HTTP.Get)t.push({method:"GET",url:r.HTTP.Get.href});if(r.HTTP&&r.HTTP.Post)t.push({method:"POST",url:r.HTTP.Post.href});return t}