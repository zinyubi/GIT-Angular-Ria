import{ProgrammingError}from"../../error/ProgrammingError.js";import{EventedSupport}from"../../util/EventedSupport.js";import{JSZip}from"../../util/jszip/jszip.js";import{isBoolean,isString}from"../../util/Lang.js";import{Codec}from"../codec/Codec.js";import{KMLCursorBuilder}from"./KMLCursor.js";import{KMZResources}from"../../view/kml/KMZResources.js";const ZIP_HEADER=1347093252;export class KMLCodec extends Codec{constructor(e){super();const{origin:r,withStyle:t}=e||{};this._origin=r??"";this._evented=new EventedSupport(["KMLNetworkLink","KMLTree","KMLGroundOverlay","KMLScreenOverlay","KMLModelGeometry","KMLFatalError","KMLIsHoverable"],true);this._withStyle=isBoolean(t)?t:true;this._kmzResources=new KMZResources}get kmzResources(){return this._kmzResources}decode(e){const{content:r}=e;if(isString(r))return new KMLCursorBuilder(r,this._withStyle,this._origin).build(this._evented,this._kmzResources);if(r instanceof Blob)return new Response(r).arrayBuffer().then((r=>this.decode({...e,content:r})));if(new DataView(r).getUint32(0)===ZIP_HEADER)return this.unzip(r).then((r=>this.decode({...e,content:r})));const t=(new TextDecoder).decode(r);return this.decode({...e,content:t})}encode(e){throw new ProgrammingError("KML Encoding is not currently supported.")}async unzip(e){const r=await JSZip.loadAsync(e);const t=r.file(/^[^/]+\.kml$/i);try{await(this._kmzResources?.setResources(r))}catch(e){this._evented.emit("KMLFatalError",`Not all KMZ resources could be loaded`);console.error(e)}return t[0].async("text")}on(e,r,t){return this._evented.on(e,r,t)}}