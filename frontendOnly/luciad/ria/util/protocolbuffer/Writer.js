import{decode as base64decode,length as base64length}from"./util/base64.js";import{float}from"./util/float.js";import{isString}from"./util/lang.js";import{LongBits}from"./util/LongBits.js";import{pool}from"./util/pool.js";import{length as utf8length,write as utf8write}from"./util/utf8.js";class Op{constructor(t,i,e){this.fn=t;this.len=i;this.next=void 0;this.val=e}}class VarintOp extends Op{constructor(t,i){super(writeVarint32,t,i)}}const noop=()=>{};class State{constructor(t){this.head=t.head;this.tail=t.tail;this.len=t.len;this.next=t.states}}export class Writer{constructor(){this.len=0;this.head=new Op(noop,0,0);this.tail=this.head;this.states=null}static create(){return new Writer}static alloc(t){return writerAlloc(t)}uint32(t){this.len+=(this.tail=this.tail.next=new VarintOp((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len;return this}int32(t){return t<0?this._push(writeVarint64,10,LongBits.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){const i=LongBits.from(t);return this._push(writeVarint64,i.length(),i)}int64(t){return this.uint64(t)}sint64(t){const i=LongBits.from(t).zzEncode();return this._push(writeVarint64,i.length(),i)}bool(t){return this._push(writeByte,1,t?1:0)}fixed32(t){return this._push(writeFixed32,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){const i=LongBits.from(t);return this._push(writeFixed32,4,i.lo)._push(writeFixed32,4,i.hi)}sfixed64(t){return this.fixed64(t)}float(t){return this._push(float.writeFloatLE,4,t)}double(t){return this._push(float.writeDoubleLE,8,t)}bytes(t){let i=t.length>>>0;if(!i)return this._push(writeByte,1,0);if(isString(t)){const e=Writer.alloc(i=base64length(t));base64decode(t,e,0);t=e}return this.uint32(i)._push(writeBytes,i,t)}string(t){const i=utf8length(t);return i?this.uint32(i)._push(utf8write,i,t):this._push(writeByte,1,0)}fork(){this.states=new State(this);this.head=this.tail=new Op(noop,0,0);this.len=0;return this}reset(){if(this.states){this.head=this.states.head;this.tail=this.states.tail;this.len=this.states.len;this.states=this.states.next}else{this.head=this.tail=new Op(noop,0,0);this.len=0}return this}ldelim(){const t=this.head;const i=this.tail;const e=this.len;this.reset().uint32(e);if(e){this.tail.next=t.next;this.tail=i;this.len+=e}return this}finish(){const t=Writer.alloc(this.len);let i=0;let e=this.head.next;while(e){e.fn(e.val,t,i);i+=e.len;e=e.next}return t}_push(t,i,e){this.tail=this.tail.next=new Op(t,i,e);this.len+=i;return this}}const writerAlloc=pool((t=>new Uint8Array(t)),Uint8Array.prototype.subarray);function writeByte(t,i,e){i[e]=255&t}function writeVarint32(t,i,e){while(t>127){i[e++]=127&t|128;t>>>=7}i[e]=t}function writeVarint64(t,i,e){while(t.hi){i[e++]=127&t.lo|128;t.lo=(t.lo>>>7|t.hi<<25)>>>0;t.hi>>>=7}while(t.lo>127){i[e++]=127&t.lo|128;t.lo=t.lo>>>7}i[e++]=t.lo}function writeFixed32(t,i,e){i[e]=255&t;i[e+1]=t>>>8&255;i[e+2]=t>>>16&255;i[e+3]=t>>>24}function writeBytes(t,i,e){i.set(t,e)}