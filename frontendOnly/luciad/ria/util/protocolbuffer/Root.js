import{common}from"./common.js";import{constructors}from"./constructors.js";import{isEnum,isField,isNamespace,isOneOf,isRoot,isType}from"./interfaces.js";import{Namespace}from"./Namespace.js";import{parse}from"./parse.js";import{asPromise}from"./util/asPromise.js";import{fetch as utilFetch}from"./util/fetch.js";import{isString}from"./util/lang.js";import{resolve}from"./util/path.js";import{read}from"./util/utf8.js";export class Root extends Namespace{static className="Root";constructor(e){super("",e);this.deferred=[];this.files=[]}get _PB_ROOT(){return true}static fromJSON(e,t,s){const i=!isString(e)?e:t;const n=(isRoot(t)?t:s)??new Root;if(i.options)n.setOptions(i.options);return n.addJSON(i.nested)}load(e,t,s){if("function"===typeof t){s=t;t=void 0}const i=t;const n=this;if(!s)return asPromise(this.load,n,e,i);const r=(e,t)=>{if(!s)return;const i=s;s=void 0;i(e,t)};const o=(e,t)=>{try{const s=t instanceof Uint8Array?read(t,0,t.length):t;const r=isString(s)&&"{"===s.charAt(0)?JSON.parse(s):s;if(!isString(r))n.setOptions(r.options).addJSON(r.nested);else{parse.filename=e;const t=parse(r,n,i);let s=0;if(t.imports)for(;s<t.imports.length;++s){const i=n.resolvePath(e,t.imports[s]);if(i)l(i)}if(t.weakImports)for(s=0;s<t.weakImports.length;++s){const i=n.resolvePath(e,t.weakImports[s]);if(i)l(i,true)}}}catch(e){r(e instanceof Error?e:new Error(""+e))}if(!f)r(null,this)};const l=(e,t)=>{const i=e.lastIndexOf("google/protobuf/");if(i>-1){const t=e.substring(i);if(t in common)e=t}if(this.files.indexOf(e)>-1)return;this.files.push(e);if(e in common){++f;setTimeout((()=>{--f;o(e,common[e])}));return}++f;utilFetch(e,((i,n)=>{--f;if(!s)return;if(i){if(!t)r(i);else if(!f)r(null,this);return}o(e,n)}))};let f=0;if(isString(e))e=[e];for(let t=0;t<e.length;++t){const s=n.resolvePath("",e[t]);if(s)l(s)}if(!f)r(null,this);return}resolveAll(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((e=>"'extend "+e.extend+"' in "+e.parent?.fullName)).join(", "));return super.resolveAll()}handleAdd(e){if(isField(e)){if(void 0!==e.extend&&!e.extensionField)if(!tryHandleExtension(this,e))this.deferred.push(e)}else if(isEnum(e)){if(e.parent&&exposeRe.test(e.name))e.parent[e.name]=e.values}else if(!isOneOf(e)){if(isType(e))for(let e=0;e<this.deferred.length;)if(tryHandleExtension(this,this.deferred[e]))this.deferred.splice(e,1);else++e;const{nestedArray:t}=e;for(let e=0;e<t.length;++e)this.handleAdd(t[e]);if(e.parent&&exposeRe.test(e.name))e.parent[e.name]=e}}handleRemove(e){if(isField(e)){if(void 0!==e.extend)if(e.extensionField){e.extensionField.parent?.remove(e.extensionField);e.extensionField=null}else{const t=this.deferred.indexOf(e);if(t>-1)this.deferred.splice(t,1)}}else if(isEnum(e)){if(exposeRe.test(e.name))delete e.parent?.[e.name]}else if(isNamespace(e)){const{nestedArray:t}=e;for(let e=0;e<t.length;++e)this.handleRemove(t[e]);if(exposeRe.test(e.name))delete e.parent?.[e.name]}}resolvePath(e,t){return resolve(e,t)}}const exposeRe=/^[A-Z]/;function tryHandleExtension(e,t){const{extend:s,parent:i}=t;const n=s&&i?.lookup(s);if(n){const e=new constructors.Field(t.fullName,t.id,t.type,t.rule,void 0,t.options);e.declaringField=t;t.extensionField=e;n.add(e);return true}return false}