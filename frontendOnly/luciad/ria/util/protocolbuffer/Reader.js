import{float}from"./util/float.js";import{LongBits}from"./util/LongBits.js";import{read}from"./util/utf8.js";function indexOutOfRange(t,i){return new RangeError(`index out of range: ${t.pos} + ${i||1} > ${t.len}`)}export class Reader{_slice=Uint8Array.prototype.subarray||Uint8Array.prototype.slice;constructor(t){this.buf=t;this.pos=0;this.len=t.length}static create(t){return create_array(t)}bool(){return 0!==this.uint32()}uint32(){let t=(127&this.buf[this.pos])>>>0;if(this.buf[this.pos++]<128)return t;t=(t|(127&this.buf[this.pos])<<7)>>>0;if(this.buf[this.pos++]<128)return t;t=(t|(127&this.buf[this.pos])<<14)>>>0;if(this.buf[this.pos++]<128)return t;t=(t|(127&this.buf[this.pos])<<21)>>>0;if(this.buf[this.pos++]<128)return t;t=(t|(15&this.buf[this.pos])<<28)>>>0;if(this.buf[this.pos++]<128)return t;if((this.pos+=5)>this.len){this.pos=this.len;throw indexOutOfRange(this,10)}return t}int32(){return 0|this.uint32()}sint32(){const t=this.uint32();return t>>>1^-(1&t)|0}fixed32(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return 0|readFixed32_end(this.buf,this.pos+=4)}int64(){return readLongVarint.call(this).toLong(false)}uint64(){return readLongVarint.call(this).toLong(true)}sint64(){return readLongVarint.call(this).zzDecode().toLong(false)}fixed64(){return readFixed64.call(this).toLong(true)}sfixed64(){return readFixed64.call(this).toLong(false)}float(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);const t=float.readFloatLE(this.buf,this.pos);this.pos+=4;return t}double(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);const t=float.readDoubleLE(this.buf,this.pos);this.pos+=8;return t}bytes(){const t=this.uint32();const i=this.pos;const s=this.pos+t;if(s>this.len)throw indexOutOfRange(this,t);this.pos+=t;if(Array.isArray(this.buf))return this.buf.slice(i,s);return i===s?new Uint8Array(0):this._slice.call(this.buf,i,s)}string(){const t=this.bytes();return read(t,0,t.length)}skip(t){if("number"===typeof t){if(this.pos+t>this.len)throw indexOutOfRange(this,t);this.pos+=t;return this}do{if(this.pos>=this.len)throw indexOutOfRange(this)}while(128&this.buf[this.pos++]);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:while(4!==(t=7&this.uint32()))this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this}}function create_array(t){if(Array.isArray(t))t=Uint8Array.from(t);if(t instanceof Uint8Array)return new Reader(t);throw new Error("illegal buffer")}function readLongVarint(){const t=new LongBits(0,0);let i=0;if(this.len-this.pos>4){for(;i<4;++i){t.lo=(t.lo|(127&this.buf[this.pos])<<7*i)>>>0;if(this.buf[this.pos++]<128)return t}t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0;t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0;if(this.buf[this.pos++]<128)return t;i=0}else{for(;i<3;++i){if(this.pos>=this.len)throw indexOutOfRange(this);t.lo=(t.lo|(127&this.buf[this.pos])<<7*i)>>>0;if(this.buf[this.pos++]<128)return t}t.lo=(t.lo|(127&this.buf[this.pos++])<<7*i)>>>0;return t}if(this.len-this.pos>4)for(;i<5;++i){t.hi=(t.hi|(127&this.buf[this.pos])<<7*i+3)>>>0;if(this.buf[this.pos++]<128)return t}else for(;i<5;++i){if(this.pos>=this.len)throw indexOutOfRange(this);t.hi=(t.hi|(127&this.buf[this.pos])<<7*i+3)>>>0;if(this.buf[this.pos++]<128)return t}throw new Error("invalid varint encoding")}function readFixed32_end(t,i){return(t[i-4]|t[i-3]<<8|t[i-2]<<16|t[i-1]<<24)>>>0}function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}