import{deflate as zlib_deflate}from"./zlib/deflate.js";import{common as utils}from"./utils/common.js";import{strings}from"./utils/strings.js";import{messages as msg}from"./zlib/messages.js";import{zstream as ZStream}from"./zlib/zstream.js";import{constants}from"./zlib/constants.js";var toString=Object.prototype.toString;var Z_NO_FLUSH=0;var Z_FINISH=4;var Z_OK=0;var Z_STREAM_END=1;var Z_SYNC_FLUSH=2;var Z_DEFAULT_COMPRESSION=-1;var Z_DEFAULT_STRATEGY=0;var Z_DEFLATED=8;function Deflate(t){if(!(this instanceof Deflate))return new Deflate(t);this.options=utils.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY,to:""},t||{});var e=this.options;if(e.raw&&e.windowBits>0)e.windowBits=-e.windowBits;else if(e.gzip&&e.windowBits>0&&e.windowBits<16)e.windowBits+=16;this.err=0;this.msg="";this.ended=false;this.chunks=[];this.strm=new ZStream;this.strm.avail_out=0;var i=zlib_deflate.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==Z_OK)throw new Error(msg[i]);if(e.header)zlib_deflate.deflateSetHeader(this.strm,e.header);if(e.dictionary){var s;if("string"===typeof e.dictionary)s=strings.string2buf(e.dictionary);else if("[object ArrayBuffer]"===toString.call(e.dictionary))s=new Uint8Array(e.dictionary);else s=e.dictionary;if((i=zlib_deflate.deflateSetDictionary(this.strm,s))!==Z_OK)throw new Error(msg[i]);this._dict_set=true}}Deflate.prototype.push=function(t,e){var i=this.strm;var s=this.options.chunkSize;var r,n;if(this.ended)return false;n=e===~~e?e:true===e?Z_FINISH:Z_NO_FLUSH;if("string"===typeof t)i.input=strings.string2buf(t);else if("[object ArrayBuffer]"===toString.call(t))i.input=new Uint8Array(t);else i.input=t;i.next_in=0;i.avail_in=i.input.length;do{if(0===i.avail_out){i.output=new utils.Buf8(s);i.next_out=0;i.avail_out=s}if((r=zlib_deflate.deflate(i,n))!==Z_STREAM_END&&r!==Z_OK){this.onEnd(r);this.ended=true;return false}if(0===i.avail_out||0===i.avail_in&&(n===Z_FINISH||n===Z_SYNC_FLUSH))if("string"===this.options.to)this.onData(strings.buf2binstring(utils.shrinkBuf(i.output,i.next_out)));else this.onData(utils.shrinkBuf(i.output,i.next_out))}while((i.avail_in>0||0===i.avail_out)&&r!==Z_STREAM_END);if(n===Z_FINISH){r=zlib_deflate.deflateEnd(this.strm);this.onEnd(r);this.ended=true;return r===Z_OK}if(n===Z_SYNC_FLUSH){this.onEnd(Z_OK);i.avail_out=0;return true}return true};Deflate.prototype.onData=function(t){this.chunks.push(t)};Deflate.prototype.onEnd=function(t){if(t===Z_OK)if("string"===this.options.to)this.result=this.chunks.join("");else this.result=utils.flattenChunks(this.chunks);this.chunks=[];this.err=t;this.msg=this.strm.msg};function deflateFunc(t,e){var i=new Deflate(e);i.push(t,true);if(i.err)throw i.msg||msg[i.err];return i.result}function deflateRaw(t,e){(e=e||{}).raw=true;return deflateFunc(t,e)}function gzip(t,e){(e=e||{}).gzip=true;return deflateFunc(t,e)}var deflate={};utils.assign(deflate,{Deflate:Deflate,deflate:deflateFunc,deflateRaw:deflateRaw,gzip:gzip},constants);export{deflate};