import{OutOfBoundsError}from"../error/OutOfBoundsError.js";import{Constants}from"../util/Constants.js";import{normalizeLon}from"../util/LonLatCoord.js";import{ProjectionType}from"./ProjectionType.js";import{Azimuthal}from"./Azimuthal.js";import{LambertAzimuthalEqualArea}from"./LambertAzimuthalEqualArea.js";const sharedOutOfBoundsError=new OutOfBoundsError("EllipsoidalLambertAzimuthalEqualArea");class CachedValuesForEllipsoid{constructor(t,i){this.a=t.a;this.e=t.e;this.cte=1/(2*this.e);const s=this.e*i.originSinLat;const n=1-s*s;const o=(1-this.e*this.e)*(i.originSinLat/n-this.cte*Math.log((1-s)/(1+s)));const e=1-this.e*this.e;this.qp=e*(1/e-this.cte*Math.log((1-this.e)/(1+this.e)));this.sinBeta0=o/this.qp;this.cosBeta0=Math.sqrt(1-this.sinBeta0*this.sinBeta0);this.rq=this.a*Math.sqrt(.5*this.qp);this.d=this.a*(i.originCosLat/Math.sqrt(1-this.e*this.e*i.originSinLat*i.originSinLat))/(this.rq*this.cosBeta0);const a=t.e2;const r=a*a;const h=r*a;this.c2=1/3*a+31/180*r+517/5040*h;this.c4=23/360*r+251/3780*h;this.c6=761/45360*h}isValid(t){return this.a==t.a&&this.e==t.e}}export class EllipsoidalLambertAzimuthalEqualArea extends Azimuthal{constructor(t=0,i=0){super();this._sphericalProjection=null;this._cachedValuesForEllipsoid=null;this._originSinLat=-1;this._originSinLon=-1;this._originCosLat=-1;this._originCosLon=-1;this.setOriginLon(t);this.setOriginLat(i);this.calculateCachedValues()}calculateCachedValues(){super.calculateCachedValues();this.resetCache();this._originSinLat=Math.sin(this.getOriginLat()*Constants.DEG2RAD);this._originSinLon=Math.sin(this.getOriginLon()*Constants.DEG2RAD);this._originCosLat=Math.cos(this.getOriginLat()*Constants.DEG2RAD);this._originCosLon=Math.cos(this.getOriginLon()*Constants.DEG2RAD)}get originSinLat(){return this._originSinLat}get originCosLat(){return this._originCosLat}isAllInBounds(){return false}geodetic2cartesianOnSphereSFCT(t,i,s){this.getSphericalProjection().geodetic2cartesianOnSphereSFCT(t,i,s)}geodetic2cartesianOnEllipsoidSFCT(t,i,s){if(i.isSphere()){this.getSphericalProjection().geodetic2cartesianOnEllipsoidSFCT(t,i,s);return}if(!this.inLonLatBounds(t))throw sharedOutOfBoundsError;const n=this.getCachedValuesForEllipsoid(i);const o=n.a;const e=n.e;const a=Math.sin(t.y*Constants.DEG2RAD);const r=e*a;const h=undefined;const c=(1-e*e)*(a/(1-r*r)-n.cte*Math.log((1-r)/(1+r)));const l=normalizeLon(t.x-this.getOriginLon());const u=Math.sin(l*Constants.DEG2RAD);const d=Math.cos(l*Constants.DEG2RAD);if(Math.abs(Math.abs(this._originSinLat)-1)<1e-8){const t=o*Math.sqrt(n.qp-this._originSinLat*c);const i=t*u;const e=-this._originSinLat*t*d;s.x=i;s.y=e}else{const t=c/n.qp;const i=Math.sqrt(1-t*t);const o=n.rq*Math.sqrt(2/(1+n.sinBeta0*t+n.cosBeta0*i*d));const e=o*n.d*(i*u);const a=o/n.d*(n.cosBeta0*t-n.sinBeta0*i*d);s.x=e;s.y=a}}cartesian2geodeticOnSphereSFCT(t,i,s){this.getSphericalProjection().cartesian2geodeticOnSphereSFCT(t,i,s)}cartesian2geodeticOnEllipsoidSFCT(t,i,s){if(i.isSphere()){this.getSphericalProjection().cartesian2geodeticOnEllipsoidSFCT(t,i,s);return}if(!this.inWorldBoundsOnEllipsoid(t,i))throw sharedOutOfBoundsError;const n=this.getCachedValuesForEllipsoid(i);if(Math.abs(Math.abs(this._originSinLat)-1)<1e-8){const i=n.a;const o=n.e;const e=Math.sqrt(t.x*t.x+t.y*t.y);const a=1-e*e/(i*i*(1-(1-o*o)/(2*o)*Math.log((1-o)/(1+o))));const r=this._originSinLat*Math.asin(a);const h=r+n.c2*Math.sin(2*r)+n.c4*Math.sin(4*r)+n.c6*Math.sin(6*r);const c=this.getOriginLon()*Constants.DEG2RAD+Math.atan2(t.x,-this._originSinLat*t.y);const l=normalizeLon(c*Constants.RAD2DEG);const u=h*Constants.RAD2DEG;s.x=l;s.y=u}else{const i=n.d;const o=n.sinBeta0;const e=n.cosBeta0;const a=Math.sqrt(t.x/i*(t.x/i)+i*t.y*(i*t.y));const r=a/(2*n.rq);if(Math.abs(r)>1)throw sharedOutOfBoundsError;const h=2*Math.asin(r);const c=Math.cos(h);const l=Math.sin(h);const u=0==a?0:c*o+i*t.y*l*e/a;const d=Math.asin(u);const g=d+n.c2*Math.sin(2*d)+n.c4*Math.sin(4*d)+n.c6*Math.sin(6*d);const L=this.getOriginLon()*Constants.DEG2RAD+Math.atan2(t.x*l,i*a*e*c-i*i*t.y*o*l);const p=normalizeLon(L*Constants.RAD2DEG);const E=g*Constants.RAD2DEG;s.x=p;s.y=E}}inLonLatBounds(t){return this.getSphericalProjection().inLonLatBounds(t)}inWorldBoundsOnSphere(t,i){return this.getSphericalProjection().inWorldBoundsOnSphere(t,i)}cartesianBoundsOnEllipsoidSFCT(t,i){this.getSphericalProjection().cartesianBoundsOnEllipsoidSFCT(t,i)}inWorldBoundsOnEllipsoid(t,i){return this.getSphericalProjection().inWorldBoundsOnEllipsoid(t,i)}boundaryLons(t){return this.getSphericalProjection().boundaryLons(t)}boundaryLats(t){return this.getSphericalProjection().boundaryLats(t)}cartesianBoundsOnSphereSFCT(t,i){this.getSphericalProjection().cartesianBoundsOnSphereSFCT(t,i)}toString(){return`EllipsoidalLambertAzimuthalEqualArea_${this.getOriginLon()}_${this.getOriginLat()}`}getCachedValuesForEllipsoid(t){let i=this._cachedValuesForEllipsoid;if(null==i||!i.isValid(t)){i=new CachedValuesForEllipsoid(t,this);this._cachedValuesForEllipsoid=i}return i}resetCache(){this._cachedValuesForEllipsoid=null;this.resetSphericalProjection()}resetSphericalProjection(){this._sphericalProjection=null}getSphericalProjection(){let t=this._sphericalProjection;if(null==t){t=new LambertAzimuthalEqualArea(this.getOriginLon(),this.getOriginLat());this._sphericalProjection=t}return t}encode(){return{type:"EllipsoidalLambertAzimuthalEqualArea",originLon:this.getOriginLon(),originLat:this.getOriginLat()}}get TYPE(){return ProjectionType.ELLIPSOIDAL_LAMBERT_AZIMUTHAL_EQUAL_AREA+ProjectionType.AZIMUTHAL}}