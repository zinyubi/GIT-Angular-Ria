import{SEElementType}from"./SEElementType.js";import{SEElement}from"./SEElement.js";import{SVGParameter}from"./SVGParameter.js";import{append,arc,arrow,combineWithRegular,gap,parallelLine,rectangle}from"../../../view/style/complexstroke/PatternFactory.js";import{createCanvasColorString}from"../util/SEUtil.js";import{normalizeDashes}from"../../../view/style/complexstroke/DashedLineUtil.js";import{ArrowType}from"../../../view/style/complexstroke/ArrowType.js";const INVISIBLE_COLOR="rgba(0,0,0,0)";export const DEFAULT_STROKE_COLOR_PARAM=new SVGParameter("stroke");export const DEFAULT_STROKE_OPACITY_PARAM=new SVGParameter("stroke-opacity");export const DEFAULT_STROKE_WIDTH_PARAM=new SVGParameter("stroke-width");export const DEFAULT_STROKE_LINECAP_PARAM=new SVGParameter("stroke-linecap");export const DEFAULT_STROKE_LINEJOIN_PARAM=new SVGParameter("stroke-linejoin");DEFAULT_STROKE_COLOR_PARAM.addContent("#000000");DEFAULT_STROKE_OPACITY_PARAM.addContent("1");DEFAULT_STROKE_WIDTH_PARAM.addContent("1");DEFAULT_STROKE_LINECAP_PARAM.addContent("");DEFAULT_STROKE_LINEJOIN_PARAM.addContent("");export class Stroke extends SEElement{static VALID_CHILDREN=["GraphicFill","GraphicStroke","SvgParameter"];VALID_SVG_PARAMETERS=["stroke","stroke-opacity","stroke-width","stroke-linejoin","stroke-linecap","stroke-dasharray","stroke-dashoffset","marker-start","marker-end"];static VALID_LINE_JOIN=["bevel","miter","round"];static isLineJoin(e){return Stroke.VALID_LINE_JOIN.indexOf(e)>=0}static VALID_LINE_CAP=["butt","round","square"];static isLineCap(e){return Stroke.VALID_LINE_CAP.indexOf(e)>=0}_graphicStroke=null;_graphicFill=null;_strokeColor=null;_strokeOpacity=null;_strokeWidth=null;_strokeLinejoin=null;_strokeLinecap=null;_strokeDasharray=null;_strokeDashoffset=null;_strokeMarkerStart=null;_strokeMarkerEnd=null;_userDefinedBaseStroke=false;_canBeStyledSimple=true;constructor(){super(SEElementType.STROKE)}isReady(){if(null!==this._graphicStroke)return this._graphicStroke.isReady();else if(null!==this._graphicFill)return this._graphicFill.isReady();else return Promise.resolve()}get graphicStroke(){return this._graphicStroke}set graphicStroke(e){this._graphicStroke=e;this._graphicFill=null;this._canBeStyledSimple=false}get graphicFill(){return this._graphicFill}set graphicFill(e){this._graphicFill=e;this._graphicStroke=null;this._canBeStyledSimple=false}get strokeColor(){return this._strokeColor}get strokeOpacity(){return this._strokeOpacity}get strokeWidth(){return this._strokeWidth}get strokeDasharray(){return this._strokeDasharray}get strokeDashoffset(){return this._strokeDashoffset}get strokeLinejoin(){return this._strokeLinejoin}get strokeLinecap(){return this._strokeLinecap}get strokeMarkerStart(){return this._strokeMarkerStart}get strokeMarkerEnd(){return this._strokeMarkerEnd}hasSVGParameter(e){return this.VALID_SVG_PARAMETERS.indexOf(e)>=0}addSVGParameter(e){e.eventedSupport=this.eventedSupport;this._userDefinedBaseStroke=true;switch(e.name){case this.VALID_SVG_PARAMETERS[0]:this._strokeColor=e;this._strokeColor.createStringEvaluationFunction(true);break;case this.VALID_SVG_PARAMETERS[1]:this._strokeOpacity=e;this._strokeOpacity.numberValidation={name:"stroke-opacity",minValue:0,maxValue:1,defaultValue:1,clamp:true};this._strokeOpacity.createNumberEvaluationFunction();break;case this.VALID_SVG_PARAMETERS[2]:this._strokeWidth=e;this._strokeWidth.createNumberEvaluationFunction();break;case this.VALID_SVG_PARAMETERS[3]:this._strokeLinejoin=e;this._strokeLinejoin.createStringEvaluationFunction();this._canBeStyledSimple=false;break;case this.VALID_SVG_PARAMETERS[4]:this._strokeLinecap=e;this._strokeLinecap.createStringEvaluationFunction();this._canBeStyledSimple=false;break;case this.VALID_SVG_PARAMETERS[5]:this._strokeDasharray=e;this._strokeDasharray.createStringEvaluationFunction();this._canBeStyledSimple=false;break;case this.VALID_SVG_PARAMETERS[6]:this._strokeDashoffset=e;this._strokeDashoffset.createNumberEvaluationFunction();this._canBeStyledSimple=false;break;case this.VALID_SVG_PARAMETERS[7]:this._strokeMarkerStart=e;this._strokeMarkerStart?.createBooleanEvaluationFunction();this._canBeStyledSimple=false;break;case this.VALID_SVG_PARAMETERS[8]:this._strokeMarkerEnd=e;this._strokeMarkerEnd.createBooleanEvaluationFunction();this._canBeStyledSimple=false;break;default:break}}canBeStyledSimple(){return this._canBeStyledSimple}getBufferWidth(e,t,r,a=1){const i=undefined;return(this.strokeWidth||DEFAULT_STROKE_WIDTH_PARAM).evaluateContentAsNumber(e,t)*a/2}createStrokeFillStyle(e,t,r,a=0,i){if(this.graphicFill){const s=this.evaluateStrokeParameters(e,t,a,i??1);return this.graphicFill.createGraphicsFillStyle(e,t,{color:s.color},r,i??1)}return}createSimpleStrokeStyle(e,t,r,a=0,i=1){const s=this.evaluateStrokeParameters(e,t,a,i);return{color:s.color,width:s.width,uom:r}}createStrokeStyles(e,t,r,a=0,i=1,s=[0,0]){const o=this.evaluateStrokeParameters(e,t,a,i);const n=!this.graphicStroke;const l=this.createFallbackPattern(o,n);const h=createLineCapDecorations(e,o);const c=[];if(this._userDefinedBaseStroke||!this.graphicStroke)c.push({fallback:l,regular:l,decorations:h,lineJoin:o.lineJoin,uom:r,sharpAngleThreshold:0,offsetX:s[0],offsetY:s[1]});let u;if(this.graphicStroke){u=this.graphicStroke.createComplexStrokedLineStyle(e,t,l,r,false,i,a);c.push({fallback:l,regular:u.regular,decorations:u.decorations,uom:r,sharpAngleThreshold:45,offsetX:s[0],offsetY:s[1]})}return c}evaluateStrokeParameters(e,t,r,a){const i=this.strokeColor||DEFAULT_STROKE_COLOR_PARAM;const s=this.strokeOpacity||DEFAULT_STROKE_OPACITY_PARAM;const o=i.evaluateContentAsString(e,t,true);const n=s.evaluateContentAsNumber(e,t);const l=createCanvasColorString(o,n)||"rgba(0,0,0,1)";const h=undefined;const c=(this.strokeWidth||DEFAULT_STROKE_WIDTH_PARAM).evaluateContentAsNumber(e,t)*a;let u;let _;const p=this.createDashArray(e,t,a);if(null!=p){u=p;if(this.strokeDashoffset)_=this.strokeDashoffset.evaluateContentAsNumber(e,t)*a}const k=undefined;const S=(this.strokeLinecap||DEFAULT_STROKE_LINECAP_PARAM).evaluateContentAsString(e,t);const f=Stroke.isLineCap(S)?S:void 0;const d=undefined;const A=(this.strokeLinejoin||DEFAULT_STROKE_LINEJOIN_PARAM).evaluateContentAsString(e,t);const E=Stroke.isLineJoin(A)?A:void 0;const m=this.strokeMarkerStart?.evaluateContentAsBoolean(e,t);const g=this.strokeMarkerEnd?.evaluateContentAsBoolean(e,t);return{color:l,width:c,perpendicularOffset:r,dashArray:u,dashOffset:_,lineCap:f,lineJoin:E,markerStart:m,markerEnd:g}}createFallbackPattern(e,t){if(e.dashArray){const t=e.dashOffset?-e.dashOffset:0;const r=normalizeDashes(e.dashArray,t);const a=[];for(const t of r)if(t.isGap)a.push(gap(t.length,false));else a.push(parallelLine({length:t.length,relative:false,offset:e.perpendicularOffset,line:{color:e.color,width:e.width}}));return append(a)}else return parallelLine({length:1,relative:true,offset:e.perpendicularOffset,line:{color:this._userDefinedBaseStroke||t?e.color:INVISIBLE_COLOR,width:e.width}})}createDashArray(e,t,r=1){if(!this.strokeDasharray)return null;const a=this.strokeDasharray.evaluateContentAsString(e,t);if(0===a.length)return null;let i=[];const s=a.trim().split(/\s+/);for(let e=0;e<s.length;e++){const t=parseFloat(s[e]);if(!isNaN(t)&&isFinite(t))i.push(t*r)}if(i.length%2!==0)i=i.concat(i);return 0!==i.length?i:null}}function createLineCapDecorations(e,t){const r=[];let a=true;if(t.markerStart){a=false;const e=combineWithRegular(arrow({line:{color:t.color,width:t.width},type:ArrowType.PLAIN,forward:false}));r.push({pattern:e,location:0,alignment:"left"})}let i=true;if(t.markerEnd){i=false;const e=combineWithRegular(arrow({line:{color:t.color,width:t.width},type:ArrowType.PLAIN,forward:true}));r.push({pattern:e,location:1,alignment:"right"})}if("round"===t.lineCap){if(a)r.push({pattern:arc({length:t.width,minorRadius:t.width/2,startAngle:90,angle:180,fill:{color:t.color},offset:t.perpendicularOffset}),location:0,alignment:"right"});if(i)r.push({pattern:arc({length:t.width,minorRadius:t.width/2,startAngle:270,angle:180,fill:{color:t.color},offset:t.perpendicularOffset}),location:1,alignment:"left"})}else if("square"===t.lineCap){if(a)r.push({pattern:rectangle({length:t.width/2,minHeight:-t.width/2+t.perpendicularOffset,maxHeight:t.width/2+t.perpendicularOffset,fill:{color:t.color}}),location:0,alignment:"right"});if(i)r.push({pattern:rectangle({length:t.width/2,minHeight:-t.width/2+t.perpendicularOffset,maxHeight:t.width/2+t.perpendicularOffset,fill:{color:t.color}}),location:1,alignment:"left"})}return r}