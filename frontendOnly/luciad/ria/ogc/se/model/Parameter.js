import{SEElementType}from"./SEElementType.js";import{SEElement}from"./SEElement.js";import{isDefined,isString}from"../../../util/Lang.js";import{ProgrammingError}from"../../../error/ProgrammingError.js";import{OGCNumberFilterBuilderVisitor}from"../../filter/OGCNumberFilterBuilderVisitor.js";import{OGCStringFilterBuilderVisitor}from"../../filter/OGCStringFilterBuilderVisitor.js";import{Log}from"../../../util/Log.js";import{clamp}from"../../../util/Cartesian.js";import{sanitizeString,trimString}from"../util/SEUtil.js";import{createEvaluationFunction,PRE_DEFINED_FUNCTION_EVALUATORS}from"../../FunctionEvaluatorUtil.js";import{OGCBooleanFilterBuilderVisitor}from"../../filter/OGCBooleanFilterBuilderVisitor.js";export class Parameter extends SEElement{_content=[];_evaluateContentAsString=null;_evaluateContentAsNumber=null;_evaluateContentAsBoolean=null;constructor(t,e){super(t??SEElementType.PARAMETER);this._functionEvaluators=isDefined(e)?Object.assign({},PRE_DEFINED_FUNCTION_EVALUATORS,e):PRE_DEFINED_FUNCTION_EVALUATORS}get content(){return this._content}addContent(t){this._content.push(t);this.eventedSupport?.emit("StyleChanged","AddContent")}clearContent(){this._content=[];this._evaluateContentAsNumber=null;this._evaluateContentAsString=null}set numberValidation(t){this._numberValidation=t}createNumberEvaluationFunction(){const t=this.createNumberExpression();this._evaluateContentAsNumber=createEvaluationFunction(t)}createStringEvaluationFunction(t=false){const e=this.createStringExpression(t);this._evaluateContentAsString=createEvaluationFunction(e)}createBooleanEvaluationFunction(t=false){const e=this.createBooleanExpression(t);this._evaluateContentAsBoolean=createEvaluationFunction(e)}toString(){let t="";for(let e=0;e<this._content.length;e++)t+=this._content[e].toString();return t}evaluateContentAsString(t,e,n=false){if(!this._evaluateContentAsString)this.createStringEvaluationFunction(n);if(!this._evaluateContentAsString)throw new ProgrammingError("We need an evaluateContentAsString method, it should get created lazily.");else return this._evaluateContentAsString(this._functionEvaluators,t,e)}evaluateContentAsNumber(t,e){if(!this._evaluateContentAsNumber)this.createNumberEvaluationFunction();if(!this._evaluateContentAsNumber)throw new ProgrammingError("We need an evaluateContentAsNumber method, it should get created lazily.");else{let n=this._evaluateContentAsNumber(this._functionEvaluators,t,e);if(this._numberValidation)if(!isDefined(this._numberValidation.maxValue)){const t=this._numberValidation.minValue;if(n<t){Log.warn("The minValue of the "+this._numberValidation.name+" parameter should be "+t+" this will be used instead of calculated value "+n+".");n=t}}else{const t=this._numberValidation.minValue;const e=this._numberValidation.maxValue;const i=this._numberValidation.defaultValue;const r=this._numberValidation.clamp?clamp(n,t,e):i;if(n<t||n>e){Log.warn("The range of the "+this._numberValidation.name+" parameter should be ["+t+","+e+"], "+r+" will be used instead of calculated value "+n+".");n=r}}return n}}evaluateContentAsBoolean(t,e,n=false){if(!this._evaluateContentAsBoolean)this.createBooleanEvaluationFunction(n);if(!this._evaluateContentAsBoolean)throw new ProgrammingError("We need an evaluateContentAsBoolean method, it should get created lazily.");else return this._evaluateContentAsBoolean(this._functionEvaluators,t,e)}createNumberExpression(){let t="";const e=this._content.length;if(this._content.every(isString)){for(let n=0;n<e;n++)t+=this._content[n].trim();const n=parseFloat(t);if(isNaN(n))throw new ProgrammingError("Invalid number value in expression: "+this.toString());return"return "+n+";"}else{for(let n=0;n<e;n++){const e=this._content[n];if("string"!==typeof e){const n=new OGCNumberFilterBuilderVisitor({functionEvaluators:this._functionEvaluators});n.reset();e.accept(n);const i=n.expression;if(i)t+=i}}return`return parseFloat(`+t+` ?? ( ${this._numberValidation?.defaultValue??0}) )`}}createStringExpression(t=false){const e=this._content;const n=e.length;let i="''";for(let r=0;r<n;r++){const n=e[r];if("string"===typeof n)if(t){const t=trimString(n);if(""!==t)i+=" + '"+sanitizeString(t)+"'"}else i+=" + '"+sanitizeString(n)+"'";else{const t=new OGCStringFilterBuilderVisitor({functionEvaluators:this._functionEvaluators,expectedFunctionOutput:"string"});t.reset();n.accept(t);i+=" + ("+t.expression+" ?? ``)"}}return"return "+i+";"}createBooleanExpression(t=false){const e=this._content;const n=e.length;let i=true;for(let r=0;r<n;r++){const n=e[r];if("string"===typeof n)if(t){const t=trimString(n);if(""!==t)i=i&&-1===sanitizeString(t).toLowerCase().indexOf("false")}else i=i&&-1===sanitizeString(n).toLowerCase().indexOf("false");else{const t=new OGCBooleanFilterBuilderVisitor({functionEvaluators:this._functionEvaluators});t.reset();n.accept(t);const e=`${t.expression??false}`;i=i&&-1===e.toLowerCase().indexOf("false")}}return`return ${i};`}}