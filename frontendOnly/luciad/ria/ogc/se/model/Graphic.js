import{isDefined}from"../../../util/Lang.js";import{icon}from"../../../view/style/complexstroke/PatternFactory.js";import{AnchorPoint}from"./AnchorPoint.js";import{Displacement}from"./Displacement.js";import{VALID_SE_GRAPHIC_FORMATS}from"./ExternalGraphic.js";import{Parameter}from"./Parameter.js";import{SEElement}from"./SEElement.js";import{SEElementType}from"./SEElementType.js";import{Expression}from"../../filter/FilterFactory.js";export const DEFAULT_NO_GRAPHIC_OR_MARK_SIZE=new Parameter;DEFAULT_NO_GRAPHIC_OR_MARK_SIZE.addContent("6");export const DEFAULT_GRAPHIC_SIZE=new Parameter;DEFAULT_GRAPHIC_SIZE.addContent("16");export const DEFAULT_PATTERN_SIZE=new Parameter;DEFAULT_PATTERN_SIZE.addContent("10");export const DEFAULT_GRAPHIC_OPACITY=new Parameter;DEFAULT_GRAPHIC_OPACITY.addContent("1");export class Graphic extends SEElement{static VALID_CHILDREN=["ExternalGraphic","Mark","Opacity","Size","Rotation","AnchorPoint","Displacement"];_defaultPointSymbolCache=new Map;_externalGraphics=[];_marks=[];_size=null;_rotation=null;constructor(){super(SEElementType.GRAPHIC);this._size=DEFAULT_NO_GRAPHIC_OR_MARK_SIZE;this._opacity=DEFAULT_GRAPHIC_OPACITY;this._displacement=new Displacement;this._anchorPoint=new AnchorPoint}isReady(){const t=new Array(this._marks.length+this._externalGraphics.length);for(let e=0;e<this._marks.length;e++)t[e]=this._marks[e].isReady();const e=this._marks.length;for(let n=0;n<this._externalGraphics.length;n++)t[e+n]=this._externalGraphics[n].isReady();return Promise.all(t).then((()=>{}))}get externalGraphics(){return this._externalGraphics}get marks(){return this._marks}get size(){return this._size}set size(t){if(t)t.eventedSupport=this.eventedSupport;this._size=t;if(this._size)this._size.numberValidation={name:"Size",minValue:0};this._size?.createNumberEvaluationFunction()}get displacement(){return this._displacement}set displacement(t){t.eventedSupport=this.eventedSupport;t.x.eventedSupport=this.eventedSupport;t.y.eventedSupport=this.eventedSupport;this._displacement=t}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){t.eventedSupport=this.eventedSupport;t.x.eventedSupport=this.eventedSupport;t.y.eventedSupport=this.eventedSupport;this._anchorPoint=t}get rotation(){return this._rotation}set rotation(t){if(t)t.eventedSupport=this.eventedSupport;this._rotation=t;this._rotation?.createNumberEvaluationFunction()}get opacity(){return this._opacity}set opacity(t){t.eventedSupport=this.eventedSupport;this._opacity=t;this._opacity.numberValidation={name:"Opacity",minValue:0,maxValue:1,defaultValue:1,clamp:true};this._opacity.createNumberEvaluationFunction()}addExternalGraphic(t){this._externalGraphics.push(t);this._size=null}addMark(t){t.eventedSupport=this.eventedSupport;this._marks.push(t);this._size=DEFAULT_GRAPHIC_SIZE}selectExternalGraphic(){let t=null;if(0!==this._externalGraphics.length)for(let e=0;e<VALID_GRAPHIC_FORMAT_FILTERS.length;e++){const n=Array.prototype.filter.call(this._externalGraphics,VALID_GRAPHIC_FORMAT_FILTERS[e]);if(0!==n.length){t=n[0];break}}return t}createIconPattern(t,e=0){const n=t.image;const i=t.offsetY?t.offsetY:0;let o=.5;if(t.anchorY){const e=undefined;o=Number(t.anchorY.replace("%",""))/100}let r=e;if(0!==i)r+=i;if(.5!==o){const e=undefined;const n=undefined;r-=(o-.5)*(t.height?t.height:t.image.height)}return icon({icon:n,size:t.height,offset:r,rotation:t.rotation,opacity:t.opacity})}createIconStyle(t,e,n,i){const o=this.selectExternalGraphic();const r=o&&(o.onlineResource||o.inlineContent);const s=this.marks.length>0;if(r){const r=o.icon;if(r)return this.createImageIconStyle(r,t,e,n,i)}else if(s){const o=undefined;const r=this.marks[0].wellKnownName.evaluateContentAsString(t,e).startsWith("pattern")?DEFAULT_PATTERN_SIZE:DEFAULT_GRAPHIC_SIZE;const s=undefined;const a=(this._size??r).evaluateContentAsNumber(t,e);const c=this.marks[0].createWellKnownSymbol(t,e,n,a);return this.createImageIconStyle(c,t,e,n,i)}const a=undefined;const c=(this._size||DEFAULT_NO_GRAPHIC_OR_MARK_SIZE).evaluateContentAsNumber(t,e);return this.createImageIconStyle(this.getDefaultPointSymbol(c),t,e,n,i)}createImageIconStyle(t,e,n,i,o){const r={image:t};this.appendGenericIconStyleProperties(e,n,o,r,i,this.size);return r}getDefaultPointSymbol(t){const e=Math.round(t);const n=this._defaultPointSymbolCache.get(e);if(n)return n;const i=document.createElement("canvas");i.width=e;i.height=e;const o=i.getContext("2d",{willReadFrequently:true});o.fillStyle="#000000";o.fillRect(0,0,e,e);o.fillStyle="#808080";o.fillRect(1,1,e-2,e-2);this._defaultPointSymbolCache.set(e,i);return i}appendGenericIconStyleProperties(t,e,n,i,o,r){i.uom=o;if(isDefined(r)){const n=r?.evaluateContentAsNumber(t,e);i.height=n;if(n){const t=i.image;const e=t.width;const o=t.height;const r=e&&o?e/o:1;i.width=n*r}}if(this.displacement){i.offsetX=this.displacement.x.evaluateContentAsNumber(t,e);const o=n?-1:1;i.offsetY=o*this.displacement.y.evaluateContentAsNumber(t,e)}if(this.anchorPoint){i.anchorX=100*this.anchorPoint.x.evaluateContentAsNumber(t,e)+"%";const n=this.anchorPoint.y.evaluateContentAsNumber(t,e);i.anchorY=100*(1-n)+"%"}if(this.rotation){const n=this.rotation.evaluateContentAsNumber(t,e);if(this.rotation.content[0]instanceof Expression&&"Function"===this.rotation.content[0].TYPE)i.heading=n;else i.rotation=n}if(this.opacity)i.opacity=this.opacity.evaluateContentAsNumber(t,e)}}const VALID_GRAPHIC_FORMAT_FILTERS=VALID_SE_GRAPHIC_FORMATS.map((function(t){return function(e){const n=e.format===t.mimeType;const i="[object String]"===Object.prototype.toString.call(e.onlineResource);const o=null!==e.inlineContent&&e.inlineContent.type===SEElementType.INLINE_CONTENT&&e.isSupportedEncoding(e.inlineContent.encoding);return n&&(i||o)}}));