import{SEElementType}from"./SEElementType.js";import{SEElement}from"./SEElement.js";import{getForName}from"./WellKnownName.js";import{Fill}from"./Fill.js";import{createByWellKnownName}from"../../../util/IconFactory.js";import{SVGParameter}from"./SVGParameter.js";import{Parameter}from"./Parameter.js";export const DEFAULT_WELL_KNOWN_NAME=new Parameter(SEElementType.WELLKNOWNNAME);DEFAULT_WELL_KNOWN_NAME.addContent("square");const DEFAULT_MARK_FILL=new Fill;const DEFAULT_MARK_FILL_COLOR=new SVGParameter("fill");DEFAULT_MARK_FILL_COLOR.addContent("#808080");DEFAULT_MARK_FILL.addSVGParameter(DEFAULT_MARK_FILL_COLOR);const IMAGE_SIZE_AT_CREATION_TIME=256;const LUCIAD_ICON_PROVIDER_WKN="LuciadIconProvider://";export class Mark extends SEElement{static VALID_CHILDREN=["WellKnownName","Fill","Stroke"];_wellKnownSymbolCache=new Map;_stroke=null;_fill=null;constructor(e){super(SEElementType.MARK);this._wellKnownName=DEFAULT_WELL_KNOWN_NAME;this._iconProvider=e??null}isReady(){if(null===this._stroke&&null===this._fill)return Promise.resolve();else{const e=null===this._stroke?Promise.resolve():this._stroke.isReady();const t=null===this._fill?Promise.resolve():this._fill.isReady();return Promise.all([e,t]).then((()=>{}))}}get wellKnownName(){return this._wellKnownName}set wellKnownName(e){if(e!==this._wellKnownName){this._wellKnownName=e;this.eventedSupport?.emit("StyleChanged","WellKnownName")}}get stroke(){return this._stroke}set stroke(e){if(e)e.eventedSupport=this.eventedSupport;this._stroke=e}get fill(){return this._fill}set fill(e){if(e)e.eventedSupport=this.eventedSupport;this._fill=e;if(!this._fill?.fillColor)this._fill?.addSVGParameter(DEFAULT_MARK_FILL_COLOR)}createWellKnownSymbol(e,t,l,o){const r=this.wellKnownName?.evaluateContentAsString(e,t,true);if(r.startsWith(LUCIAD_ICON_PROVIDER_WKN))if(!this._iconProvider)console.warn(`IconProvider not set, but ${LUCIAD_ICON_PROVIDER_WKN} used in WellKnownName, falling back to default 'grey square' icon.`);else{const n=this.createMarkStyle(e,t,l,1);const i={width:o,height:o};if(n.stroke){i.stroke=n.stroke.color;i.strokeWidth=n.stroke.width}if(n.fill)i.fill=n.fill.color;const s=wktSymbolKey(r,i);const a=this._wellKnownSymbolCache.get(s);if(a)return a;const _={url:r,iconOptions:i};const c=JSON.stringify(_);const E=this._iconProvider.getIcon(c);if(!(E instanceof HTMLCanvasElement))console.warn("IconProvider did not return a HTMLCanvasElement, falling back to default 'grey square' icon.");else{this._wellKnownSymbolCache.set(s,E);return E}}const n=getForName(r);const i=this.createMarkStyle(e,t,l,IMAGE_SIZE_AT_CREATION_TIME/o);const s={width:IMAGE_SIZE_AT_CREATION_TIME,height:IMAGE_SIZE_AT_CREATION_TIME};if(i.stroke){s.stroke=i.stroke.color;s.strokeWidth=i.stroke.width}if(i.fill)s.fill=i.fill.color;const a=wktSymbolKey(n,s);const _=this._wellKnownSymbolCache.get(a);if(_)return _;let c;if("square"===n)c=createByWellKnownName("rectangle",s);else c=createByWellKnownName(n,s);this._wellKnownSymbolCache.set(a,c);return c}createMarkStyle(e,t,l,o=1){const r={};if(this._fill)r.fill=this._fill.createSimpleFillStyle(e,t);r.stroke=this._stroke?.createSimpleStrokeStyle(e,t,l,0,o)||INVISIBLE_STROKE_STYLE;return r}}const INVISIBLE_STROKE_STYLE={color:"rgba(0,0,0,0)",width:1};const DELIM="|";function wktSymbolKey(e,t){return e+DELIM+t.width+DELIM+t.height+DELIM+t.stroke+DELIM+t.strokeWidth+DELIM+t.fill}