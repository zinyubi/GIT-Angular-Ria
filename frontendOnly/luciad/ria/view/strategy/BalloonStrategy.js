import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{isFunction,isString}from"../../util/Lang.js";import{On}from"../../util/On.js";import{BalloonAnchor}from"./BalloonAnchor.js";const DUMMY_CONTENT="No Content";function justifyContentProvider(t,o,e){if(isFunction(t))return t;else if(o?.balloonContentProvider)return o.balloonContentProvider;else if(e&&isFunction(e.toString))return()=>e.toString();return()=>DUMMY_CONTENT}function stopEvent(t){t.preventDefault();t.stopPropagation()}export class BalloonStrategy{constructor({map:t,node:o}){if(!o)throw new ProgrammingError("BalloonStrategy::must provide node in which to place the balloon.");if(!t)throw new ProgrammingError("BalloonStrategy::must provide map on which the balloon can be anchored.");this._node=o;this._map=t;this._handles=[];this._balloonContentProvider=null;this._balloonObject=null;this._anchor=null;this._balloon=null;this._content=null;this._frame=null;this._balloonArrow=null}createBalloon(t){const o=document.createElement("div");this._balloon=o;o.className="lcdBalloon";o.style.position="absolute";this._node.insertBefore(o,this._node.firstChild);this._frame=document.createElement("div");const e=this._frame;e.className="lcdFrame";e.style.top="-15px";o.appendChild(e);const n=document.createElement("div");n.className="lcdHeader";e.insertBefore(n,e.firstChild);const i=document.createElement("div");i.className="lcdClose";n.appendChild(i);this._content=document.createElement("div");const l=this._content;l.className="lcdContent";e.appendChild(l);if(isString(t)){const o=document.createElement("div");o.innerHTML=t;l.appendChild(o)}else l.appendChild(t);this._balloonArrow=document.createElement("div");const s=this._balloonArrow;s.style.display="block";s.style.position="relative";s.style.bottom="-15px";s.style.width="0";s.style.borderWidth="15px 15px 0";s.style.borderStyle="solid";s.style.borderColor=`${window.getComputedStyle(e).backgroundColor} transparent`;e.appendChild(s);this.balloonContentUpdated();const r=this;this._handles.push(On(i,"mouseup",stopEvent));this._handles.push(On(i,"mousedown",stopEvent));this._handles.push(On(i,"click",(t=>{stopEvent(t);r.hideBalloon()})));const a=l.getElementsByTagName("img");for(let t=0;t<a.length;t+=1){const o=a.item(t);if(o)this._handles.push(On(o,"load",(()=>this.balloonContentUpdated())))}}cleanup(){if(this._balloon&&this._frame&&this._content&&this._balloon.parentNode){this._frame.removeChild(this._content);this._balloon.parentNode.removeChild(this._balloon);this._balloon=null;this._frame=null;this._content=null;this._balloonArrow=null}this._anchor?.destroy();this._anchor=null;this._handles.forEach((t=>t.remove()));this._handles.length=0}onChange(t){if(this._anchor?.getPoint()){this._balloonObject=t;this.update();this.updateContents()}else this.hideBalloon()}getViewAnchorPoint(){const t=this._anchor?.getPoint()??null;if(!t||!this._balloon)return null;const{w:o,h:e}=position(this._balloon);try{const{x:n,y:i}=this._map.mapToViewTransformation.transform(t);return[n-o/2,i-e]}catch(t){OutOfBoundsError.isOrThrow(t);return null}}balloonContentUpdated(){this.update();if(this._frame&&this._balloonArrow){const t=getContentBox(this._frame).w/2-15-+this._frame.style.borderLeftWidth;this._balloonArrow.style.left=`${t}px`}}update(){if(this._balloon){const t=this.getViewAnchorPoint();if(t){this._balloon.style.left=`${t[0]}px`;this._balloon.style.top=`${t[1]}px`}else{this._balloon.style.left="-10000px";this._balloon.style.top="-10000px"}}}updateContents(){if(this._balloonContentProvider&&this._balloonObject&&this._content){const t=this._balloonContentProvider(this._balloonObject);let o=t;if(isString(t)){o=document.createElement("div");o.innerHTML=t}this._content.replaceChild(o,this._content.firstElementChild)}}showBalloon(t,o,e,n,i){if(this._balloon)this.cleanup();if(o&&o._map!==this._map)throw new ProgrammingError("Balloon::the map of this layer does not correspond to this map.");this._balloonObject=t||e;if(!this._balloonObject)throw new ProgrammingError("Balloon::feature or anchor must be provided");this._anchor=new BalloonAnchor(this._map,o,t,e);this._anchor.on("changed",(t=>this.onChange(t)));this._anchor.on("removed",(()=>this.hideBalloon()));const l=justifyContentProvider(n,o,t||e);this._balloonContentProvider=l;const s=l(this._balloonObject);if(s&&(isString(s)||isFunction(s.appendChild))){this.createBalloon(s);this.update();let t=false;if(i){const o=this._anchor.getPoint();if(o){t=true;this._map.mapNavigator.pan({targetLocation:o,animate:true})}}this._anchor.emitEvent(t)}}hideBalloon(){this.cleanup();this.update();this._map.emit("HideBalloon")}}function toPixel(t){if(t?.slice&&"px"===t.slice(-2))return parseFloat(t);return 0}function getPadExtents(t){const o=toPixel(t.paddingLeft);const e=toPixel(t.paddingTop);const n=toPixel(t.paddingRight);const i=toPixel(t.paddingBottom);return{l:o,t:e,r:n,b:i,w:o+n,h:e+i}}function getBorderExtents(t){const o=toPixel(t.borderLeftStyle);const e=toPixel(t.borderTopStyle);const n=toPixel(t.borderRightStyle);const i=toPixel(t.borderBottomStyle);return{l:o,t:e,r:n,b:i,w:o+n,h:e+i}}function getContentBox(t){const o=window.getComputedStyle(t);const e=getPadExtents(o);const n=getBorderExtents(o);let i=t.clientWidth;let l;if(!i){i=t.offsetWidth;l=t.offsetHeight}else{l=t.clientHeight;n.w=n.h=0}if(-1!==navigator.userAgent.indexOf("Opera")){e.l+=n.l;e.t+=n.t}return{l:e.l,t:e.t,w:i-e.w-n.w,h:l-e.h-n.h}}function position(t,o){const e=t.getBoundingClientRect();const n={x:e.left,y:e.top,w:e.right-e.left,h:e.bottom-e.top};if(o){const t=document.defaultView;if(t){n.x+=t.pageXOffset;n.y+=t.pageYOffset}}return n}