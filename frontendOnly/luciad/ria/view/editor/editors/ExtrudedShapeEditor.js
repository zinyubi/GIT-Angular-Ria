import{ComposedShapeEditor}from"./ComposedShapeEditor.js";import{ShapeType}from"../../../shape/ShapeType.js";import{EditContext}from"../../controller/EditContext.js";import{interactsWithControllerShape}from"../EditHandle.js";import{removeNullHandles,viewToModelOnHeightAxis}from"../handles/HandleUtil.js";import{PointDragHandle}from"../handles/PointDragHandle.js";import{createPoint}from"../../../shape/ShapeFactory.js";import{ExtrudedShapeHelperHandle}from"../handles/helper/ExtrudedShapeHelperHandle.js";import{HandleEventResult}from"../../controller/HandleEventResult.js";import{ShapeTouchHandle}from"../handles/ShapeTouchHandle.js";import{EditShapeStatus}from"../../controller/EditShapeEvent.js";import{EditMoveConstraint}from"../handles/EditMoveConstraint.js";import{getInteractionRadius}from"../../controller/EditSettings.js";export class ExtrudedShapeEditor extends ComposedShapeEditor{constructor(e){super(ShapeType.EXTRUDED_SHAPE,e)}getSubShapeCount(e){return 1}getSubShape(e,t){return e.baseShape}getEditHandles(e){const t=this.createBaseShapeHandles(e);return removeNullHandles([...t,this.createMinHeightHandle(e),this.createMaxHeightHandle(e),this.createHeightHandle(e),this.createHelperHandle(e)])}createMinHeightHandle(e){if(is3DMap(e)){const t=e.shape;return new PointDragHandle((()=>getPointOnHeightAxis(t,0)),(e=>{if(e.z<t.maximumHeight)t.minimumHeight=e.z}),{moveConstraint:EditMoveConstraint.VERTICAL})}return null}createMaxHeightHandle(e){if(is3DMap(e)){const t=e.shape;return new PointDragHandle((()=>getPointOnHeightAxis(t,1)),(e=>{if(e.z>t.minimumHeight)t.maximumHeight=e.z}),{moveConstraint:EditMoveConstraint.VERTICAL})}return null}createHeightHandle(e){if(is3DMap(e))return new ExtrudedShapeHeightBodyHandle(e.shape);return null}createHelperHandle(e){if(is3DMap(e))return new ExtrudedShapeHelperHandle(e.shape);return null}createBaseShapeHandles(e){return super.getEditHandles(e)}createTranslateHandle(e){const t=e.shape;const i=is3DMap(e)?new EditContext(e.map,e.layer,e.feature,t.baseShape,e.settings):e;return super.createTranslateHandle(i)}getCreateHandle(e){return null}}class ExtrudedShapeHeightBodyHandle extends ShapeTouchHandle{constructor(e){super();this._extrudedShape=e;this._dragStartPoint=null;this._minHeightAtStart=0;this._maxHeightAtStart=0}get extrudedShape(){return this._extrudedShape}getCursor(e,t){if(this.active||this.interacts(e,t))return"ns-resize";return null}interacts(e,t){const i=getInteractionRadius(e,t);const{x:a,y:r}=e.viewPoint;return interactsWithControllerShape(t.map,a,r,i,this.extrudedShape)&&!interactsWithControllerShape(t.map,a,r,i,this.extrudedShape.baseShape)}process(e,t){const i=viewToModelOnHeightAxis(e.viewPoint,t,this.extrudedShape.baseShape.focusPoint);if(i){this.drag(i,e,t);this.emitEditShapeEvent(this.extrudedShape,EditShapeStatus.IN_PROGRESS)}return HandleEventResult.EVENT_HANDLED}drag(e,t,i){if(!this._dragStartPoint){this._dragStartPoint=e;this._minHeightAtStart=this.extrudedShape.minimumHeight;this._maxHeightAtStart=this.extrudedShape.maximumHeight}const a=e.z-this._dragStartPoint.z;if(i.map.is3D()&&!i.map.isGeospatial()){this.extrudedShape.minimumHeight=this._minHeightAtStart+a;this.extrudedShape.maximumHeight=this._maxHeightAtStart+a}else{this.extrudedShape.minimumHeight=Math.max(0,this._minHeightAtStart+a);const e=this.extrudedShape.maximumHeight-this.extrudedShape.minimumHeight;this.extrudedShape.maximumHeight=Math.max(e,this._maxHeightAtStart+a)}}deactivate(e,t){this._dragStartPoint=null;this._minHeightAtStart=0;this._maxHeightAtStart=0;return super.deactivate(e,t)}}function getPointOnHeightAxis(e,t){const i=e.baseShape.focusPoint;const a=lerp(e.minimumHeight,e.maximumHeight,t);return createPoint(e.reference,[i.x,i.y,a])}function lerp(e,t,i){if(1===i)return t;else if(0===i)return e;return e+i*(t-e)}function is3DMap(e){return e.map.is3D()}