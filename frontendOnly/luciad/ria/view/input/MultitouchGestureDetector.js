import{Constants}from"../../util/Constants.js";const PRESSURE_THRESHOLD=0;function identifiedTouch(t,e){const i=t.length;for(let s=0;s<i;s++){const i=t[s];if(i.identifier===e)return i}return null}function removeTouches(t,e){for(let i=0,s=e.length;i<s;i++){const s=e[i].identifier;for(let e=t.length-1;e>=0;e--)if(t[e]===s)t.splice(e,1)}}function angle(t,e,i,s){const r=t-i;const n=e-s;const c=undefined;return-Math.atan2(n,r)*Constants.RAD2DEG+180}export class MultitouchGestureDetector{_gestureInProgress=false;_focusX=0;_prevFingerDiffX=0;_prevFingerDiffY=0;_focusY=0;_currFingerDiffX=0;_currFingerDiffY=0;_scaleFactor=0;_scaleFactorFromStart=0;_prevLen=0;_currLen=0;_prevPressure=0;_currPressure=0;_timeDelta=0;_pointerIDs=[];_timeStamp=0;_initLen=0;_curr1=null;_curr0=null;_cx0=0;_cy0=0;_cx1=0;_cy1=0;_px0=0;_py0=0;_px1=0;_py1=0;_prevForce0=0;_prevForce1=0;_prevTimeStamp=0;_ix0=0;_iy0=0;_ix1=0;_iy1=0;_initFingerDiffX=0;_initFingerDiffY=0;_initFocusX=0;_initFocusY=0;_previousFocusX=0;_previousFocusY=0;constructor(t){this._listener=t}ontouchstart=t=>{const e=this._pointerIDs;const i=t.changedTouches;for(let t=0,s=i.length;t<s;t++)e.push(i[t].identifier);return this._processEvent(t,"down",e)};ontouchmove=t=>{const e=this._pointerIDs;if(0===e.length){const i=t.targetTouches;for(let t=0,s=i.length;t<s;t++)e.push(i[t].identifier)}return this._processEvent(t,"move",e)};ontouchend=t=>{removeTouches(this._pointerIDs,t.changedTouches);return this._processEvent(t,"up",this._pointerIDs)};ontouchcancel=t=>{removeTouches(this._pointerIDs,t.changedTouches);return this._processEvent(t,"cancel",this._pointerIDs)};onblur=t=>{this._pointerIDs=[];this._processEvent(t,"cancel",this._pointerIDs);return false};oncontextmenu=t=>{this._pointerIDs=[];this._processEvent(t,"cancel",this._pointerIDs);return false};_processEvent(t,e,i){let s=false;const r=t.targetTouches?.length??0;if(!this._gestureInProgress){if(("down"===e||"move"===e)&&r>=2){this.reset();if(i.length>=2){this.savePrevEvent(t,i);this._timeDelta=0;this.setContext(t,i,true);this._listener.onMultiTouchGestureBegin(this);this._gestureInProgress=true;s=true}}}else if("up"===e||"cancel"===e){if(1===i.length){const e=identifiedTouch(t.touches,i[0])||identifiedTouch(t.changedTouches,i[0]);if(e){this._focusX=e.pageX;this._focusY=e.pageY}}this._listener.onMultiTouchGestureEnd(this,t);this.reset();s=true}else if("move"===e){this.setContext(t,i);if(this._currPressure/this._prevPressure>PRESSURE_THRESHOLD){this._listener.onMultiTouchGesture(this,t);this.savePrevEvent(t,i);s=true}}return s}savePrevEvent(t,e){const i=e[0];const s=e[1];const r=t.touches;const n=t.changedTouches;const c=identifiedTouch(r,i)||identifiedTouch(n,i);const h=identifiedTouch(r,s)||identifiedTouch(n,s);this._px0=c?.pageX??-1;this._py0=c?.pageY??-1;this._px1=h?.pageX??-1;this._py1=h?.pageY??-1;this._prevForce0=c?.force||.5;this._prevForce1=h?.force||.5;this._prevTimeStamp=t.timeStamp}setContext(t,e,i=false){this._timeStamp=t.timeStamp;this._initLen=-1;this._currLen=-1;this._prevLen=-1;this._scaleFactor=-1;this._scaleFactorFromStart=-1;const s=e[0];const r=e[1];const n=t.touches;const c=t.changedTouches;this._curr1=identifiedTouch(n,r)||identifiedTouch(c,r);this._curr0=identifiedTouch(n,s)||identifiedTouch(c,s);this._cx0=this._curr0?.pageX??-1;this._cy0=this._curr0?.pageY??-1;this._cx1=this._curr1?.pageX??-1;this._cy1=this._curr1?.pageY??-1;const h=this._px1-this._px0;const o=this._py1-this._py0;const _=this._cx1-this._cx0;const u=this._cy1-this._cy0;this._prevFingerDiffX=h;this._prevFingerDiffY=o;this._currFingerDiffX=_;this._currFingerDiffY=u;this._focusX=this._cx0+_/2;this._focusY=this._cy0+u/2;this._timeDelta=t.timeStamp-this._prevTimeStamp;this._currPressure=(this._curr0?.force||.5)+(this._curr1?.force||.5);this._prevPressure=this._prevForce0+this._prevForce1;if(i){this._ix0=this._cx0;this._iy0=this._cy0;this._ix1=this._cx1;this._iy1=this._cy1;this._initFingerDiffX=this._currFingerDiffX;this._initFingerDiffY=this._currFingerDiffY;this._initFocusX=this._focusX;this._initFocusY=this._focusY}}reset(){this._gestureInProgress=false}isInProgress(){return this._gestureInProgress}getFocusX(){return this._focusX}getInitialFocusX(){return this._initFocusX}getInitialFocusY(){return this._initFocusY}getPreviousFocusX(){return this._previousFocusX}getPreviousFocusY(){return this._previousFocusY}getFocusY(){return this._focusY}getInitialSpan(){if(-1===this._initLen){const t=this._initFingerDiffX;const e=this._initFingerDiffY;this._initLen=Math.sqrt(t*t+e*e)}return this._initLen}getCurrentSpan(){if(-1===this._currLen){const t=this._currFingerDiffX;const e=this._currFingerDiffY;this._currLen=Math.sqrt(t*t+e*e)}return this._currLen}getPreviousSpan(){if(-1===this._prevLen){const t=this._prevFingerDiffX;const e=this._prevFingerDiffY;this._prevLen=Math.sqrt(t*t+e*e)}return this._prevLen}getInitialAngle(){return angle(this._ix0,this._iy0,this._ix1,this._iy1)}getPreviousAngle(){return angle(this._px0,this._py0,this._px1,this._py1)}getCurrentAngle(){return angle(this._cx0,this._cy0,this._cx1,this._cy1)}getScaleFactor(){if(-1===this._scaleFactor)this._scaleFactor=this.getCurrentSpan()/this.getPreviousSpan();return this._scaleFactor}getScaleFactorFromStart(){if(-1===this._scaleFactorFromStart)this._scaleFactorFromStart=this.getCurrentSpan()/this.getInitialSpan();return this._scaleFactorFromStart}getTimeDelta(){return this._timeDelta}getEventTime(){return this._timeStamp}}