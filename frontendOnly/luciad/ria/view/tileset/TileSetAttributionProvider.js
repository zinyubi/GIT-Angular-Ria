import{createBounds}from"../../shape/ShapeFactory.js";import{isFunction}from"../../util/Lang.js";import{EventedSupport}from"../../util/EventedSupport.js";import{isAttributedTileSet}from"../../model/tileset/AttributedTileSet.js";import{LayerTreeVisitor}from"../LayerTreeVisitor.js";import{LayerTreeNode}from"../LayerTreeNode.js";var ReturnValue=LayerTreeVisitor.ReturnValue;var VisitOrder=LayerTreeNode.VisitOrder;class TileSetAttributionProvider{_queuedUpdateHandle=null;constructor(t){this._eventedSupport=new EventedSupport;this._updateQueued=null;this._map=t;this._tmpMapBounds=createBounds(t.reference);this._tilesetLayers=[];this._currentLayerAttributions=[];this._currentAttributionLogos=[];this._currentAttributionStrings=[];this._mapUpdateListener=t.on("MapChange",(()=>{this.queueUpdateAttribution()}));this._layerAddedListener=t.layerTree.on("NodeAdded",(t=>{this.addLayerTreeNode(t.node)}));this._layerRemovedListener=t.layerTree.on("NodeRemoved",(t=>{this.removeLayerTreeNode(t.node)}));this.addLayerTreeNode(t.layerTree);this.updateAttribution()}addLayerTreeNode(t){let e=false;const i={visitLayer:t=>{e=this.addLayer(t)||e;return ReturnValue.CONTINUE},visitLayerGroup(t){t.visitChildren(i,VisitOrder.BOTTOM_UP);return ReturnValue.CONTINUE}};t.accept(i);if(e)this.updateAttribution()}addLayer(t){const e=t.model;const i=this;if(isFunction(t.getAttribution)||isAttributedTileSet(e)){this._tilesetLayers.push(t);t.on("VisibilityChanged",(t=>{i.updateAttribution()}));if(isAttributedTileSet(e))e.on("AttributionChanged",(()=>{i.updateAttribution()}));return true}else return false}removeLayerTreeNode(t){let e=false;const i={visitLayer:t=>{e=this.removeLayer(t)||e;return ReturnValue.CONTINUE},visitLayerGroup(t){t.visitChildren(i,VisitOrder.BOTTOM_UP);return ReturnValue.CONTINUE}};t.accept(i);if(e)this.updateAttribution()}removeLayer(t){const e=this._tilesetLayers.indexOf(t);if(-1!==e){this._tilesetLayers.splice(e,1);return true}else return false}dispose(){this._mapUpdateListener.remove();this._layerAddedListener.remove();this._layerRemovedListener.remove()}getAttributionLogos(){return this._currentAttributionLogos.slice()}getAttributionStrings(){return this._currentAttributionStrings.slice()}getLayerAttributions(){return this._currentLayerAttributions.slice()}queueUpdateAttribution(){if(this._updateQueued)return;setTimeout((()=>{this.updateAttribution();this._updateQueued=false}),1e3);this._updateQueued=true}updateAttribution(){const t=[];let e=[];const i=[];const r=this._tilesetLayers;for(const s of r){let r=[];let n=[];if(s.visible){if(s.getAttribution){const t=s.getAttribution();if(t){r=t;e=e.concat(t)}}if(isFunction(s.model.getLogo)){const e=s.model.getLogo();if(e){n=[e];t.push(e)}}}if(0!==r.length||0!==n.length)i.push({layer:s,attributionStrings:r,attributionLogos:n})}let s=false;if(!equals(t,this._currentAttributionLogos)){this._currentAttributionLogos=t;this.emit("AttributionLogosChanged",t.slice());s=true}if(!equals(e,this._currentAttributionStrings)){this._currentAttributionStrings=e;this.emit("AttributionStringsChanged",e.slice());s=true}if(s){this._currentLayerAttributions=i;this.emit("LayerAttributionsChanged",i)}}on(t,e,i){return this._eventedSupport.on(t,e,i)}emit(t,...e){this._eventedSupport.emit(t,...e)}}function equals(t,e){if(t.length!==e.length)return false;for(let i=0,r=t.length;i<r;i++)if(t[i]!==e[i])return false;return true}export{TileSetAttributionProvider};