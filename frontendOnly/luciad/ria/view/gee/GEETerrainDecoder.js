import{DataViewCursor}from"./DataViewCursor.js";import{decode}from"./GEEPacketDecoder.js";const negativeAltitudeThreshold=1e-12;const negativeAltitudeCorrection=-(2<<31);const earthRadius=6371010;const quadSize=16;const TERRAIN_EXAGGERATION=1;export function decodeTerrainMeshes(e){const t=undefined;return parsePacket(decode(e))}function parsePacket(e,t=true){const n=new DataViewCursor(new DataView(e),t);const i=[];while(n.hasNext()){const e=getMeshMetadata(n);if(!e){i.push(void 0);continue}const t=getVertexData(n,e);const o=getFaceData(n,e,t);const{minimumElevation:s,maximumElevation:a,averageElevation:c,vertices:r}=t;const{width:u,height:d,origin:l}=e;i.push({vertices:r,faces:o,origin:l,minimumElevation:s,maximumElevation:a,averageElevation:c,width:u,height:d})}return i}function getMeshMetadata(e){const t=undefined;if(0===e.nextUint32())return null;const n=180*e.nextFloat64();const i=180*e.nextFloat64();const o=180*e.nextFloat64();const s=180*e.nextFloat64();const a=e.nextUint32();const c=e.nextUint32();e.nextUint32();const r=undefined;const u=undefined;const d=undefined;return{origin:{x:n,y:i,z:0},stepX:o,stepY:s,numVertices:a,numFaces:c,height:quadSize*s,width:quadSize*o}}function getVertexData(e,t){const{numVertices:n,stepX:i,stepY:o}=t;let s=0;let a=0;let c=0;const r=new Array(3*n);const u=new Array;for(let t=0;t<n;t++){const n=3*t;const d=e.nextUint8();const l=e.nextUint8();const g=e.nextFloat32()*earthRadius;const h=g<negativeAltitudeThreshold?g*negativeAltitudeCorrection:g;r[n]=d*i;r[n+1]=l*o;r[n+2]=h*TERRAIN_EXAGGERATION;u.push(0===d||0===l||d===quadSize||l===quadSize?r.push(d*i,l*o,0)/3-1:null);s=0===t?h:Math.min(h,s);a=0===t?h:Math.max(h,a);c+=h}const d=s-4*(a-s);for(let e=3*n+2;e<r.length;e+=3)r[e]=d;const l=undefined;return{minimumElevation:s,maximumElevation:a,averageElevation:c/n,vertices:r,edgeVertices:u}}function getFaceData(e,t,n){const{numFaces:i}=t;const o=new Array(3*i);for(let t=0;t<i;t++){const i=e.nextUint16();const s=e.nextUint16();const a=e.nextUint16();const c=3*t;o[c]=i;o[c+1]=s;o[c+2]=a;o.push(...getEdgeFaces(i,s,n),...getEdgeFaces(i,a,n),...getEdgeFaces(s,a,n))}return o}function getEdgeFaces(e,t,n){const i=n.edgeVertices[e];const o=n.edgeVertices[t];if(null===i||null===o)return[];return[e,t,i,o,i,t,e,i,t,t,i,o]}