import*as ProtocolBuffer from"../../util/protocolbuffer/ProtocolBuffer.js";import{LayerType}from"./GEEMetadataDecoderInterfaces.js";import{QuadTreeFormat2SubindexCalculator}from"./QuadTreeFormat2SubindexCalculator.js";const defaultSubIndexCalculator=QuadTreeFormat2SubindexCalculator.forSubtree();const rootSubIndexCalculator=QuadTreeFormat2SubindexCalculator.forRoot();const FLAG_TREE=16;const FLAG_VECTOR=32;const FLAG_IMAGERY=64;const FLAG_TERRAIN=128;export class GEETileMetadataV2{constructor(e,t){this._node=e.Node;this._layers=[];this._channels=[];this._index=t?`${t}${defaultSubIndexCalculator.to_traversal_path(e.index)}`:rootSubIndexCalculator.to_traversal_path(e.index)}get quadkey(){return this._index}get channels(){if(this._channels.length)return this._channels;return this._node.channel.reduce(((e,t)=>{e.push({type:t.type,version:t.channelEpoch});return e}),this._channels)}get layers(){if(this._layers.length)return this._layers;return this._node.layer.reduce(((e,t)=>{e.push({provider:t.provider??null,type:t.type,version:t.layerEpoch});return e}),this._layers)}get hasChildren(){return this.flags(15)}get hasTree(){return this.flags(FLAG_TREE)}get hasTerrainData(){return this.flags(FLAG_TERRAIN)}get hasImageryData(){return this.flags(FLAG_IMAGERY)}get hasVectorData(){return this.flags(FLAG_VECTOR)}get cnodeVersion(){return this._node.cacheNodeEpoch??1}get terrainVersion(){return this.layer(LayerType.LAYER_TYPE_TERRAIN)?.layerEpoch??1}get imageryVersion(){return this.layer(LayerType.LAYER_TYPE_IMAGERY)?.layerEpoch??1}hasChild(e){return this.flags(1<<e)}getVectorVersion(e){return this.layer(LayerType.LAYER_TYPE_VECTOR)?.layerEpoch??null}layer(e){return this._node.layer.find((t=>t.type===e))||null}flags(e){return Boolean((this._node.flags||0)&e)}}export function parseQuadTreePacketV2(e,t){const r=undefined;return QuadTreePacket.decode(new Uint8Array(e)).sparseQuadtreeNode.map((e=>new GEETileMetadataV2(e,t)))}export function getMetadataUrl(e,t,r,a){return`${e}/flatfile?${a?"db=tm&":""}qp-0${t}-q.${r}`}const QUADTREE_PACKET_JSON={nested:{keyhole:{nested:{QuadtreeChannel:{fields:{type:{rule:"required",type:"int32",id:1},channelEpoch:{rule:"required",type:"int32",id:2}}},QuadtreeImageryTimedTile:{fields:{milliseconds:{rule:"required",type:"int32",id:1},timedTileEpoch:{rule:"required",type:"int32",id:2},provider:{type:"int32",id:3}}},QuadtreeImageryDatedTile:{fields:{date:{rule:"required",type:"int32",id:1},datedTileEpoch:{rule:"required",type:"int32",id:2},provider:{rule:"required",type:"int32",id:3},timedTiles:{rule:"repeated",type:"QuadtreeImageryTimedTile",id:4,options:{packed:false}}}},QuadtreeImageryDates:{fields:{datedTile:{rule:"repeated",type:"QuadtreeImageryDatedTile",id:1,options:{packed:false}},sharedTileDate:{type:"int32",id:2},coarseTileDates:{rule:"repeated",type:"int32",id:3,options:{packed:false}},sharedTileMilliseconds:{type:"int32",id:4}}},QuadtreeLayer:{fields:{type:{rule:"required",type:"LayerType",id:1},layerEpoch:{rule:"required",type:"int32",id:2},provider:{type:"int32",id:3},datesLayer:{type:"QuadtreeImageryDates",id:4}},nested:{LayerType:{values:{LAYER_TYPE_IMAGERY:0,LAYER_TYPE_TERRAIN:1,LAYER_TYPE_VECTOR:2,LAYER_TYPE_IMAGERY_HISTORY:3}}}},QuadtreeNode:{fields:{flags:{type:"int32",id:1},cacheNodeEpoch:{type:"int32",id:2},layer:{rule:"repeated",type:"QuadtreeLayer",id:3,options:{packed:false}},channel:{rule:"repeated",type:"QuadtreeChannel",id:4,options:{packed:false}}},nested:{NodeFlags:{options:{allow_alias:true},values:{NODE_FLAGS_CHILD_COUNT:4,NODE_FLAGS_CACHE_BIT:4,NODE_FLAGS_DRAWABLE_BIT:5,NODE_FLAGS_IMAGE_BIT:6,NODE_FLAGS_TERRAIN_BIT:7}}}},QuadtreePacket:{fields:{packetEpoch:{rule:"required",type:"int32",id:1},sparseQuadtreeNode:{rule:"repeated",type:"SparseQuadtreeNode",id:2}},nested:{SparseQuadtreeNode:{fields:{index:{rule:"required",type:"int32",id:3},Node:{rule:"required",type:"QuadtreeNode",id:4}},group:true}}}}}}};const QuadTreePacket=ProtocolBuffer.Root.fromJSON(QUADTREE_PACKET_JSON).lookupType("keyhole.QuadtreePacket");export let NodeFlags=function(e){e[e["NODE_FLAGS_CHILD_COUNT"]=4]="NODE_FLAGS_CHILD_COUNT";e[e["NODE_FLAGS_CACHE_BIT"]=4]="NODE_FLAGS_CACHE_BIT";e[e["NODE_FLAGS_DRAWABLE_BIT"]=5]="NODE_FLAGS_DRAWABLE_BIT";e[e["NODE_FLAGS_IMAGE_BIT"]=6]="NODE_FLAGS_IMAGE_BIT";e[e["NODE_FLAGS_TERRAIN_BIT"]=7]="NODE_FLAGS_TERRAIN_BIT";return e}({});