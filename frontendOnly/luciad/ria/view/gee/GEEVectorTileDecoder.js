import{DataViewCursor}from"./DataViewCursor.js";import{DrawFlagType}from"./GEEDbRootDecoder.js";import{decode}from"./GEEPacketDecoder.js";import*as StyleMap from"./GEEVectorStyleMap.js";import{appendToBuffer,createDataBuffer,extractPoints,GeometryType,getPolylinesFromPolygon,isPolygonOnEdges,PacketType}from"./GEEVectorUtil.js";const SIZE_OF_HEADER=32;const SIZE_OF_POINT=8*3;function parseParentPacket(e,t){const n=parsePacketHeader(t,0);let a=new ArrayBuffer(0);const r=[];let s=0;for(let c=0;c<n.num_instances;c++){const o=undefined;const i=parseChildPacket(e,t,SIZE_OF_HEADER+n.data_instance_size*c,n.data_buffer_offset);r.push(i);s+=i.header.num_instances+Math.max(0,i.additionalShapes);a=appendToBuffer(a,i.resultBuffer)}const c=new ArrayBuffer(4);const o=undefined;new DataView(c).setUint32(0,s,true);a=appendToBuffer(c,a);return{packetHeader:n,dataBuffer:a,instances:r}}function parsePacketHeader(e,t,n=true){const a=new DataViewCursor(new DataView(e,t),n);return{keyhole_magic:a.nextUint32(),data_type_id:a.nextUint32(),packet_format_version:a.nextUint32(),num_instances:a.nextUint32(),data_instance_size:a.nextUint32(),data_buffer_offset:a.nextUint32(),data_buffer_size:a.nextUint32(),meta_buffer_size:a.nextUint32()}}function parseChildPacket(e,t,n,a){const r=parsePacketHeader(t,n);const s=new DataView(t,n+SIZE_OF_HEADER);const c=s.getUint32(0,true);const o=s.getUint32(4,true);const i=s.getInt32(8,true);const P=s.getUint32(12,true);const f=s.getUint32(16,true);const u=s.getInt32(20,true);const T=[];let p=0;let E=new ArrayBuffer(0);const y=getPacketType(r);if(null===y)throw new Error("Invalid GEE Vector packet type");for(let n=0;n<r.num_instances;n++){const s=undefined;const c=undefined;const o=parseVectorPacketData(e,t,y,a+r.data_buffer_offset+P+r.data_instance_size*n,a+r.data_buffer_offset+f);if(!o)continue;T.push(o);p+=o.additionalShapes;E=appendToBuffer(E,o.buffer)}return{header:r,metaHeader_OFFSET:c,packetBuffer_OFFSET:o,packetBufferSize:i,dataInstances_OFFSET:P,dataBuffer_OFFSET:f,maxDataBufferSize:u,instances:T,additionalShapes:p,resultBuffer:E,packetType:y}}function getPacketType(e){switch(e.data_type_id){case PacketType.TYPE_STREETPACKET:case PacketType.TYPE_STREETPACKET_UTF8:return PacketType.TYPE_STREETPACKET;case PacketType.TYPE_POLYLINEPACKET:return PacketType.TYPE_POLYLINEPACKET;case PacketType.TYPE_AREAPACKET:return PacketType.TYPE_AREAPACKET;case PacketType.TYPE_SITEPACKET:case PacketType.TYPE_SITEPACKET_UTF8:return PacketType.TYPE_SITEPACKET;case PacketType.TYPE_LANDMARKPACKET:return PacketType.TYPE_LANDMARKPACKET;case PacketType.TYPE_POLYGONPACKET:return PacketType.TYPE_POLYGONPACKET;case PacketType.TYPE_DRAWABLEPACKET:return null;default:return null}}function parseVectorPacketData(e,t,n,a,r){switch(n){case PacketType.TYPE_DRAWABLEPACKET:return null;case PacketType.TYPE_STREETPACKET:case PacketType.TYPE_STREETPACKET_UTF8:return parseStreetPacketData(t,a,r);case PacketType.TYPE_POLYLINEPACKET:return parsePolylinePacket(t,a,r);case PacketType.TYPE_AREAPACKET:return parseAreaPacket(t,a,r);case PacketType.TYPE_SITEPACKET:case PacketType.TYPE_SITEPACKET_UTF8:return parseSitePacket(t,a,r);case PacketType.TYPE_LANDMARKPACKET:return parseLandmarkPacket(t,a,r);case PacketType.TYPE_POLYGONPACKET:return parsePolygonPacketData(e,t,a,r);default:return null}}function parsePolygonPacketData(e,t,n,a,r=true){const s=new DataViewCursor(new DataView(t,n),r);const c=s.nextUint32();const o=s.nextInt32();const i=s.nextUint16();const P=s.nextUint16();const f=s.nextUint16();s.padding(2);const u=s.nextUint32();const T=s.nextUint32();const p=s.nextInt32();const E=extractPoints(t,a,i,u);const y=[...new Uint8Array(t,a+T,f)];const{buffer:_,amountOfShapes:l}=getPolygonPacketData(e,p,E,y);return{packetType:PacketType.TYPE_POLYGONPACKET,nameOffset:c,reserved1:o,numPt:i,bitFlags:P,numEdgeFlags:f,localPt:u,edgeFlags:T,style:p,points:E,additionalShapes:l,flags:y,buffer:_}}function getPolygonPacketData(e,t,n,a){const r=StyleMap.get(e,t);if(!isPolygonOnEdges(a))return getEdgelessPolygonData(t,n,r);const{buffer:s,amountOfShapes:c}=getOutlineData(t,a,n,r);const{buffer:o,amountOfShapes:i}=getFillData(t,a,n,r);const P=new ArrayBuffer(s.byteLength+o.byteLength);const f=new Uint8Array(P);const u=c+(c?1:0)*i;f.set(new Uint8Array(s));f.set(new Uint8Array(o),s.byteLength);return{buffer:P,amountOfShapes:u}}function getEdgelessPolygonData(e,t,n){let a=GeometryType.POLYGON;switch(n){case DrawFlagType.TYPE_FILL_ONLY:a=GeometryType.AREA;break;case DrawFlagType.TYPE_OUTLINE_ONLY:a=GeometryType.POLYLINE;break}const r=undefined;return{buffer:createDataBuffer(t,a,t.byteLength/SIZE_OF_POINT,e),amountOfShapes:0}}function getOutlineData(e,t,n,a){if(a===DrawFlagType.TYPE_FILL_ONLY)return{amountOfShapes:0,buffer:new ArrayBuffer(0)};const{amountOfShapes:r,buffer:s}=getPolylinesFromPolygon(n,t,e);return{amountOfShapes:Math.max(0,r-1),buffer:s}}function getFillData(e,t,n,a){if(a===DrawFlagType.TYPE_OUTLINE_ONLY)return{amountOfShapes:0,buffer:new ArrayBuffer(0)};const r=undefined;return{amountOfShapes:1,buffer:createDataBuffer(n,GeometryType.AREA,n.byteLength/SIZE_OF_POINT,e)}}function parseStreetPacketData(e,t,n,a=true){const r=new DataViewCursor(new DataView(e,t),a);const s=r.nextUint32();const c=r.nextInt32();const o=r.nextUint16();const i=r.nextUint16();const P=r.nextUint32();const f=r.nextInt32();const u=extractPoints(e,n,o,P);const T=0;const p=createDataBuffer(u,GeometryType.POLYLINE,u.byteLength/SIZE_OF_POINT,f);return{packetType:PacketType.TYPE_STREETPACKET,nameOffset:s,textId_deprecated:c,numPt:o,bitFlags:i,localPt:P,style:f,points:u,additionalShapes:T,buffer:p}}function parseLandmarkPacket(e,t,n,a=true){const r=new DataViewCursor(new DataView(e,t),a);const s=r.nextUint32();const c=r.nextUint16();const o=r.nextUint16();const i=r.nextUint32();const P=r.nextUint32();const f=r.nextInt32();const u=r.nextUint32();const T=extractPoints(e,n,c,i);const p=0;const E=createDataBuffer(T,GeometryType.POINT,T.byteLength/SIZE_OF_POINT,f);const y=undefined;return{packetType:PacketType.TYPE_LANDMARKPACKET,buffer:E,additionalShapes:p,points:T,nameOffset:s,numPt:c,bitFlags:o,localPt:i,iconNameOffset:P,style:f,descriptionOffset:u}}function parseAreaPacket(e,t,n,a=true){const r=new DataViewCursor(new DataView(e,t),a);const s=r.nextUint32();const c=r.nextInt32();const o=r.nextUint16();const i=r.nextUint16();const P=r.nextUint32();const f=r.nextInt32();const u=extractPoints(e,n,o,P);const T=0;const p=createDataBuffer(u,GeometryType.AREA,u.byteLength/SIZE_OF_POINT,f);return{packetType:PacketType.TYPE_AREAPACKET,nameOffset:s,texId:c,numPt:o,bitFlags:i,localPt:P,style:f,points:u,additionalShapes:T,buffer:p}}function parseSitePacket(e,t,n,a=true){const r=new DataViewCursor(new DataView(e,t),a);const s=r.nextUint32();const c=r.nextInt32();const o=r.nextUint16();const i=r.nextUint16();const P=r.nextUint32();const f=r.nextUint32();const u=r.nextInt32();const T=extractPoints(e,n,o,P);const p=0;const E=createDataBuffer(T,GeometryType.POINT,T.byteLength/SIZE_OF_POINT,u);const y=undefined;return{packetType:PacketType.TYPE_SITEPACKET,buffer:E,additionalShapes:p,points:T,style:u,html:f,localPt:P,bitFlags:i,numPt:o,texId:c,nameOffset:s}}function parsePolylinePacket(e,t,n){const a=new DataView(e,t);const r=a.getUint32(0,true);const s=a.getInt32(4,true);const c=a.getUint16(8,true);const o=a.getUint16(10,true);const i=a.getUint32(12,true);const P=a.getInt32(16,true);const f=extractPoints(e,n,c,i);const u=0;const T=createDataBuffer(f,GeometryType.POLYLINE,f.byteLength/SIZE_OF_POINT,P);return{packetType:PacketType.TYPE_POLYLINEPACKET,nameOffset:r,texId:s,numPt:c,bitFlags:o,localPt:i,style:P,points:f,additionalShapes:u,buffer:T}}export function decodePacket(e,t){const n=undefined;return parseParentPacket(e,decode(t))}