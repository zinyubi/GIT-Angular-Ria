import{EventedSupport}from"../../util/EventedSupport.js";import{ContextMenu}from"../ContextMenu.js";import{FeatureLayerRenderer}from"../feature/FeatureLayerRenderer.js";import{GestureEventType}from"../input/GestureEventType.js";import{PaintRepresentation}from"../PaintRepresentation.js";import{clearRequestDeactivation,EVENT_HANDLED,EVENT_IGNORED,isHandled,REQUEST_DEACTIVATION,REQUEST_FINISH,setHandled}from"./HandleEventResult.js";import{ShapeUtil}from"../../shape/ShapeUtil.js";export class EditingSupport{_lastClickChainHandled=false;_eventedSupport=new EventedSupport(["EditShape","Invalidated"]);_editShapeListener=null;_invalidateListener=null;constructor(e,t){this._finishEvent=t.settings.finishOnSingleClick?GestureEventType.SINGLE_CLICK_CONFIRMED:GestureEventType.DOUBLE_CLICK;this._finishEventResult=t.settings.finishOnSingleClick?EVENT_IGNORED:EVENT_HANDLED;this._handle=e;this._editShapeListener=this._handle.on("EditShape",(e=>{this._handle.update();this._eventedSupport.emit("EditShape",e)}));this._invalidateListener=this._handle.on("Invalidated",(()=>{this._eventedSupport.emit("Invalidated")}));this._is3d=t.map.is3D()}onDraw(e,t){if(!t.layer.visible||!t.layer._addedToMap)return;if(this._handle.shouldPaintFeature(t))FeatureLayerRenderer.paintFeature(e,t.feature,t.layer,t.map,PaintRepresentation.BODY,{selected:true});this._handle.onDraw(e,t)}onDrawLabel(e,t){if(!t.layer.visible||!t.layer._addedToMap)return;if(this._handle.shouldPaintFeature(t))FeatureLayerRenderer.paintFeature(e,t.feature,t.layer,t.map,PaintRepresentation.LABEL,{selected:true});this._handle.onDrawLabel(e,t)}getCursor(e,t){return this._handle.getCursor(e,t)}onGestureEvent(e,t){let n=EVENT_IGNORED;if(e.type===GestureEventType.CONTEXT_MENU){const i=new ContextMenu;this._handle.onCreateContextMenu(e,t,i,(()=>{if(t.map.controller)t.map.controller.invalidate()}));if(i.items.length){t.map.onShowContextMenu(e.pagePosition,i);this._handle.onGestureEvent(e,t);n=EVENT_HANDLED}}else n=this._handle.onGestureEvent(e,t);if(isHandled(n))if(t.map.controller)t.map.controller.invalidate();n=clearRequestDeactivation(n);const i=isHandled(n);if(e.type===GestureEventType.DOWN)this._lastClickChainHandled=i;if(e.type===GestureEventType.UP)this._lastClickChainHandled=this._lastClickChainHandled||i;if(e.type===GestureEventType.SINGLE_CLICK_UP)this._lastClickChainHandled=this._lastClickChainHandled||i;if(e.type===GestureEventType.SINGLE_CLICK_CONFIRMED)this._lastClickChainHandled=this._lastClickChainHandled||i;if(!i)if(e.type===this._finishEvent&&!this._lastClickChainHandled)n=this._finishEventResult|REQUEST_DEACTIVATION|REQUEST_FINISH;else if(this.shouldConsume(e))n=setHandled(n);return n}shouldConsume(e){return e.type===GestureEventType.SINGLE_CLICK_CONFIRMED||e.type===GestureEventType.LONG_PRESS}destroy(){this._editShapeListener?.remove();this._invalidateListener?.remove()}on(e,t){return this._eventedSupport.on(e,t)}hasDepth(e){return this._is3d&&null!==e&&!!e.bounds&&ShapeUtil.hasDepth(e)}}