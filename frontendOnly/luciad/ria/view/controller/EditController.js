import{ProgrammingError}from"../../error/ProgrammingError.js";import{EventedSupport}from"../../util/EventedSupport.js";import{isPromise,whenInternal}from"../../util/PromiseUtil.js";import{getConstrainedShape}from"../editor/Editor.js";import{Controller}from"./Controller.js";import{EditingSupport}from"./EditingSupport.js";import{HandleEventResult,isRequestDeactivation,REQUEST_DEACTIVATION}from"./HandleEventResult.js";import{EditContext}from"./EditContext.js";import{ShapeEditor}from"../editor/ShapeEditor.js";import{DEFAULT_MOUSE_INTERACTION_RADIUS,DEFAULT_TOUCH_INTERACTION_RADIUS,mergeMinMaxPointCount}from"./EditSettings.js";import{createHandlePointStyle,createHelperStyle}from"../feature/DefaultStyles.js";import{CompositeEditHandle}from"../editor/handles/CompositeEditHandle.js";export class EditController extends Controller{_savedState=null;_displayScaleListener=null;constructor(t,e,i={}){super();if(!e.shape)throw new Error("EditController cannot edit object without a valid shape");this._layer=t;this._layerRemovedListener=null;this._feature=e;this._options=i;this._minPointCount=0;this._maxPointCount=-1;this._editingSupport=null;this._eventedSupport=new EventedSupport(["EditShape","Restarted"]);this._editShapeHandle=null;this._invalidateHandle=null;this._editor=i.editor??new ShapeEditor;this._editContext=null;this._commitPromise=null}getMinimumPointCount(){return this._minPointCount}getMaximumPointCount(){return this._maxPointCount}setPointCount(t,e){if(t<0)throw new ProgrammingError("The minimum number of points should be positive.");if(-1!==e&&t>e)throw new ProgrammingError("The minimum number of points should be less than or equal to the maximum number of points.");this._minPointCount=t;this._maxPointCount=e}getSettings(){return{styles:{helperStyle:this._options?.helperStyle??createHelperStyle(),handleIconStyle:this._options?.handleIconStyle??createHandlePointStyle(this.layer.map?.displayScale??1)},finishOnSingleClick:this._options?.finishOnSingleClick??false,minimumPointCount:this.getMinimumPointCount(),maximumPointCount:this.getMaximumPointCount(),freehand:false,mouseInteractionRadius:this._options?.mouseInteractionRadius??DEFAULT_MOUSE_INTERACTION_RADIUS,touchInteractionRadius:this._options?.touchInteractionRadius??DEFAULT_TOUCH_INTERACTION_RADIUS}}saveState(){if(this._editContext)this._savedState=this._editor.saveState(this._editContext)}restoreState(){if(this._editContext)this._editor.restoreState(this._savedState,this._editContext)}get feature(){return this._feature}get layer(){return this._layer}onActivate(t){super.onActivate(t);this.restartInner(t);this._displayScaleListener=t.on("DisplayScaleChanged",(()=>{if(this._editContext){const e=this.getSettings();const i=createHandlePointStyle(t.displayScale);const n={...e,styles:{...e.styles,handleIconStyle:i}};this._editContext.settings=n;this.invalidate()}}))}finish(){if(this._editingSupport&&this._editContext&&this.map&&this._layer&&this._feature){const t=this.onFinish();if(isPromise(t))this._commitPromise=t.then((()=>{this.saveState()})).finally((()=>{this._commitPromise=null}));else this.saveState()}else throw new ProgrammingError("You cannot finish a non-active controller.")}restart(t,e){e=e??this.layer;if(!t){t=this.feature;this.restoreState()}if(!t.shape)throw new Error("EditController cannot edit object without a valid shape");this._layerRemovedListener?.remove();this._layerRemovedListener=null;this._editShapeHandle?.remove();this._editShapeHandle=null;this._invalidateHandle?.remove();this._invalidateHandle=null;if(this.map)this._editingSupport?.destroy();this._layer=e;this._layerRemovedListener=null;this._feature=t;this._editingSupport=null;this._editContext=null;if(this.map)this.restartInner(this.map);this._eventedSupport.emit("Restarted")}restartInner(t){if(!this._layer.map||!this._layer.editable||!this._layer.visibleInTree||this._layer._transformer.canPut&&!this._layer._transformer.canPut(this._feature))return;this._layerRemovedListener=t.layerTree.on("NodeRemoved",(t=>{if(t.node===this._layer){this._editingSupport?.destroy();this._editingSupport=null;this._layerRemovedListener?.remove();this._layerRemovedListener=null}}));if(!this._feature.shape)throw new Error(`Cannot edit a feature without a shape (shape is ${this._feature.shape})`);let e=getConstrainedShape(this._feature,this._feature.shape,this._layer,t);if(null===e)e=this._feature.shape;const i=this.getSettings();const n=mergeMinMaxPointCount(i,e);this._editContext=new EditContext(t,this._layer,this._feature,e,n);if(!this._editor.canEdit(this._editContext))throw new Error("Editor cannot edit feature");const r=this._editor.getEditHandles(this._editContext);const s=new CompositeEditHandle(r);this.map?.controllerManager.setDomainObject(this._feature);this.map?.controllerManager.setDomainLayer(this._layer);this._editingSupport=new EditingSupport(s,this._editContext);this._editShapeHandle=this._editingSupport.on("EditShape",(t=>{this._eventedSupport.emit("EditShape",t)}));this._invalidateHandle=this._editingSupport.on("Invalidated",(()=>{this.invalidate()}));this._layer.setEditedObject(this._feature);this.saveState();this.invalidate()}onDeactivate(t){const e=()=>{this.restoreState();this._layerRemovedListener?.remove();this._displayScaleListener?.remove();this._layerRemovedListener=null;this._layer.setEditedObject(null);this.map?.controllerManager.setDomainObject(null);this._editingSupport?.destroy();this._editingSupport=null;super.onDeactivate(t)};this._editShapeHandle?.remove();this._editShapeHandle=null;return whenInternal(this._commitPromise,e,e)}onDraw(t){if(!this._editingSupport||!this._editContext)return;this._editingSupport.onDraw(t,this._editContext)}onDrawLabel(t){if(!this._editingSupport||!this._editContext)return;this._editingSupport.onDrawLabel(t,this._editContext)}onGestureEvent(t){if(!this._editingSupport)return REQUEST_DEACTIVATION;let e=HandleEventResult.EVENT_IGNORED;if(this._editingSupport&&this._editContext)e=this._editingSupport.onGestureEvent(t,this._editContext);if(this._editingSupport&&this._editContext){this.cursor=this._editingSupport.getCursor(t,this._editContext);if(isRequestDeactivation(e))this.finish()}return e}onFinish(){if(!this._layer.map)return;const t=this._layer.workingSet.put(this._feature);if(isPromise(t))return t.then((()=>{}))}on(t,e,i){if("Invalidated"===t)return super.on(t,e);if("Activated"===t)return super.on(t,e);if("Deactivated"===t)return super.on(t,e);return this._eventedSupport.on(t,e)}}