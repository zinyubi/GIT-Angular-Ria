import{ProgrammingError}from"../../error/ProgrammingError.js";import{Invalidation}from"../../util/Invalidation.js";import{whenInternal}from"../../util/PromiseUtil.js";import{KeyboardHandler}from"../input/KeyboardHandler.js";import{MouseHandler}from"../input/MouseHandler.js";import{TouchHandler}from"../input/TouchHandler.js";import{Controller}from"./Controller.js";import{isHandled,isRequestDeactivation,isRequestFinish}from"./HandleEventResult.js";import{EventedSupport}from"../../util/EventedSupport.js";import{ControllerInteractionUtil}from"../ControllerInteractionUtil.js";import{DefaultController}from"./DefaultController.js";export class ControllerManager extends Invalidation{_controllerListener=null;_defaultControllerListener=null;_deactivatingControllerListener=null;_deactivatingDefaultControllerListener=null;_activatingControllerListener=null;_activatingDefaultControllerListener=null;constructor(t,e){super();let i=false;t.onReady((()=>{i=true}));this._mapReady=i;if(!this._mapReady)t.onReady((()=>{this._mapReady=true}));this._map=t;this._eventedSupport=new EventedSupport(["ControllerChanged"]);this._eventHandlers=[];this._interactionUtil=new ControllerInteractionUtil(t);if(this.isTouchDevice())this._eventHandlers.push(new TouchHandler(t,e,this));this._eventHandlers.push(new MouseHandler(t,e,this));this._eventHandlers.push(new KeyboardHandler(document,this));this._controller=null;this._activatingController=null;this._activatingDefaultController=null;this._deactivatingController=null;this._deactivatingDefaultController=null;this._drawCommand=null;this._domainObject=null;this._domainLayer=null;this._defaultController=new DefaultController;this._defaultController.onActivate(t)}getDomainObject(){return this._domainObject}setDomainObject(t){this._domainObject=t}getDomainLayer(){return this._domainLayer}setDomainLayer(t){this._domainLayer=t}onDraw(t){if(this._deactivatingController)this._deactivatingController.onDraw(t);if(this._controller)this._controller.onDraw(t);if(this._defaultController)this._defaultController.onDraw(t)}onDrawLabel(t){if(this._deactivatingController)this._deactivatingController.onDrawLabel(t);if(this._controller)this._controller.onDrawLabel(t);if(this._defaultController)this._defaultController.onDrawLabel(t)}setDrawCommand(t){this._drawCommand=t}getDrawCommand(){return this._drawCommand}getInteractionUtil(){return this._interactionUtil}destroy(){this._controller?.onDeactivate(this._map);this._defaultController?.onDeactivate(this._map);for(let t=0;t<this._eventHandlers.length;t++)this._eventHandlers[t].destroy();this._controllerListener?.remove();this._defaultControllerListener?.remove();this._activatingControllerListener?.remove();this._eventHandlers=[];this._interactionUtil=null;this._map=null;this._node=null}onKeyEvent(t){if(!this._mapReady)return false;let e=false;let i;if(null!==this._controller&&this._controller.onKeyEvent){i=this._controller.onKeyEvent(t);if(isRequestDeactivation(i)||isRequestFinish(i))this.setController(null);e=isHandled(i)}if(!e&&null!==this._defaultController&&this._defaultController.onKeyEvent){i=this._defaultController.onKeyEvent(t);if(isRequestDeactivation(i)||isRequestFinish(i))this.setDefaultController(null);e=isHandled(i)}return e}onGestureEvent(t){if(!this._mapReady)return false;let e=false;if(null!==this._controller&&this._controller.onGestureEvent){const i=this._controller.onGestureEvent(t);if(isRequestDeactivation(i)||isRequestFinish(i))this.setController(null);e=isHandled(i)}else if(null!==this._deactivatingController)e=true;if(!e&&null!==this._defaultController&&this._defaultController.onGestureEvent){const i=this._defaultController.onGestureEvent(t);if(isRequestDeactivation(i)||isRequestFinish(i))this.setDefaultController(null);e=isHandled(i)}else if(!e&&null!==this._deactivatingDefaultController)e=true;return e}_deactivationComplete(t){if(this._deactivatingController===t){this._deactivatingController=null;if(this._deactivatingControllerListener){this._deactivatingControllerListener.remove();this._deactivatingControllerListener=null}this._controller=this._activatingController;this._controllerListener=this._activatingControllerListener;this._activatingController=null;this._activatingControllerListener=null;if(this._controller&&this._controller.onActivate)this._controller.onActivate(this._map);this._eventedSupport.emit("ControllerChanged",this._controller,t)}this.invalidate()}_defaultDeactivationComplete(t){if(this._deactivatingDefaultController===t){this._deactivatingDefaultController=null;if(this._deactivatingDefaultControllerListener){this._deactivatingDefaultControllerListener.remove();this._deactivatingDefaultControllerListener=null}this._defaultController=this._activatingDefaultController;this._defaultControllerListener=this._activatingDefaultControllerListener;this._activatingDefaultController=null;this._activatingDefaultControllerListener=null;if(this._defaultController&&this._defaultController.onActivate)this._defaultController.onActivate(this._map);this._eventedSupport.emit("DefaultControllerChanged",this._defaultController,t)}this.invalidate()}setController(t){if("undefined"===typeof t)t=null;if(t===this._controller)return;if(t&&t.map)throw new Error("Cannot re-assign a controller that is already active on a map. Make sure it is deactivated before re-assigning it.");if(this._controller){this._activatingController=t;if(this._activatingController)this._activatingControllerListener=this._activatingController.on("Invalidated",this.invalidate.bind(this));else this._activatingControllerListener=null;this._deactivatingController=this._controller;this._deactivatingControllerListener=this._controllerListener;this._controller=null;this._controllerListener=null;const e=this._deactivatingController.onDeactivate(this._map);const i=this._deactivationComplete.bind(this,this._deactivatingController);whenInternal(e,i,i)}else if(this._deactivatingController){this._activatingController=t;if(this._activatingController)this._activatingControllerListener=this._activatingController.on("Invalidated",this.invalidate.bind(this));else this._activatingControllerListener=null}else{this._activatingController=null;if(this._activatingControllerListener){this._activatingControllerListener.remove();this._activatingControllerListener=null}this._controller=t;if(this._controller&&this._controller.onActivate){this._controller.onActivate(this._map);this._controllerListener=this._controller.on("Invalidated",this.invalidate.bind(this))}this._eventedSupport.emit("ControllerChanged",this._controller,null)}this.invalidate()}setDefaultController(t){if("undefined"===typeof t)t=null;if(t===this._defaultController)return;if(t&&t.map)throw new Error("Cannot re-assign a controller that is already active on a map. Make sure it is deactivated before re-assigning it.");if(this._defaultController){this._activatingDefaultController=t;if(this._activatingDefaultController)this._activatingDefaultControllerListener=this._activatingDefaultController.on("Invalidated",this.invalidate.bind(this));else this._activatingDefaultControllerListener=null;this._deactivatingDefaultController=this._defaultController;this._deactivatingDefaultControllerListener=this._defaultControllerListener;this._defaultController=null;this._defaultControllerListener=null;const e=this._deactivatingDefaultController.onDeactivate(this._map);const i=this._defaultDeactivationComplete.bind(this,this._deactivatingDefaultController);whenInternal(e,i,i)}else if(this._deactivatingDefaultController){this._activatingDefaultController=t;if(this._activatingDefaultController)this._activatingDefaultControllerListener=this._activatingDefaultController.on("Invalidated",this.invalidate.bind(this));else this._activatingDefaultControllerListener=null}else{this._activatingDefaultController=null;if(this._activatingDefaultControllerListener){this._activatingDefaultControllerListener.remove();this._activatingDefaultControllerListener=null}this._defaultController=t;if(this._defaultController&&this._defaultController.onActivate){this._defaultController.onActivate(this._map);this._defaultControllerListener=this._defaultController.on("Invalidated",this.invalidate.bind(this))}this._eventedSupport.emit("DefaultControllerChanged",this._defaultController,null)}this.invalidate()}on(t,e){if("ControllerChanged"===t||"DefaultControllerChanged"===t)return this._eventedSupport.on(t,e);return super.on(t,e)}isTouchDevice(){return!!("ontouchstart"in window||window.TouchEvent||navigator.maxTouchPoints&&navigator.maxTouchPoints>0)}get controller(){return this._controller}set controller(t){if(t&&!(t instanceof Controller))throw new ProgrammingError("Controllers must have luciad.view.controller.Controller in their prototype chain");this.setController(t)}get defaultController(){return this._defaultController}set defaultController(t){if(t&&!(t instanceof Controller))throw new ProgrammingError("Controllers must have luciad.view.controller.Controller in their prototype chain");this.setDefaultController(t)}}