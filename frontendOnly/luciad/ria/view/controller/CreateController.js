import{NotImplementedError}from"../../error/NotImplementedError.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{isPromise,whenInternal}from"../../util/PromiseUtil.js";import{getConstrainedShape}from"../editor/Editor.js";import{FeatureLayer}from"../feature/FeatureLayer.js";import{Controller}from"./Controller.js";import{EditingSupport}from"./EditingSupport.js";import{findGeoBuffer,GeoBufferEditingSupport}from"./GeoBufferEditingSupport.js";import{HandleEventResult,isRequestDeactivation,isRequestFinish}from"./HandleEventResult.js";import{EventedSupport}from"../../util/EventedSupport.js";import{EditContext}from"./EditContext.js";import{ShapeEditor}from"../editor/ShapeEditor.js";import{DEFAULT_MOUSE_INTERACTION_RADIUS,DEFAULT_TOUCH_INTERACTION_RADIUS,mergeMinMaxPointCount}from"./EditSettings.js";import{createHandlePointStyle,createHelperStyle}from"../feature/DefaultStyles.js";export class CreateController extends Controller{_eventedSupport=new EventedSupport(["EditShape","Restarted"]);_editingSupport=null;_layer=null;_feature=null;_editShapeHandle=null;_invalidateHandle=null;_commitPromise=null;_displayScaleListener=null;constructor(t){super();this._options=t||{};this._minPointCount=0;this._maxPointCount=-1;this._editor=t?.editor??new ShapeEditor;this._editContext=null}getMinimumPointCount(){return this._minPointCount}getMaximumPointCount(){return this._maxPointCount}setPointCount(t,e){if(t<0)throw new ProgrammingError("The minimum number of points should be positive.");if(-1!==e&&t>e)throw new ProgrammingError("The minimum number of points should be less than or equal to the maximum number of points.");this._minPointCount=t;this._maxPointCount=e}getSettings(){return{styles:{helperStyle:this._options?.helperStyle??createHelperStyle(),handleIconStyle:this._options?.handleIconStyle??createHandlePointStyle(this._editContext?.map.displayScale??1)},finishOnSingleClick:this._options?.finishOnSingleClick??false,minimumPointCount:this.getMinimumPointCount(),maximumPointCount:this.getMaximumPointCount(),freehand:this._options?.freehand??true,mouseInteractionRadius:this._options.mouseInteractionRadius??DEFAULT_MOUSE_INTERACTION_RADIUS,touchInteractionRadius:this._options.touchInteractionRadius??DEFAULT_TOUCH_INTERACTION_RADIUS}}onActivate(t){super.onActivate(t);this.restartInner();this._displayScaleListener=t.on("DisplayScaleChanged",(()=>{if(this._editContext){const e=this.getSettings();const i=createHandlePointStyle(t.displayScale);const n={...e,styles:{...e.styles,handleIconStyle:i}};this._editContext.settings=n;this.invalidate()}}))}onGestureEvent(t){if(!this._editingSupport)return HandleEventResult.REQUEST_DEACTIVATION;let e=HandleEventResult.EVENT_IGNORED;if(this._editingSupport&&this._editContext)e=this._editingSupport.onGestureEvent(t,this._editContext);if(this._editingSupport&&this._editContext){this.cursor=this._editingSupport.getCursor(t,this._editContext);if((isRequestDeactivation(e)||isRequestFinish(e))&&this.map&&this._layer)this.finish();this.invalidate()}return e}finish(){if(this._editingSupport&&this._editContext&&this.map&&this._layer&&this._feature)this.onObjectCreated(this.map,this._layer,this._feature);else throw new ProgrammingError("You cannot finish a non-active controller.")}restart(){this.restartInner();this._eventedSupport.emit("Restarted")}restartInner(){this._layer=null;this._feature=null;this._editContext=null;this._editShapeHandle?.remove();this._editShapeHandle=null;this._editingSupport=null;const t=this.map;if(!t)return;const e=this.onChooseLayer(t);if(!(e instanceof FeatureLayer))return;this._layer=e;if(null===e.model)return;this._feature=this.onCreateNewObject(t,e);if(!this._feature.shape)throw new Error("Cannot start creation for a feature that has a null shape");this.map?.controllerManager.setDomainObject(this._feature);this.map?.controllerManager.setDomainLayer(e);let i=getConstrainedShape(this._feature,this._feature.shape,this._layer,t);if(null===i)i=this._feature.shape;const n=this.getSettings();const r=mergeMinMaxPointCount(n,i);this._editContext=new EditContext(t,this._layer,this._feature,i,r);if(!this._editor.canEdit(this._editContext))throw new Error("Editor cannot create feature");const o=this._editor.getCreateHandle(this._editContext);const s=undefined;if(findGeoBuffer(this._editContext))this._editingSupport=new GeoBufferEditingSupport(o,this._editContext);else this._editingSupport=new EditingSupport(o,this._editContext);this._editShapeHandle=this._editingSupport.on("EditShape",(t=>{this._eventedSupport.emit("EditShape",t)}));this._invalidateHandle=this._editingSupport.on("Invalidated",(()=>{this.invalidate()}));this.cursor="crosshair";this.invalidate()}onDeactivate(t){if(null===this._editingSupport)super.onDeactivate(t);else{this._editShapeHandle?.remove();this._editShapeHandle=null;this._invalidateHandle?.remove();this._invalidateHandle=null;this._editingSupport.destroy();this._displayScaleListener?.remove()}const e=()=>{this._editingSupport=null;this._editContext=null;super.onDeactivate(t)};return whenInternal(this._commitPromise,e,e)}onDraw(t){if(!this._editingSupport||!this._editContext)return;this._editingSupport.onDraw(t,this._editContext)}onDrawLabel(t){if(!this._editingSupport||!this._editContext)return;this._editingSupport.onDrawLabel(t,this._editContext)}onChooseLayer(t){const e=t.layerTree.children;let i;for(i=e.length-1;i>=0;i--){const t=e[i];if(t instanceof FeatureLayer&&t.editable&&t.visibleInTree)return t}return null}onCreateNewObject(t,e){throw new NotImplementedError}onObjectCreated(t,e,i){const n=e.workingSet.add(i);if(isPromise(n)){this._commitPromise=n.then((()=>{}));return this._commitPromise}return}on(t,e,i){if("Invalidated"===t)return super.on(t,e,i);if("Activated"===t)return super.on(t,e,i);if("Deactivated"===t)return super.on(t,e,i);return this._eventedSupport.on(t,e,i)}}