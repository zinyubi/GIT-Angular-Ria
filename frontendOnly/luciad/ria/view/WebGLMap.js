import{Photon}from"../gen/photon/photon_painter.js";import{isIE}from"../util/Browser.js";import{EventedSupport}from"../util/EventedSupport.js";import{Log}from"../util/Log.js";import{getSpatialReference,Map}from"./Map.js";import{PhotonWorldViewTransformation}from"./photon/PhotonWorldViewTransformation.js";import{PhotonMapNavigator}from"./PhotonMapNavigator.js";import{PhotonViewPaintingStrategy}from"./strategy/PhotonViewPaintingStrategy.js";import{createBounds}from"../shape/ShapeFactory.js";import{ReferenceType}from"../reference/ReferenceType.js";import{ProgrammingError}from"../error/ProgrammingError.js";const MAP_CONFIG={viewPaintingStrategyConstructor:PhotonViewPaintingStrategy,mapNavigatorConstructor:e=>new PhotonMapNavigator(e),onPhotonReady:Photon.onReady,v2wConstructor:e=>new PhotonWorldViewTransformation(e)};const DEFAULT_CPU_HINT=500;const DEFAULT_GPU_HINT=1e3;export class WebGLMap extends Map{_webGLContextListener=null;constructor(e,t){if(isIE())Log.error("LuciadRIA WebGLMap is not supported by any version of Internet Explorer");delete t?.webgl;super(e,{...t??{},...MAP_CONFIG});this.maxMemoryUsageHint=t?.maxMemoryUsageHint??{cpuMB:DEFAULT_CPU_HINT,gpuMB:DEFAULT_GPU_HINT}}initMap(e,t){super.initMap(e,t);if(!this._webGLMapEventedSupport)this._webGLMapEventedSupport=new EventedSupport(["PostRender","WebGLContextChanged"]);const i=()=>{if(this.viewPaintingStrategy){this._webGLMapEventedSupport.onFirstListenerAdded("PostRender",(()=>{if(this.viewPaintingStrategy instanceof PhotonViewPaintingStrategy){const e=this.viewPaintingStrategy._photonView;e?.setFlushDepth(true)}}));this._webGLMapEventedSupport.onLastListenerRemoved("PostRender",(()=>{if(this.viewPaintingStrategy instanceof PhotonViewPaintingStrategy){const e=this.viewPaintingStrategy._photonView;e?.setFlushDepth(false)}}))}else this.onReady((()=>{i()}))};i();this._adjustDepthRange=t.adjustDepthRange??(!this.is3D()||this.isGeospatial());this.onReady((()=>{if(this.viewPaintingStrategy instanceof PhotonViewPaintingStrategy){const e=undefined;this.viewPaintingStrategy._photonView.setAutoAdjustCamera(this._adjustDepthRange);this._webGLContextListener=this.viewPaintingStrategy.on("WebGLContextChanged",(()=>{this._webGLMapEventedSupport.emit("WebGLContextChanged")}));if(this._maxMemoryUsageHint)this.viewPaintingStrategy.setMaxMemoryUsageHint(this._maxMemoryUsageHint)}}))}set reference(e){if(this.reference.referenceType===ReferenceType.CARTESIAN||e.referenceType===ReferenceType.CARTESIAN)throw new ProgrammingError("Map reference can not be changed at runtime from or to a non-geospatial projection.");const t=getSpatialReference(e);if(t.equals(this.reference))return;const i=this.saveState();const n=this.mapNavigator.constraints;this.layerTree._removedFromMap(this);const o={wrapAroundWorld:this.wrapAroundWorld,autoAdjustDisplayScale:this.autoAdjustDisplayScale,displayScale:this.displayScale,adjustDepthRange:this._adjustDepthRange,maxMemoryUsageHint:this.maxMemoryUsageHint,globeColor:this.globeColor};this.destroyMap();this.initMap(this.domNode,{...o,reference:t,...MAP_CONFIG});this.onReady((()=>{this._webGLMapEventedSupport.emit("WebGLContextChanged")}));this.layerTree._addedToMap(this);if(this._displayedBalloonFor)this.showBalloon(this._displayedBalloonFor);try{this.restoreState(i,{animate:false})}catch(e){console.warn(e)}this.mapNavigator.constraints=n;this._webGLMapEventedSupport.emit("ReferenceChanged",this.reference)}get reference(){return super.reference}get maxMemoryUsageHint(){return this.viewPaintingStrategy?.getMaxMemoryUsageHint()??this._maxMemoryUsageHint}set maxMemoryUsageHint(e){if(!e)e={};if(!e.cpuMB)e.cpuMB=DEFAULT_CPU_HINT;if(!e.gpuMB)e.gpuMB=DEFAULT_GPU_HINT;if(e.cpuMB<50){console.log("WebGLMap.maxMemoryUsageHint called with cpuMB < 50.  Limiting to 50 MB.");e.cpuMB=50}if(e.gpuMB<50){console.log("WebGLMap.maxMemoryUsageHint called with gpuMB < 50.  Limiting to 50 MB.");e.gpuMB=50}if(e.cpuMB>4e3)console.log("WebGLMap.maxMemoryUsageHint set cpuMB larger than 4000 MB. "+"This can cause instability on machines with low amounts of RAM.");if(e.gpuMB>4e3)console.log("WebGLMap.maxMemoryUsageHint set with gpuMB larger than 4000 MB. "+"This can cause instability on machines with low amounts of video memory.");this._maxMemoryUsageHint=e;this.onReady((()=>{this.viewPaintingStrategy.setMaxMemoryUsageHint(this._maxMemoryUsageHint)}))}set adjustDepthRange(e){this._adjustDepthRange=e;if(this.viewPaintingStrategy){const t=undefined;this.viewPaintingStrategy._photonView.setAutoAdjustCamera(e)}}get adjustDepthRange(){return this._adjustDepthRange}get webGLContext(){if(this.viewPaintingStrategy)return this.viewPaintingStrategy.webGLContext;return null}getMapBounds(e){const t=this.displayScale;if(this.wrapAroundWorld){const i=e?.reference??this.reference;const n=this.viewPaintingStrategy;const o=n.techContext.photonInstance.WrapAroundWorldUtil.create(n.techContext.photonView,false);const r={x:(e?.viewBounds?e.viewBounds.x:this.viewBounds.x)*t,y:(e?.viewBounds?e.viewBounds.y:this.viewBounds.y)*t,z:e?.viewBounds?e.viewBounds.z:this.viewBounds.z,width:(e?.viewBounds?e.viewBounds.width:this.viewBounds.width)*t,height:(e?.viewBounds?e.viewBounds.height:this.viewBounds.height)*t,depth:e?.viewBounds?e.viewBounds.depth:this.viewBounds.depth};const a=n.techContext.referenceProvider.getReference(i);const s=4;const h=Photon.BufferFactory.createFloat64BufferFromLength(2*s);const p=o.getMultiWorldBoundsOnSurface(r,a,h);const g=[];for(let e=0;e<p*s;e+=s){const t=createBounds(i,[h.typedArray[e],h.typedArray[e+2],h.typedArray[e+1],h.typedArray[e+3]]);g.push(t)}h.release();a.release();o.release();return g}return super.getMapBounds(e)}destroyMap(){super.destroyMap();this._webGLContextListener?.remove()}reboot(){if(this.webGLContext&&this.webGLContext.isContextLost()){if(this.mapNavigator instanceof PhotonMapNavigator)this.mapNavigator.preReboot(this);this.viewPaintingStrategy.reboot();if(this.mapNavigator instanceof PhotonMapNavigator)this.mapNavigator.postReboot(this);if(this.controller)this.controller.invalidate();this.invalidate()}}enableLayerClipping(e,t,i,n){if(this.viewPaintingStrategy)this.viewPaintingStrategy.enableLayerClipping(e,t,i,n)}disableLayerClipping(){if(this.viewPaintingStrategy)this.viewPaintingStrategy.disableLayerClipping()}enableLayerFlickering(e){if(this.viewPaintingStrategy)this.viewPaintingStrategy.enableLayerFlickering(e)}firePostRenderEvent(e){this._webGLMapEventedSupport?.emit("PostRender",e)}on(e,t,i){if("idle"===e)return super.on(e,t,i);if("SelectionChanged"===e)return super.on(e,t,i);if("HoverChanged"===e)return super.on(e,t,i);if("MapChange"===e)return super.on(e,t,i);if("ShowBalloon"===e)return super.on(e,t,i);if("HideBalloon"===e)return super.on(e,t,i);if("ControllerChanged"===e)return super.on(e,t,i);if("DefaultControllerChanged"===e)return super.on(e,t,i);if("DisplayScaleChanged"===e)return super.on(e,t,i);if("AutoAdjustDisplayScaleChanged"===e)return super.on(e,t,i);return this._webGLMapEventedSupport.on(e,t,i)}}