import{Photon}from"../../../gen/photon/photon_painter.js";import{GLTFDecoderDelegate}from"../../../geometry/mesh/GLTFDecoderDelegate.js";import{createGLTFBufferLoader}from"../../../geometry/mesh/GLTFBufferLoader.js";import{PhotonReferenceFactory}from"../../../reference/photon/PhotonReferenceFactory.js";import{addHttpRequestOptions}from"../../../util/HttpRequestOptions.js";import{Log}from"../../../util/Log.js";import{request,urlWithParams}from"../../../util/request.js";import{PhotonImageDecoder}from"../../../view/photon/image/PhotonImageDecoder.js";import{PhotonTileDiscretizer}from"../../../view/photon/terrain/PhotonTileDiscretizer.js";import{decodeTerrainMeshes}from"../../gee/GEETerrainDecoder.js";import{URL as RIAUrl}from"../../../util/URL.js";import{releaseObject}from"../../../util/ObjectReleaseTracker.js";import{parse}from"../../../util/JSON.js";self.onerror=function(e){self.postMessage({type:"fatalError",error:"string"===typeof e?e:e.message})};let workerStart=performance.now();let workerEnd=workerStart;let photonReady=false;var imageDecoder=new PhotonImageDecoder(Photon);var tileDiscretizer=new PhotonTileDiscretizer(Photon,imageDecoder);var referenceFactory=new PhotonReferenceFactory(Photon);const getOgc3DTilesDataParser=(()=>{var e=null;return function r(){if(!e)e=Photon.Ogc3DTilesDataParser.create();return e}})();function reply(e,r,t){postMessage({type:"result",id:e,data:r},t)}function fail(e,r){var t=r.message||r;Log.error("WebWorker failed: "+t+" for "+e);postMessage({type:"error",id:e,error:t})}function parse3DTileData(e,r,t,a){const o=getOgc3DTilesDataParser();var s={type:"error",error:"Error while decoding 3D tile."};var n;var i;try{var l=e;n=Photon.BufferFactory.createUint8BufferFromData(new Uint8Array(l));var f=o.canDecode(n,t);if(!f)s={type:"unknown",arrayBuffer:l};else{i=o.decode(n,r,t,a);var c;s={type:1===f?"data":"metadata",arrayBuffer:new Uint8Array(i.typedArray).buffer}}}finally{if(n)n.release();if(i)i.release()}return s}self.onmessage=function(e){var r=e.data;var t=r.type;var a=r.id;var o=r.data?.command;var s=r.data?.data;try{if("photonWasmModule"===t){Photon.lcdBootFromModule(e.data.photonModule).catch((e=>fail(a,e)));return}if("run"!==t){fail(a,"Unknown command "+t);return}if(!photonReady)fail(a,"WebWorker command received before Photon is ready");if("getStatistics"===o)reply(a,{...parse(Photon.StatisticsTracker.getStatisticsAsJSON(s.filter)),"luciad.timings.worker":workerEnd-workerStart});else if("parse3DTilesProperties"===o){let e,t,o,n,i;try{t=Photon.Ogc3DTilesDataParser.create();e=Photon.BufferFactory.createUint8BufferFromData(new Uint8Array(s));o=r.data?.requestUrl;n=r.data?.requestOptions;const l=o.substr(0,o.lastIndexOf("/"));i=createGLTFBufferLoader(Photon,l,n);reply(a,t.getBatchProperties(e,i,o),[])}finally{releaseObject(e);releaseObject(t)}}else if("decodeImage"===o){var n=imageDecoder._createBufferFromEncodedData(s.data,s.contentType);reply(a,n,[n.data])}else if("decodeImageAndDiscretizeTile"===o){var i=referenceFactory.getReference(s.sourceReference);var l=referenceFactory.getReference(s.destinationReference);var f=tileDiscretizer.createTileGeometry(s.data,s.contentType,i,l,s.tileBounds,s.tileDiscretizationParameters,s.isTopTile,s.isBottomTile,s.tileLevel);i.release();l.release();reply(a,f,[f.positionData,f.geocentricNormalData,f.elevationData,f.normalData,f.uvData,f.discardedTrianglesData])}else if("decodeGLTF"===o){let e;if(s.urlParams)e={...RIAUrl.parseQueryString(s.urlParams),...s.requestParameters};const r=e?urlWithParams(s.meshUrl,e):s.meshUrl;const t=addHttpRequestOptions({},{credentials:s.credentials,requestHeaders:s.requestHeaders});const o=s?.legacyAxis;var c;var d;request(r,t).then((e=>e.arrayBuffer())).then((function(e){if(!(c=Photon.BufferFactory.createUint8BufferFromData(new Uint8Array(e))))fail(a,"Could not find file requested : "+s.meshUrl);const r=s.meshUrl.substr(0,s.meshUrl.lastIndexOf("/"));if(!(d=new GLTFDecoderDelegate(Photon,s.protocol).decode(c,r,{credentials:s.credentials,requestHeaders:s.requestHeaders},o))||0==d.typedArray.length)fail(a,"Could not decode Gltf file");var t=new Uint8Array(d.typedArray).buffer;reply(a,p={arrayBuffer:t},p.arrayBuffer?[p.arrayBuffer]:[])})).catch((function(e){fail(a,e)})).finally((function(){if(c)c.release();if(d)d.release()}))}else if("decodeGEETerrain"===o){var u=decodeTerrainMeshes(s);reply(a,u,[])}else if("xhrAndParse3DTileData"===o){const e=addHttpRequestOptions({},{credentials:s.credentials,requestHeaders:s.requestHeaders});request(s.url,e).then((e=>e.arrayBuffer())).then((function(e){const r=s.url.substr(0,s.url.lastIndexOf("/"));const t=createGLTFBufferLoader(Photon,r,{credentials:s.credentials,requestHeaders:s.requestHeaders});var o=parse3DTileData(e,t,s.url,s.options);t.release();reply(a,o,o.arrayBuffer?[o.arrayBuffer]:[])})).catch((function(e){fail(a,e)}))}else if("parse3DTileData"===o){const e=s.url.substr(0,s.url.lastIndexOf("/"));const r=createGLTFBufferLoader(Photon,e,{credentials:s.credentials,requestHeaders:s.requestHeaders});var p=parse3DTileData(s,r,s.url,s.options);r.release();reply(a,p,p.arrayBuffer?[p.arrayBuffer]:[])}else fail(a,"Unknown command "+o)}catch(e){fail(a,e)}};Photon.onReady((()=>{photonReady=true;workerEnd=performance.now();self.postMessage({type:"init"})}));