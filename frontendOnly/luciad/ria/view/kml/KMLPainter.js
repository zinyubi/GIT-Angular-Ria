import{isKMLFeature}from"../../model/kml/KMLFeature.js";import{isKMLGroundOverlayFeature}from"../../model/kml/KMLGroundOverlayFeature.js";import{KMLPlacemarkFeature}from"../../model/kml/KMLPlacemarkFeature.js";import{ShapeType}from"../../shape/ShapeType.js";import{KMLAltitudeMode}from"../../util/kml/KMLAltitudeMode.js";import{KMLColorMode}from"../../util/kml/KMLColor.js";import{KMLUnits}from"../../util/kml/KMLXYVector.js";import{URL}from"../../util/URL.js";import{BasicFeaturePainter}from"../feature/BasicFeaturePainter.js";import{FeaturePainter}from"../feature/FeaturePainter.js";import{PointLabelPosition}from"../style/PointLabelPosition.js";import{KMLColorStyle}from"./KMLStyle.js";import{isShapeList}from"../../shape/ShapeList.js";import{isExtrudedShape}from"../../shape/ExtrudedShape.js";import{isPoint}from"../../shape/Point.js";import{isPolyline}from"../../shape/Polyline.js";import{isPolygon}from"../../shape/Polygon.js";import{isComplexPolygon}from"../../shape/ComplexPolygon.js";import{DrapeTarget}from"../style/DrapeTarget.js";export class KMLPainter extends FeaturePainter{constructor(){super();this._fallbackPainter=null}paintBody(e,t,o,r,i,n){if(!isKMLFeature(t))return this.fallbackPainter.paintBody(e,t,o,r,i,n);if(!t.properties?.visibility)return;if(isKMLGroundOverlayFeature(t))return;const a=r.drapeTarget??DrapeTarget.TERRAIN;const l=this.getPlacemarkIconStyle(t,n);const s=this.getPlacemarkShapeStyle(t,n);const c=t=>{if(isShapeList(t)){for(let e=0,o=t.shapeCount;e<o;++e)c(t.getShape(e));return}if(isPoint(t)&&l){l.drapeTarget=computeDrapeTarget(o,t,a);e.drawIcon(t,l);return}if(s){const{fill:r,stroke:i}=s;if(isExtrudedShape(t)){s.drapeTarget=DrapeTarget.NOT_DRAPED;e.drawShape(t,s)}else if(i&&isPolyline(t)||(i||r)&&(isPolygon(t)||isComplexPolygon(t))){s.drapeTarget=s.drapeTarget??computeDrapeTarget(o,t,a);e.drawShape(t,s)}}};c(o);drawMeshes(e,t).forEach(c)}paintLabel(e,t,o,r,i,n){if(!isKMLFeature(t))return this.fallbackPainter.paintLabel?.call(this.fallbackPainter,e,t,o,r,i,n);const{name:a,visibility:l}=t.properties;if(!a||!l)return;const s=findShape(o,ShapeType.POINT);if(0===s.length)return;const c=t.getStyle(n.selected);const u=KMLColorStyle.getRawColor(c.labelStyle).opacity;const p=getLabelColor(t,c);const f=c.labelStyle.scale;if(0===f||0===u)return;const d=`<div style="opacity:${u};color:${p};font-size:${f}${"em"};text-shadow: 0 0 5px rgb(0, 0, 0)">${a}</div>`;for(const t of s)e.drawLabel(d,t,{positions:PointLabelPosition.ANY})}getPlacemarkShapeStyle(e,t){if(e instanceof KMLPlacemarkFeature){const o=e.getStyle(t.selected||t.hovered);return createShapeStyle(e,o)}return null}getPlacemarkIconStyle(e,t){if(e instanceof KMLPlacemarkFeature){const o=e.getStyle(t.selected||t.hovered);return createIconStyle(e,o)}return null}get fallbackPainter(){if(!this._fallbackPainter)this._fallbackPainter=new BasicFeaturePainter;return this._fallbackPainter}}export function drawMeshes(e,t){if(!(t instanceof KMLPlacemarkFeature))return t.shape?[t.shape]:[];return t.meshes.reduce(((t,o)=>{if(!o.mesh){t.push(o.location);return t}const{location:r,mesh:i,orientation:n,scale:a}=o;e.drawIcon3D(r,{mesh:i,orientation:n,scale:a});return t}),[])}const getPolyColor=getComputedColor.bind(null,"polyStyle",false);const getLabelColor=getComputedColor.bind(null,"labelStyle",true);const getLineColor=getComputedColor.bind(null,"lineStyle",false);function getComputedColor(e,t,{randomColors:o},r){const{color:i,colorMode:n}=r[e];if(n!==KMLColorMode.RANDOM)return i;const a=o[e];if(i===a?.base)return a.override;const l=KMLColorStyle.getRawColor(r[e]).random()[t?"rgb":"rgba"];o[e]={base:i,override:l};return l}function findShape(e,t){if(e.type===t)return[e];const o=[];if(isShapeList(e))for(let r=0,i=e.shapeCount;r<i;++r){const i=e.getShape(r);if(i.type===t)o.push(i);else if(i.type===ShapeType.SHAPE_LIST)o.push(...findShape(i,t))}return o}function getAxisPositionProperties(e,t){if(t===KMLUnits.FRACTION)return{fraction:e,pixels:0};if(t===KMLUnits.PIXELS)return{fraction:0,pixels:e};if(t===KMLUnits.INSET_PIXELS)return{fraction:1,pixels:-e};return{fraction:.5,pixels:0}}class AxisPosition{constructor(e,t){const{fraction:o,pixels:r}=getAxisPositionProperties(e,t);this._fraction=o;this._pixels=r}get anchor(){return 0===this._fraction?`${this._pixels}px`:`${100*this._fraction}%`}get offset(){return 0===this._fraction?0:this._pixels}invert(){this._fraction=1-this._fraction;this._pixels*=-1;return this}}function computeDrapeTarget(e,t,o){const r=e.altitudeMode||t.altitudeMode;if(!r)return DrapeTarget.NOT_DRAPED;if(r===KMLAltitudeMode.RELATIVE_TO_GROUND&&t.bounds&&0===t.bounds.z&&0===t.bounds.depth)return o;return r===KMLAltitudeMode.CLAMP_TO_GROUND?o:DrapeTarget.NOT_DRAPED}function createIconStyle(e,t){const{heading:o,hotSpot:r,icon:i,scale:n}=t.iconStyle;if(!e.shape)return null;const{isTransparent:a}=KMLColorStyle.getRawColor(t.iconStyle);if(a||0===n){const{labelStyle:o}=t;const r=undefined;return e.properties.name&&o.scale>0&&!KMLColorStyle.getRawColor(o).isTransparent?{url:DUMMY_ICON}:null}const l=i?.href??null;if(i&&null===l)return null;const{anchor:s,offset:c}=new AxisPosition(r.x,r.xUnits);const{anchor:u,offset:p}=new AxisPosition(r.y,r.yUnits).invert();const f=l??DEFAULT_ICON;const d=i?.image;const A={zOrder:20,rotation:-o,anchorX:s,offsetX:c,anchorY:u,offsetY:p,...getImageSizes(n,d)};const h=d?{image:d,...A}:{url:f,...A};const m=KMLColorStyle.getRawColor(t.iconStyle);if(shouldMultiplyColor(m))h.modulationColor=m.rgba;return h}function shouldMultiplyColor(e){return 1!==e.r||1!==e.g||1!==e.b||1!==e.a}function getImageSizes(e,t){const o=32;const r=t?t.width/t.height:1;const i=undefined;const n=undefined;return{width:`${Math.round(e*r*o)}px`,height:`${Math.round(e*o)}px`}}function createShapeStyle(e,t){const o=undefined;const r=undefined;return{stroke:t.polyStyle.outline&&t.lineStyle.width>0?{width:t.lineStyle.width,color:getLineColor(e,t)}:void 0,fill:t.polyStyle.fill?{color:getPolyColor(e,t)}:void 0,zOrder:e.zOrder}}const DUMMY_ICON=URL.fromData("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=");const DEFAULT_ICON=URL.fromData("iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAAK/INwWK6QAAABh0RVh0U29mdHd"+"hcmUAUGFpbnQuTkVUIHYzLjM2qefiJQAABBxJREFUWEfFVm1IVFkYfu85517TZm2V6kcfoCuEBf2SoCKUSleiqSF2C4L+tFBE9GsZKAj2"+"z247UBZG9kPaMI3YPuiDivJH4ro1lGuY1Ew1o02OtE421do0as44vnvee72rpNNcGXUHXu69c9/7vM953nOecxSY3C9z7lxxavVqZVUig"+"UPBIOvx+dATjyf+ABi+J6G6Jwc36Wxlk8ulIiKMhILhMMdbt1Tcu1cbXLpUvQvA90jY3ElDW/tA+fb0aY43bgD29JgkRq+JBMOmJoE7dm"+"gRm42flJjfWMO1nvV1SYn6T2+vopO4ehWws3M8EVKos5Phvn1qP2P8ZwmvWS+RMpNt3L1bG+jqAnzxAvD6dcCqKsAHDwAjkfFk7t8XuGi"+"RaJSwGSmhLSZk79rFI8+fAzY0AD57ZrSjuRnw4kXAM2cA6+sBPR7AYBCQiB45koESe4NF/FRpypYrV7he9OlTwDt3AG/fBmxpASRS4TCg"+"z2coQtHczHD5cvG3RJ2TCtnS+6wsURuNMmxvNwr6/UYrWlsNRWhuNDUB1tUJdDpVzM8Xf0ngQkvgFpKEw8FDfX2G9ERgbNDIAwHAUEjBB"+"QuYe6Qws4BrOWXV8eNCl3kiAiaZS5eY7Dn7wTKq9UT+S1cX0yX/fPTm8+vXgHa76Juyno8lt2IFbx0c/PLo/X6GmZn8gvVBpc6UbiZ+Xb"+"ZM1FdVqYn375MT6OgArKjgUn6lPDWshQw5EpfTqX16+VJgPM7w40fD+ZL1/80bwJUrxSsJLSzAfzmFc1bR0MD/23iiUUDqL830ZP1vaaH"+"Jxw+lXVxKWHr48Nhdz7BYcjYyHFr7n5Og5XfsmEry70+bQHb2rN9jMTFm2x31eJoDZLNPngB6vYYiROjhQ8N2XS5BJNKz3cJCrRFRmZCA"+"eRbo7zdsl1Sh0b99O3pGWLeOB9OcB8LpdquYSAAOD0+83Y4eSsa/r63VV0JpOq2YvWQJf0ymQyOj6O0F/PABkGx4YACQ/CAeBxwaMq6xG"+"CCp8u4dYFubQk74UzoE6NvFeXnC19jIdZnNSWcuQbP3tCmZK4PeUbjduhX/mC4B+j47I4PXHTyoShJMn2TJlqD5P5E5d44IgH0qCIxgKG"+"sWLlT/PHBgduzRo3lytzM8gZyPClKQEt3dNCE5ysNpu/zQNoUEdChRWmoPtbUFsKhoTnjrVq3/6FENz57leO0awxMnBO7cqQ3Nn6/elLn"+"5U12c8NZXVlZiTU0NybtNRo6MEtnrzTK2y/syGXnTUVjHtNlsv3m9XnQ4HFH5+NW0FUoCrJaVlYX8fj/m5uZenuniVG8tyV9dXU3yfzfj"+"BKT8Jz0ejzzp2COyeNaMEyguLu4IBAKYk5NzfsaLU8GCggJPeXn5gLwt+l8IyKKVMr6fjuL/AgrpMNw8qqUJAAAAAElFTkSuQmCC");