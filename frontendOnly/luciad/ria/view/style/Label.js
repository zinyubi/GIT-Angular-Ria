import{getPinEndPositionHugBorderNoRotationSFCT,getPinEndPositionMiddleNoRotationSFCT,pinPointMiddleOfBoundsOnEdgeUnrotatedSFCT}from"./pin/PinUtil.js";import{PinEndPosition}from"./PinEndPosition.js";import{Constants}from"../../util/Constants.js";import{isDefined,isNumber,isString}from"../../util/Lang.js";import{CSSProps}from"../../util/CSSProps.js";import{toPolar}from"../../util/Cartesian.js";const TRANSFORM=CSSProps.transform;const TRANSFORM_ORIGIN=CSSProps.transformOrigin;export class Label{_positionDirty=true;_positionX=0;_positionY=0;_pinLength=0;_pinAngle=0;_pinDirty=false;_pinConnectorX=0;_pinConnectorY=0;_scratch={r:0,a:0,x:0,y:0,intersects:false,success:false};constructor(i,t,n,s){const o=document.createElement("div");o.style.position="absolute";o.style.width=`${t}px`;o.style.height=`${n}px`;o.style[TRANSFORM_ORIGIN]="top left";if(isString(i))o.innerHTML=i;else o.appendChild(i);this.div=o;this._rotationDirty=true;this._rotation=0;this._withPin=false;this._topOffset=0;if(isDefined(s)){const{endPosition:i,width:t,haloWidth:n,haloColor:e,color:l}=s;const h=document.createElement("div");h.style[TRANSFORM_ORIGIN]="top left";const r=h.style;r.backgroundColor=l;r.position="absolute";r.top=`${0}px`;r.left=`${0}px`;r.height=`${t}px`;if(n>0)r.border=`${n}px solid ${e}`;const p=document.createElement("div");p.style.position="absolute";p.style.zIndex="-1";p.appendChild(h);this._topOffset=(t+(n||0))/2;this._positionDirty=true;this._pinDirty=true;this._pinInfo={pinConnectDiv:p,pinDiv:h,isPinVisible:true,funcPinEnd:i===PinEndPosition.MIDDLE?getPinEndPositionMiddleNoRotationSFCT:i===PinEndPosition.MIDDLE_BORDER?pinPointMiddleOfBoundsOnEdgeUnrotatedSFCT:getPinEndPositionHugBorderNoRotationSFCT};this.placePinInside(o);this._withPin=true}}removeAndDestroy(i){if(this.div){try{i.removeChild(this.div)}catch(i){}this.div.innerHTML="";this.div=null}}placeLabelIn(i){if(this.div)i.appendChild(this.div)}changePosition(i,t,n,s,o,e,l,h){if(!this.div)return;const r=this.div.style;this._positionDirty=this._positionDirty||this._positionX!==i||this._positionY!==t;if(this._positionDirty){r.left=toPixelStyleValue(i);r.top=toPixelStyleValue(t);this._positionDirty=false;this._positionX=i;this._positionY=t}this._rotationDirty=this._rotationDirty||this._rotation!==n;if(this._rotationDirty){r[TRANSFORM]=toRotateStyleValue(n);this._rotationDirty=false;this._rotation=n}if(isNumber(h))r.zIndex=`${h}`;if(this._withPin&&0===n)this.changePinPosition(i,t,s,o,e,l)}placePinInside(i){if(this._pinInfo)i.appendChild(this._pinInfo.pinConnectDiv)}changePinPosition(i,t,n,s,o,e){if(!this._pinInfo)return;this._pinInfo.funcPinEnd(o,e,i,t,n,s,this._scratch);const l=this._scratch.success;if(!l){this._pinInfo.isPinVisible=false;this._pinInfo.pinConnectDiv.style.visibility="hidden";return}if(!this._pinInfo.isPinVisible&&l){this._pinInfo.isPinVisible=true;this._pinInfo.pinConnectDiv.style.visibility="visible"}const h=this._scratch.x-i;const r=this._scratch.y-t;this._pinDirty=this._pinDirty||this._pinConnectorX!==h||this._pinConnectorY!==r;if(this._pinDirty){const i=this._pinInfo.pinConnectDiv.style;i.left=toPixelStyleValue(h);i.top=toPixelStyleValue(r);this._pinConnectorX=h;this._pinConnectorY=r;this._pinDirty=false}const p=o-this._scratch.x;const a=e-this._scratch.y;toPolar(p,a,this._scratch);const _=this._topOffset;this._positionDirty=this._positionDirty||this._pinLength!==this._scratch.r||this._pinAngle!==this._scratch.a;if(this._positionDirty){this._pinLength=this._scratch.r;this._pinAngle=this._scratch.a;this._pinInfo.pinDiv.style.width=toPixelStyleValue(this._pinLength);this._pinInfo.pinDiv.style[TRANSFORM]=toRotateStyleValue(this._pinAngle*Constants.RAD2DEG);if(p<=0&&a<=0){this._pinInfo.pinDiv.style.top=toPixelStyleValue(_);this._pinInfo.pinDiv.style.left=toPixelStyleValue(-_)}else if(p<=0&&a>0)this._pinInfo.pinDiv.style.top=toPixelStyleValue(_);else if(p>0&&a>0)this._pinInfo.pinDiv.style.top=toPixelStyleValue(-_);else if(p>0&&a<=0){this._pinInfo.pinDiv.style.top=toPixelStyleValue(-_);this._pinInfo.pinDiv.style.left=toPixelStyleValue(-_)}this._positionDirty=false}}}const toRotateStyleValue=i=>0!==i?`rotate(${i.toFixed(1)}deg)`:"";const toPixelStyleValue=(i,t=2)=>`${i.toFixed(t)}px`;