import{Constants}from"../../util/Constants.js";import{isNumber,isString}from"../../util/Lang.js";import{RotatedBox}from"../../util/RotatedBox.js";import{createFontMetrics,getFontScale}from"./FontMetrics.js";import{StyleUtil}from"./StyleUtil.js";import{isWorldSize}from"../../uom/UnitOfMeasureUtil.js";const WORLD_SIZED_TEXT_ICON_HEIGHT=100;function calculatePadding(t){const e=t.stroke&&t.strokeWidth?t.strokeWidth>>1:0;const n=t.halo&&t.haloWidth?t.haloWidth>>1:0;return e>n?e:n}function calculateBounds(t,e,n,l){const o=createFontMetrics(e.font);const i=n?calculatePadding(e):0;let s=e.textAnchor;let a=0;let r=0;const c=StyleUtil.parsePercentage(s);if(null!==c)s="left";let f=e.alignmentBaseline;const d=StyleUtil.parsePercentage(f);if(null!==d)f="top";const h=o.measureText(t,s,f);const u=h.bounds;if(i>0){u[0]-=i;u[1]-=i;u[2]+=i;u[3]+=i;if(h.linesOfText>1)u[3]+=(h.linesOfText-1)*i}let g=(u[2]-u[0])/2;let x=(u[3]-u[1])/2;if(null!==c){const t=u[2]-u[0];u[2]=t;u[0]=0;a=-c/100*t;g=0}if(null!==d){const t=u[3]-u[1];u[3]=t;u[1]=0;r=-d/100*t;x=0}u[0]+=a;u[1]+=r;u[2]+=a;u[3]+=r;if(l&&isNumber(e.angle)&&0!==e.angle){const t=new RotatedBox;t.configure(u[0],u[1],u[2]-u[0],u[3]-u[1],e.angle*Constants.DEG2RAD,g,x);u[0]=t.getMinX();u[1]=t.getMinY();u[2]=t.getMaxX();u[3]=t.getMaxY()}return u}function rasterizeText(t,e,n,l,o){const i=t[3]-t[1];const s=t[2]-t[0];const a=calculatePadding(l);const r=s-2*a;const c=document.createElement("canvas");let f=1;if(isWorldSize(l.uom)){c.height=WORLD_SIZED_TEXT_ICON_HEIGHT;const t=s/i;c.width=c.height*t;f=c.height/i}else{c.height=i*o;c.width=s*o;c.style.width=i+"px";c.style.height=s+"px";f=o}const d=a;let h=a;const u=StyleUtil.parsePercentage(l.textAnchor);if(null!==u)h=a+u/100*r;else if("right"===l.textAnchor||"end"===l.textAnchor)h=s-a;else if("left"===l.textAnchor||"start"===l.textAnchor)h=a;else if("center"===l.textAnchor)h=a+r/2;const g=undefined;drawText(c.getContext("2d",{willReadFrequently:true}),e,h*f,d*f,n,l,f,"top");return c}function drawText(t,e,n,l,o,i,s,a){const r=0!==o;n+=i.offsetX*s;l+=i.offsetY*s;const{fontScale:c,scaledFont:f}=getFontScale(i.font);if(1!==c){(i={...i}).font=f;i.haloWidth*=c;i.strokeWidth*=c}const d=calculatePadding(i);t.font=i.font;if(r||1!==s){t.save();t.translate(n,l);if(1!==s)t.scale(s,s);if(r)t.rotate(o*Constants.DEG2RAD);n=0;l=0}const h=createFontMetrics(i.font);const u=h.measureText(e,"left","top").bounds;const g=u[2]-u[0];const x=u[3]-u[1];const T=StyleUtil.parsePercentage(i.textAnchor);const S=StyleUtil.parsePercentage(i.alignmentBaseline);let m=0;let p=0;if(null!==T){t.textAlign="left";m+=-T/100*g}else t.textAlign=i.textAnchor;if(a)t.textBaseline=a;else if(null!==S){t.textBaseline="top";p+=-S/100*x}else t.textBaseline=i.alignmentBaseline;n+=m;l+=p;const W=isString(e)?e.split("\n"):e?[e]:[];const k=W.length>1?d:0;const A=h.lineHeight+k;if(1!==c){t.save();t.scale(1/c,1/c)}if(i.halo&&i.haloWidth>0){t.lineJoin="round";t.lineWidth=i.haloWidth;t.strokeStyle=i.halo;for(let e=0;e<W.length;e++)t.strokeText(W[e],n,l+e*A)}if(i.fill){t.fillStyle=i.fill;for(let e=0;e<W.length;e++)t.fillText(W[e],n,l+e*A)}if(i.stroke&&i.strokeWidth>0){t.lineWidth=i.strokeWidth;t.strokeStyle=i.stroke;for(let e=0;e<W.length;e++)t.strokeText(W[e],n,l+e*A)}if(1!==c)t.restore();if(r||1!==s)t.restore()}function drawTextAnchoredTopLeft(t,e,n,l,o,i,s){const{fontScale:a,scaledFont:r}=getFontScale(i.font);if(1!==a){(i={...i}).font=r;i.haloWidth*=a;i.strokeWidth*=a}t.font=i.font;t.textAlign="left";t.textBaseline="top";t.save();t.translate(n,l);t.rotate(o*Constants.DEG2RAD);t.scale(s,s);if(1!==a){t.save();t.scale(1/a,1/a)}const c=undefined;n=0;l=calculatePadding(i);if(i.halo){t.lineWidth=i.haloWidth;t.strokeStyle=i.halo;t.strokeText(e,n,l)}if(i.fill){t.fillStyle=i.fill;t.fillText(e,n,l)}if(i.stroke){t.lineWidth=i.strokeWidth;t.strokeStyle=i.stroke;t.strokeText(e,n,l)}if(1!==a)t.restore();t.restore()}function createCanvas(t,e,n){const l=undefined;return rasterizeText(calculateBounds(t,e,true,false),t,e.angle,e,n)}export const HTML5TextUtil={drawText:drawText,calculateBounds:calculateBounds,createCanvas:createCanvas,drawTextAnchoredTopLeft:drawTextAnchoredTopLeft,calculatePadding:calculatePadding};