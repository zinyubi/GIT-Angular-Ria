import{PatternType}from"./pattern/util/PatternType.js";import{advanceWithLimit,drawFlexibleStyleLine,drawSimpleLine,drawStyledLine,handleClipLimits,findStrokedPattern,PIXEL_EPSILON}from"./pattern/util/PatternUtil.js";import{Serializable}from"./pattern/util/Serializable.js";import{ProgrammingError}from"../../../error/ProgrammingError.js";export class Pattern{_fallbackPattern=null;_atomic=false;_flexible=false;_canBend=false;constructor(t,e){this._patternType=t;this._errorTolerance=e??5}get patternType(){return this._patternType}get errorTolerance(){return this._errorTolerance}get atomic(){return this._atomic}set atomic(t){this._atomic=t}get flexible(){return this._flexible}set flexible(t){this._flexible=t}get canBend(){return this._canBend}set canBend(t){this._canBend=t}get lineJoin(){return null}set lineJoin(t){}setFallbackPattern(t){this._fallbackPattern=this!==t?t:null}getMinHeight(){return 0}getMaxHeight(){return 0}getWidth(t){return 0}isRelativeLength(){return false}resolveState(){return null}paint(t,e,r,i){throw new ProgrammingError(`paint should be implemented for patterns of type ${this.patternType}.`)}paintFlexible(t,e,r){throw new ProgrammingError(`paintFlexible should be implemented for patterns of type ${this.patternType}.`)}appendHash(t){throw new ProgrammingError(`appendHash should be implemented for patterns of type ${this.patternType}.`)}simpleStroke(t){const e=findStrokedPattern(this._fallbackPattern??this);if(e&&e.lineColor){t.save();t.lineWidth=e.lineWidth||1;t.strokeStyle=e.lineColor;t.stroke();t.restore()}}paintForward(t,e,r,i){t.save();t.translate(e.x(),e.y());t.rotate(r);t.translate(i,0);this.paint(t,e.totalLength(),r);t.restore()}paintBack(t,e,r){if(r<0){t.save();t.translate(e.x(),e.y());const i=e.angle();t.rotate(i);t.translate(r,0);this.paint(t,e.totalLength(),i);t.restore();e.advanceDistance(this.getWidth(e.totalLength())+r)}}paintSimple(t,e,r){const i=this.getWidth(e.totalLength());t.save();t.translate(e.x(),e.y());const a=e.angleToNext();t.rotate(a);handleClipLimits(t,e,i,r,[this.getMinHeight(),this.getMaxHeight()]);this.paint(t,e.totalLength(),a,i);t.restore();advanceWithLimit(e,i,r[1])}paintFlexibleWithClipLimits(t,e,r,i){t.save();t.translate(e.x(),e.y());const a=e.angleToNext();t.rotate(a);handleClipLimits(t,e,r,i,[this.getMinHeight(),this.getMaxHeight()]);this.paintFlexible(t,e,r);t.restore();advanceWithLimit(e,r,i[1])}paintShortcut(t,e,r){const i=this.getWidth(e.totalLength());t.save();t.translate(e.x(),e.y());const a=e.jumpAngle(i);t.rotate(a);handleClipLimits(t,e,i,r,[this.getMinHeight(),this.getMaxHeight()]);this.paint(t,e.totalLength(),a,i);t.restore();e.jumpDistance(i)}paintOnceOnLine(t,e,r){if(e.atEnd()||e.distanceFromStart()>=r[1])return false;const i=e.totalLength();const a=this.getWidth(i);if(this.canPaintFullPattern(e,a,r)){this.paintSimple(t,e,r);return true}const n=Math.min(e.distanceFromStart()+a,r[1]);if(this.canPaintOverCorner()){this.paintPartial(t,e,n,r);return true}if(this.canPaintShortcut(e,a,r)){this.paintShortcut(t,e,r);return true}this.drawFallback(t,e,n,r);return false}canPaintFullPattern(t,e,r){const i=Math.min(t.absoluteDistanceToNextVertex(),r[1]);const a=t.distanceFromStart()+e;if(a<=i+PIXEL_EPSILON)return true;if(this.isRelativeLength()&&!this.atomic)return a<=t.absoluteDistanceToNextVertex()+PIXEL_EPSILON;return false}canPaintShortcut(t,e,r){return t.distanceFromStart()+e<=r[1]+PIXEL_EPSILON&&t.jumpError(e)<=this._errorTolerance}canPaintOverCorner(){return!this.atomic&&this.canBend}canPaintOnce(t,e){if(t.atEnd())return false;if(this.canPaintOverCorner())return true;const r=t.totalLength();const i=this.getWidth(r);return this.canPaintFullPattern(t,i,e)||this.canPaintShortcut(t,i,e)}paintPartial(t,e,r,i){if(this.canBend)drawFlexibleStyleLine(e,t,this,r,i)}drawFallback(t,e,r,i){const a=e.distanceFromStart();if(r<a)return;if(this._fallbackPattern)drawStyledLine(e,t,this._fallbackPattern,r,i);else if(findStrokedPattern(this))drawSimpleLine(e,t,this,r,i);else e.advanceDistance(r-a)}serialize(){const t=Object.assign({},this);t._patternType=PatternType[this._patternType];delete t._fallbackPattern;delete t._errorTolerance;delete t._atomic;delete t._flexible;return Serializable.serialize(t)}}