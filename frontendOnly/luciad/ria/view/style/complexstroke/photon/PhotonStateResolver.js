import{PatternType}from"../pattern/util/PatternType.js";import{Hash}from"../../../../util/Hash.js";import{isPromise,whenInternal}from"../../../../util/PromiseUtil.js";import{PhotonNormalizedIconStyle}from"../../../feature/photon/command/PhotonNormalisedIconStyle.js";import{getIconStyleValuesInPx,normalizeIconStyle}from"../../StyleUtil.js";import{URL}from"../../../../util/URL.js";import{Ajax}from"../../../../util/Ajax.js";import{PHOTON_STATE_MAP}from"./PhotonStateContainer.js";import{isDefined}from"../../../../util/Lang.js";import{scaleIconDimension}from"../../util/IconUtil.js";export function resolvePhotonState(e,t,n,o){let r;let a=PHOTON_STATE_MAP.get(n);if(isDefined(a))r=a;else{r=new Map;PHOTON_STATE_MAP.set(n,r)}const s=n.decorations;const i=n.regular;const l=n.fallback;const c=[];if(s)for(let n=0;n<s.length;n++){const a=resolvePhotonStatePattern(e,t,r,s[n].pattern,o);if(a instanceof Promise)c.push(a)}if(i){const n=resolvePhotonStatePattern(e,t,r,i,o);if(n instanceof Promise)c.push(n)}if(l){const n=resolvePhotonStatePattern(e,t,r,l,o);if(n instanceof Promise)c.push(n)}if(c.length>=1)return Promise.all(c).then((()=>n));return n}function resolvePhotonStatePattern(e,t,n,o,r){switch(o.patternType){case PatternType.GAP:case PatternType.LINE:case PatternType.PARALLEL_LINE:case PatternType.RECTANGLE:case PatternType.TRIANGLE:case PatternType.POLYLINE:case PatternType.ARC:case PatternType.WAVE:return null;case PatternType.ICON:{const e=o;if(n.has(e))return n.get(e);const r=e.crudeIconPromise.then((n=>{e.setResolvedImage(n);return resolveIconStyle(t,new Hash,{image:n},false)})).then((t=>{n.set(e,t);return t}));n.set(e,r);return r}case PatternType.TEXT:{const e=o;if(n.has(e))return n.get(e);const a=t.getPhotonImage(e.getImageCanvas(r),true,false,false,false,false);n.set(e,{photonImage:a});return{photonImage:a}}case PatternType.COMBINE_WITH_FALLBACK:case PatternType.COMBINE_WITH_REGULAR:case PatternType.ATOMIC:case PatternType.ARROW:case PatternType.ALLOW_OVERLAP:case PatternType.REPEAT_COUNT:case PatternType.REPEAT_OVER_LENGTH:{const a=undefined;return resolvePhotonStatePattern(e,t,n,o.pattern,r)}case PatternType.APPEND:case PatternType.COMPOSE:{const a=o;let s=null;for(let o=0,i=a.patterns.length;o<i;o++){const i=resolvePhotonStatePattern(e,t,n,a.patterns[o],r);if(isPromise(i)){if(!s)s=[];s.push(i)}}return null!=s?Promise.all(s):null}}}const MAX_WIDTH=2046;const MAX_HEIGHT=510;export function resolveIconStyle(e,t,n,o,r,a,s=1){const i=n.hasOwnProperty("isWorldSized")?n:normalizeIconStyle(n);const l=i.image?n.image:n.url;const c="string"===typeof l&&!URL.isLocalURL(l);let P;if(Ajax.isSVGImage(l)&&(i.width||i.height)){P=e.getPhotonImage(l,true,o,c,i.credentials,a,scaleIconDimension(i.width,s),scaleIconDimension(i.height,s),MAX_WIDTH,r??MAX_HEIGHT);i.width=100/s+"%";i.height=100/s+"%"}else P=e.getPhotonImage(l,true,o,c,i.credentials,a,0,0,MAX_WIDTH,r??MAX_HEIGHT);return whenInternal(P,(e=>{const t=new PhotonNormalizedIconStyle(i);const n=getIconStyleValuesInPx(i.width,i.height,i.anchorX,i.anchorY,e.width,e.height);t.photonImage=e;t.anchorX=n.anchorX;t.anchorY=n.anchorY;t.width=n.width;t.height=n.height;return t}))}