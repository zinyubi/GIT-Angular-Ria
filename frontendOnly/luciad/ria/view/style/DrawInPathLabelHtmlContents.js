import{XYZPoint}from"../../shape/XYZPoint.js";import{XYZBounds}from"../../shape/XYZBounds.js";import{DrawBaseLabelHtmlContents}from"./DrawBaseLabelHtmlContents.js";import{INVALID_POSITION,LabelPositions}from"./LabelPositions.js";import{AnchorPoints}from"./AnchorPoints.js";import{drawNullCommand}from"./NullDrawCommand.js";import{INVALID_LAYER_CLIP}from"../LayerStyle.js";const anchorPoints=new AnchorPoints;const bodyViewBoundsSFCT=new XYZBounds(null);const labelBoundsSFCT=new XYZBounds(null);const ALLOWED_POSITIONS=[LabelPositions.POINT_C_SHIFT];export class DrawInPathLabelHtmlContents extends DrawBaseLabelHtmlContents{_anchor=null;_anchorDefault=null;_anchorView=new XYZPoint;constructor(t,n,i,o,s,e,r){super(i,n,t,o,s,r.padding,e);const h=t.map._isSoftwareMap();this._inView=h?r.inView:false;this._restrictToBounds=h?r.restrictToBounds:false}get anchor(){return this._anchor}requestToDrawLabel(t){this.clip=t??INVALID_LAYER_CLIP;this.group.addLabel(this)}placeHtml(t,n,i,o){if(!this.drawCommand||this.drawCommand===drawNullCommand)return false;this.zOrder=o;if(!this._anchor){this._anchor=this.getAnchor(n,this._inView);if(!this._anchor)return false}if(this._inView){if(!this.getAnchorInView(n))return false}else if(!this.getAnchorViewPoint(this._anchor))return false;const s=undefined;if(this.findLabelPosition(this._anchorView,INVALID_POSITION,i,ALLOWED_POSITIONS)!==INVALID_POSITION&&this.checkRestrictToBounds(this._anchorView,n)&&this.isValidLocation(this._anchor)){this.toScreen(t);return true}return false}checkRestrictToBounds(t,n){if(this._restrictToBounds)return this.isLabelInBodyBox(t,n);return true}getAnchor(t,n){anchorPoints.reset();anchorPoints.preferredCentroid=true;anchorPoints.inView=n;this.drawCommand?.mapAnchorPointsSFCT(t,anchorPoints,0);if(anchorPoints.anchorPointsLength>0){const[t,n,i]=anchorPoints.anchorPoints;return{x:t,y:n,z:i}}return null}isLabelInBodyBox(t,n){if(!this.drawCommand?.bounds)return true;try{n.mapToViewTransformation.transformBounds(this.drawCommand.bounds,bodyViewBoundsSFCT)}catch(t){return false}if(!this._halfWidth||!this._halfHeight)return false;labelBoundsSFCT.setTo2D(t.x-this._halfWidth,2*this._halfWidth,t.y-this._halfHeight,2*this._halfHeight);const i=bodyViewBoundsSFCT.contains2DBounds(labelBoundsSFCT);if(!i&&this._inView)this._anchor=null;return i}isWorldPointInView(t){if(!t||!this.getAnchorViewPoint(t))return false;return this.labelContext.isViewPointInView(this._anchorView)}getAnchorInView(t){if(!this._anchorDefault)this._anchorDefault=this.getAnchor(t,false);if(this._anchorDefault&&this.isWorldPointInView(this._anchorDefault)){this._anchor=copySimplePoint(this._anchorDefault);return true}if(this.isWorldPointInView(this._anchor))return true;this._anchor=this.getAnchor(t,true);return this.isWorldPointInView(this._anchor)}getAnchorViewPoint(t){return!!this.drawCommand?.viewPointSFCT(t,this._anchorView,this.labelContext.mapToViewTransformation)}resetLabelBounds(t,n){const{boundsWidth:i,ascent:o,descent:s,boundsX:e}=this.getBoundMetrics();const r=i;const h=t.x-(r>>1);const a=t.y-(o>>1);this.setLTRBAnchorAngleDeg(h,a,h+r,a+o+s,h-e,a+o,0,this._padding)}reuseStateFrom(t){if(this.drawCommand){const n=t.findLabelDrawCommand(this.drawCommand,DrawInPathLabelHtmlContents);if(n?.anchor)this._anchor=copySimplePoint(n.anchor)}}computeMetrics(){const{boundsWidth:t,boundsHeight:n}=this.computeMetricsBase(this._restrictToBounds);if(this._restrictToBounds){this._halfWidth=t/2;this._halfHeight=n/2}}toScreen(t){this.toScreenBase(t)}}function copySimplePoint({x:t,y:n,z:i}){return{x:t,y:n,z:i}}