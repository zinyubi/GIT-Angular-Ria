import{ObjectReleaseTracker}from"../../../util/ObjectReleaseTracker.js";import{ProgrammingError}from"../../../error/ProgrammingError.js";import{Photon}from"../../../gen/photon/photon_painter.js";import{PhotonWeakMap}from"./PhotonWeakMap.js";import{isPromise,whenInternal}from"../../../util/PromiseUtil.js";import{PhotonMeshVideoTexture}from"../../../geometry/mesh/PhotonMeshVideoTexture.js";function PhotonMeshProvider(e,o,r,t,n,a){this._meshCache=this.track(new PhotonWeakMap);this._shapePainter=e;this._imageProvider=o;this._gltfDecoder=r;this._photonGraphics=t;this._invalidator=n;this._videoTexturesCache=this.track(new PhotonWeakMap);this._map=a}PhotonMeshProvider.prototype=Object.create(ObjectReleaseTracker.prototype);PhotonMeshProvider.prototype.constructor=PhotonMeshProvider;PhotonMeshProvider.prototype.getPhotonMesh=function(e,o){var r=this;var t;if(e.id)t=e.id;else{const r=undefined;t=e+" "+(o?.legacyAxis??false)}var n=this._meshCache.get(t);if(n)if(isPromise(n))return whenInternal(n).then((function(t){if(r.isReleased())throw new ProgrammingError("Mesh request aborted");return r.getPhotonMesh(e,o)}));else return n;else if(e.id){var a=this._getMeshPtrOrPromise(r,e,t,o);r._meshCache.set(t,a);return a}else{var s=this._getGLTFMeshPromise(r,e,t,o);this._meshCache.set(t,s);return s}};PhotonMeshProvider.prototype.refreshVideoTexture=function(){this._videoTexturesCache._map.forEach((function(e,o,r){e.updateTexture()}))};PhotonMeshProvider.prototype._getMeshPtrOrPromise=function(e,o,r){var t=new ObjectReleaseTracker;var n=t.track(e._toPhotonPositions(o.positions));var a=t.track(e._toPhotonIndices(o.indices));var s=t.track(o.normals?e._toPhotonNormals(o.normals):e._toPhotonNormals([]));var h=Photon.PrimitiveType.Triangles;var i=t.track(o.colors?e._toPhotonColors(o.colors):e._toPhotonColors([]));var c=t.track(o.texCoords?e._toPhotonTextureCoordinates(o.texCoords):e._toPhotonTextureCoordinates([]));var P=t.track(o.images?o.images[0]:null);if(P)if(P instanceof HTMLVideoElement){const o=new PhotonMeshVideoTexture(P);const u=o.getFrameAsTexture(this._photonGraphics,e._invalidator);const f=e._shapePainter.createMesh(n,a,s,h,i,c,null,u);e._meshCache.set(r,f);this._videoTexturesCache.set(r,o);t.release();return f}else{var u=e._imageProvider.getPhotonImage(P,true,false,true,false);if(isPromise(u))return whenInternal(u).then((function(o){t.track(o);var P=e._shapePainter.createMesh(n,a,s,h,i,c,o);t.release();e._meshCache.set(r,P);return P}));else{t.track(u);var f=e._shapePainter.createMesh(n,a,s,h,i,c,u);t.release();e._meshCache.set(r,f);return f}}else{var f=this._shapePainter.createMesh(n,a,s,h,i,c,P);t.release();return f}};PhotonMeshProvider.prototype._getGLTFMeshPromise=function(e,o,r,t){var n=this._gltfDecoder.decode(o,t);var a;return whenInternal(n).then((function(o){var t=Photon.BufferFactory.createUint8BufferFromData(new Uint8Array(o.arrayBuffer));var n=e._shapePainter.createMeshFromSerializedMeshData(t);e._meshCache.set(r,n);t.release();return n}),(function(e){throw e}))};PhotonMeshProvider.prototype.meshHashCode=function(e,o){if(e.id)o.append("mesh-"+e.id);else o.appendString(e)};PhotonMeshProvider.prototype.clean=function(){const e=undefined;this._meshCache.purge().forEach((e=>{this._videoTexturesCache.remove(e)}))};PhotonMeshProvider.prototype._toPhotonPositions=function(e){return Photon.BufferFactory.createFloat64BufferFromData(new Float64Array(e))};PhotonMeshProvider.prototype._toPhotonIndices=function(e){return Photon.BufferFactory.createUint32BufferFromData(new Uint32Array(e))};PhotonMeshProvider.prototype._toPhotonNormals=function(e){return Photon.BufferFactory.createFloat32BufferFromData(new Float32Array(e))};PhotonMeshProvider.prototype._toPhotonColors=function(e){return Photon.BufferFactory.createFloat32BufferFromData(new Float32Array(e))};PhotonMeshProvider.prototype._toPhotonTextureCoordinates=function(e){return Photon.BufferFactory.createFloat32BufferFromData(new Float32Array(e))};export{PhotonMeshProvider};