import{Photon}from"../../../gen/photon/photon_painter.js";import{Shape}from"../../../shape/Shape.js";import{ObjectReleaseTracker}from"../../../util/ObjectReleaseTracker.js";import{GeoDiscretizerStatic}from"../../shape/discretization/GeoDiscretizerStatic.js";import{PenThreshold}from"../../shape/generalpath/PenThreshold.js";import{PhotonCommandUtil}from"./command/PhotonCommandUtil.js";const DEFAULT_PEN_THRESHOLD=new PenThreshold(5e4,5);function validateLines(e){if(e){const t=[];for(let r=0;r<e.length;r++)if(e[r].length/3>1)t.push(e[r]);return t}return null}function createGeometryArrays(e,t){if(!e)return{lineMesh:null,fillMesh:null};const r={lineMesh:null,fillMesh:null,fractions:e.fractions};const l=validateLines(e.lines);if(l&&l.length>0){let e;if(1===l.length)e=t.track(Photon.BufferFactory.createFloat64BufferFromData(l[0]));else{let r=0;for(let e=0;e<l.length;e++)r+=l[e].length;e=t.track(Photon.BufferFactory.createFloat64BufferFromLength(r));let n=0;for(let t=0;t<l.length;t++)for(let r=0;r<l[t].length;r++)e.typedArray[n++]=l[t][r]}const n=t.track(Photon.BufferFactory.createUint32BufferFromLength(2*l.length));let o=0;for(let e=0;e<l.length;e++){n.typedArray[2*e]=o;n.typedArray[2*e+1]=l[e].length/3;o+=l[e].length/3}r.lineMesh=t.track(Photon.Tessellator.wrapMesh(e,n))}if(e.fills&&e.canUseFillForStroke)r.fillMesh=r.lineMesh;else if(e.fills&&e.fills.length>0){let l;let n=0;if(1===e.fills.length&&1===e.fills[0].length)l=t.track(Photon.BufferFactory.createFloat64BufferFromData(e.fills[0][0]));else{for(let t=0;t<e.fills.length;t++)for(let r=0;r<e.fills[t].length;r++)n+=e.fills[t][r].length;l=t.track(Photon.BufferFactory.createFloat64BufferFromLength(n));let r=0;for(let t=0;t<e.fills.length;t++)for(let n=0;n<e.fills[t].length;n++)for(let o=0;o<e.fills[t][n].length;o++)l.typedArray[r++]=e.fills[t][n][o]}n=0;for(let t=0;t<e.fills.length;t++)n+=e.fills[t].length;const o=t.track(Photon.BufferFactory.createUint32BufferFromLength(2*n));let s=0;let i=0;for(let t=0;t<e.fills.length;t++)for(let r=0;r<e.fills[t].length;r++){o.typedArray[i]=s;o.typedArray[i+1]=e.fills[t][r].length/3;s+=e.fills[t][r].length/3;i+=2}r.fillMesh=t.track(Photon.Tessellator.wrapMesh(l,o))}return r}export class PhotonShapeDiscretizer{constructor(e,t){this._is3d=e;this._objectReleaseTracker=new ObjectReleaseTracker;this._tessellator=this._objectReleaseTracker.track(Photon.Tessellator.create());this._photonReferenceProvider=t}discretize(e,t,r,l,n){const o=e instanceof Shape?e.bounds:null;if(!o)return null;const s=new ObjectReleaseTracker;const i=this._is3d;const a=n.zToZero;const c=PhotonCommandUtil.hasAreaShape(e);console.assert(!n.addFractions);const h=undefined;const f=createGeometryArrays(GeoDiscretizerStatic.discretize(e,{modelReference:e.reference,worldReference:t,lineType:n.lineType,zToZero:n.zToZero,penThreshold:n.penThreshold||DEFAULT_PEN_THRESHOLD,noDiscretization:true===n.noDiscretization,normalizeOrientation:c&&n.normalizeOrientation}),s);const d=!a&&i&&PhotonCommandUtil.isExtrudedShape(e);const u=d?e.minimumHeight:0;const p=d?e.maximumHeight:0;let m;if(!l&&(!d||!i))m=f.lineMesh?Photon.Tessellator.wrapLineAndFillMesh(f.lineMesh,f.fillMesh):null;else{const e=s.track(this._photonReferenceProvider.getReference(t));const a=s.track(this._photonReferenceProvider.getReference(o.reference));const h=s.track(Photon.Tessellator.wrapLineAndFillMesh(f.lineMesh,f.fillMesh));const g=true===n.canUseEarcut;m=this._tessellator.tessellateLineAndFill(h,e,o,a,e,{needsLine:r,needsFill:l,is3d:i,isAreaShape:c,canUseEarcut:g,isExtruded:d,extrusionMinZ:u,extrusionMaxZ:p})}s.release();return m}static discretizeLine(e,t,r){const l=new ObjectReleaseTracker;const n=undefined;const o=createGeometryArrays(GeoDiscretizerStatic.discretize(e,{modelReference:e.reference,worldReference:t,lineType:r.lineType,zToZero:r.zToZero,penThreshold:r.penThreshold||DEFAULT_PEN_THRESHOLD,fraction:r.addFractions,noDiscretization:r.noDiscretization}),l);if(!o.lineMesh)return null;const s=o.lineMesh.copy();if(o.fractions)s.getFractions=function(){return o.fractions};l.release();return s}release(){this._objectReleaseTracker.release()}}