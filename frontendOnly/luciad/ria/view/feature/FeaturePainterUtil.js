import{CSSProps}from"../../util/CSSProps.js";import{isFunction,isString}from"../../util/Lang.js";import{mimeType}from"../../util/mimeType.js";import{isComplexStrokeStyle,normalizeIconStyle,normalizeShapeStyle,scaleValue}from"../style/StyleUtil.js";const SELECTION_STROKE_COLOR="rgb(255,140,0)";const SELECTION_FILL_COLOR="rgba(255,165,0,0.8)";const SELECTION_STROKE_WIDTH_SCALE_FACTOR=2;const SELECTION_ICON_SCALE_FACTOR=2;const SELECTION_TEXT_HALO_COLOR="rgb(255,140,0)";const HOVER_STROKE_COLOR="rgb(0,140,255)";const HOVER_FILL_COLOR="rgba(0,165,255,0.8)";const HOVER_STROKE_WIDTH_SCALE_FACTOR=1.5;const HOVER_ICON_SCALE_FACTOR=1.5;const HOVER_TEXT_HALO_COLOR="rgb(0,140,255)";let classCounter=0;let tmpNode;const haloCSS=[CSSProps.textShadowString+": 2px 2px 2px ",", 2px -2px 2px ",", -2px 2px 2px ",", -2px -2px 2px ",", 0px -2px 2px ",", -2px 0px 2px ",", 2px 0px 2px ",", 0px 2px 2px "," !important;"];function makeTSHalo(t){return haloCSS.join(t)}function initTempNode(){if(!tmpNode)tmpNode=document.createElement("div")}function getComplexStrokeMinMaxHeight(t){const{regular:e,fallback:o}=t;if(!e&&!o)return{min:-2,max:2};let a=Number.POSITIVE_INFINITY;if(e)a=Math.min(a,e.getMinHeight());if(o)a=Math.min(a,o.getMinHeight());let l=Number.NEGATIVE_INFINITY;if(e)l=Math.max(l,e.getMaxHeight());if(o)l=Math.max(l,o.getMaxHeight());return{min:a,max:l}}class GeoCanvasWrapper{constructor(t){this._fillColor=t.fillColor;this._strokeColor=t.strokeColor;this._strokeWidthScaleFactor=t.strokeWidthScaleFactor;this._iconScaleFactor=t.iconScaleFactor;this.geoCanvas=null}drawIcon(t,e){this.geoCanvas.drawIcon(t,this.makeIconStyleSelected(e))}drawShape(t,e){const o=this.makeShapeStyleSelected(e);for(const e of o)this.geoCanvas?.drawShape(t,e)}drawText(t,e,o){this.geoCanvas.drawText(t,e,this.makeTextStyleSelected(o))}makeIconStyleSelected(t){const e=normalizeIconStyle(t);if(e.isWorldSized){e.worldHeight*=this._iconScaleFactor;e.worldWidth*=this._iconScaleFactor}else{e.width=e.width?scaleValue(e.width,this._iconScaleFactor):100*this._iconScaleFactor+"%";e.height=e.height?scaleValue(e.height,this._iconScaleFactor):100*this._iconScaleFactor+"%"}return e}makeShapeStyleSelected(t){const e=normalizeShapeStyle(t);if(!e)return[];const o={};const a=e.stroke;const l=[o];if(isComplexStrokeStyle(a)){o.stroke=t.stroke;const{min:e,max:i}=getComplexStrokeMinMaxHeight(a);l.push({stroke:{width:this._strokeWidthScaleFactor*(i-e),color:this._strokeColor,uom:a.uom},zOrder:(o.zOrder??0)-1})}else if(a){const t=a.width;o.stroke={color:this._strokeColor,width:this._strokeWidthScaleFactor*(t>0?t:1),uom:a.uom??void 0}}if(e.fill)o.fill={color:this._fillColor};return l}makeTextStyleSelected(t){const e={...t};if(e.halo){e.halo=this._strokeColor;e.haloWidth=(e.haloWidth||1)*this._strokeWidthScaleFactor}else{e.stroke=e.stroke||this._strokeColor;e.strokeWidth=(e.strokeWidth||1)*this._strokeWidthScaleFactor}return e}}class LabelCanvasWrapper{constructor(t){const e=(t=t||{}).textHaloColor;const o=document.createElement("style");o.type=mimeType.css;const a="lcdLabel"+classCounter;classCounter+=1;const l=makeTSHalo(e);o.innerHTML=".luciad ."+a+" * { "+l+"}";document.getElementsByTagName("head")[0].appendChild(o);this._wrapTemplate='<div class="'+a+'">$content</div>';this.labelCanvas=null}drawLabel(t,e,o){const a=this.makeHtmlSelected(t);this.labelCanvas?.drawLabel(a,e,o)}drawLabelInPath(t,e,o){const a=this.makeHtmlSelected(t);this.labelCanvas?.drawLabelInPath(a,e,o)}drawLabelOnPath(t,e,o){const a=this.makeHtmlSelected(t);this.labelCanvas?.drawLabelOnPath(a,e,o)}makeHtmlSelected(t){const e=isString(t)?t:this.stringifyNode(t);return this._wrapTemplate.replace("$content",e)}stringifyNode(t){initTempNode();let e;try{tmpNode.appendChild(t);e=tmpNode.innerHTML}catch(t){e=""}finally{tmpNode.innerHTML=""}return e}}export function addSelection(t,e){const o=undefined;return addStyleMutation(t,{fillColor:e?.fillColor||SELECTION_FILL_COLOR,iconScaleFactor:e?.iconScaleFactor||SELECTION_ICON_SCALE_FACTOR,strokeColor:e?.strokeColor||SELECTION_STROKE_COLOR,strokeWidthScaleFactor:e?.strokeWidthScaleFactor||SELECTION_STROKE_WIDTH_SCALE_FACTOR,textHaloColor:e?.textHaloColor||SELECTION_TEXT_HALO_COLOR},(t=>t.selected))}export function addHover(t,e){const o=undefined;return addStyleMutation(t,{fillColor:e?.fillColor||HOVER_FILL_COLOR,iconScaleFactor:e?.iconScaleFactor||HOVER_ICON_SCALE_FACTOR,strokeColor:e?.strokeColor||HOVER_STROKE_COLOR,strokeWidthScaleFactor:e?.strokeWidthScaleFactor||HOVER_STROKE_WIDTH_SCALE_FACTOR,textHaloColor:e?.textHaloColor||HOVER_TEXT_HALO_COLOR},(t=>t.hovered))}function addStyleMutation(t,e,o){let a;let l;let i;let r;if(!t)return t;if(isFunction(t.paintBody)){a=t.paintBody;l=new GeoCanvasWrapper(e);t.paintBody=function(e,i,r,n,s,c){if(o(c)){l.geoCanvas=e;a.call(t,l,i,r,n,s,c)}else a.call(t,e,i,r,n,s,c)}}if(isFunction(t.paintLabel)){i=t.paintLabel;r=new LabelCanvasWrapper(e);t.paintLabel=function(e,a,l,n,s,c){if(o(c)){r.labelCanvas=e;i.call(t,r,a,l,n,s,c)}else i.call(t,e,a,l,n,s,c)}}return t}