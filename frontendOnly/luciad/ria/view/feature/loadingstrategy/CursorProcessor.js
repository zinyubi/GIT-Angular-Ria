import{NULL_FEATURE}from"./ScaleLevelCursor.js";import{isCluster}from"../transformation/ClusteringTransformer.js";export class CursorProcessor{constructor(e,t,{shouldUpdateFunc:s,isFeatureSelected:i,incremental:r,clearFlag:a}){this._cursor=e;this._workingSet=t;this._shouldUpdateFunc=s;this._isFeatureSelected=i;this._clearRequired=a;this._idMapSnapshot=a?null:t.getIdMapSnapshot();this._incremental=r;this._shouldDelete=true}processObject(e){if(!e||e===NULL_FEATURE)return;if(!this._idMapSnapshot){this._workingSet._addObject(e,e.id);return}if(!this._idMapSnapshot.has(e.id))this._workingSet._addObject(e,e.id);else if(!this._clearRequired){const t=this._idMapSnapshot.get(e.id);const s=t?.feature;if(s&&(isCluster(e)||this._shouldUpdateFunc(s,e)))this._workingSet._updateObject(e,e.id);this._idMapSnapshot.delete(e.id)}}finished(){return!this._cursor.hasNext()}processCursor(e){if(this._clearRequired){this._workingSet._clearData();this._clearRequired=false}while(this._cursor.hasNext()){const t=this._cursor.next();this.processObject(t);if(this._incremental&&Date.now()>=e)break}if(this._cursor.hasNext())return;if(this._shouldDelete&&this._idMapSnapshot){this._idMapSnapshot.forEach(((e,t)=>{if(!this._isFeatureSelected(e.feature))this._workingSet._removeObject(e.feature,t)}));this._idMapSnapshot.clear()}}set shouldDelete(e){this._shouldDelete=e}}