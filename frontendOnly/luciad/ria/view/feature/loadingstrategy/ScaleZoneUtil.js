import{createArcBand,createPoint}from"../../../shape/ShapeFactory.js";import{getReference}from"../../../reference/ReferenceProvider.js";import{getTransformation}from"../../../util/CacheUtil.js";import{VecMath}from"../../../util/VecMath.js";import{ReferenceType}from"../../../reference/ReferenceType.js";const CRS84=getReference("CRS:84");const GRID_SIZE_X=9;const GRID_SIZE_Y=14;function computeScaleGrid(e){const n=e.viewToMapTransformation;const t=e.viewSize[0]/(GRID_SIZE_X-1);const r=e.viewSize[1]/(GRID_SIZE_Y-1);const o=[];const c=createPoint(null,[0,0]);for(let a=0;a<GRID_SIZE_Y;a++){const s=a*r;for(let r=0;r<GRID_SIZE_X;r++){c.move2DToCoordinates(r*t,s);const a=transformPoint(n,c);if(a)o.push({worldPoint:a,scale:e.getScaleAt(a)})}}return o}function transformPoint(e,n){try{return e&&n?e.transform(n):null}catch(e){return null}}function calculateLevelRadiusRange(e,n,t){const r=t.length-1;const o=[];for(let c=0;c<r;c++){const r=t[c];const a=t[c+1];const s=n.filter((e=>e.scale>=r&&e.scale<=a));o.push({level:c,minMax:getMinMaxDistance(e,s)})}adjustLevelRadiusRange(o);return o}function getMinMaxDistance(e,n){const t=n.length;if(0===t)return null;n.sort(((e,n)=>e.scale-n.scale));const r=VecMath.length(VecMath.sub([e,n[t-1].worldPoint]));const o=VecMath.length(VecMath.sub([e,n[0].worldPoint]));return r<o?[r,o]:[o,r]}function adjustLevelRadiusRange(e){const n=e.length-1;for(let t=0;t<n;t++){const n=e[t];const r=e[t+1];if(n.level===r.level-1&&n.minMax&&r.minMax)n.minMax[0]=r.minMax[1]}return e}function calculate2DZone(e,n,t){const r=e.mapScale[0];const o=n.length-2;let c=null;for(let e=0;e<=o;e++)if(n[e]<=r&&r<=n[e+1]){c=e;break}return null===c?[]:[{level:c,bounds:t,zone:t}]}function getCameraAtZeroZ(e,n){if(e.reference.referenceType==ReferenceType.GEOCENTRIC){const t=getTransformation(e.reference,CRS84).transform(e.camera.eyePoint);t.z=0;return getTransformation(CRS84,n).transform(t)}else{const t=e.camera.eyePoint;t.z=0;return getTransformation(e.reference,n).transform(t)}}function getScaleZones(e,n,t){if(!e.is3D())return calculate2DZone(e,n,t);if(null===t.reference)throw new Error("ScaleZoneUtil: Cannot determine scale zones for null model reference");const r=getCameraAtZeroZ(e,t.reference);const o=undefined;const c=undefined;const a=calculateLevelRadiusRange(getCameraAtZeroZ(e,e.reference),computeScaleGrid(e),n);a.forEach((e=>{if(e.minMax){const[n,o]=e.minMax;const c=createArcBand(r.reference,r,n,o,0,360);e.zone=c;const a=c.bounds.copy();a.setTo2DIntersection(t);e.bounds=a}}));return a}export const ScaleZoneUtil={getScaleZones:getScaleZones,getCameraAtZeroZ:getCameraAtZeroZ,computeScaleGrid:computeScaleGrid,_GRID_SIZE:[GRID_SIZE_X,GRID_SIZE_Y]};