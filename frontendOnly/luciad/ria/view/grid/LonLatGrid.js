import{LonLatPointFormat}from"../../shape/format/LonLatPointFormat.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{isDefined}from"../../util/Lang.js";import{normalizeLineStyle,normalizeTextStyle}from"../style/StyleUtil.js";import{LabelPosition}from"./LabelPosition.js";import{Grid}from"./Grid.js";import{CanvasLonLatGridRenderer}from"./CanvasLonLatGridRenderer.js";import{PhotonLonLatGridLayerRenderer}from"./photon/PhotonLonLatGridLayerRenderer.js";import{getReference}from"../../reference/ReferenceProvider.js";const DEFAULT_ORIGIN=0;const DEFAULT_INCREMENT=10;const DEFAULT_LINE_STYLE=normalizeLineStyle({color:"rgb(220,220,220)"});const DEFAULT_LABEL_STYLE=normalizeTextStyle({stroke:"rgb(220,220,220)"});const DEFAULT_POINT_FORMAT=new LonLatPointFormat({pattern:"lat(+DM),lon(+DM)"});class LonLatGrid extends Grid{constructor(e,t){super();this._scales=[];this._styles=[];this._deltaLons=[];this._deltaLats=[];this._originLon=0;this._originLat=0;this._fallbackStyle={lineStyle:DEFAULT_LINE_STYLE,originLineStyle:DEFAULT_LINE_STYLE,labeled:true,labelStyle:DEFAULT_LABEL_STYLE,originLabelStyle:DEFAULT_LABEL_STYLE,labelFormat:DEFAULT_POINT_FORMAT,originLabelFormat:DEFAULT_POINT_FORMAT};if(!e)e=[{scale:4e-5,deltaLon:1/60,deltaLat:1/60},{scale:2e-5,deltaLon:1/30,deltaLat:1/30},{scale:1e-5,deltaLon:1/10,deltaLat:1/10},{scale:5e-6,deltaLon:1/2,deltaLat:1/2},{scale:1e-6,deltaLon:1,deltaLat:1},{scale:2e-7,deltaLon:5,deltaLat:5},{scale:2e-8,deltaLon:10,deltaLat:10},{scale:9e-9,deltaLon:20,deltaLat:20},{scale:5e-9,deltaLon:45,deltaLat:45},{scale:0,deltaLon:90,deltaLat:90}];if(!isDefined(e.length))throw new ProgrammingError("The settings for the grid must be passed as an array of LonLatGrid.Settings objects.");this._originLon=t&&isDefined(t.originLon)?t.originLon:DEFAULT_ORIGIN;this._originLat=t&&isDefined(t.originLat)?t.originLat:DEFAULT_ORIGIN;this._validateOrigin(this._originLon,this._originLat);for(const t of e)this._addDelta(t.scale,t.deltaLon,t.deltaLat);if(0===e.length)this._addDelta(0,DEFAULT_INCREMENT,DEFAULT_INCREMENT);this._defaultStyle={lineStyle:DEFAULT_LINE_STYLE,originLineStyle:DEFAULT_LINE_STYLE,labeled:true,labelStyle:DEFAULT_LABEL_STYLE,originLabelStyle:DEFAULT_LABEL_STYLE,labelFormat:new LonLatPointFormat,originLabelFormat:new LonLatPointFormat}}get defaultStyle(){return this._defaultStyle}get scales(){return this._scales}get originLon(){return this._originLon}get originLat(){return this._originLat}get fallbackStyle(){return this._fallbackStyle}set fallbackStyle(e){if(!e)throw new ProgrammingError("LonLatGrid#fallbackStyle::must supply style");this._normalizeAndValidateStyle(e);this._fallbackStyle=e;this.eventedSupport.emit("change")}_addDelta(e,t,i){this._checkValidScale(e);this._checkValidDeltaLon(t);this._checkValidDeltaLat(i);let a=0;while(a<this._scales.length)if(e>=this._scales[a])break;else a++;this._scales.splice(a,0,e);this._deltaLons.splice(a,0,t);this._deltaLats.splice(a,0,i);this._styles.splice(a,0,null)}_validateOrigin(e,t){if(e<-180||e>180)throw new ProgrammingError("the longitude of the origin should be inside the interval [-180, 180]");if(t<-90||t>90)throw new ProgrammingError("the longitude of the origin should be inside the interval [-90, 90]")}_checkValidScale(e){if(e<0)throw new ProgrammingError(`The scale on a longitude-latitude grid should be positive. ${e}`)}_checkValidDeltaLon(e){if(e<=0)throw new ProgrammingError(`The longitude increment on a longitude-latitude grid should be strictly positive. ${e}`)}_checkValidDeltaLat(e){if(e<=0)throw new ProgrammingError("The latitude increment on a longitude-latitude grid should be strictly positive.")}getDeltaLon(e){this._validateScaleIndex(e);return this._deltaLons[e]}getDeltaLat(e){this._validateScaleIndex(e);return this._deltaLats[e]}_normalizeAndValidateStyle(e){if(e.labelStyle&&isDefined(e.labelStyle))e.labelStyle=normalizeTextStyle(e.labelStyle);if(e.originLabelStyle&&isDefined(e.originLabelStyle))e.originLabelStyle=normalizeTextStyle(e.originLabelStyle);if(e.lineStyle&&isDefined(e.lineStyle))e.lineStyle=normalizeLineStyle(e.lineStyle);if(e.originLineStyle&&isDefined(e.originLineStyle))e.originLineStyle=normalizeLineStyle(e.originLineStyle);if(e.labelPosition!==LabelPosition.AUTO&&e.labelPosition!==LabelPosition.ALL_SIDES)e.labelPosition=LabelPosition.ALL_SIDES;if(e&&e.labelFormat&&isDefined(e.labelFormat))if(!LonLatPointFormat.prototype.isPrototypeOf(e.labelFormat))throw new ProgrammingError("LonLatGrid::labelFormat in the LonLatGrid.StyleSettings must be a LonLatPointFormat");if(e&&e.originLabelFormat&&isDefined(e.originLabelFormat))if(!LonLatPointFormat.prototype.isPrototypeOf(e.originLabelFormat))throw new ProgrammingError("LonLatGrid::originLabelFormat in the LonLatGrid.StyleSettings must be a LonLatPointFormat")}_validateScaleIndex(e){if(e<0||e>=this._scales.length)throw new ProgrammingError(`LonLatGrid#setStyle: the scaleIndex parameter [${e}]] must be positive and smaller then ${this._scales.length}`)}setStyle(e,t){this._validateScaleIndex(e);this._normalizeAndValidateStyle(t);this._styles[e]=t;this.eventedSupport.emit("change")}getStyle(e){this._validateScaleIndex(e);return this._styles[e]}_getStyleSetting(e,t,i){const a=(e,t)=>{let i;if(null!==e){i=e[t];if(isDefined(i))return i}return this.fallbackStyle[t]};let l;const r=this.getStyle(e);l=a(r,t);if(isDefined(l))return l;if(i&&isDefined(i)){l=a(r,i);if(isDefined(l))return l}return this.defaultStyle[t]}getLabeled(e){return this._getStyleSetting(e,"labeled")}getLabelPosition(e){return this._getStyleSetting(e,"labelPosition")}getLabelFormat(e){return this._getStyleSetting(e,"labelFormat")}getOriginLabelFormat(e){return this._getStyleSetting(e,"originLabelFormat","labelFormat")}getLabelStyle(e){return this._getStyleSetting(e,"labelStyle")}getOriginLabelStyle(e){return this._getStyleSetting(e,"originLabelStyle","labelStyle")}getLineStyle(e){return this._getStyleSetting(e,"lineStyle")}getOriginLineStyle(e){return this._getStyleSetting(e,"originLineStyle","lineStyle")}createRenderer(e){const t=e.techContext;if("Canvas"===t.type)return new CanvasLonLatGridRenderer(e.grid,createTransformation(getReference("CRS:84"),e.map.reference),e.map,{bodies:e.paintBodies,labels:e.paintLabels});else{const i=undefined;return new PhotonLonLatGridLayerRenderer({photon:t.photonInstance,grid:e.grid,map:e.map,layer:e.layer},e.paintBodies,e.paintLabels,t.photonView,t.photonGraphics)}}get labelGroupName(){return"LonLat"}get name(){return"Lon Lat Grid"}}export{LonLatGrid};