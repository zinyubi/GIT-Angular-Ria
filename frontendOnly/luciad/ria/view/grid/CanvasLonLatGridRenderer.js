import{LineType}from"../../geodesy/LineType.js";import{ShapeType}from"../../shape/ShapeType.js";import{GridRendererState}from"./GridRendererState.js";import{GridDrawCommand}from"./GridDrawCommand.js";import{GridLabelConflictChecker}from"./GridLabelConflictChecker.js";import{GridLineLabel}from"./GridLineLabel.js";import{GeoDiscretizerStatic}from"../shape/discretization/GeoDiscretizerStatic.js";export class CanvasLonLatGridRenderer{constructor(e,t,i,r){this._grid=e;this._map=i;this._reference=i.reference;this._conflictChecker=new GridLabelConflictChecker;this._bodiesVisible=r.bodies;this._labelsVisible=r.labels;this._gridRendererState=new GridRendererState(this._grid,t.inputReference)}get bounds(){return this._gridRendererState.modelBounds}get gridRendererState(){return this._gridRendererState}render(e,t,i){const r=this._map;const s=this._gridRendererState.getModelBounds(r);if(!s)return true;const a=r.xScale;const n=this._gridRendererState.calculateScaleIndex(this._grid.scales,a);if(!this._gridRendererState.canSkipUpdate(s,a,n)){const e=this._grid;this._currentLineStyle=e.getLineStyle(n);this._currentOriginStyle=e.getOriginLineStyle(n);this._isLabeled=e.getLabeled(n);this._labelPosition=e.getLabelPosition(n);this._labelStyle=e.getLabelStyle(n);this._labelFormat=e.getLabelFormat(n);this._originLabelStyle=e.getOriginLabelStyle(n);this._originLabelFormat=e.getOriginLabelFormat(n);this._gridRendererState.reset(s,a,n);this.updateDrawCommands();this._drawGridCommand.setStyles(this._currentLineStyle,this._currentOriginStyle)}this.drawGrid(e,r.mapToViewTransformation,r);return true}drawGrid(e,t,i){if(this._drawGridCommand&&this._bodiesVisible)this._drawGridCommand.draw(e,t);if(this._isLabeled&&this._labelsVisible&&!this._gridRendererState.tooMany)this.drawLabels(e,i)}drawLabels(e,t){this._conflictChecker.resetViewWidthHeight(t.getLeftBorderSize(),0,t.getViewWidth()+t.getLeftBorderSize(),t.getViewHeight());this._conflictChecker.clear();for(let i=0;i<this._labels.length;i+=1)this._labels[i].paint(e,t,this._conflictChecker)}discretizeAndCollectLabels(e,t,i){const r=[];const s=this._reference;let a;let n,l,d,o,h;let c;for(l=0,o=e.length;l<o;l++){const o=e[l];const _=o.reference;a=GeoDiscretizerStatic.discretize(o,{modelReference:_,worldReference:s,lineType:LineType.CONSTANT_BEARING});if(a){n=a.lines||[];for(d=0,h=n.length;d<h;d++)r.push(n[d]);c=this.makeLabel(n,o,t,i);this._labels.push(c)}}return r}makeLabel(e,t,i,r){let s;if(t.type===ShapeType.MERIDIAN)s=r.formatLon(t.getDegrees());else if(t.type===ShapeType.PARALLEL)s=r.formatLat(t.getDegrees());return new GridLineLabel(e,s,i,this._labelPosition)}updateDrawCommands(){this._labels=[];const e=this.discretizeAndCollectLabels(this._gridRendererState.gridLines,this._labelStyle,this._labelFormat);const t=this.discretizeAndCollectLabels(this._gridRendererState.originLines,this._originLabelStyle,this._originLabelFormat);this._drawGridCommand=new GridDrawCommand(e,t)}invalidate(){this._gridRendererState.invalidate();this._drawGridCommand=null}update(){return true}collectLabels(e){}release(){}}