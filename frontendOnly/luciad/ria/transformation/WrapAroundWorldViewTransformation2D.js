import{WorldViewTransformation2D}from"./WorldViewTransformation2D.js";import{isObject}from"../util/Lang.js";import{Constants}from"../util/Constants.js";import{createPoint}from"../shape/ShapeFactory.js";import{GridReference}from"../reference/GridReference.js";export class WrapAroundWorldViewTransformation2D extends WorldViewTransformation2D{constructor(t,e){super(t,e);this._mapPixelXOffset=null;this._mapPixelYOffset=null;this._mapWestPixelPoint={x:0,y:0,z:0};this._mapEastPixelPoint={x:0,y:0,z:0};this._previousRotation=null;this._previousScaleX=null;this._previousScaleY=null}setMapPixelOffsets(){const t=this.camera.asLook2D();if(this.inputReference instanceof GridReference&&null!==this.inputReference.bounds){if(t.rotation!==this._previousRotation&&t.scaleX!==this._previousScaleX&&t.scaleY!==this._previousScaleY){const e=this.inputReference.bounds;const i=t.rotation*Constants.DEG2RAD;const s=Math.cos(i);const a=Math.sin(i);const n={x:e.x,y:e.y,z:0};const h={x:e.x+e.width,y:e.y,z:0};super.transform(n,this._mapWestPixelPoint);super.transform(h,this._mapEastPixelPoint);const r=s*a===0?1:-s*a/Math.abs(s*a);this._mapPixelXOffset=Math.abs(this._mapWestPixelPoint.x-this._mapEastPixelPoint.x);this._mapPixelYOffset=Math.abs(this._mapWestPixelPoint.y-this._mapEastPixelPoint.y)*r}}else{this._mapPixelXOffset=null;this._mapPixelYOffset=null;this._previousRotation=null;this._previousScaleX=null;this._previousScaleY=null}}tryPuttingPointInBounds(t){this.setMapPixelOffsets();if(null!==this._mapPixelXOffset&&null!==this._mapPixelYOffset){const e={x:t.x,y:t.y,z:0};if(t.x>this.camera.width||t.x<0||t.y>this.camera.height||t.y<0){t.x=t.x-this._mapPixelXOffset;t.y=t.y-this._mapPixelYOffset}if(t.x>this.camera.width||t.x<0||t.y>this.camera.height||t.y<0){t.x=t.x+2*this._mapPixelXOffset;t.y=t.y+2*this._mapPixelYOffset;if(t.x>this.camera.width||t.x<0||t.y>this.camera.height||t.y<0){t.x=e.x;t.y=e.y}}}}transform(t,e){e=super.transform(t,e);if(isObject(e)&&null!==e&&(e.x<0||e.x>this.camera.width||e.y<0||e.y>this.camera.height))this.tryPuttingPointInBounds(e);return e}transformToAllVisibleMaps(t){let e=createPoint(this._outputReference,[0,0]);this.transform(t,e);const i=[];this.setMapPixelOffsets();if(null!==this._mapPixelXOffset&&null!==this._mapPixelYOffset&&e.x<=this.camera.width&&e.x>=0&&e.y<=this.camera.height&&e.y>=0){do{i.push(createPoint(this._outputReference,[e.x,e.y]));e.x=e.x-this._mapPixelXOffset;e.y=e.y-this._mapPixelYOffset}while(e.x<=this.camera.width&&e.x>=0&&e.y<=this.camera.height&&e.y>=0);e=createPoint(this._outputReference,[i[0].x,i[0].y]);e.x=e.x+this._mapPixelXOffset;e.y=e.y+this._mapPixelYOffset;while(e.x<=this.camera.width&&e.x>=0&&e.y<=this.camera.height&&e.y>=0){i.push(createPoint(this._outputReference,[e.x,e.y]));e.x=e.x+this._mapPixelXOffset;e.y=e.y+this._mapPixelYOffset}}return i}}