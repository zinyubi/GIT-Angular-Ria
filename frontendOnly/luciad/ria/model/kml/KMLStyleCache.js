import{isKeyValue,isPairNode,isStyleMapNode,isStyleNode,isStyleSelectorNode,isStyleUrlValue}from"../../util/kml/KMLTypes.js";import{xmlNodeContains,xmlParentNode,xmlReduceChildren}from"../../util/kml/KMLInternalUtil.js";import{Log}from"../../util/Log.js";import{KMLStyleBuilder}from"./KMLStyleBuilder.js";import{KMLStyle}from"../../view/kml/KMLStyle.js";import{isString}from"../../util/Lang.js";import{getKmlId,getKmlValue}from"../../util/kml/KMLValues.js";export class KMLStyleCache{constructor(){this._entries=Object.create(null)}pushStyle(e){const t=getKmlId(e);if(!t)return;const l=undefined;if(!xmlParentNode(e))return;const r={node:e,style:null};const n=this._entries[t];if(!n){this._entries[t]=[r];return}n.push(r)}getStyle(e){const{inlineStyleNode:t,sharedStyleUrl:l}=this.getDirectStyles(e);if(!t&&!l)return toKmlStyles();const r=l?this.geUrlStyleEntry(e,l):null;if(l&&!r)Log.error(`Failed to retrieve shared KML styles from URL "${l}"`);if(t)return this.processInlineStyle(t,r);return r||toKmlStyles()}getDirectStyles(e){return xmlReduceChildren(e,((e,t)=>{if(!e.inlineStyleNode&&isStyleSelectorNode(t))e.inlineStyleNode=t;else if(!e.sharedStyleUrl&&isStyleUrlValue(t))e.sharedStyleUrl=getKmlValue(t);return e}),{inlineStyleNode:null,sharedStyleUrl:null})}processInlineStyle(e,t){if(isStyleNode(e)){const l=copyStyleOrDefault(t,"normal");return toKmlStyles(new KMLStyleBuilder(e).build(l))}if(isStyleMapNode(e))return this.processStyleMap(e,t);return t??toKmlStyles()}processStyleMap(e,t){const l=xmlReduceChildren(e,styleReducer,{highlight:null,normal:null});return toKmlStyles(this.processReducedStyleMap(e,l,t,"normal"),this.processReducedStyleMap(e,l,t,"highlight"))}processReducedStyleMap(e,t,l,r){const n=t[r];if(n)if(isString(n)){const t=this.geUrlStyleEntry(e,n)?.[r];if(t)return t;Log.error(`Failed to retrieve shared KML styles from URL "${n}"`)}else if(isStyleNode(n)){const e=copyStyleOrDefault(l,r);return new KMLStyleBuilder(n).build(e)}return copyStyleOrDefault(l,r)}geUrlStyleEntry(e,t){if(!t)return null;const l=normalizeStyleUrlId(t);if(!l)return null;const r=this._entries[l];if(!r)return null;const n=r.reduce(((t,l)=>{const r=xmlParentNode(l.node);const n=r&&xmlNodeContains(r,e);const i=t&&r&&xmlNodeContains(r,t.node);if(n&&!i)return l;return t}),null);if(!n)return null;if(n.style)return n.style;if(isStyleNode(n.node))return n.style=toKmlStyles(new KMLStyleBuilder(n.node).build());if(isStyleMapNode(n.node))return n.style=this.processStyleMap(n.node,null);return null}}function normalizeStyleUrlId(e){if(!e)return null;const t=e.indexOf("#");if(-1===t)return null;if(0!==t){Log.error("Remote KML Styles are not currently supported. Using the default KML Style instead.");return null}return e.substring(t+1)}export function toKmlStyles(e=null,t=null){return{normal:e||t||new KMLStyle,highlight:t||e||new KMLStyle}}function styleReducer(e,t){if(!isPairNode(t))return e;const l=xmlReduceChildren(t,pairReducer,{key:null,style:null});if("highlight"===l.key)e.highlight=l.style;if(null===l.key||"normal"===l.key)e.normal=l.style;return e}function pairReducer(e,t){if(isKeyValue(t))e.key=getKmlValue(t);if(isStyleNode(t))e.style=t;if(isStyleUrlValue(t))e.style=getKmlValue(t);return e}function copyStyleOrDefault(e,t){return e?e[t].copy():new KMLStyle}