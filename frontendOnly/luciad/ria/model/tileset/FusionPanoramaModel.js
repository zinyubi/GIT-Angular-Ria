import{ProgrammingError}from"../../error/ProgrammingError.js";import{URL as RIAUrl}from"../../util/URL.js";import{PanoramaModel}from"./PanoramaModel.js";import{createPowerOfTwoStructure}from"./PanoramaTileSetStructure.js";import{PanoramaType}from"./PanoramaType.js";function isFusionPanoramaFeature(e){const r=e.properties||{};return"1.0"===r.version&&"cubemap"===r.type&&"number"===typeof r.levelCount&&"number"===typeof r.tileWidth&&"number"===typeof r.tileHeight}export class FusionPanoramaModel extends PanoramaModel{constructor(e,r){let t="";let a=e;let o;if(e.includes("?")){a=e.split("?")[0];o=RIAUrl.parseQueryString(e)}if(a.match("\\/.+\\.json$"))t=e.substring(0,e.lastIndexOf("/"))+"/";else if(a.endsWith("/"))t=e;else throw new ProgrammingError("The LuciadFusion panorama image path must of the form http://host/path/cubemap.json or http://host/path/, not "+e);super({baseURL:t,panoramaDescriptor:{type:PanoramaType.CUBE_MAP,structure:createPowerOfTwoStructure({levelCount:1,level0Columns:1,level0Rows:1,tileWidth:1,tileHeight:1})},requestParameters:o,...r})}getPanoramaDescriptor(e,r){if(isFusionPanoramaFeature(e))return{type:PanoramaType.CUBE_MAP,structure:createPowerOfTwoStructure({levelCount:e.properties.levelCount,level0Rows:1,level0Columns:1,tileWidth:e.properties.tileWidth,tileHeight:e.properties.tileHeight,imageDataFractionX:1,imageDataFractionY:1})};return super.getPanoramaDescriptor(e,r)}getPanoramicImageURL(e){if(isFusionPanoramaFeature(e.feature)){const r=this.requestParameters&&0!==Object.keys(this.requestParameters).length?`?${RIAUrl.buildQueryString(this.requestParameters)}`:"";return this.replaceURLPatterns(`${this.baseURL}images/{id}/{face}-{z}-{x}-{y}.jpg${r}`,e)}return super.getPanoramicImageURL(e)}}