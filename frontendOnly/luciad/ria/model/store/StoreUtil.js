import{isArray}from"../../util/Lang.js";import{handleResponseAs,request}from"../../util/request.js";import{GeoJsonCodec}from"../codec/GeoJsonCodec.js";import{Log}from"../../util/Log.js";import{GMLCodec}from"../codec/GMLCodec.js";import{WFSVersion}from"../../ogc/WFSVersion.js";function decodeServerResponse(e,t,o,n){const r=t.headers.get("Content-Type")||void 0;return handleResponseAs(t,n).then((t=>e.decode({content:t,contentType:r,reference:o})))}const FORMATS={json:[RegExp("json","i")],gml:[RegExp("gml","i"),RegExp("text/xml","i")]};function hasFormatType(e,t){return t.some((t=>e.some((e=>e.test(t)))))}function getOutputType(e=[]){if(e.length>0){if(hasFormatType(FORMATS.json,e))return"json";if(hasFormatType(FORMATS.gml,e))return"gml"}return"json"}function getFirstFormatOfType(e,t){return e.find((e=>FORMATS[t].some((t=>t.test(e)))))}const DEFAULT_OUTPUT_GML_WFS_1="text/xml; subtype=gml/3.1.1";const DEFAULT_OUTPUT_GML_WFS_2="application/gml+xml; version=3.2";const DEFAULT_OUTPUT_JSON="application/json";export function getOutputFormat(e,t=[]){const o=undefined;if("json"===getOutputType(t))return t.includes(DEFAULT_OUTPUT_JSON)?DEFAULT_OUTPUT_JSON:getFirstFormatOfType(t,"json")??DEFAULT_OUTPUT_JSON;if(e.some((e=>e===WFSVersion.V202||e===WFSVersion.V200))&&t.includes(DEFAULT_OUTPUT_GML_WFS_2))return DEFAULT_OUTPUT_GML_WFS_2;if(e.some((e=>e===WFSVersion.V110||e===WFSVersion.V100))&&t.includes(DEFAULT_OUTPUT_GML_WFS_1))return DEFAULT_OUTPUT_GML_WFS_1;return getFirstFormatOfType(t,"gml")??DEFAULT_OUTPUT_GML_WFS_2}export function getAutoDetectedCodec(e){const t=undefined;return"gml"===getOutputType(e?[e]:[])?new GMLCodec:new GeoJsonCodec}export function mergeRequestMethods(e,t){if(!t||!isArray(t)||!t.length)return e;const o=e.filter((e=>t.indexOf(e)>-1));if(0===o.length){Log.warn(`WFS service does not support request methods: ${t.join(", ")}`);return e}return o}export async function performRequestAndConvertToCursorPromise(e,t,o,n,r){const s=request(e,t);const i=undefined;return decodeServerResponse(o,await Promise.resolve(s),n,r)}