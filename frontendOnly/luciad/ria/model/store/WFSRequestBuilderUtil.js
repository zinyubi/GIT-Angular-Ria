import{createOGCEncoder}from"../../ogc/filter/encoders/OGCEncoderFactory.js";import{mimeType}from"../../util/mimeType.js";import{XMLWriter}from"../../util/XMLWriter.js";import{WFSVersion}from"../../ogc/WFSVersion.js";import{isArray,isString,isUndefined}from"../../util/Lang.js";import{urlWithParams}from"../../util/request.js";const MAX_URL_LENGTH=255;const WFSV200_XML_NAMESPACES=[{prefix:"xsd",namespace:"http://www.w3.org/2001/XMLSchema"},{prefix:"wfs",namespace:"http://www.opengis.net/wfs/2.0"},{prefix:"fes",namespace:"http://www.opengis.net/fes/2.0"},{prefix:"ows",namespace:"http://www.opengis.net/ows/1.1"},{prefix:"gml",namespace:"http://www.opengis.net/gml/3.2"},{prefix:"xlink",namespace:"http://www.w3.org/1999/xlink"}];const XML_NAMESPACES={[WFSVersion.V100]:[{prefix:"xsd",namespace:"http://www.w3.org/2001/XMLSchema"},{prefix:"wfs",namespace:"http://www.opengis.net/wfs"},{prefix:"ogc",namespace:"http://www.opengis.net/ogc"},{prefix:"gml",namespace:"http://www.opengis.net/gml"},{prefix:"xlink",namespace:"http://www.w3.org/1999/xlink"}],[WFSVersion.V110]:[{prefix:"xsd",namespace:"http://www.w3.org/2001/XMLSchema"},{prefix:"wfs",namespace:"http://www.opengis.net/wfs"},{prefix:"ogc",namespace:"http://www.opengis.net/ogc"},{prefix:"ows",namespace:"http://www.opengis.net/ows"},{prefix:"gml",namespace:"http://www.opengis.net/gml"},{prefix:"xlink",namespace:"http://www.w3.org/1999/xlink"}],[WFSVersion.V200]:WFSV200_XML_NAMESPACES,[WFSVersion.V202]:WFSV200_XML_NAMESPACES};var SortOrder=function(e){e[e["Ascending"]=0]="Ascending";e[e["Descending"]=1]="Descending";return e}(SortOrder||{});const WFS_V1_FILTER_ENCODER_OPTS={filterPrefix:"ogc",gmlPrefix:"gml"};const WFS_V2_FILTER_ENCODER_OPTS={filterPrefix:"fes",gmlPrefix:"gml"};const FILTER_ENCODER_OPTIONS={[WFSVersion.V100]:WFS_V1_FILTER_ENCODER_OPTS,[WFSVersion.V110]:WFS_V1_FILTER_ENCODER_OPTS,[WFSVersion.V200]:WFS_V2_FILTER_ENCODER_OPTS,[WFSVersion.V202]:WFS_V2_FILTER_ENCODER_OPTS};const getMajorVersion=e=>+e.substring(0,e.indexOf("."));const isWFSMajorVersion2=e=>getMajorVersion(e)>=2;function isQueryNamePredicate(e){return e&&isString(e.namespace)&&isString(e.localPart)&&isString(e.prefix)}function appendGetFeatureOpenTag(e,r){const t=undefined;const n=[...XML_NAMESPACES[r.version]];if(isArray(r.typeNames)){const e=undefined;r.typeNames.filter(isQueryNamePredicate).forEach((e=>{n.push({prefix:e.prefix,namespace:e.namespace})}))}e.beginNode("GetFeature","wfs",n);e.attribute("service",r.service);e.attribute("outputFormat","JSON"===r.outputFormat?mimeType.json:r.outputFormat);if(!isUndefined(r.maxFeatures)){const t=getCountLimitAttributeName(r.version);e.attribute(t,r.maxFeatures)}e.attribute("version",r.version)}function appendGetFeatureCloseTag(e){e.endNode()}function appendQueryElements(e,r){const t=r.version;const n=r.typeNames;const s=r.filters;const i=new Array(s.length);const o=FILTER_ENCODER_OPTIONS[t];for(let e=0,r=s.length;e<r;e++){if(!s[e])throw new Error("Filter should be defined for every typeName");i[e]=createOGCEncoder(t).encode(s[e],o)}for(let o=0,a=n.length;o<a;o++){const a=n[o];let p;if(isQueryNamePredicate(a))p=`${a.prefix}:${a.localPart}`;else if(isString(a))p=a;else continue;const m=isWFSMajorVersion2(t)?"typeNames":"typeName";e.beginNode("Query","wfs");e.attribute(m,p);if(r.srsName)e.attribute("srsName",r.srsName);if(r.propertyNames)r.propertyNames.forEach((r=>e.node("wfs:PropertyName",r)));if(s[o])e.rawValue(i[o]);appendSortBy(e,r);e.endNode()}}function appendSortBy(e,r){const t=r.sortBy;if(!isArray(t)||0===t.length)return;e.beginNode("SortBy","fes");for(let r=0;r<t.length;r++){const{sortProperty:n,sortOrder:s}=t[r];const i=s===SortOrder.Descending?"DESC":"ASC";e.beginNode("SortProperty","fes");e.node("fes:ValueReference",n);e.node("fes:SortOrder",i);e.endNode()}e.endNode()}function buildPOSTParams(e,r){const t=new XMLWriter(true);appendGetFeatureOpenTag(t,r);appendQueryElements(t,r);appendGetFeatureCloseTag(t);const n=undefined;return{url:e,handleAs:"json",requestOptions:{method:"POST",body:`<?xml version="1.0" encoding="UTF-8"?>\n${t.toString()}`,headers:{"Content-Type":mimeType.xml}}}}function getCountLimitAttributeName(e){return isWFSMajorVersion2(e)?"count":"maxFeatures"}function buildGETParams(e,r){const t=r.version;const n=r.typeNames;const s=r.filters;const i=new Array(n.length);for(let e=0,r=n.length;e<r;e++){const r=n[e];if(isQueryNamePredicate(r))i[e]=`${r.prefix}:${r.localPart}`;else if(isString(n[e]))i[e]=n[e]}const o={service:r.service,request:r.request,version:t,outputFormat:r.outputFormat};const a=undefined;o[isWFSMajorVersion2(t)?"typeNames":"typeName"]=i.join(",");if(r.srsName)o["srsName"]=r.srsName;if(!isUndefined(r.maxFeatures)){const e=undefined;o[getCountLimitAttributeName(t)]=`${r.maxFeatures}`}if(isArray(r.sortBy)){const e=isWFSMajorVersion2(t)?["DESC","ASC"]:["D","A"];o.sortBy=r.sortBy.map((({sortProperty:r,sortOrder:t})=>`${r} ${t===SortOrder.Descending?e[0]:e[1]}`)).join(",")}if(isArray(r.propertyNames))o.propertyName=r.propertyNames.join(",");const p=s.length;if(p>0){const e={includeNamespaces:true,...FILTER_ENCODER_OPTIONS[t]};if(1===s.length)o.filter=createOGCEncoder(t).encode(s[0],e);else{let r="";for(let n=0;n<p;n++){if(!s[n])throw new Error("Filter should be defined for every typeName");r+=`(${createOGCEncoder(t).encode(s[n],e)})`}o.filter=r}}return{url:urlWithParams(e,o),handleAs:"json",requestOptions:{method:"GET"}}}function buildPOSTorGETParams(e,r,t){if(t.filters.length>0)return buildPOSTParams(r,t);const n=buildGETParams(e,t);return n.url.length<MAX_URL_LENGTH?n:buildPOSTParams(r,t)}export const WFSRequestBuilderUtil={buildPOSTParams:buildPOSTParams,buildGETParams:buildGETParams,buildPOSTorGETParams:buildPOSTorGETParams};