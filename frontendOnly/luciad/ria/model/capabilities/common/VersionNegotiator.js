import{addHttpRequestOptions}from"../../../util/HttpRequestOptions.js";import{request,urlWithParams}from"../../../util/request.js";import{isArray}from"../../../util/Lang.js";export class VersionNegotiator{constructor(e,t,s,i,r,o={}){this._baseUrl=e;this._service=t;this._parseVersionFromResponse=s;this._versionsToNegotiate=[];r=isArray(r)?r:i;for(let e=0;e<r.length;e++){const t=r[e];if(i.indexOf(t)>=0)this._versionsToNegotiate.push(t)}if(0===this._versionsToNegotiate.length)throw new Error(`Could not find a ${t} version to negotiate. `+`Supported versions are: [${i.join(", ")}]. `+`Only the following versions are allowed: [${r.join(", ")}]`);this._requestOptions=o;this._versionIndex=0;this._negotiatedVersion=null}get requestOptions(){return this._requestOptions}get baseUrl(){return this._baseUrl}get service(){return this._service}async negotiateVersion(){this._negotiatedVersion=null;this._versionIndex=0;const e=await this.negotiateVersionStep();if(!this._negotiatedVersion){const e=this._versionsToNegotiate.join(", ");throw new Error(`No ${this._service} version could be negotiated. Tried versions: [${e}]`)}return{version:this._negotiatedVersion,response:e}}async negotiateVersionStep(){const e=await this.requestCapabilities(this._versionsToNegotiate[this._versionIndex]);const t=this._parseVersionFromResponse(e);for(let e=0;e<this._versionsToNegotiate.length;e++)if(this._versionsToNegotiate[e]===t){this._negotiatedVersion=t;break}this._versionIndex++;if(!this._negotiatedVersion&&this._versionIndex<this._versionsToNegotiate.length)return this.negotiateVersionStep();return e}async requestCapabilities(e){const t={SERVICE:this._service,REQUEST:"GetCapabilities",VERSION:e};const s=urlWithParams(this._baseUrl,{...t,...this._requestOptions.requestParameters});const i=addHttpRequestOptions({method:"GET",credentials:this._requestOptions.credentials,headers:this._requestOptions.requestHeaders,urlParams:{...t,...this._requestOptions.requestParameters}},this._requestOptions);const r=undefined;return(await request(s,i)).text()}}