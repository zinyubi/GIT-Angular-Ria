import{isDefined}from"../../util/Lang.js";import{XMLSchema}from"../../util/XMLSchema.js";import{WMTSCapabilitiesSchema}from"./WMTSCapabilitiesSchema.js";import{freeze,parseCornerValues}from"./common/CapabilitiesParserUtil.js";import{WMTSCapabilitiesLayer}from"./WMTSCapabilitiesLayer.js";import{WMTSCapabilitiesTileMatrixSet}from"./WMTSCapabilitiesTileMatrixSet.js";import{WMSVersion}from"../../ogc/WMSVersion.js";export class WMTSCapabilitiesParser{constructor(e){const t=undefined;const i=new XMLSchema(WMTSCapabilitiesSchema).parse(e);this._raw=i;this._rawRoot=i["Capabilities"]}get version(){return WMSVersion.V100}getRawCapabilities(){return this._raw}getService(){const e=this._rawRoot.ServiceIdentification;const t=this._rawRoot.ServiceMetadataURL;const i=this._rawRoot.ServiceProvider;if(!isDefined(e))return null;return freeze({title:e.Title,abstract:e.Abstract,keywords:e&&this.getKeywords(e),url:t&&t[0].href,contactInformation:getContactInformation(i),fees:"none"!==e.Fees?e.Fees:null})}getRequests(){const e=this._rawRoot?.OperationsMetadata;if(e?.Operation)return freeze({GetCapabilities:this.getRequestInformationByName(e.Operation,"GetCapabilities"),GetTile:this.getRequestInformationByName(e.Operation,"GetTile"),GetFeatureInfo:this.getRequestInformationByName(e.Operation,"GetFeatureInfo")});return freeze({GetCapabilities:[],GetTile:[],GetFeatureInfo:[]})}getRequestInformationByName(e,t){const i=e.filter((e=>e.name===t))[0];if(!isDefined(i))return[];const r=[];const n=i.DCP&&i.DCP[0];if(n.HTTP&&n.HTTP.Get)n.HTTP.Get.forEach((e=>{if(isDefined(e.Constraint)){const t=e.Constraint.filter((e=>"GetEncoding"===e.name))[0];if(isDefined(t))r.push({requestMethod:"GET",encodings:t.AllowedValues.Value,url:e.href})}}));if(n.HTTP&&n.HTTP.Post)n.HTTP.Post.forEach((e=>{const t=e.Constraint.filter((e=>"GetEncoding"===e.name))[0];const i=e.Constraint.filter((e=>"PostEncoding"===e.name))[0];if(isDefined(t))r.push({requestMethod:"POST",encodings:t.AllowedValues.Value,url:e.href,postEncodings:i&&i.AllowedValues.Value})}));return r}getUpdateSequence(){return this._rawRoot.updateSequence}getLayers(){const e=this._rawRoot.Contents.Layer;const t=[];const i=this.getThemes();e.forEach((e=>{const r=this.getLayer(e,i);t.push(r)}));return t}getTileMatrixSet(e,t){const i=undefined;const r=(this._rawRoot.Contents.TileMatrixSet||[]).filter((t=>t.Identifier["#text"]===e))[0];return this.createTileMatrixSet(r,t)}createTileMatrixSet(e,t){if(!isDefined(e))return null;return new WMTSCapabilitiesTileMatrixSet(freeze({title:e.Title&&e.Title[0]["#text"],abstract:e.Abstract&&e.Abstract[0]&&e.Abstract[0]["#text"],keywords:e&&this.getKeywords(e),identifier:e.Identifier["#text"],wellKnownScaleSet:e.WellKnownScaleSet,tileMatrices:this.getTileMatrices(e.TileMatrix,t),bounds:getBounds(e.BoundingBox),referenceName:e.SupportedCRS}))}getTileMatrices(e,t){if(!isDefined(e))return[];return e.map((i=>{const r=i.Identifier&&i.Identifier["#text"];return freeze({title:i.Title&&i.Title["#text"],abstract:i.Abstract&&i.Abstract["#text"],keywords:i&&this.getKeywords(e),identifier:r,scaleDenominator:i.ScaleDenominator,topLeftCorner:i.TopLeftCorner,tileWidth:i.TileWidth,tileHeight:i.TileHeight,matrixWidth:i.MatrixWidth,matrixHeight:i.MatrixHeight,limits:this.getTileMatrixLimits(t,r)})}))}getTileMatrixLimits(e,t){const i=e.filter((e=>e.TileMatrix===t))[0];if(!isDefined(i))return null;return{minTileRow:i.MinTileRow,maxTileRow:i.MaxTileRow,minTileCol:i.MinTileCol,maxTileCol:i.MaxTileCol}}getLayer(e,t){if(!isDefined(e))return null;const i=e.Identifier["#text"];return new WMTSCapabilitiesLayer(freeze({title:e.Title&&e.Title[0]["#text"],abstract:e.Abstract&&e.Abstract[0]&&e.Abstract[0]["#text"],keywords:e&&this.getKeywords(e),formats:e.Format||[],identifier:i,styles:this.getStyles(e.Style),infoFormats:e.InfoFormat||[],dimensions:this.getDimensions(e.Dimension),tileMatrixSets:this.getLayerTileMatrixSets(e.TileMatrixSetLink),resourceUrls:(e.ResourceURL||[]).map(parseResourceUrl),themes:this.getLayerThemes(t,i),wgs84Bounds:this.getBoundsList(e.WGS84BoundingBox,"CRS:84"),bounds:this.getBoundsList(e.BoundingBox)}))}getBoundsList(e,t){if(!isDefined(e))return[];return e.map((e=>getBounds(e,t)))}getLayerTileMatrixSets(e){if(!isDefined(e))return[];return e.map((e=>{const t=e.TileMatrixSetLimits&&e.TileMatrixSetLimits.TileMatrixLimits||[];return this.getTileMatrixSet(e.TileMatrixSet,t)}))}getStyles(e){if(!isDefined(e))return[];return e.map((e=>freeze({title:e.Title&&e.Title[0]["#text"],abstract:e.Abstract&&e.Abstract[0]&&e.Abstract[0]["#text"],keywords:e&&this.getKeywords(e),identifier:e.Identifier["#text"],isDefault:e.isDefault,legends:(e.LegendURL||[]).map(getLegend)})))}getDimensions(e){if(!isDefined(e))return[];return e.map((e=>freeze({title:e.Title&&e.Title[0]["#text"],abstract:e.Abstract&&e.Abstract[0]&&e.Abstract[0]["#text"],keywords:this.getKeywords(e),identifier:e.Identifier&&e.Identifier["#text"],unitsOfMeasure:e.UOM&&e.UOM["#text"],default:e.Default,unitSymbol:e.UnitSymbol,current:e.Current,values:e.Value||[]})))}getLayerThemes(e,t){const i=[];e.filter((e=>Array.isArray(e.layerIdentifier)&&e.layerIdentifier.indexOf(t)>=0)).forEach((e=>{const t=getThemeWithParents(e);i.push.apply(i,t)}));return i}getThemes(){const e=this._rawRoot.Themes&&this._rawRoot.Themes[0];if(!isDefined(e))return[];const t=[];this.collectThemesSFCT(t,e,null);return t}collectThemesSFCT(e,t,i){const r={parent:i,title:t.Title&&t.Title["#text"],abstract:t.Abstract&&t.Abstract["#text"],keywords:t&&this.getKeywords(t),identifier:t.Identifier&&t.Identifier["#text"],layerIdentifier:t.LayerRef};r.children=(t.Theme||[]).map((t=>this.collectThemesSFCT(e,t,r)));e.push(r);return freeze(r)}getKeywords(e){const t=e.Keywords;if(!isDefined(t))return[];return t.map((e=>{const t=e.Type&&e.Type["#text"];return freeze({keywords:e.Keyword||[],type:t})}))}}function getContactInformation(e){if(!isDefined(e))return null;const t=e.ServiceContact;const i=t.ContactInfo;const r=i&&i.Phone;const n=i&&i.Address;const s=r&&r.Voice&&Object.keys(r.Voice).length>0&&r.Voice[0];const o=n&&n.ElectronicMailAddress&&Object.keys(n.ElectronicMailAddress).length>0&&n.ElectronicMailAddress[0];return freeze({primaryPerson:getPrimaryPerson(e),position:t.PositionName,address:getAddress(e),telephone:s,fax:r&&r.Facsimile,email:o})}function getPrimaryPerson(e){if(!isDefined(e))return null;return freeze({person:e.ServiceContact&&e.ServiceContact.IndividualName,organization:e.ProviderName})}function getAddress(e){if(!isDefined(e))return null;const t=e.ServiceContact&&e.ServiceContact.ContactInfo;const i=t&&t.Address;if(!isDefined(i))return null;return freeze({address:i.DeliveryPoint&&i.DeliveryPoint[0],city:i.City,stateOrProvince:i.AdministrativeArea,postCode:i.PostalCode,country:i.Country})}function parseResourceUrl(e){return{format:e.format,resourceType:e.resourceType,template:e.template}}function getBounds(e,t){if(!isDefined(e))return null;const i=parseCornerValues(e.LowerCorner);const r=parseCornerValues(e.UpperCorner);const n=i[0];const s=i[1];const o=r[0];const a=r[1];return freeze({reference:isDefined(t)?t:e.crs,x:n,y:s,width:o-n,height:a-s})}function getLegend(e){return{url:e.href,format:e.format,minScaleDenominator:e.minScaleDenominator,maxScaleDenominator:e.maxScaleDenominator,width:e.width,height:e.height}}function getThemeWithParents(e){const t=[];while(null!==e){t.push(e);e=e.parent}return t}