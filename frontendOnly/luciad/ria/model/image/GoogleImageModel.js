import{URL}from"../../util/URL.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{getReference}from"../../reference/ReferenceProvider.js";import{createTransformation}from"../../transformation/TransformationFactory.js";import{getLevelByScalePixelDensity,getScaleByLevelPixelDensity}from"../tileset/TileCoordinateUtil.js";import{RasterDataType}from"../tileset/RasterDataType.js";import{WebMercatorBounds}from"../WebMercatorBounds.js";import{RasterImageModel}from"./RasterImageModel.js";import{isArray,isBoolean}from"../../util/Lang.js";const LEVEL_PRECISION=1e8;const CENTER_PRECISION=1e14;function roundToPrecision(e,t){return Math.round(e*t)/t}const GEO_REF=getReference("CRS:84");const GOOG=getReference("EPSG:900913");const GOOG_TO_GEO=createTransformation(GOOG,GEO_REF);const DEFAULT_ACCOUNT_LIMITS={maxScale:2,maxSize:[640,640]};const DEFAULT_REQUEST_PARAMETERS={sensor:false};function collectStyle(e,t){e.push(`style=${encodeURIComponent(t)}`);return e}function requestString(e){const t=undefined;function r(t,r){if("style"===r&&isArray(e[r])){const o=undefined;return e[r].reduce(collectStyle,t)}t.push(`${r}=${encodeURIComponent(e[r])}`);return t}const o=undefined;return Object.keys(e).reduce(r,[]).join("&")}function validateParameters(e,t){if(!t.key&&!t.client)throw new ProgrammingError("Cannot connect without an application key or a client. Choose one.");else if(t.key&&t.client)throw new ProgrammingError("Cannot connect with both an application key and a client. Choose one.");if(e.maxScale>4)throw new ProgrammingError("maxScale cannot be larger than 4");if(e.maxZoom<0)throw new ProgrammingError("maxZoom must not be smaller than 0");const r=["roadmap","satellite","hybrid","terrain"];if(t.maptype&&r.indexOf(t.maptype)<0)throw new ProgrammingError(`mapType ${t.maptype} is not known. Choose from ${r.join(",")}`);if(!isBoolean(t.sensor))throw new ProgrammingError("Sensor is mandatory boolean parameter");const o=undefined;["scale","zoom","center","size"].forEach((e=>{if("undefined"!==typeof t[e])throw new ProgrammingError(`May not specify the ${e} request parameter`)}))}export class GoogleImageModel extends RasterImageModel{constructor(e){e=e||{};const t=Object.assign({},DEFAULT_ACCOUNT_LIMITS,e.accountLimits);const r=Object.assign({},DEFAULT_REQUEST_PARAMETERS,e.requestParameters);validateParameters(t,r);super({reference:GOOG,credentials:e.credentials,requestHeaders:e.requestHeaders,modelDescriptor:Object.freeze({source:e.serviceUrl||"https://maps.googleapis.com/maps/api/staticmap",name:"Google Maps",description:"Google Maps Image Model",type:RasterDataType.IMAGE})});this._bounds=WebMercatorBounds.create();this._pd=256*1/this._bounds.width;this.levelCount=20;this._serviceUrl=e.serviceUrl||"https://maps.googleapis.com/maps/api/staticmap";this._maxWidth=t.maxSize[0];this._maxHeight=t.maxSize[1];this._scale=1;this._maxScale=t.maxScale;this._requestString=requestString(r);this.useCors=!URL.isLocalURL(this._serviceUrl)}get reference(){return super.reference}get bounds(){return this._bounds}get credentials(){return super.credentials}set credentials(e){super.credentials=e}get requestHeaders(){return super.requestHeaders}set requestHeaders(e){super.requestHeaders=e}_formatUrl(e,t,r,o,n,s){let a=`${this._serviceUrl}?center=${t},${e}&zoom=${r}&size=${o}x${n}&scale=${s}`;if(""!==this._requestString)a+=`&${this._requestString}`;return a}getPixelDensity(e){return this._pd*Math.pow(2,e)}getImageUrl(e,t,r,o){const n=t/e.width;let s,a;try{a=getLevelByScalePixelDensity(n,this._pd);s=GOOG_TO_GEO.transform(e.focusPoint);s.x=Number(roundToPrecision(s.x,CENTER_PRECISION).toString());s.y=Number(roundToPrecision(s.y,CENTER_PRECISION).toString())}catch(e){return null}a=roundToPrecision(a,LEVEL_PRECISION);let i=Math.ceil(a);i=Math.max(i,0);i=Math.min(i,this.levelCount);const c=undefined;const m=getScaleByLevelPixelDensity(i,this._pd)/n;let l=t*m;let u=r*m;let d=this._scale;while(l>this._maxWidth||u>this._maxHeight){l/=2;u/=2;i-=1;d*=2}l=Math.round(l);u=Math.round(u);d=Math.min(d,this._maxScale);return this._formatUrl(s.x,s.y,i,l,u,d)}}