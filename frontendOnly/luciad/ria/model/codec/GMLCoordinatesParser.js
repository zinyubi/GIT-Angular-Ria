import{Log}from"../../util/Log.js";import{ReferenceType}from"../../reference/ReferenceType.js";import{XML}from"../../util/XML.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{shouldSwapAxes}from"../../reference/AxisInformationUtil.js";function getSRSDimension(e){if(e&&e.parentNode&&e.hasAttribute("srsDimension")){const t=e.getAttribute("srsDimension");if(t){const e=parseInt(t);if(2===e||3===e)return e}Log.warn(`Invalid srsDimension: ${t}`)}return null}function parseCoordinate(e){const t=parseFloat(e);if(isNaN(t))throw new ProgrammingError(`Invalid coordinate: ${e}`);return t}function findSRSDimension(e){const t=getSRSDimension(e);if(t)return t;return e.parentNode?findSRSDimension(e.parentNode):null}function getAttributeContent(e,t){return e.attributes.getNamedItem(t)?.textContent??null}function coordinatesAsPointCoordinates(e,t,n){let o=e.textContent.trim();const r=getAttributeContent(e,"decimal")||".";const i=getAttributeContent(e,"cs")||",";const s=getAttributeContent(e,"ts")||" ";if("."!==r)o=o.replace(r,".");const a=o.split(s);let l,p;let c=0;let f=1;if(shouldSwapAxes(t,n)){c=1;f=0}const m=[];if(a&&a.length>0){l=a[0].split(i);p=getSRSDimension(e)||l.length;if(2===p)for(let e=0;e<a.length;e++){l=a[e].split(i);m.push([parseCoordinate(l[c]),parseCoordinate(l[f])])}else if(3===p)for(let e=0;e<a.length;e++){l=a[e].split(i);m.push([parseCoordinate(l[c]),parseCoordinate(l[f]),parseCoordinate(l[2])])}else throw new ProgrammingError(`Invalid coordinates: ${a}`)}return m}function posAsPointCoordinates(e,t,n,o){const r=e.textContent.trim();const i=getSRSDimension(e)||o;const s=r.split(/\ +/);let a=0;let l=1;if(shouldSwapAxes(t,n)){a=1;l=0}if(i<2||i>3||s.length%i)throw new ProgrammingError(`Invalid coordinates length: ${s.length}, srs dimension: ${i}`);const p=[];if(2===i)for(let e=0;e<s.length;e+=2)p.push([parseCoordinate(s[e+a]),parseCoordinate(s[e+l])]);else if(3===i)for(let e=0;e<s.length;e+=3)p.push([parseCoordinate(s[e+a]),parseCoordinate(s[e+l]),parseCoordinate(s[e+2])]);return p}export function parseGeometryToPointCoordinates(e,t,n){let o=[];const r=findSRSDimension(e)||(t.referenceType===ReferenceType.GEOCENTRIC?3:t.axisInformation.length);const i=getChildren(e);for(let e=0;e<i.length;e++){const s=i[e];if(XML.matchesName(s,"posList","http://www.opengis.net/gml"))return posAsPointCoordinates(s,t,n,r);if(XML.matchesName(s,"pos","http://www.opengis.net/gml"))o=o.concat(posAsPointCoordinates(s,t,n,r));if(XML.matchesName(s,"coordinates","http://www.opengis.net/gml"))return coordinatesAsPointCoordinates(s,t,n)}return o}function getChildren(e){const t=[];if(e.children)for(let n=0;n<e.childElementCount;n++)t.push(e.children[n]);else{const n=e.childNodes;let o=0;let r=n[o++];while(r){if(1===r.nodeType)t.push(r);r=n[o++]}}return t}