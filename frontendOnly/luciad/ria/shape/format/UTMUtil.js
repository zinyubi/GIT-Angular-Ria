import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{createTransformation,createTransformationWithOptions,isTransformationRequired}from"../../transformation/TransformationFactory.js";import{GeodeticGridTransformation}from"../../transformation/GeodeticGridTransformation.js";import{NORTH_LAT_LIMIT,SOUTH_LAT_LIMIT,UTMGridSystem}from"../../view/grid/UTMGridSystem.js";import{ProgrammingError}from"../../error/ProgrammingError.js";import{XYZPoint}from"../XYZPoint.js";import{ParseError}from"../../error/ParseError.js";import{getReference}from"../../reference/ReferenceProvider.js";import{LLHPoint}from"../LLHPointBounds.js";import{formatUtmUpsString}from"./UtmUpsUtil.js";const NORTHERN_HEMISPHERE_DESIGNATOR="N";const SOUTHERN_HEMISPHERE_DESIGNATOR="S";const LATITUDE_BAND_LETTERS=["C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","W","X"];const LATITUDE_BAND_LETTER_STRING="CDEFGHJKLMNPQRSTUVWX";export class UTMUtil{constructor(){this._gridSystem=new UTMGridSystem;this._tempXYPoint=new XYZPoint;this._utmCoordinateSeparator=" ";this._useLatitudeBandDesignator=true;this._numberOfDigits=7;this._geodeticReference=getReference("CRS:84");this._tempLLPoint=new LLHPoint(this._geodeticReference)}get utmCoordinateSeparator(){return this._utmCoordinateSeparator}set utmCoordinateSeparator(t){this._utmCoordinateSeparator=t}get useLatitudeBandDesignator(){return this._useLatitudeBandDesignator}set useLatitudeBandDesignator(t){this._useLatitudeBandDesignator=t}get numberOfDigits(){return this._numberOfDigits}set numberOfDigits(t){if(-1===t)this._numberOfDigits=7;else this._numberOfDigits=t}static calculateLatitudeBand(t){let e;if(t<=84)if(t>=72)e=19;else e=Math.floor(t+80)/8;else throw new OutOfBoundsError("The given lon lat point is outside the bounds of the UTM grid system.");return Math.floor(e)}static parseUtmUpsCoordinateString(t,e){if(!isEmptyString(t)&&!isNumeric(t))throw new ParseError("Non Numeric values are not allowed, but got "+t);let r=0===t.length?0:parseInt(t);if(r<0)throw new ParseError("Negative values are not allowed, but got "+t);if(e>0&&e<7)r*=Math.pow(10,7-e);r+=.5;return r}static truncateLatCoordinateToUtmBounds(t){const e=t.x;let r=t.y;if(r<SOUTH_LAT_LIMIT)r=SOUTH_LAT_LIMIT;if(r>NORTH_LAT_LIMIT)r=NORTH_LAT_LIMIT;t.move2D(e,r)}lonLat2Utm(t){if(t.y>NORTH_LAT_LIMIT)throw new OutOfBoundsError("Point above northern latitude limit.");if(t.y<SOUTH_LAT_LIMIT)throw new ProgrammingError("Point below southern latitude limit.");const e=this._gridSystem.getUTMGridForPoint(t);const r=undefined;new GeodeticGridTransformation(t.reference,e,{createTransformation:createTransformation,isTransformationRequired:isTransformationRequired,createTransformationWithOptions:createTransformationWithOptions}).transform(t,this._tempXYPoint);const n=this._tempXYPoint.x;const i=this._tempXYPoint.y;const o=e.zoneID;const s=e.isNorthernHemisphere();const a=UTMUtil.calculateLatitudeBand(t.y);return this.utmXY2UtmImpl(n,i,o,a,s)}utmXY2UtmImpl(t,e,r,n,i){let o;if(this._useLatitudeBandDesignator)o=LATITUDE_BAND_LETTERS[n];else if(i)o=NORTHERN_HEMISPHERE_DESIGNATOR;else o=SOUTHERN_HEMISPHERE_DESIGNATOR;return formatUtmUpsString(r+o,t,e,this._numberOfDigits,this._utmCoordinateSeparator)}utm2LonLat(t,e){if(t.length<2)throw new ParseError("UTM String doesn't contain enough information: "+t);const r=this._numberOfDigits;let n;let i;let o;if(null!==this.utmCoordinateSeparator){const e=t.split(this.utmCoordinateSeparator);if(!e[0])throw new ParseError("Cannot parse UTM String ["+t+"]");n=e[0];if(!e[1])throw new ParseError("Cannot parse UTM String ["+t+"]"+" "+n.length);i=e[1];if(!e[2])throw new ParseError("Cannot parse UTM String ["+t+"]"+" "+n.length);o=e[2]}else{const e=isDigit(t.charAt(1))?3:2;const r=t.length-e;if(13!==r&&r%2===1)throw new ParseError("UTM String doesn't have a valid length: "+t);const s=13===r?6:r/2;const a=13===r?7:r/2;n=t.substring(0,e);i=t.substring(e,e+s);o=t.substring(e+s,e+s+a)}const s=i.length;const a=o.length;if(s>7)throw new ParseError("Easting should consist of minimum 0 and maximum 7 digits, but was: "+i+" "+n.length);if(a>7)throw new ParseError("Northing should consist of minimum 0 and maximum 7 digits, but was: "+o+" "+n.length);if(s!==a)if(6!==s||7!==a)throw new ParseError("Easting and northing should consist of the same number of digits, but was: "+i+" and "+o+" "+n.length);let m;let u;if(this.useLatitudeBandDesignator){const e=getLatitudeBand(n.charAt(n.length-1));if(-1===e)throw new ParseError("Cannot parse UTM String ["+t+"]: no latitude band designator found."+" "+(n.length-2));u=e>=10;m=n.substring(0,n.length-1)}else{let e;if(n.endsWith(NORTHERN_HEMISPHERE_DESIGNATOR)){e=NORTHERN_HEMISPHERE_DESIGNATOR;u=true}else if(n.endsWith(SOUTHERN_HEMISPHERE_DESIGNATOR)){e=SOUTHERN_HEMISPHERE_DESIGNATOR;u=false}else throw new ParseError("Cannot parse UTM String ["+t+"], no hemisphere designator found.");m=n.substring(0,n.length-e.length)}const d=parseInt(m);if(d<=0||d>60)throw new ParseError("Cannot parse UTM String ["+t+"]: zone should be between 1 and 60 inclusive.");const f=UTMUtil.parseUtmUpsCoordinateString(i,r);const h=UTMUtil.parseUtmUpsCoordinateString(o,r);this._tempXYPoint.move2D(f,h);try{const t=this._gridSystem.getUTMGrid(d,u);const r=undefined;createTransformation(t,this._geodeticReference).transform(this._tempXYPoint,this._tempLLPoint);UTMUtil.truncateLatCoordinateToUtmBounds(this._tempLLPoint);e.move2D(this._tempLLPoint)}catch(t){const e=t instanceof Error?t.message:""+t;throw new ParseError(e)}}}const getLatitudeBand=t=>LATITUDE_BAND_LETTER_STRING.indexOf(t);const isDigit=t=>/^\d$/.test(t);const isNumeric=t=>/^\d+$/.test(t);const isEmptyString=t=>0===t.length;export function getZoneBoundsMin(t,e){let r=6*(t-1)-180;if(32===t&&17===e)r=3;if(19===e)if(33===t)r=9;else if(35===t)r=21;else if(37===t)r=33;return r}export function getZoneBoundsMax(t,e){let r=6*t-180;if(31===t&&17===e)r=3;if(19===e)if(31===t)r=9;else if(33===t)r=21;else if(35===t)r=33;return r}export function getBandBoundsMin(t){return 8*(t-10)}export function getBandBoundsMax(t){let e=8*(t-9);if(19===t)e+=4;return e}