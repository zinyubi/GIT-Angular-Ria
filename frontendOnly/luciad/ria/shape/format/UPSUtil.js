import{OutOfBoundsError}from"../../error/OutOfBoundsError.js";import{NORTH_LAT_LIMIT,SOUTH_LAT_LIMIT}from"../../view/grid/UTMGridSystem.js";import{UPSGridSystem}from"../../view/grid/UPSGridSystem.js";import{createTransformation,createTransformationWithOptions,isTransformationRequired}from"../../transformation/TransformationFactory.js";import{GeodeticGridTransformation}from"../../transformation/GeodeticGridTransformation.js";import{LLHPoint}from"../LLHPoint.js";import{XYZPoint}from"../XYZPoint.js";import*as Cartesian from"../../util/Cartesian.js";import{distance2D_xy}from"../../util/Cartesian.js";import{ParseError}from"../../error/ParseError.js";import{getReference}from"../../reference/ReferenceProvider.js";import{formatUtmUpsString}from"./UtmUpsUtil.js";const EPSILON=1e-8;export const POLE_X=2e6;export const POLE_Y=2e6;export function getNorthRadius(t){const e=new LLHPoint(t.inputReference,[0,NORTH_LAT_LIMIT]);const r=new XYZPoint;t.transform(e,r);return distance2D_xy(r.x,r.y,POLE_X,POLE_Y)}export function getSouthRadius(t){const e=new LLHPoint(t.inputReference,[0,SOUTH_LAT_LIMIT]);const r=new XYZPoint;t.transform(e,r);return distance2D_xy(r.x,r.y,POLE_X,POLE_Y)}export class UPSUtil{constructor(){this._gridSystem=new UPSGridSystem;this._tempXYPoint=new XYZPoint;this._upsCoordinateSeparator=" ";this._numberOfDigits=7;this._geodeticReference=getReference("CRS:84");this._tempLLPoint=new LLHPoint(this._geodeticReference);this._northRadius=getNorthRadius(createTransformation(this._geodeticReference,this._gridSystem.getUPSGrid(true)));this._southRadius=getSouthRadius(createTransformation(this._geodeticReference,this._gridSystem.getUPSGrid(false)))}get upsCoordinateSeparator(){return this._upsCoordinateSeparator}set upsCoordinateSeparator(t){this._upsCoordinateSeparator=t}get numberOfDigits(){return this._numberOfDigits}set numberOfDigits(t){if(-1===t)this._numberOfDigits=7;else this._numberOfDigits=t}static truncateLatCoordinateToUpsBounds(t){const e=t.x;let r=t.y;if(r>0&&r<NORTH_LAT_LIMIT)r=NORTH_LAT_LIMIT;if(r<0&&r>SOUTH_LAT_LIMIT)r=SOUTH_LAT_LIMIT;t.move2D(e,r)}lonLat2Ups(t){if(t.y<NORTH_LAT_LIMIT&&t.y>SOUTH_LAT_LIMIT)throw new OutOfBoundsError("Point should be above the northern latitude limit or below the southern latitude limit.");const e=this._gridSystem.getUPSGridForPoint(t);const r=new GeodeticGridTransformation(t.reference,e,{createTransformation:createTransformation,isTransformationRequired:isTransformationRequired,createTransformationWithOptions:createTransformationWithOptions});r.transform(t,this._tempXYPoint);const i=this._tempXYPoint.x;const o=this._tempXYPoint.y;const s=e.isNorthPole();let n;if(s)n=getNorthRadius(r);else n=getSouthRadius(r);return this.upsXY2Ups(i,o,s,n)}ups2LonLat(t,e){if(0===t.length)throw new ParseError("Can't parse 0 size UPS String");let r;let i;let o;if(null!==this.upsCoordinateSeparator){const e=t.split(this.upsCoordinateSeparator);if(!e[0])throw new ParseError("Cannot parse UPS String ["+t+"]"+" 0");r=e[0];if(!e[1])throw new ParseError("Cannot parse UPS String ["+t+"]"+" "+r.length);i=e[1];if(!e[2])throw new ParseError("Cannot parse UPS String ["+t+"]"+" "+(r.length+i.length));o=e[2]}else{r=t.substring(0,1);if(0===this._numberOfDigits){i="";o=""}else{if(t.length!==1+2*this._numberOfDigits)throw new ParseError("UPS String doesn't have a valid length: "+t+" 0");i=t.substring(1,1+this._numberOfDigits);o=t.substring(1+this._numberOfDigits,1+2*this._numberOfDigits)}}if(1!==r.length)throw new ParseError("Zone should constitute of exactly one character instead of "+r+" 0");const s=r.charAt(0);let n;let a;switch(s){case"A":n=false;a=false;break;case"B":n=false;a=true;break;case"Y":n=true;a=false;break;case"Z":n=true;a=true;break;default:throw new ParseError("Invalid zone designation: "+s+" 0")}const f=parseUtmUpsCoordinateString(i,this._numberOfDigits);const m=parseUtmUpsCoordinateString(o,this._numberOfDigits);this._tempXYPoint.move2D(f,m);this.truncateUPSCoordinates(this._tempXYPoint,n,a);try{const t=this._gridSystem.getUPSGrid(n);const r=undefined;createTransformation(t,this._tempLLPoint.reference).transform(this._tempXYPoint,this._tempLLPoint);UPSUtil.truncateLatCoordinateToUpsBounds(this._tempLLPoint);e.move2D(this._tempLLPoint)}catch(e){const r=e instanceof Error?e.message:""+e;throw new ParseError("Cannot parse UPS String ["+t+"]"+"  message : "+r)}}upsXY2Ups(t,e,r,i){const o=undefined;if(distance2D_xy(t,e,POLE_X,POLE_Y)>i+EPSILON)throw new OutOfBoundsError("The given coordinate is outside the bounds of the UPS grid system.");const s=undefined;return formatUtmUpsString(t<POLE_X?r?"Y":"A":r?"Z":"B",t,e,this._numberOfDigits,this.upsCoordinateSeparator)}truncateUPSCoordinates(t,e,r){let i=t.x;let o=t.y;const s=Cartesian.distance2D_xy(i,o,POLE_X,POLE_Y);if(e&&s>this._northRadius){let t=.5-1e-4;let e=.5-1e-4;if(i>POLE_X)t=-t;if(o>POLE_Y)e=-e;i+=t;o+=e}else if(!e&&s>this._southRadius){let t=.5-1e-4;let e=.5-1e-4;if(i>POLE_X)t=-t;if(o>POLE_Y)e=-e;i+=t;o+=e}if(r&&i<POLE_X)i=POLE_X;else if(!r&&i>POLE_X)i=POLE_X;t.move2D(i,o)}}function parseUtmUpsCoordinateString(t,e){let r=0===t.length?0:parseFloat(t);if(r<0)throw new ParseError("Negative values are not allowed, but got "+t+" 0");if((e=parseInt(String(e)))>0&&e<7)r*=Math.pow(10,7-e);r+=.5;return r}