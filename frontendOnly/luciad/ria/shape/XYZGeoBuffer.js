import{Constants}from"../util/Constants.js";import{CoordinateType}from"../reference/CoordinateType.js";import{XYZGeoBufferHelper}from"../geometry/constructivegeometry/geobuffer/XYZGeoBufferHelper.js";import{GeoBuffer}from"./GeoBuffer.js";import{XYZPoint}from"./XYZPoint.js";import{EndCapStyle}from"./EndCapStyle.js";import{closestPointOnSegment,distance2D,forwardAzimuth2D}from"../util/Cartesian.js";import{isPolygon}from"./Polygon.js";const ABS_TOLERANCE=.01;export class XYZGeoBuffer extends GeoBuffer{constructor(t,e,i){super(t,e,i);this._tempPoint=new XYZPoint(this._reference);this._bufferHelper=new XYZGeoBufferHelper(this._reference)}get bounds(){return this._cache.memoize("buffer-bounds",(()=>{let t=this.baseShape.bounds;if(null===t)return null;t=t.copy();t.translate2D(-this.width,-this.width);t.width+=2*this.width;t.height+=2*this.width;return t}))}get coordinateType(){return CoordinateType.CARTESIAN}copy(){const t=new XYZGeoBuffer(this._reference,this._baseShape.copy(),this._width);t.endCapStyle=this._endCapStyle;return t}contains2DPoint(t){let e,i,n,s,o,r;if(!this.bounds?.contains2DPoint(t))return false;if(this._baseShape.contains2DPoint(t))return true;if(isPolygon(this._baseShape))return this.nearPolygonBounds(this._baseShape,t);const a=this._baseShape.pointCount;if(0==a)return false;if(1==a)return this._baseShape.getPoint(0).contains2DPoint(t);const h=this._baseShape.getSimplePoint(0);const f=this._baseShape.getSimplePoint(1);if(2==a){r=closestPointOnSegment(t,h,f,this._tempPoint);e=r.distance;if(e<=this._width){if(this._endCapStyle===EndCapStyle.CAP_ROUND)return true;if(distance2D(h,this._tempPoint)<=ABS_TOLERANCE){i=forwardAzimuth2D(h,f)*Constants.RAD2DEG;n=forwardAzimuth2D(this._tempPoint,t)*Constants.RAD2DEG;o=i-n;if(o<0)o+=360;if(o>90&&o<270)return false}if(distance2D(f,this._tempPoint)<=ABS_TOLERANCE){s=forwardAzimuth2D(f,h)*Constants.RAD2DEG;n=forwardAzimuth2D(this._tempPoint,t)*Constants.RAD2DEG;o=s-n;if(o<0)o+=360;if(o>90&&o<270)return false}return true}return false}if(a>2)for(let i=1;i<a-2;i++){r=closestPointOnSegment(t,this._baseShape.getSimplePoint(i),this._baseShape.getSimplePoint(i+1),this._tempPoint);e=r.distance;if(e<=this._width)return true}r=closestPointOnSegment(t,h,f,this._tempPoint);e=r.distance;if(e<=this._width)if(this._endCapStyle===EndCapStyle.CAP_ROUND)return true;else{if(distance2D(h,this._tempPoint)<=ABS_TOLERANCE){i=forwardAzimuth2D(h,f)*Constants.RAD2DEG;n=forwardAzimuth2D(this._tempPoint,t)*Constants.RAD2DEG;o=i-n;if(o<0)o+=360;if(o>90&&o<270)return false}return true}r=closestPointOnSegment(t,this._baseShape.getSimplePoint(a-2),this._baseShape.getSimplePoint(a-1),this._tempPoint);e=r.distance;if(e<=this._width){if(this._endCapStyle===EndCapStyle.CAP_ROUND)return true;else if(distance2D(this._baseShape.getSimplePoint(a-1),this._tempPoint)<=ABS_TOLERANCE){s=forwardAzimuth2D(this._baseShape.getSimplePoint(a-1),this._baseShape.getSimplePoint(a-2))*Constants.RAD2DEG;n=forwardAzimuth2D(this._tempPoint,t)*Constants.RAD2DEG;o=s-n;if(o<0)o+=360;if(o>90&&o<270)return false}return true}return false}contains2DCoordinates(t,e){return this.contains2DPoint(new XYZPoint(this._reference,[t,e]))}nearPolygonBounds(t,e){let i,n,s;const o=t.pointCount;if(0===o)return false;if(1===o)return distance2D(t.getPoint(0),e)<=this._width;for(s=0;s<o-1;++s){i=closestPointOnSegment(e,t.getSimplePoint(s),t.getSimplePoint(s+1),this._tempPoint);n=i.distance;if(n<=this._width)return true}if(o>2){i=closestPointOnSegment(e,t.getSimplePoint(o-1),t.getSimplePoint(0),this._tempPoint);n=i.distance;if(n<=this._width)return true}return false}}