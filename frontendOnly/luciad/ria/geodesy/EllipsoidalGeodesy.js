import{Constants}from"../util/Constants.js";import{closestPointOnGeodesic as closestPointOnGeodesicSphere,geodesicArea as geodesicAreaSphere}from"./SphereUtil.js";import{closestPointOnGeodesic,geodesicArea}from"./EllipsoidUtil.js";import{GeodeticGeodesy}from"./GeodeticGeodesy.js";import{LineType}from"./LineType.js";import{createPoint}from"../shape/ShapeFactory.js";import{distance3D as cartesianDistance3D}from"../util/Cartesian.js";export class EllipsoidalGeodesy extends GeodeticGeodesy{constructor(e){super(e);this._EPSILON=.01}distanceImpl(e,t,s,i){switch(i){default:case LineType.SHORTEST_DISTANCE:return e.geodesicDistance(t,s);case LineType.CONSTANT_BEARING:return e.rhumblineDistance(t,s)}}distance3DImpl(e,t,s,i){if(Math.abs(t.z)<1e-8&&Math.abs(s.z)<1e-8)return this.distanceImpl(e,t,s,i);const n=createPoint(null,[]);const o=createPoint(null,[]);e.geod2geocSFCT(t,n);e.geod2geocSFCT(s,o);const a=cartesianDistance3D(n,o);const c=Math.max(.001,1e-6*a);return this.calculateDistance3DImpl(e,i,t,s,n,o,a,c)}forwardAzimuthImpl(e,t,s,i){switch(i){default:case LineType.SHORTEST_DISTANCE:return Constants.RAD2DEG*e.forwardAzimuth2D(t,s);case LineType.CONSTANT_BEARING:return e.rhumblineAzimuth2D(t,s)}}interpolateDistanceAzimuthImpl(e,t,s,i,n,o){switch(n){default:case LineType.SHORTEST_DISTANCE:e.geodesicPositionSFCT(t,s,i,o);break;case LineType.CONSTANT_BEARING:e.rhumblinePositionSFCT(t,s,i,o);break}return o}interpolateFractionImpl(e,t,s,i,n,o){switch(n){default:case LineType.SHORTEST_DISTANCE:e.geodesicPositionAtFractionSFCT(t,s,i,o);break;case LineType.CONSTANT_BEARING:{const n=e.rhumblineAzimuth2D(t,s);const a=e.rhumblineDistance(t,s);e.rhumblinePositionSFCT(t,i*a,n,o);break}}return o}shortestDistanceToLineImpl(e,t,s,i,n,o){if(n&&n.clipToSegment)return closestPointOnGeodesic(s,i,t,this.ellipsoid,1e-10,.01,o);else{closestPointOnGeodesicSphere(s,i,t,false,o);return this.ellipsoid.geodesicDistance(t,o)}}calculateDistance3DImpl(e,t,s,i,n,o,a,c){const r=this.interpolateFractionImpl(e,s,i,.5,t,createPoint(s.reference,[0,0,s.z+.5*(i.z-s.z)]));const l=createPoint(null,[]);e.geod2geocSFCT(r,l);const p=cartesianDistance3D(n,l);const d=cartesianDistance3D(l,o);const u=p+d;const m=u-a;if(Math.abs(m)<c)return u;else{const a=undefined;const u=undefined;return this.calculateDistance3DImpl(e,t,s,r,n,l,p,.5*c)+this.calculateDistance3DImpl(e,t,r,i,l,o,d,.5*c)}}areaImpl(e,t){if(e.isSphere())return Math.abs(geodesicAreaSphere(t,e.a));else return Math.abs(geodesicArea(t,e))}}