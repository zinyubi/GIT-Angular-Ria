import{Constants}from"../util/Constants.js";import{LineType}from"./LineType.js";import{closestPointOnGeodesic,geodesicArea,greatCircleDistance,greatCirclePointAtFractionSFCT,greatCirclePointSFCT,rhumblineAzimuth2D,rhumblineDistance,rhumblinePointSFCT}from"./SphereUtil.js";import{forwardAzimuth2D}from"./AzimuthUtil.js";import{GeodeticGeodesy}from"./GeodeticGeodesy.js";import{createPoint}from"../shape/ShapeFactory.js";import{Ellipsoid}from"./Ellipsoid.js";import{distance3D as cartesianDistance3D}from"../util/Cartesian.js";export class SphericalGeodesy extends GeodeticGeodesy{constructor(t,e){super(t);this._earthRadius=e?e:null;this._EPSILON=.01}distanceImpl(t,e,i,s){const n=this._earthRadius||t.radiusEuler(e.y,t.forwardAzimuth2D(e,i));switch(s){default:case LineType.SHORTEST_DISTANCE:return greatCircleDistance(e,i)*Constants.DEG2RAD*n;case LineType.CONSTANT_BEARING:return rhumblineDistance(e,i)*Constants.DEG2RAD*n}}distance3DImpl(t,e,i,s){if(Math.abs(e.z)<1e-8&&Math.abs(i.z)<1e-8)return this.distanceImpl(this.ellipsoid,e,i,s);const n=this._earthRadius||t.radiusEuler(e.y,t.forwardAzimuth2D(e,i));const a=Ellipsoid.fromAB({a:n,b:n});const r=createPoint(null,[]);const o=createPoint(null,[]);a.geod2geocSFCT(e,r);a.geod2geocSFCT(i,o);const c=cartesianDistance3D(r,o);const l=Math.max(.001,1e-6*c);return this.calculateDistance3DImpl(s,e,i,r,o,c,a,l)}forwardAzimuthImpl(t,e,i,s){switch(s){default:case LineType.SHORTEST_DISTANCE:return forwardAzimuth2D(e,i)*Constants.RAD2DEG;case LineType.CONSTANT_BEARING:return rhumblineAzimuth2D(e,i)*Constants.RAD2DEG}}interpolateDistanceAzimuthImpl(t,e,i,s,n,a){const r=this._earthRadius||t.radiusEuler(e.y,s);switch(n){default:case LineType.SHORTEST_DISTANCE:greatCirclePointSFCT(e,i/r*Constants.RAD2DEG,s,a);break;case LineType.CONSTANT_BEARING:rhumblinePointSFCT(e,i/r*Constants.RAD2DEG,s,a);break}return a}interpolateFractionImpl(t,e,i,s,n,a){switch(n){default:case LineType.SHORTEST_DISTANCE:greatCirclePointAtFractionSFCT(e,i,s,a);break;case LineType.CONSTANT_BEARING:{const t=Constants.RAD2DEG*rhumblineAzimuth2D(e,i);const n=rhumblineDistance(e,i);rhumblinePointSFCT(e,s*n,t,a);break}}return a}calculateDistance3DImpl(t,e,i,s,n,a,r,o){const c=this.interpolateFractionImpl(r,e,i,.5,t,createPoint(e.reference,[0,0,e.z+.5*(i.z-e.z)]));const l=createPoint(null,[]);r.geod2geocSFCT(c,l);const u=cartesianDistance3D(s,l);const h=cartesianDistance3D(l,n);const D=u+h;const m=D-a;if(Math.abs(m)<o)return D;else{const a=undefined;const D=undefined;return this.calculateDistance3DImpl(t,e,c,s,l,u,r,.5*o)+this.calculateDistance3DImpl(t,c,i,l,n,h,r,.5*o)}}shortestDistanceToLineImpl(t,e,i,s,n,a){const r=closestPointOnGeodesic(i,s,e,n&&!!n.clipToSegment,a);const o=this._earthRadius||this.ellipsoid.radiusEuler(e.y,this.ellipsoid.forwardAzimuth2D(e,a));return r*Constants.DEG2RAD*o}areaImpl(t,e){const i=this._earthRadius||t.a;return Math.abs(geodesicArea(e,i))}}